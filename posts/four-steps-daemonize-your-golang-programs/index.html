

<!DOCTYPE html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="light"
  data-auto-appearance="true"
><head>
  <meta charset="utf-8" />
  
    <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Four Steps to Daemonize Your Go Programs &middot; Ilija Eftimov üë®‚ÄçüöÄ</title>
    <meta name="title" content="Four Steps to Daemonize Your Go Programs &middot; Ilija Eftimov üë®‚ÄçüöÄ" />
  
  <meta name="description" content="Documenting my experiences and learnings, with the goal of helping other software engineers on their journey" />
  
  
  
  <link rel="canonical" href="https://ieftimov.com/posts/four-steps-daemonize-your-golang-programs/" />
  
  
  
  
  
  
  
  
  
    
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.4801cb831d6359e43865e37733fc89df21983ad1c08157d4e17c36e09cb2501cdbd2e1dcde1db016cfa1554f175134d948555ab487816811cb9e93b19673ce89.css"
    integrity="sha512-SAHLgx1jWeQ4ZeN3M/yJ3yGYOtHAgVfU4Xw24JyyUBzb0uHc3h2wFs&#43;hVU8XUTTZSFVatIeBaBHLnpOxlnPOiQ=="
  />
  
  
  <script type="text/javascript" src="/js/appearance.min.badab316c9287a5a42a843e4eb45da65bb3d194a5a0f5fa4a3e516160e67df0b8c65f4f19a8e146436e29d583699e6cb41d6bbe99e05e1dbaa877763bad9f8e2.js" integrity="sha512-utqzFskoelpCqEPk60XaZbs9GUpaD1&#43;ko&#43;UWFg5n3wuMZfTxmo4UZDbinVg2mebLQda76Z4F4duqh3djutn44g=="></script>
  
    
    
    
  
  
    
    
  
  
  
    
    <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.15ae6e2c9b1ac24a9ccf40003fa689efb1a18db1ee9b73d780b01a6c31b150441415862513e93184f68fe385759e4698b8763cba6a0f79493c1fed99ad5868d4.js" integrity="sha512-Fa5uLJsawkqcz0AAP6aJ77GhjbHum3PXgLAabDGxUEQUFYYlE&#43;kxhPaP44V1nkaYuHY8umoPeUk8H&#43;2ZrVho1A==" data-copy="Copy" data-copied="Copied"></script>
  
  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  <meta property="og:title" content="Four Steps to Daemonize Your Go Programs" />
<meta property="og:description" content="Hands-on introduction for the best four-step approach to daemonizing your Go programs" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ieftimov.com/posts/four-steps-daemonize-your-golang-programs/" /><meta property="og:image" content="https://ieftimov.com/cards/four-steps-daemonize-your-golang-programs.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-02T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-05-02T00:00:00+00:00" /><meta property="og:site_name" content="Ilija Eftimov üë®‚ÄçüöÄ" />

  <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://ieftimov.com/cards/four-steps-daemonize-your-golang-programs.png"/>

<meta name="twitter:title" content="Four Steps to Daemonize Your Go Programs"/>
<meta name="twitter:description" content="Hands-on introduction for the best four-step approach to daemonizing your Go programs"/>

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Four Steps to Daemonize Your Go Programs",
    "headline": "Four Steps to Daemonize Your Go Programs",
    "description": "Hands-on introduction for the best four-step approach to daemonizing your Go programs",
    "abstract": "If you have ever worked with Ruby, or have maybe maintained a Rails application, I am sure the name Sidekiq will sound familiar.",
    "inLanguage": "en",
    "url" : "https:\/\/ieftimov.com\/posts\/four-steps-daemonize-your-golang-programs\/",
    "author" : {
      "@type": "Person",
      "name": "Ilija Eftimov"
    },
    "copyrightYear": "2020",
    "dateCreated": "2020-05-02T00:00:00\u002b00:00",
    "datePublished": "2020-05-02T00:00:00\u002b00:00",
    
    "dateModified": "2020-05-02T00:00:00\u002b00:00",
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "2955"
  }]
  </script>


  
  <meta name="author" content="Ilija Eftimov" />
  
    
      <link href="https://twitter.com/ilijaio" rel="me" />
    
      <link href="https://www.linkedin.com/in/ieftimov/" rel="me" />
    
      <link href="mailto:blog@ieftimov.com" rel="me" />
    
      <link href="https://captainscodebook.com" rel="me" />
    
      <link href="https://dev.to/fteem" rel="me" />
    
      <link href="https://github.com/fteem" rel="me" />
    
      <link href="https://t.me/ieftimovcom" rel="me" />
    
  
  
  






  
  <script async defer data-domain="ieftimov.com" src="https://plausible.io/js/plausible.js"></script>

  
  
</head>
<body
    class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"
  >
    <div id="the-top" class="absolute flex self-center">
      <a
        class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0"
        href="#main-content"
        ><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400"
          >&darr;</span
        >Skip to main content</a
      >
    </div>
    
    
      <header class="py-6 font-semibold sm:py-10 text-neutral-900 dark:text-neutral print:hidden">
  <nav class="flex justify-between">
    
    <div>
      
        <a
          class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
          rel="me"
          href="/"
          >Ilija Eftimov üë®‚ÄçüöÄ</a
        >
      

    </div>
    
    
      <ul class="flex flex-col list-none ltr:text-right rtl:text-left sm:flex-row">
        
          
            <li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
              <a
                class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
                href="/"
                title=""
                >Home</a
              >
            </li>
          
            <li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
              <a
                class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
                href="/posts/"
                title="Posts"
                >Essays</a
              >
            </li>
          
            <li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
              <a
                class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
                href="/work"
                title=""
                >Work</a
              >
            </li>
          
            <li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
              <a
                class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
                href="https://captainscodebook.com"
                title=""
                >Subscribe</a
              >
            </li>
          
        
        
          <li class="ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
            <button
              id="search-button"
              class="text-base hover:text-primary-600 dark:hover:text-primary-400"
              title="Search (/)"
            >
              

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
          </li>
        
      </ul>
    
  </nav>
</header>

    
    <div class="relative flex flex-col grow">
      <main id="main-content" class="grow">
        
  <article>
    <header class="max-w-prose">
      
      <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        Four Steps to Daemonize Your Go Programs
      </h1>
      <div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
        





  
  



  

  
  
    
  

  

  

  
    
  

  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="2020-05-02 00:00:00 &#43;0000 UTC">2 May 2020</time><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">14 mins</span>
    

    
    
  </div>

  
  


      </div>
    </header>
    <section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert">
      
        <div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last">
          <div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10 print:hidden">
            <details open class="mt-0 overflow-hidden rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700"
  >
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"
  >
    <nav id="TableOfContents">
  <ul>
    <li><a href="#website-observer">Website Observer</a></li>
    <li><a href="#logging-to-stdout">Logging to <code>STDOUT</code></a></li>
    <li><a href="#shut-down-on-sigtermsigint">Shut down on <code>SIGTERM</code>/<code>SIGINT</code></a>
      <ul>
        <li><a href="#termination-signals">Termination signals</a></li>
        <li><a href="#handling-sigterm--signit">Handling <code>SIGTERM</code> &amp; <code>SIGNIT</code></a></li>
      </ul>
    </li>
    <li><a href="#reload-config-on-sighup">Reload config on <code>SIGHUP</code></a></li>
    <li><a href="#provide-the-necessary-config-file-for-your-favorite-init-system-to-control-your-daemon">Provide the necessary config file for your favorite init system to control your daemon</a></li>
  </ul>
</nav>
  </div>
</details>

          </div>
        </div>
      
      <div class="min-w-0 min-h-0 max-w-prose">
        <p>If you have ever worked with Ruby, or have maybe maintained a Rails
application, I am sure the name Sidekiq will sound familiar. For those
unfamiliar with the project, Sidekiq is a job system for Ruby. It is a <a href="https://github.com/mperham/sidekiq">wildly
popular</a> project, and the author has turned
it into <a href="https://sidekiq.org/">a successful business</a>.</p>
<p>None of the above would be relevant if Sidekiq&rsquo;s author Mike Perham, in 2014,
did not write a concise and informative post titled <a href="https://www.mikeperham.com/2014/09/22/dont-daemonize-your-daemons">&ldquo;Don&rsquo;t Daemonize your
Daemons!&rdquo;</a>.
In it, he covers four guidelines to daemonizing programs correctly:</p>
<ol>
<li>Log to <code>STDOUT</code></li>
<li>Shut down on <code>SIGTERM</code>/<code>SIGINT</code></li>
<li>Reload config on <code>SIGHUP</code></li>
<li>Provide the necessary config file for your favorite init system to control
your daemon</li>
</ol>
<p>(You can also read the whole article on <a href="https://www.mikeperham.com/2014/09/22/dont-daemonize-your-daemons/">his
website</a>.)</p>
<p>So I was thinking, why don&rsquo;t we explore how to apply these guidelines while
daemonizing a Go program?</p>
<h2 id="website-observer" class="relative group">Website Observer <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#website-observer" aria-label="Anchor">#</a></span></h2>
<p>The program in question is a simple command-line program that can monitor any
website by sending periodic HTTP requests to it. If you ever heard of
Datadog&rsquo;s synthetic tests or Pingdom, think of our program as their little
sibling.</p>
<p>The <code>observer</code> program will read its configuration from flags, environment
variables, or a configuration file. If the configuration is not present as a
flag, it will look into the <code>ENV</code> vars for it and then in a configuration file
(if present). If nothing is found, it will use the default value or exit with
an error depending on how crucial the configuration is.</p>
<p>To do this, we will use <a href="https://github.com/namsral/flag">the <code>namsral/flag</code>
package</a>, which is a drop-in replacement for
Go&rsquo;s flag package, with the addition of parsing files and environment
variables. Being a drop-in replacement means that using the <code>namsral/flag</code>
package is as simple as using the <code>flag</code> package from the standard library.</p>
<p>First, <code>observer</code> will have a <code>config</code> type, which will encapsulate the
configuration for the website that it will observe:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">const</span> defaultTick <span style="color:#eceff4">=</span> <span style="color:#b48ead">60</span> <span style="color:#81a1c1">*</span> time<span style="color:#eceff4">.</span>Second
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">type</span> config <span style="color:#81a1c1;font-weight:bold">struct</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	contentType <span style="color:#81a1c1">string</span>
</span></span><span style="display:flex;"><span>	server      <span style="color:#81a1c1">string</span>
</span></span><span style="display:flex;"><span>	statusCode  <span style="color:#81a1c1">int</span>
</span></span><span style="display:flex;"><span>	tick        time<span style="color:#eceff4">.</span>Duration
</span></span><span style="display:flex;"><span>	url         <span style="color:#81a1c1">string</span>
</span></span><span style="display:flex;"><span>	userAgent   <span style="color:#81a1c1">string</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#eceff4">(</span>c <span style="color:#81a1c1">*</span>config<span style="color:#eceff4">)</span> <span style="color:#88c0d0">init</span><span style="color:#eceff4">(</span>args <span style="color:#eceff4">[]</span><span style="color:#81a1c1">string</span><span style="color:#eceff4">)</span> <span style="color:#81a1c1">error</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	flags <span style="color:#81a1c1">:=</span> flag<span style="color:#eceff4">.</span><span style="color:#88c0d0">NewFlagSet</span><span style="color:#eceff4">(</span>args<span style="color:#eceff4">[</span><span style="color:#b48ead">0</span><span style="color:#eceff4">],</span> flag<span style="color:#eceff4">.</span>ExitOnError<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	flags<span style="color:#eceff4">.</span><span style="color:#88c0d0">String</span><span style="color:#eceff4">(</span>flag<span style="color:#eceff4">.</span>DefaultConfigFlagname<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;&#34;</span><span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;Path to config file&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">var</span> <span style="color:#eceff4">(</span>
</span></span><span style="display:flex;"><span>		statusCode  <span style="color:#eceff4">=</span> flags<span style="color:#eceff4">.</span><span style="color:#88c0d0">Int</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;status&#34;</span><span style="color:#eceff4">,</span> <span style="color:#b48ead">200</span><span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;Response HTTP status code&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		tick        <span style="color:#eceff4">=</span> flags<span style="color:#eceff4">.</span><span style="color:#88c0d0">Duration</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;tick&#34;</span><span style="color:#eceff4">,</span> defaultTick<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;Ticking interval&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		server      <span style="color:#eceff4">=</span> flags<span style="color:#eceff4">.</span><span style="color:#88c0d0">String</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;server&#34;</span><span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;&#34;</span><span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;Server HTTP header value&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		contentType <span style="color:#eceff4">=</span> flags<span style="color:#eceff4">.</span><span style="color:#88c0d0">String</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;content_type&#34;</span><span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;&#34;</span><span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;Content-Type HTTP header value&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		userAgent   <span style="color:#eceff4">=</span> flags<span style="color:#eceff4">.</span><span style="color:#88c0d0">String</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;user_agent&#34;</span><span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;&#34;</span><span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;User-Agent HTTP header value&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		url         <span style="color:#eceff4">=</span> flags<span style="color:#eceff4">.</span><span style="color:#88c0d0">String</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;url&#34;</span><span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;&#34;</span><span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;Request URL&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">:=</span> flags<span style="color:#eceff4">.</span><span style="color:#88c0d0">Parse</span><span style="color:#eceff4">(</span>args<span style="color:#eceff4">[</span><span style="color:#b48ead">1</span><span style="color:#eceff4">:]);</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	c<span style="color:#eceff4">.</span>statusCode <span style="color:#eceff4">=</span> <span style="color:#81a1c1">*</span>statusCode
</span></span><span style="display:flex;"><span>	c<span style="color:#eceff4">.</span>tick <span style="color:#eceff4">=</span> <span style="color:#81a1c1">*</span>tick
</span></span><span style="display:flex;"><span>	c<span style="color:#eceff4">.</span>server <span style="color:#eceff4">=</span> <span style="color:#81a1c1">*</span>server
</span></span><span style="display:flex;"><span>	c<span style="color:#eceff4">.</span>contentType <span style="color:#eceff4">=</span> <span style="color:#81a1c1">*</span>contentType
</span></span><span style="display:flex;"><span>	c<span style="color:#eceff4">.</span>userAgent <span style="color:#eceff4">=</span> <span style="color:#81a1c1">*</span>userAgent
</span></span><span style="display:flex;"><span>	c<span style="color:#eceff4">.</span>url <span style="color:#eceff4">=</span> <span style="color:#81a1c1">*</span>url
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#81a1c1;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>The <code>init</code> function will take the command line arguments as input and build a
<code>FlagSet</code>, which represents a set of defined flags. Each of the flags is listed
and parsed; then, their values are assigned to the <code>config</code>. Additionally,
having the <code>flag.DefaultConfigFilename</code> as a flag as well enables our
<code>observer</code> to load the configuration from a <code>config.conf</code> file. The <code>.conf</code>
file has a <code>key=value</code> format, with new lines after each key-value pair.</p>
<p>Here&rsquo;s the main function:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#88c0d0">main</span><span style="color:#eceff4">()</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	ctx <span style="color:#81a1c1">:=</span> context<span style="color:#eceff4">.</span><span style="color:#88c0d0">Background</span><span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>	ctx<span style="color:#eceff4">,</span> cancel <span style="color:#81a1c1">:=</span> context<span style="color:#eceff4">.</span><span style="color:#88c0d0">WithCancel</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	c <span style="color:#81a1c1">:=</span> <span style="color:#81a1c1">&amp;</span>config<span style="color:#eceff4">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">defer</span> <span style="color:#81a1c1;font-weight:bold">func</span><span style="color:#eceff4">()</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#88c0d0">cancel</span><span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">:=</span> <span style="color:#88c0d0">run</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> c<span style="color:#eceff4">);</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		fmt<span style="color:#eceff4">.</span><span style="color:#88c0d0">Fprintf</span><span style="color:#eceff4">(</span>os<span style="color:#eceff4">.</span>Stderr<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;%s\n&#34;</span><span style="color:#eceff4">,</span> err<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		os<span style="color:#eceff4">.</span><span style="color:#88c0d0">Exit</span><span style="color:#eceff4">(</span><span style="color:#b48ead">1</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>Following <a href="https://pace.dev/blog/2020/02/12/why-you-shouldnt-use-func-main-in-golang-by-mat-ryer.html">Mat Ryer&rsquo;s
advice</a>,
we are going to keep <code>main</code> very thin while keeping the main logic of the
<code>observer</code> in the <code>run</code> method. <code>main</code> here just sets up the main context that
will propagate down to the <code>run</code> method, and it initializes the observer
<code>config</code>. Then it passes all of the relevant arguments to the <code>run</code> method.</p>
<p>Here&rsquo;s the <code>run</code> method:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#88c0d0">run</span><span style="color:#eceff4">(</span>ctx context<span style="color:#eceff4">.</span>Context<span style="color:#eceff4">,</span> c <span style="color:#81a1c1">*</span>config<span style="color:#eceff4">)</span> <span style="color:#81a1c1">error</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	c<span style="color:#eceff4">.</span><span style="color:#88c0d0">init</span><span style="color:#eceff4">(</span>os<span style="color:#eceff4">.</span>Args<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">for</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">select</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">case</span> <span style="color:#81a1c1">&lt;-</span>ctx<span style="color:#eceff4">.</span><span style="color:#88c0d0">Done</span><span style="color:#eceff4">():</span>
</span></span><span style="display:flex;"><span>			<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#81a1c1;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">case</span> <span style="color:#81a1c1">&lt;-</span>time<span style="color:#eceff4">.</span><span style="color:#88c0d0">Tick</span><span style="color:#eceff4">(</span>c<span style="color:#eceff4">.</span>tick<span style="color:#eceff4">):</span>
</span></span><span style="display:flex;"><span>			resp<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">:=</span> http<span style="color:#eceff4">.</span><span style="color:#88c0d0">Get</span><span style="color:#eceff4">(</span>c<span style="color:#eceff4">.</span>url<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#81a1c1;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>			<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#81a1c1;font-weight:bold">if</span> resp<span style="color:#eceff4">.</span>StatusCode <span style="color:#81a1c1">!=</span> c<span style="color:#eceff4">.</span>statusCode <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>				log<span style="color:#eceff4">.</span><span style="color:#88c0d0">Printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Status code mismatch, got: %d\n&#34;</span><span style="color:#eceff4">,</span> resp<span style="color:#eceff4">.</span>StatusCode<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#81a1c1;font-weight:bold">if</span> s <span style="color:#81a1c1">:=</span> resp<span style="color:#eceff4">.</span>Header<span style="color:#eceff4">.</span><span style="color:#88c0d0">Get</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;server&#34;</span><span style="color:#eceff4">);</span> s <span style="color:#81a1c1">!=</span> c<span style="color:#eceff4">.</span>server <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>				log<span style="color:#eceff4">.</span><span style="color:#88c0d0">Printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Server header mismatch, got: %s\n&#34;</span><span style="color:#eceff4">,</span> s<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#81a1c1;font-weight:bold">if</span> ct <span style="color:#81a1c1">:=</span> resp<span style="color:#eceff4">.</span>Header<span style="color:#eceff4">.</span><span style="color:#88c0d0">Get</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;content-type&#34;</span><span style="color:#eceff4">);</span> ct <span style="color:#81a1c1">!=</span> c<span style="color:#eceff4">.</span>contentType <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>				log<span style="color:#eceff4">.</span><span style="color:#88c0d0">Printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Content-Type header mismatch, got: %s\n&#34;</span><span style="color:#eceff4">,</span> ct<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#81a1c1;font-weight:bold">if</span> ua <span style="color:#81a1c1">:=</span> resp<span style="color:#eceff4">.</span>Header<span style="color:#eceff4">.</span><span style="color:#88c0d0">Get</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;user-agent&#34;</span><span style="color:#eceff4">);</span> ua <span style="color:#81a1c1">!=</span> c<span style="color:#eceff4">.</span>userAgent <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>				log<span style="color:#eceff4">.</span><span style="color:#88c0d0">Printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;User-Agent header mismatch, got: %s\n&#34;</span><span style="color:#eceff4">,</span> ua<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>First, the <code>run</code> method initializes the <code>config</code> instance <code>c</code>, using the <code>init</code>
method. Then, it loops infinitely until the context <code>ctx</code> is done. When <code>ctx</code>
is done, it means the <code>observer</code> process is terminated, so it merely returns a
<code>nil</code> and finishes with its execution.</p>
<p>Alternatively, it will execute the other case every <code>tick</code>. By using the
<code>time.Tick</code> channel here we run this code by receiving a signal through the
channel every <code>c.tick</code> period. For example, if <code>c.tick</code> is 30 seconds, we will
receive a signal every 30 seconds, meaning the code will run every 30 seconds.</p>
<p>The code itself is simple ‚Äì it sends an HTTP <code>GET</code> request to the URL assigned
to <code>c.url</code>. Once the response returns, the <code>run</code> method compares the relevant
response headers and the status code with the once provided through the
configuration. If any mismatch is detected, it logs the error.</p>
<p>Running the <code>observer</code> is relatively simple. One way is to supply a config file
through the command line:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./observer -config ./config.conf
</span></span><span style="display:flex;"><span>2020/04/23 19:41:54 Status code mismatch, got: <span style="color:#b48ead">200</span>
</span></span></code></pre></div><p>Alternatively, using flags:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./observer -status<span style="color:#81a1c1">=</span><span style="color:#b48ead">500</span> -tick<span style="color:#81a1c1">=</span>10s -url<span style="color:#81a1c1">=</span>https://ieftimov.com -server<span style="color:#81a1c1">=</span>Cloudflare
</span></span><span style="display:flex;"><span>2020/04/23 19:43:34 Status code mismatch, got: <span style="color:#b48ead">200</span>
</span></span><span style="display:flex;"><span>2020/04/23 19:43:34 Server header mismatch, got: cloudflare
</span></span><span style="display:flex;"><span>2020/04/23 19:43:34 Content-Type header mismatch, got: text/html<span style="color:#eceff4">;</span> charset<span style="color:#81a1c1">=</span>utf-8
</span></span></code></pre></div><p>We can do the same using environment variables, or a combination of all three:
config file, environment variables, and flags.</p>
<p>Now, how can we apply the four simple rules of daemonization?</p>
<h2 id="logging-to-stdout" class="relative group">Logging to <code>STDOUT</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#logging-to-stdout" aria-label="Anchor">#</a></span></h2>
<p>While daemons don&rsquo;t have much to do with web services, one of the 12 factors of
modern web services are treating logs as event streams. While the 12 factors in
this particular case are not applicable, the guiding principle stays: the
daemon itself should not manage log streams, nor it should not concern itself
with writing to or managing log files. Instead, daemons should send their log
stream, unbuffered, to <code>STDOUT</code>.</p>
<p>The service management system will capture each daemon&rsquo;s stream. The <code>init</code>
config file is what we will use to configure logging, such as where the logs
should be stored or streamed.</p>
<p>So, how can we adapt the <code>observer</code> to log to <code>STDOUT</code>?</p>
<p>First, we will add another argument to the <code>run</code> function, called <code>out</code> of type
<code>io.Writer</code>. Then, we will invoke the <code>log.SetOutput</code> function passing the
<code>out</code> as argument to it.</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#88c0d0">run</span><span style="color:#eceff4">(</span>ctx context<span style="color:#eceff4">.</span>Context<span style="color:#eceff4">,</span> c <span style="color:#81a1c1">*</span>config<span style="color:#eceff4">,</span> out io<span style="color:#eceff4">.</span>Writer<span style="color:#eceff4">)</span> <span style="color:#81a1c1">error</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	c<span style="color:#eceff4">.</span><span style="color:#88c0d0">init</span><span style="color:#eceff4">(</span>os<span style="color:#eceff4">.</span>Args<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	log<span style="color:#eceff4">.</span><span style="color:#88c0d0">SetOutput</span><span style="color:#eceff4">(</span>out<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">for</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">select</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">case</span> <span style="color:#81a1c1">&lt;-</span>ctx<span style="color:#eceff4">.</span><span style="color:#88c0d0">Done</span><span style="color:#eceff4">():</span>
</span></span><span style="display:flex;"><span>			<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#81a1c1;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">case</span> <span style="color:#81a1c1">&lt;-</span>time<span style="color:#eceff4">.</span><span style="color:#88c0d0">Tick</span><span style="color:#eceff4">(</span>c<span style="color:#eceff4">.</span>tick<span style="color:#eceff4">):</span>
</span></span><span style="display:flex;"><span>			<span style="color:#616e87;font-style:italic">// Identical to above, removed from brewity
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>		<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>By doing this, we will have to pass <code>STDOUT</code> from the <code>main</code> function, but we
keep our <code>run</code> function more testable. Using a separate <code>run</code> method means we
can invoke it with any instance that implements the <code>io.Writer</code> interface. We
basically couple the <code>run</code> method to <strong>a behavior instead of type</strong>.</p>
<p>Then, we need to update the <code>main</code> function to pass the additional argument to
the <code>run</code> function when invoking it. And the <code>io.Writer</code> will be simple
<code>os.Stdout</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#88c0d0">main</span><span style="color:#eceff4">()</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	ctx <span style="color:#81a1c1">:=</span> context<span style="color:#eceff4">.</span><span style="color:#88c0d0">Background</span><span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>	ctx<span style="color:#eceff4">,</span> cancel <span style="color:#81a1c1">:=</span> context<span style="color:#eceff4">.</span><span style="color:#88c0d0">WithCancel</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	c <span style="color:#81a1c1">:=</span> <span style="color:#81a1c1">&amp;</span>config<span style="color:#eceff4">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">defer</span> <span style="color:#81a1c1;font-weight:bold">func</span><span style="color:#eceff4">()</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#88c0d0">cancel</span><span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">:=</span> <span style="color:#88c0d0">run</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> c<span style="color:#eceff4">,</span> os<span style="color:#eceff4">.</span>Stdout<span style="color:#eceff4">);</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		fmt<span style="color:#eceff4">.</span><span style="color:#88c0d0">Fprintf</span><span style="color:#eceff4">(</span>os<span style="color:#eceff4">.</span>Stderr<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;%s\n&#34;</span><span style="color:#eceff4">,</span> err<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		os<span style="color:#eceff4">.</span><span style="color:#88c0d0">Exit</span><span style="color:#eceff4">(</span><span style="color:#b48ead">1</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>If we run the program again we won&rsquo;t see a difference:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./observer -status<span style="color:#81a1c1">=</span><span style="color:#b48ead">500</span> -tick<span style="color:#81a1c1">=</span>10s -url<span style="color:#81a1c1">=</span>https://ieftimov.com -server<span style="color:#81a1c1">=</span>Cloudflare
</span></span><span style="display:flex;"><span>2020/04/23 19:43:34 Status code mismatch, got: <span style="color:#b48ead">200</span>
</span></span><span style="display:flex;"><span>2020/04/23 19:43:34 Server header mismatch, got: cloudflare
</span></span><span style="display:flex;"><span>2020/04/23 19:43:34 Content-Type header mismatch, got: text/html<span style="color:#eceff4">;</span> charset<span style="color:#81a1c1">=</span>utf-8
</span></span></code></pre></div><p>Why is that? Well, the <code>log</code> package <a href="https://github.com/golang/go/blob/5477623/src/log/log.go#L76">logs to <code>STDERR</code> by
default</a>, so
there is no visible change of behavior there. Still, we make the dependency on
an output stream explicit to the <code>run</code> function, which clearly states that
<code>run</code> needs to know where to send its logs when running.</p>
<h2 id="shut-down-on-sigtermsigint" class="relative group">Shut down on <code>SIGTERM</code>/<code>SIGINT</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#shut-down-on-sigtermsigint" aria-label="Anchor">#</a></span></h2>
<p>In Go, having errors as values is very helpful to think about what will happen
to our program if an error is returned. While this makes our Go programs
always have some repetitive error handling, it also gives us confidence that
our program will gracefully handle any error.</p>
<h3 id="termination-signals" class="relative group">Termination signals <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#termination-signals" aria-label="Anchor">#</a></span></h3>
<p>*nix operating systems (OS) employ a system of signals, which is a mechanism
of the OS to ask a process to perform a particular action. There are two
general types of signals: those that cause termination of a process and those
that do not.</p>
<p>(Refer to <a href="https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/signal.h.html">the full
list</a>
of the POSIX-defined signals to learn more.)</p>
<p>Using these system signals, a process that has received one can choose one of
the following behaviors to take place: perform the default POSIX-defined
action, ignore the signal, or catch the signal with a signal handler and
perform some sort of a custom action.</p>
<p>Some signals that just can&rsquo;t be caught or ignored; it means that the default
action has to happen. For example, <code>SIGSTOP</code> and <code>SIGKILL</code> are such signals.
Once a process receives any of these two signals, we just know that it will be
stopped/killed by the OS.</p>
<p>But other signals are more polite. While we cannot ignore them, they give a
chance to our process to clean up and go away with grace. Most of the ones on
<a href="https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/signal.h.html">the
list</a>
are of the polite kind. In this section, we will look into the <code>SIGTERM</code> and
<code>SIGINT</code> signals and how we can treat them in our Go programs.</p>
<h3 id="handling-sigterm--signit" class="relative group">Handling <code>SIGTERM</code> &amp; <code>SIGNIT</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#handling-sigterm--signit" aria-label="Anchor">#</a></span></h3>
<p>The <a href="https://golang.org/pkg/os/signal"><code>os/signal</code></a> package implements access
to incoming signals with the purpose of signal handling. Through the
<a href="https://golang.org/pkg/os/signal/#Notify"><code>Notify</code></a> function, a Go program can
accept signals thorough a channel of type <code>os.Signal</code>.</p>
<p>In our <code>observer</code>&rsquo;s case, we don&rsquo;t have to do any cleanup once it receives a
<code>SIGTERM</code>/<code>SIGINT</code>. All we have to do is to stop further execution and shut
down gracefully. So, how can we achieve that?</p>
<p>First, we need to create a channel through which we will accept these two signals:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>signalChan <span style="color:#81a1c1">:=</span> <span style="color:#81a1c1">make</span><span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">chan</span> os<span style="color:#eceff4">.</span>Signal<span style="color:#eceff4">,</span> <span style="color:#b48ead">1</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>signal<span style="color:#eceff4">.</span><span style="color:#88c0d0">Notify</span><span style="color:#eceff4">(</span>signalChan<span style="color:#eceff4">,</span> syscall<span style="color:#eceff4">.</span>SIGINT<span style="color:#eceff4">,</span> syscall<span style="color:#eceff4">.</span>SIGTERM<span style="color:#eceff4">)</span>
</span></span></code></pre></div><p>Once the <code>observer</code> process receives a <code>SIGINT</code> or a <code>SIGTERM</code>, it will proxy
it through the <code>signalChan</code> channel. To process the signals, we would need to
create a goroutine that will receive signals through the <code>signalChan</code>. Once it
gets a signal, it will have to <code>cancel()</code> the context, which would stop the
further execution of the <code>run</code> method:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">go</span> <span style="color:#81a1c1;font-weight:bold">func</span><span style="color:#eceff4">()</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1;font-weight:bold">select</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1;font-weight:bold">case</span> <span style="color:#eceff4">=</span> <span style="color:#81a1c1">&lt;-</span>signalChan<span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>                log<span style="color:#eceff4">.</span><span style="color:#88c0d0">Printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Got SIGINT/SIGTERM, exiting.&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#88c0d0">cancel</span><span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>                os<span style="color:#eceff4">.</span><span style="color:#88c0d0">Exit</span><span style="color:#eceff4">(</span><span style="color:#b48ead">1</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1;font-weight:bold">case</span> <span style="color:#81a1c1">&lt;-</span>ctx<span style="color:#eceff4">.</span><span style="color:#88c0d0">Done</span><span style="color:#eceff4">():</span>
</span></span><span style="display:flex;"><span>                log<span style="color:#eceff4">.</span><span style="color:#88c0d0">Printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Done.&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>                os<span style="color:#eceff4">.</span><span style="color:#88c0d0">Exit</span><span style="color:#eceff4">(</span><span style="color:#b48ead">1</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}()</span>
</span></span></code></pre></div><p>So, once the <code>cancel</code> function is executed, in the <code>for</code> loop of the <code>run</code>
method the execution will stop:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#88c0d0">run</span><span style="color:#eceff4">(</span>ctx context<span style="color:#eceff4">.</span>Context<span style="color:#eceff4">,</span> c <span style="color:#81a1c1">*</span>config<span style="color:#eceff4">,</span> stdout io<span style="color:#eceff4">.</span>Writer<span style="color:#eceff4">)</span> <span style="color:#81a1c1">error</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>        c<span style="color:#eceff4">.</span><span style="color:#88c0d0">init</span><span style="color:#eceff4">(</span>os<span style="color:#eceff4">.</span>Args<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>        log<span style="color:#eceff4">.</span><span style="color:#88c0d0">SetOutput</span><span style="color:#eceff4">(</span>os<span style="color:#eceff4">.</span>Stdout<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1;font-weight:bold">for</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#81a1c1;font-weight:bold">select</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#81a1c1;font-weight:bold">case</span> <span style="color:#81a1c1">&lt;-</span>ctx<span style="color:#eceff4">.</span><span style="color:#88c0d0">Done</span><span style="color:#eceff4">():</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#81a1c1;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>                <span style="color:#81a1c1;font-weight:bold">case</span> <span style="color:#81a1c1">&lt;-</span>time<span style="color:#eceff4">.</span><span style="color:#88c0d0">Tick</span><span style="color:#eceff4">(</span>c<span style="color:#eceff4">.</span>tick<span style="color:#eceff4">):</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#616e87;font-style:italic">// Same as above...
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>                <span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>The last thing we need to do in the <code>main</code> function is to close the
<code>signalChan</code> channel when the programs exits:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#88c0d0">main</span><span style="color:#eceff4">()</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#616e87;font-style:italic">// Same as above...
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">defer</span> <span style="color:#81a1c1;font-weight:bold">func</span><span style="color:#eceff4">()</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>                signal<span style="color:#eceff4">.</span><span style="color:#88c0d0">Stop</span><span style="color:#eceff4">(</span>signalChan<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#88c0d0">cancel</span><span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#616e87;font-style:italic">// Same as above...
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>The <code>Stop</code> function will stop relaying incoming signals to <code>signalChan</code>. When
<code>Stop</code> returns, it is guaranteed that <code>signalChan</code> will receive no more
signals.</p>
<p>Let&rsquo;s run the <code>observer</code> program and see the signal handling in action:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./observer -config<span style="color:#81a1c1">=</span>config.conf
</span></span><span style="display:flex;"><span>2020/04/26 00:14:46 Status code mismatch, got: <span style="color:#b48ead">200</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>2020/04/26 00:15:46 Status code mismatch, got: <span style="color:#b48ead">200</span>
</span></span></code></pre></div><p>Now, having the PID of <code>observer</code>, we can send any signal using the <code>kill</code>
command line tool:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#81a1c1">kill</span> -SIGINT <span style="color:#b48ead">37212</span>
</span></span></code></pre></div><p>By executing the <code>kill</code> command, we will send a <code>SIGINT</code> to the <code>observer</code>
process. This will force <code>observer</code> to wrap up the execution, log a line to
<code>STDOUT</code> and exit:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./observer -config<span style="color:#81a1c1">=</span>config.conf
</span></span><span style="display:flex;"><span>2020/04/26 00:29:22 Status code mismatch, got: <span style="color:#b48ead">200</span>
</span></span><span style="display:flex;"><span>2020/04/26 00:29:22 Got SIGINT/SIGTERM, exiting.
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">exit</span> status <span style="color:#b48ead">1</span>
</span></span></code></pre></div><p>We can try the same exercise with <code>SIGTERM</code> as well:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚Ä∫ <span style="color:#81a1c1">kill</span> -SIGTERM <span style="color:#b48ead">37827</span>
</span></span></code></pre></div><p>Causes <code>observer</code> to exit with the same behavior:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./observer -config<span style="color:#81a1c1">=</span>config.conf
</span></span><span style="display:flex;"><span>2020/04/26 00:33:42 Status code mismatch, got: <span style="color:#b48ead">200</span>
</span></span><span style="display:flex;"><span>2020/04/26 00:33:44 Got SIGINT/SIGTERM, exiting.
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">exit</span> status <span style="color:#b48ead">1</span>
</span></span></code></pre></div><h2 id="reload-config-on-sighup" class="relative group">Reload config on <code>SIGHUP</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#reload-config-on-sighup" aria-label="Anchor">#</a></span></h2>
<p>Now that we know how to handle signals, we need to add another signal to the
mix - <code>SIGHUP</code>. To do that, we can just add <code>syscall.SIGHUP</code> to the
<code>signal.Notify</code> call:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>signalChan <span style="color:#81a1c1">:=</span> <span style="color:#81a1c1">make</span><span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">chan</span> os<span style="color:#eceff4">.</span>Signal<span style="color:#eceff4">,</span> <span style="color:#b48ead">1</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>signal<span style="color:#eceff4">.</span><span style="color:#88c0d0">Notify</span><span style="color:#eceff4">(</span>signalChan<span style="color:#eceff4">,</span> syscall<span style="color:#eceff4">.</span>SIGINT<span style="color:#eceff4">,</span> syscall<span style="color:#eceff4">.</span>SIGTERM<span style="color:#eceff4">,</span> syscall<span style="color:#eceff4">.</span>SIGHUP<span style="color:#eceff4">)</span>
</span></span></code></pre></div><p>Now that we have <code>SIGHUP</code> covered, in the goroutine that handles the signals,
once a <code>SIGHUP</code> is received, it should re-run the <code>config.init</code> method. By
doing that, we will reload the configuration of the <code>observer</code>, loading any
changes in the configuration:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">go</span> <span style="color:#81a1c1;font-weight:bold">func</span><span style="color:#eceff4">()</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1;font-weight:bold">select</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1;font-weight:bold">case</span> s <span style="color:#81a1c1">:=</span> <span style="color:#81a1c1">&lt;-</span>signalChan<span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#81a1c1;font-weight:bold">switch</span> s <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#81a1c1;font-weight:bold">case</span> syscall<span style="color:#eceff4">.</span>SIGINT<span style="color:#eceff4">,</span> syscall<span style="color:#eceff4">.</span>SIGTERM<span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>                        log<span style="color:#eceff4">.</span><span style="color:#88c0d0">Printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Got SIGINT/SIGTERM, exiting.&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#88c0d0">cancel</span><span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>                        os<span style="color:#eceff4">.</span><span style="color:#88c0d0">Exit</span><span style="color:#eceff4">(</span><span style="color:#b48ead">1</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#81a1c1;font-weight:bold">case</span> syscall<span style="color:#eceff4">.</span>SIGHUP<span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>                        log<span style="color:#eceff4">.</span><span style="color:#88c0d0">Printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Got SIGHUP, reloading.&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>                        c<span style="color:#eceff4">.</span><span style="color:#88c0d0">init</span><span style="color:#eceff4">(</span>os<span style="color:#eceff4">.</span>Args<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1;font-weight:bold">case</span> <span style="color:#81a1c1">&lt;-</span>ctx<span style="color:#eceff4">.</span><span style="color:#88c0d0">Done</span><span style="color:#eceff4">():</span>
</span></span><span style="display:flex;"><span>                log<span style="color:#eceff4">.</span><span style="color:#88c0d0">Printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Done.&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>                os<span style="color:#eceff4">.</span><span style="color:#88c0d0">Exit</span><span style="color:#eceff4">(</span><span style="color:#b48ead">1</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}()</span>
</span></span></code></pre></div><p>The change is relatively small. By using a <code>switch</code> construct, detect the
received signal. If it&rsquo;s a <code>SIGHUP</code>, we invoke <code>c.init(os.Args)</code>. Otherwise,
we <code>cancel()</code> the context and <code>os.Exit</code> the program.</p>
<p>We can test this using the same trick from before:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#81a1c1">kill</span> -SIGHUP <span style="color:#b48ead">38761</span>
</span></span></code></pre></div><p>Will cause the <code>observer</code> to reload:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./observer -config<span style="color:#81a1c1">=</span>config.conf
</span></span><span style="display:flex;"><span>2020/04/26 01:15:40 Status code mismatch, got: <span style="color:#b48ead">200</span>
</span></span><span style="display:flex;"><span>2020/04/26 01:15:44 Got SIGHUP, reloading.
</span></span></code></pre></div><p>This looks nice. Let&rsquo;s shut down the server now by sending a <code>SIGTERM</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#81a1c1">kill</span> -SIGTERM <span style="color:#b48ead">38761</span>
</span></span></code></pre></div><p>In case you&rsquo;re following along, you will find out that the <code>observer</code> is still
running; this is a bug ‚Äì¬†the goroutine that was receiving signals exited
because the <code>select</code> construct completed once it received the <code>SIGHUP</code>.</p>
<p>To make the goroutine accept signals without exiting, we need to make the
goroutine run infinitely ‚Äì using a <code>for</code> loop:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">go</span> <span style="color:#81a1c1;font-weight:bold">func</span><span style="color:#eceff4">()</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1;font-weight:bold">for</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#81a1c1;font-weight:bold">select</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#81a1c1;font-weight:bold">case</span> s <span style="color:#81a1c1">:=</span> <span style="color:#81a1c1">&lt;-</span>signalChan<span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#81a1c1;font-weight:bold">switch</span> s <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#81a1c1;font-weight:bold">case</span> syscall<span style="color:#eceff4">.</span>SIGINT<span style="color:#eceff4">,</span> syscall<span style="color:#eceff4">.</span>SIGTERM<span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>                                log<span style="color:#eceff4">.</span><span style="color:#88c0d0">Printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Got SIGINT/SIGTERM, exiting.&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#88c0d0">cancel</span><span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>                                os<span style="color:#eceff4">.</span><span style="color:#88c0d0">Exit</span><span style="color:#eceff4">(</span><span style="color:#b48ead">1</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#81a1c1;font-weight:bold">case</span> syscall<span style="color:#eceff4">.</span>SIGHUP<span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>                                log<span style="color:#eceff4">.</span><span style="color:#88c0d0">Printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Got SIGHUP, reloading.&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>                                c<span style="color:#eceff4">.</span><span style="color:#88c0d0">init</span><span style="color:#eceff4">(</span>os<span style="color:#eceff4">.</span>Args<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#81a1c1;font-weight:bold">case</span> <span style="color:#81a1c1">&lt;-</span>ctx<span style="color:#eceff4">.</span><span style="color:#88c0d0">Done</span><span style="color:#eceff4">():</span>
</span></span><span style="display:flex;"><span>                        log<span style="color:#eceff4">.</span><span style="color:#88c0d0">Printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Done.&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>                        os<span style="color:#eceff4">.</span><span style="color:#88c0d0">Exit</span><span style="color:#eceff4">(</span><span style="color:#b48ead">1</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}()</span>
</span></span></code></pre></div><p>By wrapping the whole goroutine in a <code>for</code> loop, we will make sure that it will
not exit, except when a <code>SIGINT</code>/<code>SIGTERM</code> is received, or if the context is
done. By having this endless goroutine, we also can send multiple <code>SIGHUP</code>s to
the <code>observer</code>, and it will process them correctly.</p>
<p>Let&rsquo;s send two <code>SIGHUP</code>s, to perform two reloads, and <code>SIGTERM</code> to shut down
the <code>observer</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#81a1c1">kill</span> -SIGHUP <span style="color:#b48ead">38960</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#81a1c1">kill</span> -SIGHUP <span style="color:#b48ead">38960</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#81a1c1">kill</span> -SIGTERM <span style="color:#b48ead">38960</span>
</span></span></code></pre></div><p>And the <code>observer</code> output:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./observer -config<span style="color:#81a1c1">=</span>config.conf
</span></span><span style="display:flex;"><span>2020/04/26 01:25:02 Status code mismatch, got: <span style="color:#b48ead">200</span>
</span></span><span style="display:flex;"><span>2020/04/26 01:25:03 Got SIGHUP, reloading.
</span></span><span style="display:flex;"><span>2020/04/26 01:25:05 Got SIGHUP, reloading.
</span></span><span style="display:flex;"><span>2020/04/26 01:25:08 Got SIGINT/SIGTERM, exiting.
</span></span></code></pre></div><p>And that&rsquo;s it. The <code>observer</code> now knows how to log to <code>STDOUT</code>, gracefully exit
when it receives <code>SIGINT</code> or <code>SIGTERM</code> and reloads the configuration when it
receives a <code>SIGHUP</code>.</p>
<h2 id="provide-the-necessary-config-file-for-your-favorite-init-system-to-control-your-daemon" class="relative group">Provide the necessary config file for your favorite init system to control your daemon <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#provide-the-necessary-config-file-for-your-favorite-init-system-to-control-your-daemon" aria-label="Anchor">#</a></span></h2>
<p>Now, given that computer of choice is a MacBook, I will explain here how you
can create a config file for <a href="https://www.launchd.info/"><code>launchd</code></a> ‚Äì macOS&rsquo;s
service management framework for starting, stopping and managing daemons,
applications, processes, and scripts. In macOS, the system runs daemons, while
the users run programs as agents. So, we will turn our <code>observer</code> into an
agent.</p>
<p>In the past, I have written about <a href="/create-manage-macos-launchd-agents-golang">creating and managing macOS
agents</a>, so if you would like to
more about this topic, you can head read that as well. Still, let&rsquo;s see a
minimal <code>launchd</code> configuration for <code>observer</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#5e81ac;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#5e81ac;font-style:italic">&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">&lt;plist</span> <span style="color:#8fbcbb">version=</span><span style="color:#a3be8c">&#34;1.0&#34;</span><span style="color:#81a1c1">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1">&lt;dict&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1">&lt;key&gt;</span>Label<span style="color:#81a1c1">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1">&lt;string&gt;</span>com.ieftimov.observer<span style="color:#81a1c1">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1">&lt;key&gt;</span>RunAtLoad<span style="color:#81a1c1">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1">&lt;true/&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1">&lt;key&gt;</span>KeepAlive<span style="color:#81a1c1">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1">&lt;true/&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1">&lt;key&gt;</span>ProgramArguments<span style="color:#81a1c1">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1">&lt;array&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#81a1c1">&lt;string&gt;</span>/usr/local/bin/observer<span style="color:#81a1c1">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#81a1c1">&lt;string&gt;</span>-config<span style="color:#81a1c1">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#81a1c1">&lt;string&gt;</span>/etc/observer.conf<span style="color:#81a1c1">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1">&lt;/array&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1">&lt;key&gt;</span>StandardOutPath<span style="color:#81a1c1">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1">&lt;string&gt;</span>/tmp/observer.log<span style="color:#81a1c1">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1">&lt;key&gt;</span>StandardErrorPath<span style="color:#81a1c1">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#81a1c1">&lt;string&gt;</span>/tmp/observer.error.log<span style="color:#81a1c1">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1">&lt;/dict&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">&lt;/plist&gt;</span>
</span></span></code></pre></div><p>The configuration is relatively straightforward, here are all of the pieces in
order:</p>
<ul>
<li>The <code>Label</code> identifies the job and has to be unique for the launchd instance.
Think of it as a unique name for the given agent.</li>
<li><code>RunAtLoad</code> means <code>launchd</code> will start the job as soon as it loads it.</li>
<li><code>KeepAlive</code> tells launchd to keep the agent running no matter what.</li>
<li><code>ProgramArguments</code> provides command-line options to the agent command. In our
case, this will create the following command: <code>/usr/local/bin/observer -config /etc/observer.conf</code>.</li>
<li><code>StandardOutPath</code> and <code>StandardErrorPath</code> are the paths to where <code>launchd</code>
will write the respective output. In our case, we write these to the <code>tmp</code>
directory. An alternative would be to add the log files to <code>/var/log</code>, but
that requires granting write access of the agent to <code>/var/log</code>.</li>
</ul>
<p>To make sure we can run the agent, we have to also supply the configuration
file <code>observer.conf</code> in the <code>/etc</code> directory. On my machine, its contents are
as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>status=500
</span></span><span style="display:flex;"><span>tick=30s
</span></span><span style="display:flex;"><span>url=https://ieftimov.com
</span></span><span style="display:flex;"><span>server=cloudflare
</span></span><span style="display:flex;"><span>content_type=text/html; charset=utf-8
</span></span><span style="display:flex;"><span>user_agent=
</span></span></code></pre></div><p>After placing the <code>observer.conf</code> file in <code>/etc</code>, for the agent to work, we
have to place its <code>.plist</code> file in <code>~/Library/LaunchAgents</code>, and load it with:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ launchctl load ~/Library/LaunchAgents/com.ieftimov.observer.plist
</span></span></code></pre></div><p>Now, if we would <code>tail -f</code> the log files in <code>/tmp</code> we will see its outputs
there:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ tail -f /tmp/observer.*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">==</span>&gt; /tmp/observer.error.log &lt;<span style="color:#81a1c1">==</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">==</span>&gt; /tmp/observer.log &lt;<span style="color:#81a1c1">==</span>
</span></span><span style="display:flex;"><span>2020/05/02 11:49:03 Status code mismatch, got: <span style="color:#b48ead">200</span>
</span></span></code></pre></div><p>Voila! The agent is running and its logging output to <code>STDOUT</code>, while <code>launchd</code>
is redirecting that output to a log file.</p>
<p>If we would like to run the <code>observer</code> on GNU/Linux, we cannot use this
<code>launchd</code> configuration.</p>
<p>In Linux-land, <code>systemd</code> is widespread and popular. If you are interested in a
deeper explanation of <code>systemd</code> units and unit files, Digital Ocean&rsquo;s blog has
<a href="https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files">an
article</a>
on &ldquo;Understanding Systemd Units and Unit Files&rdquo; by Justin Ellingwood. I
recommend reading it! And keep in mind, the community&rsquo;s opinion on <code>systemd</code>
<a href="https://www.reddit.com/r/linux/comments/5n069y/why_do_people_not_like_systemd/">is pretty
divided</a>.</p>
<p>There are a bunch of other alternatives, but my knowledge of GNU/Linux init
systems is minimal. Therefore, I will stop right here and ask for your help:¬†if
you would like to contribute a Linux init system configuration to this article,
drop the link to a gist/repo in the comments, and I will include it in this
article.</p>
<p>Of course, with proper attribution.</p>
<p>You can see the final implementation of the observer
<a href="https://github.com/fteem/go-playground/tree/master/observer">here</a>.</p>
<iframe src="https://captainscodebook.com/embed" width="480" height="320" style="border:1px solid #EEE; background:white;" frameborder="0" scrolling="no"></iframe>


      </div>
    </section>
    <footer class="pt-8 max-w-prose print:hidden">
      
  <div class="flex">
    
      
      
        
        <img
          class="w-24 h-24 !mt-0 !mb-0 ltr:mr-4 rtl:ml-4 rounded-full"
          width="96"
          height="96"
          alt="Ilija Eftimov"
          src="/img/avatar_huae39953c6189b6aa60e47103b358d088_112612_192x192_fill_q75_box_smart1.jpg"
        />
      
    
    <div class="place-self-center">
      
        <div class="text-[0.6rem] leading-3 text-neutral-500 dark:text-neutral-400 uppercase">
          Author
        </div>
        <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
          Ilija Eftimov
        </div>
      
      
      <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://twitter.com/ilijaio"
          target="_blank"
          aria-label="Twitter"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>

  </span>

</a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://www.linkedin.com/in/ieftimov/"
          target="_blank"
          aria-label="Linkedin"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>

</a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="mailto:blog@ieftimov.com"
          target="_blank"
          aria-label="Email"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>

</a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://captainscodebook.com"
          target="_blank"
          aria-label="Substack"
          rel="me noopener noreferrer"
          >

</a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://dev.to/fteem"
          target="_blank"
          aria-label="Dev"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M120.12 208.29c-3.88-2.9-7.77-4.35-11.65-4.35H91.03v104.47h17.45c3.88 0 7.77-1.45 11.65-4.35 3.88-2.9 5.82-7.25 5.82-13.06v-69.65c-.01-5.8-1.96-10.16-5.83-13.06zM404.1 32H43.9C19.7 32 .06 51.59 0 75.8v360.4C.06 460.41 19.7 480 43.9 480h360.2c24.21 0 43.84-19.59 43.9-43.8V75.8c-.06-24.21-19.7-43.8-43.9-43.8zM154.2 291.19c0 18.81-11.61 47.31-48.36 47.25h-46.4V172.98h47.38c35.44 0 47.36 28.46 47.37 47.28l.01 70.93zm100.68-88.66H201.6v38.42h32.57v29.57H201.6v38.41h53.29v29.57h-62.18c-11.16.29-20.44-8.53-20.72-19.69V193.7c-.27-11.15 8.56-20.41 19.71-20.69h63.19l-.01 29.52zm103.64 115.29c-13.2 30.75-36.85 24.63-47.44 0l-38.53-144.8h32.57l29.71 113.72 29.57-113.72h32.58l-38.46 144.8z"/></svg>

  </span>

</a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/fteem"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>

</a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://t.me/ieftimovcom"
          target="_blank"
          aria-label="Telegram"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M248,8C111.033,8,0,119.033,0,256S111.033,504,248,504,496,392.967,496,256,384.967,8,248,8ZM362.952,176.66c-3.732,39.215-19.881,134.378-28.1,178.3-3.476,18.584-10.322,24.816-16.948,25.425-14.4,1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25,5.342-39.5,3.652-3.793,67.107-61.51,68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608,69.142-14.845,10.194-26.894,9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7,18.45-13.7,108.446-47.248,144.628-62.3c68.872-28.647,83.183-33.623,92.511-33.789,2.052-.034,6.639.474,9.61,2.885a10.452,10.452,0,0,1,3.53,6.716A43.765,43.765,0,0,1,362.952,176.66Z"/></svg>

  </span>

</a
        >
      
    
  </div>

</div>
    </div>
  </div>


      
  
  <section class="flex flex-row flex-wrap justify-center pt-4 text-xl">
    
      
        <a
          class="bg-neutral-300 text-neutral-700 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800 m-1 hover:bg-primary-500 hover:text-neutral rounded min-w-[2.4rem] inline-block text-center p-1"
          href="https://www.facebook.com/sharer/sharer.php?u=https://ieftimov.com/posts/four-steps-daemonize-your-golang-programs/&amp;quote=Four%20Steps%20to%20Daemonize%20Your%20Go%20Programs"
          title="Share on Facebook"
          aria-label="Share on Facebook"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>

  </span>

</a
        >
      
    
      
        <a
          class="bg-neutral-300 text-neutral-700 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800 m-1 hover:bg-primary-500 hover:text-neutral rounded min-w-[2.4rem] inline-block text-center p-1"
          href="https://twitter.com/intent/tweet/?url=https://ieftimov.com/posts/four-steps-daemonize-your-golang-programs/&amp;text=Four%20Steps%20to%20Daemonize%20Your%20Go%20Programs"
          title="Tweet on Twitter"
          aria-label="Tweet on Twitter"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>

  </span>

</a
        >
      
    
      
        <a
          class="bg-neutral-300 text-neutral-700 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800 m-1 hover:bg-primary-500 hover:text-neutral rounded min-w-[2.4rem] inline-block text-center p-1"
          href="https://reddit.com/submit/?url=https://ieftimov.com/posts/four-steps-daemonize-your-golang-programs/&amp;resubmit=true&amp;title=Four%20Steps%20to%20Daemonize%20Your%20Go%20Programs"
          title="Submit to Reddit"
          aria-label="Submit to Reddit"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M201.5 305.5c-13.8 0-24.9-11.1-24.9-24.6 0-13.8 11.1-24.9 24.9-24.9 13.6 0 24.6 11.1 24.6 24.9 0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4 0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8 0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7 0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9 0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5 0 52.6 59.2 95.2 132 95.2 73.1 0 132.3-42.6 132.3-95.2 0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6 0-2.2-2.2-6.1-2.2-8.3 0-2.5 2.5-2.5 6.4 0 8.6 22.8 22.8 87.3 22.8 110.2 0 2.5-2.2 2.5-6.1 0-8.6-2.2-2.2-6.1-2.2-8.3 0zm7.7-75c-13.6 0-24.6 11.1-24.6 24.9 0 13.6 11.1 24.6 24.6 24.6 13.8 0 24.9-11.1 24.9-24.6 0-13.8-11-24.9-24.9-24.9z"/></svg>

  </span>

</a
        >
      
    
      
        <a
          class="bg-neutral-300 text-neutral-700 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800 m-1 hover:bg-primary-500 hover:text-neutral rounded min-w-[2.4rem] inline-block text-center p-1"
          href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://ieftimov.com/posts/four-steps-daemonize-your-golang-programs/&amp;title=Four%20Steps%20to%20Daemonize%20Your%20Go%20Programs"
          title="Share on LinkedIn"
          aria-label="Share on LinkedIn"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>

</a
        >
      
    
      
        <a
          class="bg-neutral-300 text-neutral-700 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800 m-1 hover:bg-primary-500 hover:text-neutral rounded min-w-[2.4rem] inline-block text-center p-1"
          href="mailto:?body=https://ieftimov.com/posts/four-steps-daemonize-your-golang-programs/&amp;subject=Four%20Steps%20to%20Daemonize%20Your%20Go%20Programs"
          title="Send via email"
          aria-label="Send via email"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>

</a
        >
      
    
  </section>


      
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group" href="/posts/understanding-bytes-golang-build-tcp-protocol/">
              <span
                class="mr-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Understanding bytes in Go by building a TCP protocol</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2020-04-02 00:00:00 &#43;0000 UTC">2 April 2020</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group" href="/posts/testing-in-go-stop-leaking-files/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Testing in Go: Stop Leaking Files</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2020-05-22 00:00:00 &#43;0000 UTC">22 May 2020</time>
                  
                </span>
              </span>
              <span
                class="ml-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


      
    </footer>
  </article>

        
          <div
            class="absolute top-[100vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-0"
          >
            <a
              href="#the-top"
              class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5.5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400"
              aria-label="Scroll to top"
              title="Scroll to top"
            >
              &uarr;
            </a>
          </div>
        
      </main><footer class="py-10 print:hidden">
  
  
    <nav class="pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400">
      <ul class="flex flex-col list-none sm:flex-row">
        
          <li
            class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            <a
              class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
              href="/analytics"
              title=""
              >Analytics</a
            >
          </li>
        
          <li
            class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            <a
              class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
              href="/index.xml"
              title=""
              >RSS</a
            >
          </li>
        
          <li
            class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            <a
              class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
              href="https://forms.gle/orfXK5jh1LRaiFzo8"
              title=""
              >Suggest a topic</a
            >
          </li>
        
      </ul>
    </nav>
  
  <div class="flex items-center justify-between">
    <div>
      
      
        <p class="text-sm text-neutral-500 dark:text-neutral-400">
            &copy;
            2023
            Ilija Eftimov
        </p>
      
      
      
        <p class="text-xs text-neutral-500 dark:text-neutral-400">
          
          
          Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
            href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://git.io/hugo-congo" target="_blank" rel="noopener noreferrer">Congo</a>
        </p>
      
    </div>
    
    
      <div
        class="text-sm cursor-pointer text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-14 rtl:ml-14"
      >
        <button
          id="appearance-switcher"
          class="w-12 h-12 "
          type="button"
          title="Switch to dark appearance"
        >
          <span class="inline dark:hidden">

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>

</span>
          <span class="hidden dark:inline">

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>

</span>
        </button>
      </div>
    
  </div>
  
  
</footer>
<div
  id="search-wrapper"
  class="fixed inset-0 z-50 flex flex-col p-4 sm:p-6 md:p-[10vh] lg:p-[12vh] w-screen h-screen cursor-default bg-neutral-500/50 backdrop-blur-sm dark:bg-neutral-900/50 invisible"
  data-url="https://ieftimov.com/"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg border-neutral-200 top-20 bg-neutral dark:bg-neutral-800 dark:border-neutral-700"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-transparent focus:outline-2"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

    </div>
  </body>
</html>
