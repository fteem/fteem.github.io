<!DOCTYPE html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="light"
  data-auto-appearance="true"
><head>
  <meta charset="utf-8" />
  
    <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Understanding bytes in Go by building a TCP protocol &middot; Ilija Eftimov üë®‚ÄçüöÄ</title>
    <meta name="title" content="Understanding bytes in Go by building a TCP protocol &middot; Ilija Eftimov üë®‚ÄçüöÄ" />
  
  <meta name="description" content="Documenting my experiences and learnings, with the goal of helping other software engineers on their journey" />
  
  
  
  <link rel="canonical" href="https://ieftimov.com/posts/understanding-bytes-golang-build-tcp-protocol/" />
  
  
  
  
  
  
  
  
  
    
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.b4e16dd9839a706aac3e482fb2ead8a30c01f199844299a37ddc79029b6a3bae7c65ff23668804cf9b10c85a4931caa1dca1efa0395de6dc9fe0784468f41457.css"
    integrity="sha512-tOFt2YOacGqsPkgvsurYowwB8ZmEQpmjfdx5AptqO658Zf8jZogEz5sQyFpJMcqh3KHvoDld5tyf4HhEaPQUVw=="
  />
  
  
  <script type="text/javascript" src="/js/appearance.min.dbca9e2200cf929a23b55442f2ff09361b8d5290147ff1407f89ed3839f0fea13db4e94f5ae6bf2f3de10d322b4bede74b578455e9cc7d5565314d914602c974.js" integrity="sha512-28qeIgDPkpojtVRC8v8JNhuNUpAUf/FAf4ntODnw/qE9tOlPWua/Lz3hDTIrS&#43;3nS1eEVenMfVVlMU2RRgLJdA=="></script>
  
    
    
    
  
  
    
    
  
  
    
    <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.238e7ce9c541b4e7abb5781ad8e736e849e74890fcb8a26e73ea1845f573b3a0cf91418b20ac4401bdbb57d9c6c009d8f6ec50dad6d44b48f3936aea0f95c391.js" integrity="sha512-I4586cVBtOertXga2Oc26EnnSJD8uKJuc&#43;oYRfVzs6DPkUGLIKxEAb27V9nGwAnY9uxQ2tbUS0jzk2rqD5XDkQ==" data-copy="Copy" data-copied="Copied"></script>
  
  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  <meta property="og:title" content="Understanding bytes in Go by building a TCP protocol" />
<meta property="og:description" content="Learn everything you need to know to work with bytes and slices of bytes ([]byte) by building a chat TCP-based protocol." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ieftimov.com/posts/understanding-bytes-golang-build-tcp-protocol/" /><meta property="og:image" content="https://ieftimov.com/cards/understanding-bytes-golang-build-tcp-protocol.gif" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-02T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-04-02T00:00:00+00:00" /><meta property="og:site_name" content="Ilija Eftimov üë®‚ÄçüöÄ" />


  <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://ieftimov.com/cards/understanding-bytes-golang-build-tcp-protocol.gif"/>

<meta name="twitter:title" content="Understanding bytes in Go by building a TCP protocol"/>
<meta name="twitter:description" content="Learn everything you need to know to work with bytes and slices of bytes ([]byte) by building a chat TCP-based protocol."/>

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Understanding bytes in Go by building a TCP protocol",
    "headline": "Understanding bytes in Go by building a TCP protocol",
    "description": "Learn everything you need to know to work with bytes and slices of bytes ([]byte) by building a chat TCP-based protocol.",
    "abstract": "Some of my newsletter subscribers have asked me a few times what is the easiest way to think about byte slices, or using Go\u0026rsquo;s syntax: []byte.",
    "inLanguage": "en",
    "url" : "https:\/\/ieftimov.com\/posts\/understanding-bytes-golang-build-tcp-protocol\/",
    "author" : {
      "@type": "Person",
      "name": "Ilija Eftimov"
    },
    "copyrightYear": "2020",
    "dateCreated": "2020-04-02T00:00:00\u002b00:00",
    "datePublished": "2020-04-02T00:00:00\u002b00:00",
    
    "dateModified": "2020-04-02T00:00:00\u002b00:00",
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "5479"
  }]
  </script>


  
  
    <meta name="generator" content="Hugo 0.92.2" />
  
  
  <meta name="author" content="Ilija Eftimov" />
  
    
      <link href="https://twitter.com/efilija" rel="me" />
    
      <link href="https://www.linkedin.com/in/ieftimov/" rel="me" />
    
      <link href="mailto:blog@ieftimov.com" rel="me" />
    
      <link href="https://dev.to/fteem" rel="me" />
    
      <link href="https://github.com/fteem" rel="me" />
    
      <link href="https://t.me/ieftimovcom" rel="me" />
    
  
  
  






  
  <script async defer data-domain="ieftimov.com" src="https://plausible.io/js/plausible.js"></script>

  
  
</head>
<body
    class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"
  >
    <div id="the-top" class="absolute flex self-center">
      <a
        class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0"
        href="#main-content"
        ><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400"
          >&darr;</span
        >Skip to main content</a
      >
    </div><header
  class="flex justify-between py-6 font-semibold sm:items-center sm:py-10 text-neutral-900 dark:text-neutral"
>
  
  <div>
    
      <a
        class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
        rel="me"
        href="/"
        >Ilija Eftimov üë®‚ÄçüöÄ</a
      >
    

  </div>
  
  
    <nav>
      <ul class="flex flex-col list-none sm:flex-row">
        
          <li
            class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            <a
              class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
              href="/"
              title=""
              >Home</a
            >
          </li>
        
          <li
            class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            <a
              class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
              href="/posts/"
              title="Posts"
              >Writing</a
            >
          </li>
        
          <li
            class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            <a
              class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
              href="/work"
              title=""
              >Work</a
            >
          </li>
        
          <li
            class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            <a
              class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
              href="https://www.getrevue.co/profile/itsilija"
              title=""
              >Subscribe</a
            >
          </li>
        
        
          <li
            class="ltr:text-right rtl:text-left ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            <button
              id="search-button"
              class="text-base hover:text-primary-600 dark:hover:text-primary-400"
              title="Search (/)"
            >
              

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
  </span>


            </button>
          </li>
        
      </ul>
    </nav>
  
</header>
<main id="main-content" class="relative grow">
  <article>
    <header class="max-w-prose">
      
      <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        Understanding bytes in Go by building a TCP protocol
      </h1>
      <div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400">
        





  
  



  

  
  
    
  

  

  

  
    
  

  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="2020-04-02 00:00:00 &#43;0000 UTC">2 April 2020</time><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">26 mins</span>
    

    
    
  </div>

  
  


      </div>
    </header>
    <section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert">
      
        <div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last">
          <div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10">
            <details open class="mt-0 overflow-hidden rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 lg:mt-3">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700"
  >
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"
  >
    <nav id="TableOfContents">
  <ul>
    <li><a href="#standing-on-shoulders-of-giants">Standing on shoulders of giants</a></li>
    <li><a href="#enter-slck">Enter SLCK</a>
      <ul>
        <li><a href="#slck-design">SLCK design</a>
          <ul>
            <li><a href="#protocol-conventions">Protocol conventions</a></li>
            <li><a href="#protocol-commands-subjects-and-options">Protocol commands (subjects and options)</a></li>
            <li><a href="#reg">REG</a></li>
            <li><a href="#join">JOIN</a></li>
            <li><a href="#leave">LEAVE</a></li>
            <li><a href="#msg">MSG</a></li>
            <li><a href="#chns">CHNS</a></li>
            <li><a href="#usrs">USRS</a></li>
            <li><a href="#okerr">OK/ERR</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#implementing-a-server">Implementing a server</a>
      <ul>
        <li><a href="#server-design">Server design</a></li>
        <li><a href="#commands">Commands</a></li>
        <li><a href="#channels">Channels</a></li>
        <li><a href="#client">Client</a></li>
        <li><a href="#handling-bytes-in-handle-using-the-bytes-package">Handling bytes in <code>handle</code> using the <code>bytes</code> package</a></li>
        <li><a href="#the-hub">The hub</a></li>
        <li><a href="#sending-messages">Sending messages</a></li>
      </ul>
    </li>
    <li><a href="#tying-it-all-together">Tying it all together</a></li>
    <li><a href="#notable-shortcuts">Notable shortcuts</a></li>
  </ul>
</nav>
  </div>
</details>

          </div>
        </div>
      
      <div class="min-w-0 min-h-0 max-w-prose">
        <p>Some of <a href="/newsletter">my newsletter</a> subscribers have asked me a few times what
is the easiest way to think about <code>byte</code> slices, or using Go&rsquo;s syntax:
<code>[]byte</code>. Folks that have experience with low-level languages, where working
with bytes is widespread, usually do not have challenges comprehending what
<code>[]byte</code> means and how to use it.</p>
<p>But, if you come from a dynamic or a high-level language background, although
everything we do ends up being a bunch of bytes, higher-level languages hide
such details from us. Coming from a Ruby background, I sympathize with the
folks that find this challenging.</p>
<p>Inspired by the conversations I had with these readers, I decided to try to
help out. So, without beating around the bush ‚Äì let&rsquo;s explore how we can build
a simple TCP-based application protocol. And thoroughly understand bytes in the
process.</p>
<h2 id="standing-on-shoulders-of-giants" class="relative group">Standing on shoulders of giants <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#standing-on-shoulders-of-giants" aria-label="Anchor">#</a></span></h2>
<p>The protocol that we will be implementing will work on top of TCP, because:</p>
<ol>
<li>TCP is high level enough, so we don&rsquo;t have to worry about too many low-level
connection details</li>
<li>Go has excellent TCP support through the <code>net</code> package</li>
<li>The interfaces that the <code>net</code> packages provide allow us to play with bytes
(and slices of bytes)</li>
<li>TCP provides <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol#Data_transfer">certain
guarantees</a>
when it comes to data transfer, so we are left with less to worry about</li>
<li>Standing on the shoulders of giants is more uncomplicated than reinventing
the wheel</li>
</ol>
<p>Now, because protocol design is no small feat, we will be implementing a very
tiny and toyish protocol. I am by no means a protocol designer, so what we are
going to be working on here is merely an example. But, if you have any
experience with protocols, please do not hesitate to drop me a comment (or a
message) and let me know what I got wrong.</p>
<h2 id="enter-slck" class="relative group">Enter SLCK <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#enter-slck" aria-label="Anchor">#</a></span></h2>
<p>Let us imagine that <a href="https://slack.com">Slack</a>, the omnipresent collaboration
and communication app, wants to turn their chat design into an open internet
protocol. Being an open internet protocol would allow anyone to create a
Slack-compliant server by implementing the SLCK protocol and build their
version of Slack.</p>
<p>In theory, having an open protocol would allow Slack to become distributed,
with people hosting their Slack servers. If people would host their SLCK
servers, the servers will communicate with a cluster (or inter-server)
protocol. With a cluster protocol (between servers) and a client protocol
(between client and server), two SLCK servers will have the ability to
communicate between themselves and with clients.</p>
<p>But, a cluster protocol is not what we will explore here, as it is
significantly more challenging to implement. That&rsquo;s why we will focus only on
the client SLCK protocol.</p>
<p>Now, to make the client SLCK protocol production-ready would be a massive
effort, and it is beyond what an article can cover. But, I believe that it&rsquo;s a
great example through which we can learn more about working with bytes.</p>
<p>Without further ado, let&rsquo;s talk about <code>SLCK</code>.</p>
<h3 id="slck-design" class="relative group">SLCK design <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#slck-design" aria-label="Anchor">#</a></span></h3>
<p>SLCK is a text-based wire protocol, meaning that the data that travels on the
wire is not binary, but just ASCII text. The advantage of text-based protocols
is that a client can practically open a TCP connection to a server that
implements the protocol and talk to it by sending ASCII characters.</p>
<p>Clients can connect to and communicate with a SLCK server through a TCP socket,
using a set of commands and conventions that we will define next.</p>
<h4 id="protocol-conventions" class="relative group">Protocol conventions <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#protocol-conventions" aria-label="Anchor">#</a></span></h4>
<p>SLCK follows a few simple but important conventions:</p>
<ul>
<li>It has <a href="https://en.wikipedia.org/wiki/Type-length-value">TLV (type-length-value)
format</a></li>
<li>It has a control line &amp; a content line</li>
<li>It uses carriage return (<code>\r\n</code>) as delimiter</li>
<li>It contains a fixed list of subjects (tags) representing actions</li>
<li>And as already mentioned, it uses ASCII encoded text on the wire</li>
</ul>
<p>Or, if we put all of these conventions in combination, a SLCK message would
look like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">MSG #general 11\r\nHello World
</code></pre></div><p>So, why an ASCII-encoded text-based wire protocol? Well, the advantage of such
protocols is that once the specification (usually called spec) of the protocol
is public, anyone can write an implementation. Thus, such a protocol can be the
backbone on top of which an ecosystem can be born.</p>
<p>More practically, having a simple protocol makes it easy to work with it. We do
not need fancy clients to talk to a server that implements SLCK. A connection
through <code>telnet</code> would suffice, and the messages sent to the server can be
written by anyone that understands the protocol specification, just by hand.</p>
<h4 id="protocol-commands-subjects-and-options" class="relative group">Protocol commands (subjects and options) <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#protocol-commands-subjects-and-options" aria-label="Anchor">#</a></span></h4>
<p>SLCK has a few different commands:</p>
<table>
<thead>
<tr>
<th style="text-align:left">ID</th>
<th style="text-align:left">Sent by</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>REG</code></td>
<td style="text-align:left">Client</td>
<td style="text-align:left">Register as client</td>
</tr>
<tr>
<td style="text-align:left"><code>JOIN</code></td>
<td style="text-align:left">Client</td>
<td style="text-align:left">Join a channel</td>
</tr>
<tr>
<td style="text-align:left"><code>LEAVE</code></td>
<td style="text-align:left">Client</td>
<td style="text-align:left">Leave a channel</td>
</tr>
<tr>
<td style="text-align:left"><code>MSG</code></td>
<td style="text-align:left">Both</td>
<td style="text-align:left">Send or receive a message to/from entity (channel or user)</td>
</tr>
<tr>
<td style="text-align:left"><code>CHNS</code></td>
<td style="text-align:left">Client</td>
<td style="text-align:left">List available channels</td>
</tr>
<tr>
<td style="text-align:left"><code>USRS</code></td>
<td style="text-align:left">Client</td>
<td style="text-align:left">List users</td>
</tr>
<tr>
<td style="text-align:left"><code>OK</code></td>
<td style="text-align:left">Server</td>
<td style="text-align:left">Command acknowledgement</td>
</tr>
<tr>
<td style="text-align:left"><code>ERR</code></td>
<td style="text-align:left">Server</td>
<td style="text-align:left">Error</td>
</tr>
</tbody>
</table>
<p>Let&rsquo;s explore each of them:</p>
<h4 id="reg" class="relative group">REG <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#reg" aria-label="Anchor">#</a></span></h4>
<p>When a client connects to a server, they can register as a client using the
<code>REG</code> command. It takes an identifier as an argument, which is the client&rsquo;s
username.</p>
<p>Syntax:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">REG &lt;handle&gt;
</code></pre></div><p>where:</p>
<ul>
<li><code>handle</code>: name of the user</li>
</ul>
<h4 id="join" class="relative group">JOIN <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#join" aria-label="Anchor">#</a></span></h4>
<p>When a client connects to a server, they can join a channel using the <code>JOIN</code>
command. It takes an identifier as an argument, which is the channel ID.</p>
<p>Syntax:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">JOIN &lt;channel-id&gt;
</code></pre></div><p>where:</p>
<ul>
<li><code>channel-id</code>: ID of the channel</li>
</ul>
<h4 id="leave" class="relative group">LEAVE <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#leave" aria-label="Anchor">#</a></span></h4>
<p>Once a user has joined a channel, they can leave the channel using the <code>LEAVE</code>
command, with the channel ID as argument.</p>
<p>Syntax:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">LEAVE &lt;channel-id&gt;
</code></pre></div><p>where:</p>
<ul>
<li><code>channel-id</code>: ID of the channel</li>
</ul>
<p><strong>Example 1:</strong> to leave the <code>#general</code> channel, the client can send:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">LEAVE #general
</code></pre></div><h4 id="msg" class="relative group">MSG <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#msg" aria-label="Anchor">#</a></span></h4>
<p>To send a message to a channel or a user, the client can use the <code>MSG</code> command,
with the channel or user identifier as argument, followed with the body length
and the body itself.</p>
<p>Syntax:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">MSG &lt;entity-id&gt; &lt;length&gt;\r\n[payload]
</code></pre></div><p>where:</p>
<ul>
<li><code>entity-id</code>: the ID of the channel or user</li>
<li><code>length</code>: payload length</li>
<li><code>payload</code>: the message body</li>
</ul>
<p><strong>Example 1:</strong> send a <code>Hello everyone!</code> message to the <code>#general</code> channel:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">MSG #general 16\r\nHello everyone!
</code></pre></div><p><strong>Example 2:</strong> send a <code>Hello!</code> message to <code>@jane</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">MSG @jane 4\r\nHey!
</code></pre></div><h4 id="chns" class="relative group">CHNS <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#chns" aria-label="Anchor">#</a></span></h4>
<p>To list all available channels, the client can send the <code>CHNS</code> message. The
server will reply with the list of available channels.</p>
<p>Syntax:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">CHNS
</code></pre></div><h4 id="usrs" class="relative group">USRS <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#usrs" aria-label="Anchor">#</a></span></h4>
<p>To list all users, the client can send the <code>USRS</code> message. The server will
reply with the list of available users.</p>
<p>Syntax:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">USRS
</code></pre></div><h4 id="okerr" class="relative group">OK/ERR <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#okerr" aria-label="Anchor">#</a></span></h4>
<p>When the server receives a command, it can reply with <code>OK</code> or <code>ERR</code>.</p>
<p><code>OK</code> does not have any text after that, think of it as an <code>HTTP 204</code>.</p>
<p><code>ERR &lt;error-message&gt;</code> is the format of the errors returned by the server to the
client. No protocol errors result in the server closing the connection. That
means that although an <code>ERR</code> has been returned, the server is still maintaining
the connection with the client.</p>
<p><strong>Example 1:</strong> Protocol error due to bad username selected during registration:</p>
<pre tabindex="0"><code>ERR Username must begin with @
</code></pre><p><strong>Example 2:</strong> Protocol error due to bad channel ID sent with <code>JOIN</code>:</p>
<pre tabindex="0"><code>ERR Channel ID must begin with #
</code></pre><h2 id="implementing-a-server" class="relative group">Implementing a server <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#implementing-a-server" aria-label="Anchor">#</a></span></h2>
<p>Now that we have the basics of the SLCK protocol in place, we can move on to
the implementation. There are many ways to create the server, but as long as it
implements the SLCK protocol correctly, the clients will not care about what
happens under the hood of the server.</p>
<p>In continuation, I will explain my approach to building the SLCK TCP server,
and while we are on it, we will learn lots about bytes and slices of bytes.</p>
<p>(If you would like to jump ahead, the full code of the SLCK protocol server
implementation can be found in <a href="https://github.com/fteem/go-playground/tree/master/slck-protocol">this
repo</a>.)</p>
<h3 id="server-design" class="relative group">Server design <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#server-design" aria-label="Anchor">#</a></span></h3>
<p>The server design will have four different parts: a client (user), a channel
(chat room), a command (from the client to the server), and a hub - the server
that manages it all.</p>
<p>Let&rsquo;s take it from the most straightforward piece towards the most complicated.</p>
<h3 id="commands" class="relative group">Commands <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#commands" aria-label="Anchor">#</a></span></h3>
<p>Commands are what flows from the clients to the hub. Each received command from
the user, such as <code>REG</code>, <code>MSG</code>, and the others, has to be appropriately parsed,
validated, and handled.</p>
<p>Each command is of type <code>command</code>. The type definition is as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">command</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">id</span>        <span class="nx">ID</span>
	<span class="nx">recipient</span> <span class="kt">string</span>
	<span class="nx">sender</span>    <span class="kt">string</span>
	<span class="nx">body</span>      <span class="p">[]</span><span class="kt">byte</span>
<span class="p">}</span>
</code></pre></div><p>The four attributes of the type, including their explanation:</p>
<ul>
<li><code>id</code> - the identification of the <code>command</code>, which can be one of the protocol
commands.</li>
<li><code>recipient</code> - who/what is the receiver of the command. It can be a <code>@user</code> or
a <code>#channel</code>.</li>
<li><code>sender</code> - the sender of the command, which is the <code>@username</code> of a user.</li>
<li><code>body</code> - the body of the command sent by the sender to the receiver.</li>
</ul>
<p>The flow of <code>command</code>s will be: a <code>client</code> receives the wire-protocol message,
parses it, and turns it in a <code>command</code>, that the <code>client</code> sends to the <code>hub</code>.</p>
<p>Additionally, the <code>command</code> also uses a type <code>ID</code>, which is an <code>int</code> type
alias. We use <code>ID</code> so we can control the valid command types using a constants
and an <code>iota</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ID</span> <span class="kt">int</span>

<span class="kd">const</span> <span class="p">(</span>
	<span class="nx">REG</span> <span class="nx">ID</span> <span class="p">=</span> <span class="kc">iota</span>
	<span class="nx">JOIN</span>
	<span class="nx">LEAVE</span>
	<span class="nx">MSG</span>
	<span class="nx">CHNS</span>
	<span class="nx">USRS</span>
<span class="p">)</span>
</code></pre></div><p>Although the <code>client</code>s have to work with the raw strings that they receive from
the network, internally in the server, we map the wire commands to their
constant counterparts. This way, we establish strict control of all the command
types, enforced by Go&rsquo;s compiler. Using this approach, we assure that the <code>id</code>
will always be a valid command type.</p>
<h3 id="channels" class="relative group">Channels <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#channels" aria-label="Anchor">#</a></span></h3>
<p>Channels in the <code>SLCK</code> protocol lingo are just chat rooms. It&rsquo;s worth
mentioning they have nothing in common with Go channels, except the name.</p>
<p>A <code>channel</code> is just a <code>type</code> with two attributes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">channel</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">name</span>    <span class="kt">string</span>
	<span class="nx">clients</span> <span class="kd">map</span><span class="p">[</span><span class="o">*</span><span class="nx">client</span><span class="p">]</span><span class="kt">bool</span>
<span class="p">}</span>
</code></pre></div><p>The <code>name</code> of the channel is just a <code>string</code> that contains the unique name of
the channel. The <code>clients</code> map is a set of <code>*client</code>s that are part of the
channel at a given time. Having the list of clients available allows us to
easily broadcast messages to all clients in the channel, such as:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">channel</span><span class="p">)</span> <span class="nf">broadcast</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">m</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">msg</span> <span class="o">:=</span> <span class="nb">append</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">s</span><span class="p">),</span> <span class="s">&#34;: &#34;</span><span class="o">...</span><span class="p">)</span>
	<span class="nx">msg</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">m</span><span class="o">...</span><span class="p">)</span>
	<span class="nx">msg</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>

	<span class="k">for</span> <span class="nx">cl</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">clients</span> <span class="p">{</span>
		<span class="nx">cl</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Which brings us to the <code>client</code> itself.</p>
<h3 id="client" class="relative group">Client <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#client" aria-label="Anchor">#</a></span></h3>
<p>A <code>client</code> is a wrapper around the TCP connection. It encapsulates all the
functionality around accepting messages from the TCP connection, parsing the
messages, validating their structure and content, and sending them for further
processing and handling to the <code>hub</code>.</p>
<p>Let&rsquo;s look closer into the <code>client</code> type:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">client</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">conn</span>       <span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span>
	<span class="nx">outbound</span>   <span class="kd">chan</span><span class="o">&lt;-</span> <span class="nx">command</span>
	<span class="nx">register</span>   <span class="kd">chan</span><span class="o">&lt;-</span> <span class="o">*</span><span class="nx">client</span>
	<span class="nx">deregister</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="o">*</span><span class="nx">client</span>
	<span class="nx">username</span>   <span class="kt">string</span>
<span class="p">}</span>
</code></pre></div><p>The four attributes of the <code>client</code> type, in order:</p>
<ul>
<li><code>conn</code> - the TCP connection itself (of type
<a href="https://golang.org/pkg/net/#Conn"><code>net.Conn</code></a>)</li>
<li><code>outbound</code> - a send-only channel of type <code>command</code>. This channel will be the
connection between the <code>client</code> and the <code>hub</code>, through which the <code>client</code>
will send <code>command</code>s to the <code>hub</code></li>
<li><code>register</code> - a send-only channel of type <code>*client</code> through which the client
will let the <code>hub</code> know that it wants to register itself with the <code>hub</code>
(a.k.a. the chat server)</li>
<li><code>deregister</code> - a send-only channel of type <code>*client</code> through which the client
will let the <code>hub</code> know that the user has closed the socket, so the <code>hub</code>
should deregister the client (by removing it from the clients <code>map</code> and from
all channels)</li>
<li><code>username</code> - the username of the user (of type <code>string</code>) that is sitting
behind the TCP connection</li>
</ul>
<p>If this is a bit confusing, worry not. It will get more evident once you see
the whole thing in action.</p>
<p>Now, let&rsquo;s move on to the <code>client</code>&rsquo;s methods. Once we intantiate a <code>client</code>, it
can listen for incoming messages over the TCP connection. To do that, the
<code>client</code> has a method called <code>read</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">client</span><span class="p">)</span> <span class="nf">read</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">conn</span><span class="p">).</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
			<span class="c1">// Connection closed, deregister client
</span><span class="c1"></span>			<span class="nx">c</span><span class="p">.</span><span class="nx">deregister</span> <span class="o">&lt;-</span> <span class="nx">c</span>
			<span class="k">return</span> <span class="kc">nil</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>

		<span class="nx">c</span><span class="p">.</span><span class="nf">handle</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p><code>read</code> loops endlessly using a <code>for</code> loop, and accepts incoming messages from
the <code>conn</code> attribute (the TCP connection). Once the message (<code>msg</code>) is
received, it will pass it on to the <code>handle</code> method, which will process it.</p>
<p>In case the <code>err</code> returned is <code>io.EOF</code>, meaning the user can closed the
connection, the <code>client</code> will send notify the <code>hub</code> through the <code>deregister</code>
channel. The <code>hub</code> will remove the deregistered client from the <code>clients</code> map
and from all of the channels that the <code>client</code> participated in.</p>
<h3 id="handling-bytes-in-handle-using-the-bytes-package" class="relative group">Handling bytes in <code>handle</code> using the <code>bytes</code> package <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#handling-bytes-in-handle-using-the-bytes-package" aria-label="Anchor">#</a></span></h3>
<p>Because of the protocol definition, we know the structure of the commands that
the chat server might receive from the user. That&rsquo;s what the <code>client</code>&rsquo;s
<code>handle</code> method does - it get the raw messages from the socket and parses the
bytes to make meaning out of them.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">client</span><span class="p">)</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">message</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">ToUpper</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34; &#34;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]))</span>
	<span class="nx">args</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">TrimPrefix</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">))</span>

	<span class="k">switch</span> <span class="nb">string</span><span class="p">(</span><span class="nx">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="s">&#34;REG&#34;</span><span class="p">:</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">reg</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">err</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="s">&#34;JOIN&#34;</span><span class="p">:</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">err</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="s">&#34;LEAVE&#34;</span><span class="p">:</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">leave</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">err</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="s">&#34;MSG&#34;</span><span class="p">:</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">msg</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">err</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="s">&#34;CHNS&#34;</span><span class="p">:</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">chns</span><span class="p">()</span>
	<span class="k">case</span> <span class="s">&#34;USRS&#34;</span><span class="p">:</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">usrs</span><span class="p">()</span>
	<span class="k">default</span><span class="p">:</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">err</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Unknown command %s&#34;</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">))</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Handling messages is where we get to see the slice of bytes (<code>[]byte</code>) type in
action. So, what happens here? Let&rsquo;s break it down.</p>
<p>Given that our SLCK protocol is a text-based wire protocol, the bytes that are
flowing on the TCP connection are, in fact, plain ASCII text. Each byte (or
octet, because a byte is eight bits) in the decimal number system has a value
between 0 and 255 (2 to the power of 8). That means that each of the octets can
contain any of the characters in the extended ASCII encoding.  (Refer to <a href="https://www.asciitable.com/">this
ASCII table</a> to see all of the available
characters.)</p>
<p>Having a text-based protocol allows us to easily convert each of the bytes that
arrive through the TCP connection into a meaningful text. That&rsquo;s why each
<code>byte</code> in the <code>[]byte</code> slice represents one character. Because each byte in the
slice <code>[]byte</code> is a character, converting a <code>[]byte</code> in a string is as easy as:
<code>s := string(slice)</code>.</p>
<p>And Go is good at handling bytes. For example, it has a
<a href="https://golang.org/pkg/bytes/">bytes</a> package which lets us work with
<code>[]byte</code>, instead of converting them into <code>string</code>s every time we want to work
with bytes.</p>
<p>Given that all SLCK commands begin with a single word separated with space
after it, we can simply take the first word from the <code>[]byte</code>, upcase it and
compare it with the valid keywords of the protocol. &ldquo;But, how are we supposed
to take a word from a slice of bytes?&rdquo; you might ask. Since bytes are not
words, we have to resort to either compare them byte-by-byte or use the
built-in <code>bytes</code> package. To keep things simple, we will use the <code>bytes</code>
package. (You can check <a href="https://play.golang.org/p/DSxiMiiDwta">this snippet</a>
to compare the two approaches.)</p>
<p>In the first line of the <code>handle</code>, method we take the first part of the
received message, and we upcase it. Then, on the second line, we remove the
first part from the rest of the message. The split allows us to have the
command (<code>cmd</code>) and the rest of the command arguments (<code>args</code>) in separate
variables.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">ToUpper</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34; &#34;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nx">args</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">TrimPrefix</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">))</span>
</code></pre></div><p>After that, in the <code>switch</code> construct, we handle all of the different commands.
For example, handling the <code>REG</code> command is done using the <code>reg</code>, and the <code>err</code>
methods:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">client</span><span class="p">)</span> <span class="nf">reg</span><span class="p">(</span><span class="nx">args</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">u</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;@&#39;</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Username must begin with @&#34;</span><span class="p">)</span>
	<span class="p">}</span>
   	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">u</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
	     	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Username cannot be blank&#34;</span><span class="p">)</span>
   	<span class="p">}</span>

	<span class="nx">c</span><span class="p">.</span><span class="nx">username</span> <span class="p">=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">u</span><span class="p">)</span> <span class="nx">c</span><span class="p">.</span><span class="nx">register</span> <span class="o">&lt;-</span> <span class="nx">c</span>

	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>The <code>reg</code> method takes the <code>args</code> slice, and it removes any space bytes (using
<code>bytes.TrimSpace</code>). Given that the second argument of the <code>REG</code> command is the
<code>@username</code> of the user, it checks if the passed username begins with <code>@</code> and
if it&rsquo;s blank. Once it does that, it converts the username to a string, and it
assigns it to the client (<code>c</code>) itself. From then on, the client has an assigned
username.</p>
<p>As a second step, it sends the client itself through the <code>register</code> channel.
This channel is read by the <code>hub</code> (the chat server), which will do more
validation of the username before it successfully registers the client.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">client</span><span class="p">)</span> <span class="nf">err</span><span class="p">(</span><span class="nx">e</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">c</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;ERR &#34;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Error</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;\n&#34;</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div><p>The <code>err</code> func simply takes an error and sends its contents back to the user,
using the underlying TCP connection of the client.</p>
<p>We will come back to the other commands and methods once we have thoroughly
explored the chat server.</p>
<h3 id="the-hub" class="relative group">The hub <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#the-hub" aria-label="Anchor">#</a></span></h3>
<p>The <code>hub</code> is the central entity that the clients connect and register with.
The <code>hub</code> also manages the available channels (chat rooms), broadcasting
messages to said channels, and relaying messages (private/direct messages)
between clients.</p>
<p>All of the above functionality means that the <code>hub</code> is the central place of all
communications, hence the name.</p>
<p>First, let&rsquo;s explore the <code>hub</code> type with all of its attributes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">hub</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">channels</span>        <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">channel</span>
	<span class="nx">clients</span>         <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">client</span>
	<span class="nx">commands</span>        <span class="kd">chan</span> <span class="nx">command</span>
	<span class="nx">deregistrations</span> <span class="kd">chan</span> <span class="o">*</span><span class="nx">client</span>
	<span class="nx">registrations</span>   <span class="kd">chan</span> <span class="o">*</span><span class="nx">client</span>
<span class="p">}</span>
</code></pre></div><p>The attributes, and their explanations, in order:</p>
<ul>
<li><code>channels</code> - a <code>map</code> of the channels (chat rooms), with the name of the
channel as the key and the <code>*channel</code> as value</li>
<li><code>clients</code> - a <code>map</code> of the clients (connected users), with the username as
the key and the <code>*client</code> as value</li>
<li><code>commands</code> - a channel of <code>command</code> that are flowing from the clients to the
<code>hub</code>, that the <code>hub</code> will validate and execute</li>
<li><code>deregistrations</code> - a channel of <code>*client</code> through which a client deregisters
itself, through which the <code>hub</code> will be informed that the user has closed the
connection and it will clean up any references to that <code>client</code></li>
<li><code>registrations</code> - a channel of <code>*client</code> through which new clients register
themselves to the <code>hub</code>, through which the <code>hub</code> will accept the new client,
validate their <code>username</code> and add them to the <code>clients</code> map</li>
</ul>
<p>So, how does the <code>hub</code> function? It all begins with the <code>run</code> method:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">hub</span><span class="p">)</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">client</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">h</span><span class="p">.</span><span class="nx">registrations</span><span class="p">:</span>
			<span class="nx">h</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span>
		<span class="k">case</span> <span class="nx">client</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">h</span><span class="p">.</span><span class="nx">deregistrations</span><span class="p">:</span>
			<span class="nx">h</span><span class="p">.</span><span class="nf">unregister</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span>
		<span class="k">case</span> <span class="nx">cmd</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">h</span><span class="p">.</span><span class="nx">commands</span><span class="p">:</span>
			<span class="k">switch</span> <span class="nx">cmd</span><span class="p">.</span><span class="nx">id</span> <span class="p">{</span>
			<span class="k">case</span> <span class="nx">JOIN</span><span class="p">:</span>
				<span class="nx">h</span><span class="p">.</span><span class="nf">joinChannel</span><span class="p">(</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">.</span><span class="nx">recipient</span><span class="p">)</span>
			<span class="k">case</span> <span class="nx">LEAVE</span><span class="p">:</span>
				<span class="nx">h</span><span class="p">.</span><span class="nf">leaveChannel</span><span class="p">(</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">.</span><span class="nx">recipient</span><span class="p">)</span>
			<span class="k">case</span> <span class="nx">MSG</span><span class="p">:</span>
				<span class="nx">h</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">.</span><span class="nx">recipient</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
			<span class="k">case</span> <span class="nx">USRS</span><span class="p">:</span>
				<span class="nx">h</span><span class="p">.</span><span class="nf">listUsers</span><span class="p">(</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">sender</span><span class="p">)</span>
			<span class="k">case</span> <span class="nx">CHNS</span><span class="p">:</span>
				<span class="nx">h</span><span class="p">.</span><span class="nf">listChannels</span><span class="p">(</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">sender</span><span class="p">)</span>
			<span class="k">default</span><span class="p">:</span>
				<span class="c1">// Freak out?
</span><span class="c1"></span>			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>When we establish a new <code>hub</code> instance (which we will see later), we execute
the <code>run</code> method in a goroutine. The goroutine will run the <code>for</code> loop
indefinitely, processing the <code>registrations</code>, <code>deregistrations</code>, and the
<code>commands</code> channels. Messages arriving through the <code>registrations</code> and
<code>deregistrations</code> channels will be handled differently from the messages that
will come from the <code>commands</code> channel.</p>
<p><code>run</code> will receive messages through the <code>registrations</code> channel, and it will
send them to the <code>register</code> method for processing:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">hub</span><span class="p">)</span> <span class="nf">register</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">exists</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">username</span><span class="p">];</span> <span class="nx">exists</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nx">username</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
		<span class="nx">c</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;ERR username taken\n&#34;</span><span class="p">))</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">h</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">username</span><span class="p">]</span> <span class="p">=</span> <span class="nx">c</span>
		<span class="nx">c</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;OK\n&#34;</span><span class="p">))</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>The <code>register</code> method will check if the <code>hub</code> already has a user with the given
username, and it will react accordingly. If the username is taken, it will
remove the username from the <code>client</code> and respond with an error. If the
username is not taken, then it will add the <code>client</code> to the <code>clients</code> map, with
the username as a key and the <code>client</code> reference as a value.</p>
<p><code>run</code> will receive messages through the <code>deregistrations</code> channel, and it will
send them to the <code>deregister</code> method for processing:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">hub</span><span class="p">)</span> <span class="nf">deregister</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">exists</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">username</span><span class="p">];</span> <span class="nx">exists</span> <span class="p">{</span>
                <span class="nb">delete</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">clients</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">username</span><span class="p">)</span>

		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">channel</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">h</span><span class="p">.</span><span class="nx">channels</span> <span class="p">{</span>
			<span class="nb">delete</span><span class="p">(</span><span class="nx">channel</span><span class="p">.</span><span class="nx">clients</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>The <code>deregister</code> method will check if the <code>hub</code> already has a user with the
given username. If it finds the user, it will remove it from the <code>hub</code>&rsquo;s
<code>clients</code> map. Also, it will go through the map of <code>channels</code> and it will try
to remove it from each of the <code>channel</code>&rsquo;s <code>clients</code> map.</p>
<p>When it comes to handling commands, things are more different. Each of the
<code>command</code>s, as we already established, has an <code>id</code> attribute. For each of the
<code>command</code>s that we receive, we do a switch on the <code>id</code> attribute, which will
invoke a different method. For example, to join a channel, the <code>id</code> must be of
value <code>JOIN</code>, which will invoke the <code>joinChannel</code> function, with the
<code>command</code>&rsquo;s <code>sender</code> and <code>recipient</code> attributes.</p>
<p>The <code>joinChannel</code> function receives the username (<code>u</code>) and the channel (<code>c</code>) as
arguments. Then, if it finds the channel, it will add the <code>client</code> to the
channel&rsquo;s <code>clients</code> map. Otherwise, it will first create the channel, using the
<code>newChannel</code> constructor, and then add the <code>client</code> as the first client to the
<code>channel</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">hub</span><span class="p">)</span> <span class="nf">joinChannel</span><span class="p">(</span><span class="nx">u</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">c</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">u</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="nx">c</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
			<span class="c1">// Channel exists, join
</span><span class="c1"></span>			<span class="nx">channel</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">client</span><span class="p">]</span> <span class="p">=</span> <span class="kc">true</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="c1">// Channel doesn&#39;t exists, create and join
</span><span class="c1"></span>			<span class="nx">h</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="nx">c</span><span class="p">]</span> <span class="p">=</span> <span class="nf">newChannel</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
			<span class="nx">h</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="nx">c</span><span class="p">].</span><span class="nx">clients</span><span class="p">[</span><span class="nx">client</span><span class="p">]</span> <span class="p">=</span> <span class="kc">true</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Now, let&rsquo;s zoom out and see how a <code>client</code> wraps a TCP connection. Then, we
will see how bytes are flowing from the user, through the <code>client</code>, to the
<code>hub</code> ending up with the receiver (another channel or user).</p>
<h3 id="sending-messages" class="relative group">Sending messages <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#sending-messages" aria-label="Anchor">#</a></span></h3>
<p>The core functionality to a chat server and the purpose of our SLCK protocol
is sending and receiving messages. Let&rsquo;s follow the flow of the bytes and see
how we can implement sending messages between clients.</p>
<p>The structure of the <code>MSG</code> command is as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">MSG &lt;entity-id&gt; &lt;length&gt;\r\n[payload]
</code></pre></div><p>For example, to send a <code>Hello!</code> message to the <code>#general</code> channel:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">MSG #general 6\r\nHello!
</code></pre></div><p>Or, to send a <code>Hey!</code> message to <code>@jane</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">MSG @jane 4\r\nHey!
</code></pre></div><p>Once the user sends the <code>MSG</code> command, the <code>client</code>&rsquo;s <code>handle</code> method accepts
it. Then, in <code>handle</code> we extract the message and the command, and we invoke the
<code>msg</code> method of the <code>client</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">client</span><span class="p">)</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">message</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">ToUpper</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34; &#34;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]))</span>
	<span class="nx">args</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">TrimPrefix</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">))</span>

	<span class="k">switch</span> <span class="nb">string</span><span class="p">(</span><span class="nx">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// Some other stuff here...
</span><span class="c1"></span>	<span class="k">case</span> <span class="s">&#34;MSG&#34;</span><span class="p">:</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">msg</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">err</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="c1">// Some other stuff here...
</span><span class="c1"></span>	<span class="k">default</span><span class="p">:</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">err</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Unknown command %s&#34;</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">))</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>The <code>args</code> are passed to the <code>msg</code> method, which does some heavy lifting.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">client</span><span class="p">)</span> <span class="nf">msg</span><span class="p">(</span><span class="nx">args</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">args</span> <span class="p">=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;#&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;@&#39;</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;recipient must be a channel (&#39;#name&#39;) or user (&#39;@user&#39;)&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">recipient</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34; &#34;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">recipient</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;recipient must have a name&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// More stuff here...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>The <code>msg</code> method&rsquo;s first step is to check if the first argument of the message
begins with a <code>@</code> or <code>#</code> ‚Äì a user or a channel name. If that&rsquo;s correct, we
extract the <code>recipient</code>, which can be the username or the channel name.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">client</span><span class="p">)</span> <span class="nf">msg</span><span class="p">(</span><span class="nx">args</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="c1">// The stuff from above here...
</span><span class="c1"></span>
	<span class="nx">args</span> <span class="p">=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">TrimPrefix</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">recipient</span><span class="p">))</span>
	<span class="nx">l</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">DELIMITER</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
	<span class="nx">length</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Atoi</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">l</span><span class="p">))</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;body length must be present&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;body length must be at least 1&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">padding</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="nx">DELIMITER</span><span class="p">)</span> <span class="c1">// Size of the body length + the delimiter
</span><span class="c1"></span>	<span class="nx">body</span> <span class="o">:=</span> <span class="nx">args</span><span class="p">[</span><span class="nx">padding</span> <span class="p">:</span> <span class="nx">padding</span><span class="o">+</span><span class="nx">length</span><span class="p">]</span>

	<span class="nx">c</span><span class="p">.</span><span class="nx">outbound</span> <span class="o">&lt;-</span> <span class="nx">command</span><span class="p">{</span>
		<span class="nx">recipient</span><span class="p">:</span> <span class="nb">string</span><span class="p">(</span><span class="nx">recipient</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
		<span class="nx">sender</span><span class="p">:</span>    <span class="nx">c</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
		<span class="nx">body</span><span class="p">:</span>      <span class="nx">body</span><span class="p">,</span>
		<span class="nx">id</span><span class="p">:</span>        <span class="s">&#34;MSG&#34;</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>We extract the next argument after, which, according to the protocol
specification, is the length of the body in bytes. Having the size of the body
(the length of the bytes) as part of the command that is sent by the client
allows the server to slice off the bytes it needs from the body efficiently.</p>
<p>Let&rsquo;s see an example:</p>
<pre tabindex="0"><code>MSG #general 39\r\nHey folks, hope you are all doing well!
</code></pre><p>In the <code>handle</code> method, we sliced off <code>MSG</code>, and we send the rest of the bytes
to the <code>msg</code> method. In <code>msg</code>, we checked if the next argument is a channel or
a username ‚Äì which is correct. Then, we pick up the <code>39</code>, and we store them in
the <code>l</code> variable.</p>
<p>Having <code>l</code> being <code>39</code> is not enough ‚Äì the slice of bytes that represent the
ASCII <code>39</code> is <code>[51 57]</code>. The <code>51</code> and <code>57</code> bytes just mean that the two octets
representing <code>3</code> and <code>9</code> in ASCII, have byte representation as <code>51</code> and <code>57</code>.
To make our Go code understand <code>[51 57]</code> like <code>39</code>, we have to convert them
into a <code>string</code>, so they become <code>&quot;39&quot;</code> and then use the <code>strconv</code> package to
convert the <code>string</code> to an <code>int</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">l</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">DELIMITER</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nx">length</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Atoi</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">l</span><span class="p">))</span>
</code></pre></div><p>Once we have the <code>length</code> of the body, we validate that it will be at least one
byte. Next, we take the remaining bytes from the <code>args</code>, and we slice off the
<code>length</code> amount of bytes from the <code>args</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">padding</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="nx">DELIMITER</span><span class="p">)</span> <span class="c1">// Size of the body length + the delimiter
</span><span class="c1"></span><span class="nx">body</span> <span class="o">:=</span> <span class="nx">args</span><span class="p">[</span><span class="nx">padding</span> <span class="p">:</span> <span class="nx">padding</span><span class="o">+</span><span class="nx">length</span><span class="p">]</span>
</code></pre></div><p>In context of our example above:</p>
<pre tabindex="0"><code>MSG #general 39\r\nHey folks, hope you are all doing well!
</code></pre><p>we take the length (2) of the <code>39</code> plus the length of the <code>\r\n</code> delimiter and
then take the body out of the <code>args</code> slice of bytes by using the &ldquo;slice&rdquo;
operator (<code>:</code>). The slicing operation results in slicing all of the bytes
between <code>\n</code> to the end of the body, meaning the <code>body</code> becomes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">Hey folks, hope you are all doing well!
</code></pre></div><p>If the <code>length</code> were less then <code>39</code>, then the <code>body</code> would end up being
shorter, because the user has sent the wrong body size to the server.
Conversely, if we tried to slice off more than the size of the <code>body</code>, then the
goroutine serving the <code>hub</code> would crash, rendering our server useless.</p>
<p>Given that <code>body</code> now contains the message itself, the last step of the <code>msg</code>
method is to send the new command it received through the <code>outbound</code> channel to
the <code>hub</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">c</span><span class="p">.</span><span class="nx">outbound</span> <span class="o">&lt;-</span> <span class="nx">command</span><span class="p">{</span>
        <span class="nx">recipient</span><span class="p">:</span> <span class="nb">string</span><span class="p">(</span><span class="nx">recipient</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
        <span class="nx">sender</span><span class="p">:</span>    <span class="nx">c</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
        <span class="nx">body</span><span class="p">:</span>      <span class="nx">body</span><span class="p">,</span>
        <span class="nx">id</span><span class="p">:</span>        <span class="nx">MSG</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div><p>The <code>command</code> has a <code>recipient</code> (channel or user ID), the <code>sender</code>, which is
the username of the message author, the <code>body</code> containing the <code>body</code> of the
message, and the <code>id</code> that&rsquo;s the identifier of the <code>command</code> - <code>MSG</code> in this
case.</p>
<p>Then, the <code>hub</code> which infinitely loops and reads from the <code>commands</code> channel
(which is the same channel as the <code>outbound</code> channel of the <code>client</code>), will
pick up the message from the <code>client</code> and process it in the <code>message</code> method:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">hub</span><span class="p">)</span> <span class="nf">message</span><span class="p">(</span><span class="nx">u</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">r</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">m</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">sender</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">u</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="nx">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;#&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="nx">r</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
				<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">sender</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
					<span class="nx">channel</span><span class="p">.</span><span class="nf">broadcast</span><span class="p">(</span><span class="nx">sender</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="sc">&#39;@&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">r</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
				<span class="nx">user</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nb">append</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>The <code>message</code> method will check if the sender username (<code>u</code>) is present in the
list of active clients (<code>h.clients</code>). If the client is active, then it will
check if the first byte of the message (<code>m</code>) is a <code>#</code> or a <code>@</code>. Based on the
result of the <code>switch</code>, either it will broadcast the message (<code>m</code>) to the
channel, or it will find the recipient (<code>r</code>) from the <code>h.clients</code> list and send
the message through the recipient&rsquo;s TCP connection.</p>
<p>Let&rsquo;s see this in action. I will start the server (using <code>go run .</code>) and open
two <code>telnet</code> sessions with the server:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ telnet 127.0.0.1 <span class="m">8081</span>
Trying 127.0.0.1...
Connected to localhost.
Escape character is <span class="s1">&#39;^]&#39;</span>.
</code></pre></div><p>Given that SCLK is a ASCII wire protocol, it means we can just send some
commands to the server right away. Let&rsquo;s first register both clients. The first
one will be <code>@jane</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">REG @jane
OK
</code></pre></div><p>And the second client will be <code>@john</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">REG @john
OK
</code></pre></div><p>In both cases the registration with the server went well, so the server replied
with <code>OK</code>. Now, let&rsquo;s make both of the clients join the <code>#general</code> channel. If
any of the users listed the channels they would get an error:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">CHNS
ERR no channels found
</code></pre></div><p>Great, let&rsquo;s make them both join <code>#general</code>, so the channel would be created.
First <code>@john</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">JOIN <span class="c1">#general</span>
OK
</code></pre></div><p><code>@jane</code> righ after:</p>
<pre tabindex="0"><code>CHNS
#general

JOIN #general
OK
</code></pre><p>Now that both are in the channel, we can also send a message from <code>@jane</code> to
<code>#general</code>, and it should pop up on <code>@john</code>&rsquo;s screen too.</p>
<p>Sending the message:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">MSG <span class="c1">#general 5\r\nHello</span>
</code></pre></div><p>And in <code>@john</code>&rsquo;s screen we can see:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">jane: Hello
</code></pre></div><p>Voil√°! <code>@john</code> received the message. Let&rsquo;s say <code>@john</code> would like to send
<code>@jane</code> a direct message. He sends:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">MSG @jane 3<span class="se">\r\n</span>Hey
</code></pre></div><p>And on <code>@jane</code>&rsquo;s screen she will see:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">@john: Hey
</code></pre></div><h2 id="tying-it-all-together" class="relative group">Tying it all together <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#tying-it-all-together" aria-label="Anchor">#</a></span></h2>
<p>Now that we went through the <code>client</code>, <code>hub</code>, <code>channel</code>, and <code>command</code>, we need
to see the last piece of the puzzle - the <code>main</code> function that ties it all
together.</p>
<p>In the <code>main</code> func, we will initialize a TCP listener, through which we can
accept a new TCP connection. Then, we will establish a new <code>hub</code> and invoke
<code>run</code> in a separate goroutine.</p>
<p>Once the <code>hub</code> is running, we will infinitely loop using a <code>for</code>. Within the
<code>for</code> loop, we will accept new TCP connections, wrap them in a new <code>client</code> and
spin them off in a new goroutine.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;log&#34;</span>
	<span class="s">&#34;net&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span> <span class="nx">ln</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="s">&#34;:8081&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">hub</span> <span class="o">:=</span> <span class="nf">newHub</span><span class="p">()</span>
	<span class="k">go</span> <span class="nx">hub</span><span class="p">.</span><span class="nf">run</span><span class="p">()</span>

	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ln</span><span class="p">.</span><span class="nf">Accept</span><span class="p">()</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>

		<span class="nx">c</span> <span class="o">:=</span> <span class="nf">newClient</span><span class="p">(</span>
			<span class="nx">conn</span><span class="p">,</span>
			<span class="nx">hub</span><span class="p">.</span><span class="nx">commands</span><span class="p">,</span>
			<span class="nx">hub</span><span class="p">.</span><span class="nx">registrations</span><span class="p">,</span>
			<span class="nx">hub</span><span class="p">.</span><span class="nx">deregistrations</span><span class="p">,</span>
		<span class="p">)</span>
		<span class="k">go</span> <span class="nx">c</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>As a refresher, within the <code>read</code> function of the <code>client</code>, we also infinitely
loop using a <code>for</code> and accept new incoming TCP messages:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">client</span><span class="p">)</span> <span class="nf">read</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">conn</span><span class="p">).</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
			<span class="c1">// Connection closed, deregister client
</span><span class="c1"></span>			<span class="nx">c</span><span class="p">.</span><span class="nx">deregister</span> <span class="o">&lt;-</span> <span class="nx">c</span>
			<span class="k">return</span> <span class="kc">nil</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>

		<span class="nx">c</span><span class="p">.</span><span class="nf">handle</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>Having the <code>client</code>&rsquo;s <code>read</code> method being run a separate goroutine allows us to
spin off as many goroutines as we have connections. That leaves our main thread
to accept new connections and just spin the off into goroutines. Once the
goroutine is running, it will take care of itself until it crashes or the
client exits.</p>
<p>The pitfall of this approach is that we have a single <code>hub</code> instance, which
means that there&rsquo;s only one goroutine that is accepting messages from what can
be thousands of clients. While having a single <code>hub</code> instance simplifies the
design, it also introduces a single point of failure. If the <code>hub.run</code>
goroutine crashes/exits for whatever reason, the server will be rendered
useless, although all of the client connections will be working fine.</p>
<p>The full code of the SLCK protocol server implementation can be found in <a href="https://github.com/fteem/go-playground/tree/master/slck-protocol">this
repo</a>.</p>
<h2 id="notable-shortcuts" class="relative group">Notable shortcuts <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#notable-shortcuts" aria-label="Anchor">#</a></span></h2>
<p>Before we wrap up here, I would like to highlight a few of the shortcuts we
took while building this server implementation. Cutting these corners was with
a purpose - not making this long article even longer.</p>
<p>First, we are missing resource locking when creating the channels or when a
user joins/leaves a channel. If multiple people would join the same channel at
the same time, it is possible to get a concurrent writes issue.</p>
<p>Second, our server does not have a graceful shutdown. A production-ready
implementation would gracefully shut down all of the connections, informing the
clients about the shutdown. Then, it would potentially save some state on disk
before shutting down.</p>
<p>Another shortcut we took was validation of the body size in the <code>msg</code> method.
When we are performing the slicing of the message body, we do not take into
consideration if there are enough bytes in the message. If a client sends a
body size larger then the body itself, we might slice off more bytes than
available, which would result in a <code>panic</code> and a slice out of bounds error.</p>
<p>If you would like to play more with our chat server, I recommend starting with
adding each of these missing functionalities to it. And drop me the link to the
repo in the comments, so I can see how you pulled it off.</p>
<hr>
<p>Changelog:</p>
<ul>
<li>2020-04-04 10:10UTC - Fixed the <code>client</code> type definition, which was
missing the <code>deregister</code> channel, as pointed out by Rene C. over email.</li>
</ul>
<div id="revue-embed">
  <form action="https://www.getrevue.co/profile/itsilija/add_subscriber" method="post" id="revue-form" name="revue-form"  target="_blank">
    <p><b>Liked this article?</b>
Subscribe to my newsletter and get future articles in your inbox. It's a
short and sweet read, going out to hundreds of other engineers.</p>
    <div class="revue-form-group">
      <input class="revue-form-field" placeholder="Your email address..." type="email" name="member[email]" id="member_email">
    </div>
    <div class="revue-form-actions">
      <input type="submit" value="Subscribe" name="member[subscribe]" id="member_submit">
    </div>
  </form>
</div>


      </div>
    </section>
    <footer class="pt-8 max-w-prose">
      
  <div class="flex">
    
      
      
        
        <img
          class="w-24 h-24 !mt-0 !mb-0 ltr:mr-4 rtl:ml-4 rounded-full"
          width="96"
          height="96"
          alt="Author"
          src="/img/avatar_huae39953c6189b6aa60e47103b358d088_112612_192x192_fill_q75_box_smart1.jpg"
        />
      
    
    <div class="place-self-center">
      
        <div class="text-[0.6rem] leading-3 text-neutral-500 dark:text-neutral-400 uppercase">
          Author
        </div>
        <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
          Ilija Eftimov
        </div>
      
      
      <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://twitter.com/efilija"
          target="_blank"
          aria-label="Twitter"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" class="svg-inline--fa fa-twitter fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg>
  </span>

</a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://www.linkedin.com/in/ieftimov/"
          target="_blank"
          aria-label="Linkedin"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg>
  </span>

</a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="mailto:blog@ieftimov.com"
          target="_blank"
          aria-label="Email"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="at" class="svg-inline--fa fa-at fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 8C118.941 8 8 118.919 8 256c0 137.059 110.919 248 248 248 48.154 0 95.342-14.14 135.408-40.223 12.005-7.815 14.625-24.288 5.552-35.372l-10.177-12.433c-7.671-9.371-21.179-11.667-31.373-5.129C325.92 429.757 291.314 440 256 440c-101.458 0-184-82.542-184-184S154.542 72 256 72c100.139 0 184 57.619 184 160 0 38.786-21.093 79.742-58.17 83.693-17.349-.454-16.91-12.857-13.476-30.024l23.433-121.11C394.653 149.75 383.308 136 368.225 136h-44.981a13.518 13.518 0 0 0-13.432 11.993l-.01.092c-14.697-17.901-40.448-21.775-59.971-21.775-74.58 0-137.831 62.234-137.831 151.46 0 65.303 36.785 105.87 96 105.87 26.984 0 57.369-15.637 74.991-38.333 9.522 34.104 40.613 34.103 70.71 34.103C462.609 379.41 504 307.798 504 232 504 95.653 394.023 8 256 8zm-21.68 304.43c-22.249 0-36.07-15.623-36.07-40.771 0-44.993 30.779-72.729 58.63-72.729 22.292 0 35.601 15.241 35.601 40.77 0 45.061-33.875 72.73-58.161 72.73z"></path></svg>
  </span>

</a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://dev.to/fteem"
          target="_blank"
          aria-label="Dev"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="dev" class="svg-inline--fa fa-dev fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M120.12 208.29c-3.88-2.9-7.77-4.35-11.65-4.35H91.03v104.47h17.45c3.88 0 7.77-1.45 11.65-4.35 3.88-2.9 5.82-7.25 5.82-13.06v-69.65c-.01-5.8-1.96-10.16-5.83-13.06zM404.1 32H43.9C19.7 32 .06 51.59 0 75.8v360.4C.06 460.41 19.7 480 43.9 480h360.2c24.21 0 43.84-19.59 43.9-43.8V75.8c-.06-24.21-19.7-43.8-43.9-43.8zM154.2 291.19c0 18.81-11.61 47.31-48.36 47.25h-46.4V172.98h47.38c35.44 0 47.36 28.46 47.37 47.28l.01 70.93zm100.68-88.66H201.6v38.42h32.57v29.57H201.6v38.41h53.29v29.57h-62.18c-11.16.29-20.44-8.53-20.72-19.69V193.7c-.27-11.15 8.56-20.41 19.71-20.69h63.19l-.01 29.52zm103.64 115.29c-13.2 30.75-36.85 24.63-47.44 0l-38.53-144.8h32.57l29.71 113.72 29.57-113.72h32.58l-38.46 144.8z"></path></svg>
  </span>

</a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/fteem"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
  </span>

</a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://t.me/ieftimovcom"
          target="_blank"
          aria-label="Telegram"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="telegram-plane" class="svg-inline--fa fa-telegram-plane fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M446.7 98.6l-67.6 318.8c-5.1 22.5-18.4 28.1-37.3 17.5l-103-75.9-49.7 47.8c-5.5 5.5-10.1 10.1-20.7 10.1l7.4-104.9 190.9-172.5c8.3-7.4-1.8-11.5-12.9-4.1L117.8 284 16.2 252.2c-22.1-6.9-22.5-22.1 4.6-32.7L418.2 66.4c18.4-6.9 34.5 4.1 28.5 32.2z"></path></svg>
  </span>

</a
        >
      
    
  </div>

</div>
    </div>
  </div>


      
  
  <section class="flex flex-row flex-wrap justify-center pt-4 text-xl">
    
      
        <a
          class="bg-neutral-300 text-neutral-700 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800 m-1 hover:bg-primary-500 hover:text-neutral rounded min-w-[2.4rem] inline-block text-center p-1"
          href="https://www.facebook.com/sharer/sharer.php?u=https://ieftimov.com/posts/understanding-bytes-golang-build-tcp-protocol/&amp;quote=Understanding%20bytes%20in%20Go%20by%20building%20a%20TCP%20protocol"
          title="Share on Facebook"
          aria-label="Share on Facebook"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="facebook" class="svg-inline--fa fa-facebook fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"></path></svg>
  </span>

</a
        >
      
    
      
        <a
          class="bg-neutral-300 text-neutral-700 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800 m-1 hover:bg-primary-500 hover:text-neutral rounded min-w-[2.4rem] inline-block text-center p-1"
          href="https://twitter.com/intent/tweet/?url=https://ieftimov.com/posts/understanding-bytes-golang-build-tcp-protocol/&amp;text=Understanding%20bytes%20in%20Go%20by%20building%20a%20TCP%20protocol"
          title="Tweet on Twitter"
          aria-label="Tweet on Twitter"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" class="svg-inline--fa fa-twitter fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg>
  </span>

</a
        >
      
    
      
        <a
          class="bg-neutral-300 text-neutral-700 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800 m-1 hover:bg-primary-500 hover:text-neutral rounded min-w-[2.4rem] inline-block text-center p-1"
          href="https://reddit.com/submit/?url=https://ieftimov.com/posts/understanding-bytes-golang-build-tcp-protocol/&amp;resubmit=true&amp;title=Understanding%20bytes%20in%20Go%20by%20building%20a%20TCP%20protocol"
          title="Submit to Reddit"
          aria-label="Submit to Reddit"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="reddit" class="svg-inline--fa fa-reddit fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M201.5 305.5c-13.8 0-24.9-11.1-24.9-24.6 0-13.8 11.1-24.9 24.9-24.9 13.6 0 24.6 11.1 24.6 24.9 0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4 0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8 0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7 0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9 0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5 0 52.6 59.2 95.2 132 95.2 73.1 0 132.3-42.6 132.3-95.2 0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6 0-2.2-2.2-6.1-2.2-8.3 0-2.5 2.5-2.5 6.4 0 8.6 22.8 22.8 87.3 22.8 110.2 0 2.5-2.2 2.5-6.1 0-8.6-2.2-2.2-6.1-2.2-8.3 0zm7.7-75c-13.6 0-24.6 11.1-24.6 24.9 0 13.6 11.1 24.6 24.6 24.6 13.8 0 24.9-11.1 24.9-24.6 0-13.8-11-24.9-24.9-24.9z"></path></svg>
  </span>

</a
        >
      
    
      
        <a
          class="bg-neutral-300 text-neutral-700 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800 m-1 hover:bg-primary-500 hover:text-neutral rounded min-w-[2.4rem] inline-block text-center p-1"
          href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://ieftimov.com/posts/understanding-bytes-golang-build-tcp-protocol/&amp;title=Understanding%20bytes%20in%20Go%20by%20building%20a%20TCP%20protocol"
          title="Share on LinkedIn"
          aria-label="Share on LinkedIn"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg>
  </span>

</a
        >
      
    
      
        <a
          class="bg-neutral-300 text-neutral-700 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800 m-1 hover:bg-primary-500 hover:text-neutral rounded min-w-[2.4rem] inline-block text-center p-1"
          href="mailto:?body=https://ieftimov.com/posts/understanding-bytes-golang-build-tcp-protocol/&amp;subject=Understanding%20bytes%20in%20Go%20by%20building%20a%20TCP%20protocol"
          title="Send via email"
          aria-label="Send via email"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="at" class="svg-inline--fa fa-at fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 8C118.941 8 8 118.919 8 256c0 137.059 110.919 248 248 248 48.154 0 95.342-14.14 135.408-40.223 12.005-7.815 14.625-24.288 5.552-35.372l-10.177-12.433c-7.671-9.371-21.179-11.667-31.373-5.129C325.92 429.757 291.314 440 256 440c-101.458 0-184-82.542-184-184S154.542 72 256 72c100.139 0 184 57.619 184 160 0 38.786-21.093 79.742-58.17 83.693-17.349-.454-16.91-12.857-13.476-30.024l23.433-121.11C394.653 149.75 383.308 136 368.225 136h-44.981a13.518 13.518 0 0 0-13.432 11.993l-.01.092c-14.697-17.901-40.448-21.775-59.971-21.775-74.58 0-137.831 62.234-137.831 151.46 0 65.303 36.785 105.87 96 105.87 26.984 0 57.369-15.637 74.991-38.333 9.522 34.104 40.613 34.103 70.71 34.103C462.609 379.41 504 307.798 504 232 504 95.653 394.023 8 256 8zm-21.68 304.43c-22.249 0-36.07-15.623-36.07-40.771 0-44.993 30.779-72.729 58.63-72.729 22.292 0 35.601 15.241 35.601 40.77 0 45.061-33.875 72.73-58.161 72.73z"></path></svg>
  </span>

</a
        >
      
    
  </section>


      
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group" href="/posts/testing-in-go-websockets/">
              <span
                class="mr-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Testing in Go: WebSockets</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2020-03-13 00:00:00 &#43;0000 UTC">13 March 2020</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group" href="/posts/four-steps-daemonize-your-golang-programs/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Four Steps to Daemonize Your Go Programs</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2020-05-02 00:00:00 &#43;0000 UTC">2 May 2020</time>
                  
                </span>
              </span>
              <span
                class="ml-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    </footer>
    
  </article>

      
        <div
          class="absolute top-[110vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-[-5.5rem]"
        >
          <a
            href="#the-top"
            class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400"
            aria-label="Scroll to top"
            title="Scroll to top"
          >
            &uarr;
          </a>
        </div>
      
    </main>
    <div
  id="search-wrapper"
  class="fixed inset-0 z-50 flex flex-col p-4 sm:p-6 md:p-[10vh] lg:p-[12vh] w-screen h-screen cursor-default bg-neutral-500/50 backdrop-blur-sm dark:bg-neutral-900/50 invisible"
  data-url="https://ieftimov.com/"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg border-neutral-200 top-20 bg-neutral dark:bg-neutral-800 dark:border-neutral-700"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-transparent focus:outline-2"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="times" class="svg-inline--fa fa-times fa-w-11" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 352 512"><path fill="currentColor" d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z"></path></svg>
  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>
<footer class="py-10">
  
  
    <nav class="pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400">
      <ul class="flex flex-col list-none sm:flex-row">
        
          <li class="mb-1 sm:mb-0 sm:mr-7 sm:last:mr-0">
            <a
              class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
              href="/analytics"
              title=""
              >Analytics</a
            >
          </li>
        
          <li class="mb-1 sm:mb-0 sm:mr-7 sm:last:mr-0">
            <a
              class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
              href="/index.xml"
              title=""
              >RSS</a
            >
          </li>
        
          <li class="mb-1 sm:mb-0 sm:mr-7 sm:last:mr-0">
            <a
              class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
              href="https://forms.gle/orfXK5jh1LRaiFzo8"
              title=""
              >Suggest a topic</a
            >
          </li>
        
      </ul>
    </nav>
  
  <div class="flex justify-between">
    <div>
      
      <p class="text-sm text-neutral-500 dark:text-neutral-400">
          &copy;
          2022
          Ilija Eftimov
      </p>
      
      
        <p class="text-xs text-neutral-500 dark:text-neutral-400">
          
          
          Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
            href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://git.io/hugo-congo" target="_blank" rel="noopener noreferrer">Congo</a>
        </p>
      
    </div>
    
    
      <div
        class="text-sm cursor-pointer text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-14 rtl:ml-14"
      >
        <button
          id="appearance-switcher"
          class="w-12 h-12 "
          type="button"
          title="Switch to dark appearance"
        >
          <span class="inline dark:hidden">

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="moon" class="svg-inline--fa fa-moon fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M283.211 512c78.962 0 151.079-35.925 198.857-94.792 7.068-8.708-.639-21.43-11.562-19.35-124.203 23.654-238.262-71.576-238.262-196.954 0-72.222 38.662-138.635 101.498-174.394 9.686-5.512 7.25-20.197-3.756-22.23A258.156 258.156 0 0 0 283.211 0c-141.309 0-256 114.511-256 256 0 141.309 114.511 256 256 256z"></path></svg>
  </span>

</span>
          <span class="hidden dark:inline">

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="sun" class="svg-inline--fa fa-sun fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 160c-52.9 0-96 43.1-96 96s43.1 96 96 96 96-43.1 96-96-43.1-96-96-96zm246.4 80.5l-94.7-47.3 33.5-100.4c4.5-13.6-8.4-26.5-21.9-21.9l-100.4 33.5-47.4-94.8c-6.4-12.8-24.6-12.8-31 0l-47.3 94.7L92.7 70.8c-13.6-4.5-26.5 8.4-21.9 21.9l33.5 100.4-94.7 47.4c-12.8 6.4-12.8 24.6 0 31l94.7 47.3-33.5 100.5c-4.5 13.6 8.4 26.5 21.9 21.9l100.4-33.5 47.3 94.7c6.4 12.8 24.6 12.8 31 0l47.3-94.7 100.4 33.5c13.6 4.5 26.5-8.4 21.9-21.9l-33.5-100.4 94.7-47.3c13-6.5 13-24.7.2-31.1zm-155.9 106c-49.9 49.9-131.1 49.9-181 0-49.9-49.9-49.9-131.1 0-181 49.9-49.9 131.1-49.9 181 0 49.9 49.9 49.9 131.1 0 181z"></path></svg>
  </span>

</span>
        </button>
      </div>
    
  </div>
  
  
</footer>
</body>
</html>
