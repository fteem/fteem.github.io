<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Rack: Writing middleware | Ilija Eftimov ⚡️</title><meta name=keywords content="rack,middleware"><meta name=description content="Last time I wrote about the basics of Rack and writing a tiny Rack application. If you are unsure what Rack is and what is it&rsquo;s purpose, I recommend you read the other post, famirialize yourself with Rack and get back to this post. If you think you know enough about Rack, please, carry on reading.
Enter: Middleware So, middleware. Lets take it from the basics. What is middleware? Remember that Rack &ldquo;wraps&rdquo; HTTP requests and responses?"><meta name=author content="Ilija Eftimov"><link rel=canonical href=https://ieftimov.com/post/writing-rack-middleware/><link crossorigin=anonymous href=/assets/css/stylesheet.min.css rel="preload stylesheet" as=style><link rel=icon href=https://ieftimov.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ieftimov.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ieftimov.com/favicon-32x32.png><link rel=apple-touch-icon href=https://ieftimov.com/apple-touch-icon.png><link rel=mask-icon href=https://ieftimov.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.83.1"><script async defer data-domain=ieftimov.com src=https://plausible.io/js/plausible.js></script><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel=stylesheet><meta property="og:title" content="Rack: Writing middleware"><meta property="og:description" content="Last time I wrote about the basics of Rack and writing a tiny Rack application. If you are unsure what Rack is and what is it&rsquo;s purpose, I recommend you read the other post, famirialize yourself with Rack and get back to this post. If you think you know enough about Rack, please, carry on reading.
Enter: Middleware So, middleware. Lets take it from the basics. What is middleware? Remember that Rack &ldquo;wraps&rdquo; HTTP requests and responses?"><meta property="og:type" content="article"><meta property="og:url" content="https://ieftimov.com/post/writing-rack-middleware/"><meta property="article:section" content="posts"><meta name=twitter:card content="summary"><meta name=twitter:title content="Rack: Writing middleware"><meta name=twitter:description content="Last time I wrote about the basics of Rack and writing a tiny Rack application. If you are unsure what Rack is and what is it&rsquo;s purpose, I recommend you read the other post, famirialize yourself with Rack and get back to this post. If you think you know enough about Rack, please, carry on reading.
Enter: Middleware So, middleware. Lets take it from the basics. What is middleware? Remember that Rack &ldquo;wraps&rdquo; HTTP requests and responses?"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ieftimov.com/posts/"},{"@type":"ListItem","position":2,"name":"Rack: Writing middleware","item":"https://ieftimov.com/post/writing-rack-middleware/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Rack: Writing middleware","name":"Rack: Writing middleware","description":"Last time I wrote about the basics of Rack and writing a tiny Rack application. If you are unsure what Rack is and what is it\u0026rsquo;s purpose, I recommend you read the other post, famirialize yourself with Rack and get back to this post. If you think you know enough about Rack, please, carry on reading.\nEnter: Middleware So, middleware. Lets take it from the basics. What is middleware? Remember that Rack \u0026ldquo;wraps\u0026rdquo; HTTP requests and responses?","keywords":["rack","middleware"],"articleBody":"Last time I wrote about the basics of Rack and writing a tiny Rack application. If you are unsure what Rack is and what is it’s purpose, I recommend you read the other post, famirialize yourself with Rack and get back to this post. If you think you know enough about Rack, please, carry on reading.\nEnter: Middleware So, middleware. Lets take it from the basics. What is middleware? Remember that Rack “wraps” HTTP requests and responses? Also, remember that it has this interface (or API) which allows you to play with the request and the responses?\nWell, middleware is a term that is used when speaking for a piece of software which is somehow related to the execution of the web application, but is not directly involved with the execution of the requested task.\nConfusing? Okay, lets put it in another way.\nThink of logging. You request a resource from an API, and the API responds with your results. Although you did not request the API to log your request (why would you?), the API has a logger which records everything that goes in and out of the application. So you see, although the logger is not directly involved with handling your request, the logger is middleware that writes down what you requested and what the API responded with.\nHow it works Every Rack application is a class. The same applies to Rack middleware. Lets write the class and see some basic rules that apply to writing middleware classes.\nclass MyMiddleware def initialize(app) @app = app end end When writing a Rack middleware class, the first argument of the initialize method is the application, or the request handler. If that’s confusing, think of it in this way\n the request handler has to be passed in the middleware class, so the middleware can wrap the execution of the application and do something to the request and the response of the application.  Another rule that applies to a middleware class is the call method. The call method executes the application which returns the status, the headers and the body of the response.\nTake this for an example:\n# test_handler.ru class MiddlewareTwo def initialize(app) @app = app end def call(env) puts \"MiddlewareTwo reporting in!\" puts \"The app is: #{@app}\" puts \"The has the methods: #{@app.methods - Object.methods}\" status, headers, body = @app.call(env) [status, headers, body] end end class MiddlewareOne def initialize(app) @app = app end def call(env) puts \"MiddlewareOne reporting in!\" puts \"The app is: #{@app}\" puts \"The has the methods: #{@app.methods - Object.methods}\" status, headers, body = @app.call(env) [status, headers, body] end end class HandlerClass def self.call(env) puts 'Handling the request...' [200, { \"Content-Type\" = \"text/html\" }, [\"Request handled.\"]] end end use MiddlewareTwo use MiddlewareOne run HandlerClass When we run this file with rackup test_handler.ru, the WEBrick server will boot and our request handler will be served (your output may vary):\n➜ rackup ~/Desktop/test.ru  Thin web server (v1.5.1 codename Straight Razor)  Maximum connections set to 1024  Listening on localhost:9292, CTRL+C to stop When you visit localhost:9292 in your browser (or cURL it), you will see the “Request handled.” message. But the server logs are what we are interested in:\nMiddlewareTwo reporting in! The app is: # The has the methods: [:call] MiddlewareOne reporting in! The app is: HandlerClass The has the methods: [:call] Handling the request... As you can see, the app is actually the handler, or, the HandlerClass. It only has one method, the call method. But, what’s really interesting is the order in which the statements are executed. First, MiddlewareTwo wraps the request and prints the app and it’s methods. After, it executes the @app.call(env) line, which is the MiddlewareOne class. When it calls the call method, it actually executes the MiddlewareOne call method. Then, that method prints out the app and it’s methods. Here, the app is the RequestHandler. After it calls the call method, the response is served.\nThis is what the wrapping looks like:\nMiddlewareTwo[ MiddlewareOne [ RequestHandler ] ] This means that MiddlewareTwo executes MiddlewareOne which executes RequestHandler.\nLoggster Let’s take it to the next level and write our own logging middleware. We’ll call the class Loggster! :-) What we are aiming for is middleware, that will wrap our Rack application and will log the requests that come in to a logfile. Sounds simple? Lets see…\n# loggster.ru class Loggster def initialize app @app = app end def call env start_time = Time.now status, headers, body = @app.call env end_time = Time.now Dir.mkdir('logs') unless File.directory?('logs') File.open('logs/server.log', 'a+') do |f| f.write(\"[#{Time.now}] \\\"#{env['REQUEST_METHOD']}#{env['PATH_INFO']}\\\"#{status}Delta: #{end_time - start_time}s \\n\") end [status, headers, body] end end class RackApp def self.call env [200, {'Content-Type' = 'text/html'}, ['Hi!']] end end use Loggster run RackApp The Rack application, or, the RackApp class just returns a HTTP 200 with a “Hi!” message. Simple stuff. So, what does Loggster do? When we add the use Loggster line in the file, we tell Rack to wrap the request handler a.k.a. RackApp with Loggster. This means that Loggster#call will call RackApp.call, it will write to the log file and return the full response that RackApp returned. The “magic” call method, is really simple. It checks if there’s a directory called “logs” and creates it if it does not exist. After, it creates a server.log file and inside, it writes the current time, the request method (i.e. GET), the URL that the web client requested and the response HTTP status.\nIf we run this file with rackup loggster.ru and visit the URL, we’ll see that a directory called “logs” and a file “server.log” inside, have been created. So, how does the output of our simple logger looks?\n➜ cat logs/server.log [2015-06-27 01:24:37 +0200] \"GET /something\" 200 Delta: 1.3s [2015-06-27 01:24:37 +0200] \"GET /favicon.ico\" 200 Delta: 0.3s [2015-06-27 01:24:37 +0200] \"GET /favicon.ico\" 200 Delta: 0.2s As you can see, I requested localhost:/something via my browser. The browser requested the path and it also requested the favicon twice.\nOutro As you can see, writing Rack middleware can be pretty simple. Of course, it all depends on what functionality you would like the middleware to have. That being said, the rules (or constraints) that Rack imposes when writing middleware are tiny and very clear. In the next post, we will see how we can implement Rack middleware and mount it in a Rails application. In the mean time, did you implement any Rack middleware yourself?\nFeel free to share your stuff (or ask for help, if needed) with me and my readers in the comments.\nLiked this article? Subscribe to my newsletter and get future articles in your inbox. It's a short and sweet read, going out to +1000 of other engineers.\n    ","wordCount":"1114","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"Ilija Eftimov"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ieftimov.com/post/writing-rack-middleware/"},"publisher":{"@type":"Organization","name":"Ilija Eftimov ⚡️","logo":{"@type":"ImageObject","url":"https://ieftimov.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://ieftimov.com/ accesskey=h title="Ilija Eftimov ⚡️ (Alt + H)">Ilija Eftimov ⚡️</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://ieftimov.com/ title=About><span>About</span></a></li><li><a href=https://ieftimov.com/posts title=Writing><span>Writing</span></a></li><li><a href=https://ieftimov.com/newsletter title=Newsletter><span>Newsletter</span></a></li><li><a href=https://forms.gle/orfXK5jh1LRaiFzo8 title="Suggest a topic"><span>Suggest a topic</span></a></li><li><a href=https://www.buymeacoffee.com/ieftimov title="Buy me a ☕"><span>Buy me a ☕</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Rack: Writing middleware</h1><div class=post-meta>June 28, 2015&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Ilija Eftimov</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#enter-middleware aria-label="Enter: Middleware">Enter: Middleware</a></li><li><a href=#how-it-works aria-label="How it works">How it works</a></li><li><a href=#loggster aria-label=Loggster>Loggster</a></li><li><a href=#outro aria-label=Outro>Outro</a></li></ul></div></details></div><div class=post-content><p>Last time I wrote about <a href=/rack-first-principles>the basics of Rack</a> and writing
a tiny Rack application. If you are unsure what Rack is and what is it&rsquo;s purpose,
I recommend you read the other post, famirialize yourself with Rack and get back
to this post. If you think you know enough about Rack, please, carry on reading.</p><h2 id=enter-middleware>Enter: Middleware<a hidden class=anchor aria-hidden=true href=#enter-middleware>#</a></h2><p>So, middleware. Lets take it from the basics. What is middleware? Remember that
Rack &ldquo;wraps&rdquo; HTTP requests and responses? Also, remember that it has this
interface (or API) which allows you to play with the request and the responses?</p><p>Well, middleware is a term that is used when speaking for a piece of software
which is somehow related to the execution of the web application, but is not
directly involved with the execution of the requested task.</p><p>Confusing? Okay, lets put it in another way.</p><p>Think of logging. You request a resource from an API, and the API responds with
your results. Although you did not request the API to log your request (why
would you?), the API has a logger which records everything that goes in and out
of the application. So you see, although the logger is not directly involved
with handling your request, the logger is middleware that writes down what you
requested and what the API responded with.</p><h2 id=how-it-works>How it works<a hidden class=anchor aria-hidden=true href=#how-it-works>#</a></h2><p>Every Rack application is a class. The same applies to Rack middleware. Lets write
the class and see some basic rules that apply to writing middleware classes.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#719e07>class</span> <span style=color:#268bd2>MyMiddleware</span>
  <span style=color:#719e07>def</span> <span style=color:#268bd2>initialize</span>(app)
    @app <span style=color:#719e07>=</span> app
  <span style=color:#719e07>end</span>
<span style=color:#719e07>end</span></code></pre></div><p>When writing a Rack middleware class, the first argument of the <code>initialize</code> method
is the application, or the request handler. If that&rsquo;s confusing, think of it in this way</p><ul><li>the request handler has to be passed in the middleware class, so the middleware can wrap
the execution of the application and do something to the request and the response of
the application.</li></ul><p>Another rule that applies to a middleware class is the <code>call</code> method. The
<code>call</code> method executes the application which returns the status, the headers and the
body of the response.</p><p>Take this for an example:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#586e75># test_handler.ru</span>

<span style=color:#719e07>class</span> <span style=color:#268bd2>MiddlewareTwo</span>
  <span style=color:#719e07>def</span> <span style=color:#268bd2>initialize</span>(app)
    @app <span style=color:#719e07>=</span> app
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>call</span>(env)
    <span style=color:#b58900>puts</span> <span style=color:#2aa198>&#34;MiddlewareTwo reporting in!&#34;</span>
    <span style=color:#b58900>puts</span> <span style=color:#2aa198>&#34;The app is: </span><span style=color:#2aa198>#{</span>@app<span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>
    <span style=color:#b58900>puts</span> <span style=color:#2aa198>&#34;The has the methods: </span><span style=color:#2aa198>#{</span>@app<span style=color:#719e07>.</span>methods <span style=color:#719e07>-</span> <span style=color:#cb4b16>Object</span><span style=color:#719e07>.</span>methods<span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>
    status, headers, body <span style=color:#719e07>=</span> @app<span style=color:#719e07>.</span>call(env)
    <span style=color:#719e07>[</span>status, headers, body<span style=color:#719e07>]</span>
  <span style=color:#719e07>end</span>
<span style=color:#719e07>end</span>

<span style=color:#719e07>class</span> <span style=color:#268bd2>MiddlewareOne</span>
  <span style=color:#719e07>def</span> <span style=color:#268bd2>initialize</span>(app)
    @app <span style=color:#719e07>=</span> app
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>call</span>(env)
    <span style=color:#b58900>puts</span> <span style=color:#2aa198>&#34;MiddlewareOne reporting in!&#34;</span>
    <span style=color:#b58900>puts</span> <span style=color:#2aa198>&#34;The app is: </span><span style=color:#2aa198>#{</span>@app<span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>
    <span style=color:#b58900>puts</span> <span style=color:#2aa198>&#34;The has the methods: </span><span style=color:#2aa198>#{</span>@app<span style=color:#719e07>.</span>methods <span style=color:#719e07>-</span> <span style=color:#cb4b16>Object</span><span style=color:#719e07>.</span>methods<span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>
    status, headers, body <span style=color:#719e07>=</span> @app<span style=color:#719e07>.</span>call(env)
    <span style=color:#719e07>[</span>status, headers, body<span style=color:#719e07>]</span>
  <span style=color:#719e07>end</span>
<span style=color:#719e07>end</span>

<span style=color:#719e07>class</span> <span style=color:#268bd2>HandlerClass</span>
  <span style=color:#719e07>def</span> <span style=color:#268bd2>self</span><span style=color:#719e07>.</span><span style=color:#268bd2>call</span>(env)
    <span style=color:#b58900>puts</span> <span style=color:#2aa198>&#39;Handling the request...&#39;</span>
    <span style=color:#719e07>[</span><span style=color:#2aa198>200</span>, { <span style=color:#2aa198>&#34;Content-Type&#34;</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#34;text/html&#34;</span> }, <span style=color:#719e07>[</span><span style=color:#2aa198>&#34;&lt;b&gt;Request handled.&lt;/b&gt;&#34;</span><span style=color:#719e07>]]</span>
  <span style=color:#719e07>end</span>
<span style=color:#719e07>end</span>

use <span style=color:#cb4b16>MiddlewareTwo</span>
use <span style=color:#cb4b16>MiddlewareOne</span>
run <span style=color:#cb4b16>HandlerClass</span></code></pre></div><p>When we run this file with <code>rackup test_handler.ru</code>, the WEBrick server will boot
and our request handler will be served (your output may vary):</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>➜  rackup ~/Desktop/test.ru
&gt;&gt; Thin web server <span style=color:#719e07>(</span>v1.5.1 codename Straight Razor<span style=color:#719e07>)</span>
&gt;&gt; Maximum connections <span style=color:#b58900>set</span> to <span style=color:#2aa198>1024</span>
&gt;&gt; Listening on localhost:9292, CTRL+C to stop</code></pre></div><p>When you visit localhost:9292 in your browser (or cURL it), you will see the &ldquo;Request handled.&rdquo;
message. But the server logs are what we are interested in:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>MiddlewareTwo reporting in!
The app is: <span style=color:#586e75>#&lt;MiddlewareOne:0x007fbcdb111f08&gt;</span>
The has the methods: <span style=color:#719e07>[</span>:call<span style=color:#719e07>]</span>
MiddlewareOne reporting in!
The app is: HandlerClass
The has the methods: <span style=color:#719e07>[</span>:call<span style=color:#719e07>]</span>
Handling the request...</code></pre></div><p>As you can see, the app is actually the handler, or, the <code>HandlerClass</code>. It only has one method, the
call method. But, what&rsquo;s really interesting is the order in which the statements are executed.
First, <code>MiddlewareTwo</code> wraps the request and prints the app and it&rsquo;s methods. After,
it executes the <code>@app.call(env)</code> line, which is the <code>MiddlewareOne</code> class.
When it calls the <code>call</code> method, it actually executes the <code>MiddlewareOne</code> call method.
Then, that method prints out the app and it&rsquo;s methods. Here, the app is the <code>RequestHandler</code>.
After it calls the <code>call</code> method, the response is served.</p><p>This is what the wrapping looks like:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#cb4b16>MiddlewareTwo</span><span style=color:#719e07>[</span> <span style=color:#cb4b16>MiddlewareOne</span> <span style=color:#719e07>[</span> <span style=color:#cb4b16>RequestHandler</span> <span style=color:#719e07>]</span> <span style=color:#719e07>]</span></code></pre></div><p>This means that <code>MiddlewareTwo</code> executes <code>MiddlewareOne</code> which executes <code>RequestHandler</code>.</p><h2 id=loggster>Loggster<a hidden class=anchor aria-hidden=true href=#loggster>#</a></h2><p>Let&rsquo;s take it to the next level and write our own logging middleware. We&rsquo;ll call the class Loggster! :-)
What we are aiming for is middleware, that will wrap our Rack application and will log the
requests that come in to a logfile. Sounds simple? Lets see&mldr;</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#586e75># loggster.ru</span>
<span style=color:#719e07>class</span> <span style=color:#268bd2>Loggster</span>
  <span style=color:#719e07>def</span> <span style=color:#268bd2>initialize</span> app
    @app <span style=color:#719e07>=</span> app
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>call</span> env
    start_time <span style=color:#719e07>=</span> <span style=color:#cb4b16>Time</span><span style=color:#719e07>.</span>now
    status, headers, body <span style=color:#719e07>=</span> @app<span style=color:#719e07>.</span>call env
    end_time <span style=color:#719e07>=</span> <span style=color:#cb4b16>Time</span><span style=color:#719e07>.</span>now

    <span style=color:#cb4b16>Dir</span><span style=color:#719e07>.</span>mkdir(<span style=color:#2aa198>&#39;logs&#39;</span>) <span style=color:#719e07>unless</span> <span style=color:#cb4b16>File</span><span style=color:#719e07>.</span>directory?(<span style=color:#2aa198>&#39;logs&#39;</span>)
    <span style=color:#cb4b16>File</span><span style=color:#719e07>.</span>open(<span style=color:#2aa198>&#39;logs/server.log&#39;</span>, <span style=color:#2aa198>&#39;a+&#39;</span>) <span style=color:#719e07>do</span> <span style=color:#719e07>|</span>f<span style=color:#719e07>|</span>
      f<span style=color:#719e07>.</span>write(<span style=color:#2aa198>&#34;[</span><span style=color:#2aa198>#{</span><span style=color:#cb4b16>Time</span><span style=color:#719e07>.</span>now<span style=color:#2aa198>}</span><span style=color:#2aa198>] </span><span style=color:#cb4b16>\&#34;</span><span style=color:#2aa198>#{</span>env<span style=color:#719e07>[</span><span style=color:#2aa198>&#39;REQUEST_METHOD&#39;</span><span style=color:#719e07>]</span><span style=color:#2aa198>}</span><span style=color:#2aa198> </span><span style=color:#2aa198>#{</span>env<span style=color:#719e07>[</span><span style=color:#2aa198>&#39;PATH_INFO&#39;</span><span style=color:#719e07>]</span><span style=color:#2aa198>}</span><span style=color:#cb4b16>\&#34;</span><span style=color:#2aa198> </span><span style=color:#2aa198>#{</span>status<span style=color:#2aa198>}</span><span style=color:#2aa198> Delta: </span><span style=color:#2aa198>#{</span>end_time <span style=color:#719e07>-</span> start_time<span style=color:#2aa198>}</span><span style=color:#2aa198>s </span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>)
    <span style=color:#719e07>end</span>

    <span style=color:#719e07>[</span>status, headers, body<span style=color:#719e07>]</span>
  <span style=color:#719e07>end</span>
<span style=color:#719e07>end</span>

<span style=color:#719e07>class</span> <span style=color:#268bd2>RackApp</span>
  <span style=color:#719e07>def</span> <span style=color:#268bd2>self</span><span style=color:#719e07>.</span><span style=color:#268bd2>call</span> env
    <span style=color:#719e07>[</span><span style=color:#2aa198>200</span>, {<span style=color:#2aa198>&#39;Content-Type&#39;</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;text/html&#39;</span>}, <span style=color:#719e07>[</span><span style=color:#2aa198>&#39;Hi!&#39;</span><span style=color:#719e07>]]</span>
  <span style=color:#719e07>end</span>
<span style=color:#719e07>end</span>

use <span style=color:#cb4b16>Loggster</span>
run <span style=color:#cb4b16>RackApp</span></code></pre></div><p>The Rack application, or, the <code>RackApp</code> class just returns a HTTP 200 with a &ldquo;Hi!&rdquo; message. Simple stuff.
So, what does Loggster do? When we add the <code>use Loggster</code> line in the file, we tell Rack to wrap
the request handler a.k.a. <code>RackApp</code> with <code>Loggster</code>. This means that <code>Loggster#call</code> will
call <code>RackApp.call</code>, it will write to the log file and return the full response that <code>RackApp</code> returned.
The &ldquo;magic&rdquo; call method, is really simple. It checks if there&rsquo;s a directory called
&ldquo;logs&rdquo; and creates it if it does not exist. After, it creates a <code>server.log</code>
file and inside, it writes the current time, the request method (i.e. GET), the
URL that the web client requested and the response HTTP status.</p><p>If we run this file with <code>rackup loggster.ru</code> and visit the URL, we&rsquo;ll see that a directory called
&ldquo;logs&rdquo; and a file &ldquo;server.log&rdquo; inside, have been created. So, how does the output of our simple logger looks?</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>➜ cat logs/server.log
<span style=color:#719e07>[</span>2015-06-27 01:24:37 +0200<span style=color:#719e07>]</span> <span style=color:#2aa198>&#34;GET /something&#34;</span> <span style=color:#2aa198>200</span> Delta: 1.3s
<span style=color:#719e07>[</span>2015-06-27 01:24:37 +0200<span style=color:#719e07>]</span> <span style=color:#2aa198>&#34;GET /favicon.ico&#34;</span> <span style=color:#2aa198>200</span> Delta: 0.3s
<span style=color:#719e07>[</span>2015-06-27 01:24:37 +0200<span style=color:#719e07>]</span> <span style=color:#2aa198>&#34;GET /favicon.ico&#34;</span> <span style=color:#2aa198>200</span> Delta: 0.2s</code></pre></div><p>As you can see, I requested <code>localhost:&lt;port-number>/something</code> via my browser. The browser requested the path
and it also requested the favicon twice.</p><h2 id=outro>Outro<a hidden class=anchor aria-hidden=true href=#outro>#</a></h2><p>As you can see, writing Rack middleware can be pretty simple. Of course, it all
depends on what functionality you would like the middleware to have. That being said,
the rules (or constraints) that Rack imposes when writing middleware are tiny and very clear.
In the next post, we will see how we can implement Rack middleware and mount it in
a Rails application. In the mean time, did you implement any Rack middleware yourself?</p><p>Feel free to share your stuff (or ask for help, if needed) with me and my readers in the comments.</p><div id=revue-embed><form action=https://www.getrevue.co/profile/itsilija/add_subscriber method=post id=revue-form name=revue-form target=_blank><p><b>Liked this article?</b>
Subscribe to my newsletter and get future articles in your inbox. It's a
short and sweet read, going out to +1000 of other engineers.</p><div class=revue-form-group><input class=revue-form-field placeholder="Your email address..." type=email name=member[email] id=member_email></div><div class=revue-form-actions><input type=submit value=Subscribe name=member[subscribe] id=member_submit></div></form></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://ieftimov.com/tags/rack/>rack</a></li><li><a href=https://ieftimov.com/tags/middleware/>middleware</a></li></ul><nav class=paginav><a class=prev href=https://ieftimov.com/post/writing-rails-middleware/><span class=title>« Prev Page</span><br><span>How to write Rails middleware</span></a>
<a class=next href=https://ieftimov.com/post/rack-first-principles/><span class=title>Next Page »</span><br><span>Rack: First Principles</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Rack: Writing middleware on twitter" href="https://twitter.com/intent/tweet/?text=Rack%3a%20Writing%20middleware&url=https%3a%2f%2fieftimov.com%2fpost%2fwriting-rack-middleware%2f&hashtags=rack%2cmiddleware"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Rack: Writing middleware on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fieftimov.com%2fpost%2fwriting-rack-middleware%2f&title=Rack%3a%20Writing%20middleware&summary=Rack%3a%20Writing%20middleware&source=https%3a%2f%2fieftimov.com%2fpost%2fwriting-rack-middleware%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Rack: Writing middleware on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fieftimov.com%2fpost%2fwriting-rack-middleware%2f&title=Rack%3a%20Writing%20middleware"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Rack: Writing middleware on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fieftimov.com%2fpost%2fwriting-rack-middleware%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Rack: Writing middleware on whatsapp" href="https://api.whatsapp.com/send?text=Rack%3a%20Writing%20middleware%20-%20https%3a%2f%2fieftimov.com%2fpost%2fwriting-rack-middleware%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Rack: Writing middleware on telegram" href="https://telegram.me/share/url?text=Rack%3a%20Writing%20middleware&url=https%3a%2f%2fieftimov.com%2fpost%2fwriting-rack-middleware%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>Copyright 2021 © Ilija Eftimov</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>