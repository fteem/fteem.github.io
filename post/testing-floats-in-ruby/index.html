<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Testing Ruby&#39;s floats precision - Ilija Eftimov</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Testing Ruby&#39;s floats precision" />
<meta property="og:description" content="Float precision in Ruby is a well known quirk. But when testing floats, not many of us bother to remember this and make their tests respectful to this quirk. In this post we will see how the popular Ruby testing frameworks help us test floats properly.
Background story Last week I published a post about migrating a test suite from RSpec to Minitest. What was very interesting is that I got a mention on Twitter from Ryan Davis with an offer for a code review of the migration." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ieftimov.com/post/testing-floats-in-ruby/" />
<meta property="article:published_time" content="2015-07-21T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Testing Ruby&#39;s floats precision"/>
<meta name="twitter:description" content="Float precision in Ruby is a well known quirk. But when testing floats, not many of us bother to remember this and make their tests respectful to this quirk. In this post we will see how the popular Ruby testing frameworks help us test floats properly.
Background story Last week I published a post about migrating a test suite from RSpec to Minitest. What was very interesting is that I got a mention on Twitter from Ryan Davis with an offer for a code review of the migration."/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://ieftimov.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://ieftimov.com/css/main.css" />
		<link rel="stylesheet" type="text/css" href="https://ieftimov.com/css/overrides.css" />
	

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="https://ieftimov.com/js/main.js"></script><script src="https://ieftimov.com/js/tooltip.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="https://ieftimov.com/">
				<img src="avatar.jpg" alt="Ilija Eftimov" />
			</a>
		</div>
	
	<h1 class="site-title"><a href="https://ieftimov.com/">Ilija Eftimov</a></h1>
	<div class="site-description"><p>A human, interested in building products and software.</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/fteem" title="Github"><i data-feather="github"></i></a></li><li><a href="https://twitter.com/fteem" title="Twitter"><i data-feather="twitter"></i></a></li><li><a href="https://www.linkedin.com/in/ieftimov" title="Linkedin"><i data-feather="linkedin"></i></a></li><li><a href="mailto:blog@ieftimov.com" title="Email"><i data-feather="mail"></i></a></li></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/categories/testing-in-go">Testing in Go</a>
			</li>
			
			<li>
				<a href="/posts">Archive</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="https://forms.gle/orfXK5jh1LRaiFzo8">Suggest a topic</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">21</span>
							<span class="rest">Jul 2015</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Testing Ruby&#39;s floats precision</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>Float precision in Ruby is a well known quirk. But when testing floats, not
many of us bother to remember this and make their tests respectful to this
quirk. In this post we will see how the popular Ruby testing frameworks help us
test floats properly.</p>
<h2 id="background-story">Background story</h2>
<p>Last week I published <a href="/migrate-rspec-to-minitest">a post about migrating a test suite from RSpec to
Minitest</a>.  What was very interesting is that I got
a mention on Twitter from <a href="https://twitter.com/the_zenspider">Ryan Davis</a> with
an offer for a code review of the migration. Here's the convo:</p>
<!-- raw HTML omitted -->
<p>Ryan did the review for me, and one of his comments was:</p>
<!-- raw HTML omitted -->
<p>Lets see why&hellip;</p>
<h2 id="ruby-float-imprecision">Ruby Float (im)precision</h2>
<p>Float numbers cannot store decimal numbers properly. The reason is that Float
is a binary number format. What do I mean? Well, Ruby always converts Floats
from decimal to binary and vice versa.</p>
<p>Think about this very simple example. Whats the result of 1 divided by 3? Yup,
0.33333333333&hellip;  The result of this calculation is 0.333(3), with 3 repeating
until infinity.</p>
<p>This same rule, or quirk, applies to binary numbers. When a decimal number is
converted to binary, the resulting binary number can be endless. Mathematically
this is all fine.  But in practice, my MacBook Air doesn't have endless memory.
I am running just on 4GBs of RAM, so Ruby must cut off the endless number at
some point. Or it will fill up the whole memory of the computer and it will
become useless.  This mechanism of rounding numbers produces a rounding error
and that's exactly what we have to deal with here.</p>
<p>So, the base rule about this is: <strong>do not</strong> represent currency (or, money) with
Float.</p>
<h2 id="in-practice">In practice</h2>
<p>Take this for an example. Simple calculation. We want to add 0.1 to 0.05, which
should return 0.15. Right? Lets give it a try:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">&gt;&gt;</span> <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">1</span> <span style="font-weight:bold"></span><span style="font-weight:bold">+</span> <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">05</span> <span style="font-weight:bold"></span><span style="font-weight:bold">==</span> <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">15</span>
<span style="font-weight:bold"></span><span style="font-weight:bold">=</span><span style="font-weight:bold">&gt;</span> <span style="font-weight:bold">false</span></code></pre></div>
<p>Okay, what? Let's see what's the result of the addition:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">&gt;&gt;</span> <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">1</span> <span style="font-weight:bold"></span><span style="font-weight:bold">+</span> <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">05</span>
<span style="font-weight:bold"></span><span style="font-weight:bold">=</span><span style="font-weight:bold">&gt;</span> <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">15000000000000002</span><span style="font-weight:bold"></span></code></pre></div>
<p>You can see that Ruby rounds off the number at the end. Lets print this number
with 50 decimal points:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">&gt;&gt;</span> <span style="color:#999">sprintf</span>(<span style="color:#b84">&#34;</span><span style="color:#b84">%0.50f</span><span style="color:#b84">&#34;</span>, <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">10</span> <span style="font-weight:bold"></span><span style="font-weight:bold">+</span> <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">05</span><span style="font-weight:bold"></span>)
<span style="font-weight:bold">=</span><span style="font-weight:bold">&gt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">0.15000000000000002220446049250313080847263336181641</span><span style="color:#b84">&#34;</span></code></pre></div>
<p>Whoa! You can see that the actual result of this addition is quite different
from 0.15.  Ruby here rounds off the numbers, because the difference is so
&ldquo;microscopic&rdquo;.</p>
<p>If you are curious, here's how the numbers 0.10 and 0.05 actually look like
with 50 decimal points in Ruby:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">&gt;&gt;</span> <span style="color:#999">sprintf</span>(<span style="color:#b84">&#34;</span><span style="color:#b84">%0.50f</span><span style="color:#b84">&#34;</span>, <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">10</span><span style="font-weight:bold"></span>)
<span style="font-weight:bold">=</span><span style="font-weight:bold">&gt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">0.10000000000000000555111512312578270211815834045410</span><span style="color:#b84">&#34;</span>
<span style="font-weight:bold">&gt;&gt;</span> <span style="color:#999">sprintf</span>(<span style="color:#b84">&#34;</span><span style="color:#b84">%0.50f</span><span style="color:#b84">&#34;</span>, <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">05</span><span style="font-weight:bold"></span>)
<span style="font-weight:bold">=</span><span style="font-weight:bold">&gt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">0.05000000000000000277555756156289135105907917022705</span><span style="color:#b84">&#34;</span></code></pre></div>
<h2 id="testing-it">Testing it</h2>
<p>Okay, so now when the problem is obvious, how can we test it?  The best way to
test this is to use a <strong>delta</strong> number. You can think of this delta number as a
number showing the margin of rounding error.</p>
<p>For example, the delta for the 0.10 + 0.05 operation is approximately
0.0000000000000001.</p>
<h3 id="with-minitest">With Minitest</h3>
<p>Minitest provides us the <code>assert_in_delta</code> and <code>assert_in_epsilon</code> methods.</p>
<h4 id="assert-in-delta">assert_in_delta</h4>
<p>It fails unless the expected and the actual values are within <strong>delta</strong> of each
other.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">test_precision</span>
  assert_in_delta(<span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">15</span><span style="font-weight:bold"></span>, <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">10</span> <span style="font-weight:bold"></span><span style="font-weight:bold">+</span> <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">05</span><span style="font-weight:bold"></span>, <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">0000000000000001</span><span style="font-weight:bold"></span>)
<span style="font-weight:bold">end</span></code></pre></div>
<p>This means that, while we will expect to get 0.15 as a result, the rounding-off
error can be as big as 0.0000000000000001.</p>
<p>If you see the source of this method, it's quite easy to understand:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># File minitest/unit.rb, line 122</span>
<span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">assert_in_delta</span> exp, act, delta <span style="font-weight:bold">=</span> <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">001</span><span style="font-weight:bold"></span>, msg <span style="font-weight:bold">=</span> <span style="font-weight:bold">nil</span>
  n <span style="font-weight:bold">=</span> (exp <span style="font-weight:bold">-</span> act)<span style="font-weight:bold">.</span>abs
  msg <span style="font-weight:bold">=</span> message(msg) { <span style="color:#b84">&#34;</span><span style="color:#b84">Expected </span><span style="color:#b84">#{</span>exp<span style="color:#b84">}</span><span style="color:#b84"> - </span><span style="color:#b84">#{</span>act<span style="color:#b84">}</span><span style="color:#b84"> (</span><span style="color:#b84">#{</span>n<span style="color:#b84">}</span><span style="color:#b84">) to be &lt; </span><span style="color:#b84">#{</span>delta<span style="color:#b84">}</span><span style="color:#b84">&#34;</span> }
  assert delta <span style="font-weight:bold">&gt;</span><span style="font-weight:bold">=</span> n, msg
<span style="font-weight:bold">end</span></code></pre></div>
<p>The delta must be larger or equal than the absolute value of the result of subtraction
of the expected and the actual values.</p>
<h4 id="assert-in-epsilon">assert_in_epsilon</h4>
<p>This method behaves in a different matter than <code>assert_in_delta</code>. For
example, if we use the delta as an epsilon, this test will fail:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">test_precision</span>
  assert_in_epsilon(<span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">15</span><span style="font-weight:bold"></span>, <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">10</span> <span style="font-weight:bold"></span><span style="font-weight:bold">+</span> <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">05</span><span style="font-weight:bold"></span>, <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">0000000000000001</span><span style="font-weight:bold"></span>)
<span style="font-weight:bold">end</span></code></pre></div>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#998;font-style:italic"># Running:</span>

F

Finished in 0.001584s, 1262.6263 runs/s, 1262.6263 assertions/s.

  1<span style="font-weight:bold">)</span> Failure:
SomeTest#test_with_epsilon <span style="font-weight:bold">[</span>test.rb:5<span style="font-weight:bold">]</span>:
Expected |0.15 - 0.15000000000000002| <span style="font-weight:bold">(</span>2.7755575615628914e-17<span style="font-weight:bold">)</span> to be &lt;<span style="font-weight:bold">=</span> 1.5e-17.</code></pre></div>
<p>Why this happens is easier to see in the source of the <code>assert_in_epsilon</code>
method:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># File minitest/unit.rb, line 132</span>
<span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">assert_in_epsilon</span> a, b, epsilon <span style="font-weight:bold">=</span> <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">001</span><span style="font-weight:bold"></span>, msg <span style="font-weight:bold">=</span> <span style="font-weight:bold">nil</span>
  assert_in_delta a, b, <span style="font-weight:bold">[</span>a, b<span style="font-weight:bold">]</span><span style="font-weight:bold">.</span>min <span style="font-weight:bold">*</span> epsilon, msg
<span style="font-weight:bold">end</span></code></pre></div>
<p>So, <code>assert_in_epsilon</code> is a wrapper for <code>assert_in_delta</code> with a small but
important difference. The delta here is subject to &ldquo;auto-scaling&rdquo;. This means
that it will increase for the product of the smaller number from the expected
value/actual value pair and the epsilon.</p>
<p>Also, I guess, it's called &ldquo;epsilon&rdquo; because the greek letter Epsilon is usually used to
denote a small quantity (like a margin of error) or perhaps a number which will be
turned into a zero within some limit.</p>
<h3 id="with-rspec">With RSpec</h3>
<p>RSpec provides us the <code>be_within</code> matcher. The same rules apply here as the
Minitest <code>assert_in_delta</code> method. The format is:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">expect(<span style="font-weight:bold">&lt;</span>actual<span style="font-weight:bold">&gt;</span>)<span style="font-weight:bold">.</span>to be_within(<span style="font-weight:bold">&lt;</span>delta<span style="font-weight:bold">&gt;</span>)<span style="font-weight:bold">.</span>of(<span style="font-weight:bold">&lt;</span>expected<span style="font-weight:bold">&gt;</span>)</code></pre></div>
<p>Or, in our case:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">it <span style="color:#b84">&#34;</span><span style="color:#b84">should match within a delta</span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">do</span>
  expect(<span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">10</span> <span style="font-weight:bold"></span><span style="font-weight:bold">+</span> <span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">05</span><span style="font-weight:bold"></span>)<span style="font-weight:bold">.</span>to be_within(<span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">0000000000000001</span><span style="font-weight:bold"></span>)<span style="font-weight:bold">.</span>of(<span style="color:#099">0</span><span style="font-weight:bold"></span><span style="font-weight:bold">.</span><span style="color:#099">15</span><span style="font-weight:bold"></span>)
<span style="font-weight:bold">end</span></code></pre></div>
<h2 id="conclusion">Conclusion</h2>
<p>Since the people behind RSpec and Minitest are awesome, they have provided us
these methods where we can easily smooth out the edges of testing floats.
What's very important to understand here is that while testing this is pretty
easy, it's <strong>extremely</strong> important to know what to use when.</p>
<p>When it comes to money/currency, every sane developer out there will use
<a href="http://ruby-doc.org/stdlib-2.1.1/libdoc/bigdecimal/rdoc/BigDecimal.html">BigDecimal</a>.
It provides arbitrary-precision floating point decimal arithmetic, which means
that it will <strong>always</strong> get a correct result for any calculation involving
floating point numbers.</p>
<p>As an outro, I'll leave you with this tweet:</p>
<!-- raw HTML omitted -->

			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="/tags/floats">floats</a></li>
							
							<li><a href="/tags/precision">precision</a></li>
							
						</ul>
					
				
			</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = 'eftimov';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the </a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> Copyright Â© 2014 - 2020 Ilija Eftimov |  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-11264459-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
