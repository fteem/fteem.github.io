<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>In and out of PostgreSQL using COPY - Ilija Eftimov</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="In and out of PostgreSQL using COPY" />
<meta property="og:description" content="I am pretty sure everyone of us has been in a situation where you needed to generate a report and/or extract some data from a database and present it in a spreadsheet. In many cases, our clients prefer Excel to handle spreadsheets/reports, because, duh, it&#39;s Excel.
So, how do you approach this problem? Do you copy and paste data? Or use a RDBMS GUI to generate the report into a spreadsheet?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ieftimov.com/post/postgresql-copy/" />
<meta property="article:published_time" content="2015-06-12T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="In and out of PostgreSQL using COPY"/>
<meta name="twitter:description" content="I am pretty sure everyone of us has been in a situation where you needed to generate a report and/or extract some data from a database and present it in a spreadsheet. In many cases, our clients prefer Excel to handle spreadsheets/reports, because, duh, it&#39;s Excel.
So, how do you approach this problem? Do you copy and paste data? Or use a RDBMS GUI to generate the report into a spreadsheet?"/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://ieftimov.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://ieftimov.com/css/main.css" />
		<link rel="stylesheet" type="text/css" href="https://ieftimov.com/css/overrides.css" />
	

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="https://ieftimov.com/js/main.js"></script><script src="https://ieftimov.com/js/tooltip.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="https://ieftimov.com/">
				<img src="https://pbs.twimg.com/profile_images/1194757753585225728/JbET17PZ_400x400.jpg" alt="Ilija Eftimov" />
			</a>
		</div>
	
	<h1 class="site-title"><a href="https://ieftimov.com/">Ilija Eftimov</a></h1>
	<div class="site-description"><p>Software engineer, author and open source contributor</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/fteem" title="Github"><i data-feather="github"></i></a></li><li><a href="https://twitter.com/fteem" title="Twitter"><i data-feather="twitter"></i></a></li><li><a href="https://www.linkedin.com/in/ieftimov" title="Linkedin"><i data-feather="linkedin"></i></a></li><li><a href="mailto:blog@ieftimov.com" title="Email"><i data-feather="mail"></i></a></li></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/categories/testing-in-go">Testing in Go</a>
			</li>
			
			<li>
				<a href="/posts">Archive</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="https://forms.gle/orfXK5jh1LRaiFzo8">Suggest a topic</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">12</span>
							<span class="rest">Jun 2015</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">In and out of PostgreSQL using COPY</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>I am pretty sure everyone of us has been in a situation where you needed to
generate a report and/or extract some data from a database and present it in a spreadsheet.
In many cases, our clients prefer Excel to handle spreadsheets/reports, because, duh, it's Excel.</p>
<p>So, how do you approach this problem? Do you copy and paste data? Or use a RDBMS GUI to
generate the report into a spreadsheet? Today, I'll show you a really small but convenient feature
of PostgreSQL - <a href="http://www.postgresql.org/docs/9.2/static/sql-copy.html">COPY</a>.</p>
<h2 id="hello-copy">Hello COPY</h2>
<p>From the <a href="http://www.postgresql.org/docs/9.2/static/sql-copy.html">COPY</a>
documentation: &ldquo;COPY moves data between PostgreSQL tables and standard file-system files.
COPY TO copies the contents of a table to a file, while COPY FROM copies data from
a file to a table (appending the data to whatever is in the table already). COPY TO
can also copy the results of a SELECT query.&rdquo;</p>
<p>So, what does COPY do:</p>
<ol>
<li>It can copy the contents of a file (data) to a table, or</li>
<li>It can copy the contents of a table (or a SELECT query result) into a file.</li>
</ol>
<p>If a list of columns is specified, COPY will only copy the data in the specified
columns to or from the file. If there are any columns in the table that are not in the column list,
COPY FROM will insert the default values for those columns.</p>
<p>COPY with a file name instructs the PostgreSQL server to directly read from or write to a file.
The file must be accessible to the server and the name must be specified from the viewpoint of the server.
When STDIN or STDOUT is specified, data is transmitted via the connection between the client and the server.</p>
<p>Sounds good? Let's give it a try!</p>
<p>Disclaimer: COPY has the ability to read/write data from/to CSV and Binary files. Although I am
sure there are lots of usecases for using binary files, in this blogpost I will
only focus on using it for CSV files because, personally for me, they are the most
convenient for handing data sets.</p>
<h2 id="copy-to">COPY TO</h2>
<p>When you want to create a CSV file out of a SELECT query, or dump all of the contents of
a table in a CSV file, you can use the &ldquo;COPY &hellip; TO &hellip;&rdquo; command.</p>
<h3 id="using-a-select-query">Using a SELECT query</h3>
<p>When you want to copy a result set to a CSV file, the format of the COPY command is:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="font-weight:bold">COPY</span> (<span style="font-weight:bold">&lt;</span><span style="font-weight:bold">select</span><span style="font-weight:bold">-</span>query<span style="font-weight:bold">-</span>here<span style="font-weight:bold">&gt;</span>) <span style="font-weight:bold">TO</span> <span style="font-weight:bold">&lt;</span>file<span style="font-weight:bold">-</span>path<span style="font-weight:bold">&gt;</span>;</code></pre></div>
<p>Or, a more real-life example:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="font-weight:bold">COPY</span> (<span style="font-weight:bold">SELECT</span> <span style="font-weight:bold">*</span> <span style="font-weight:bold">FROM</span> people <span style="font-weight:bold">WHERE</span> age <span style="font-weight:bold">&gt;</span> <span style="color:#099">21</span>) <span style="font-weight:bold">TO</span> <span style="color:#b84">&#39;</span><span style="color:#b84">~/Desktop/adults.csv</span><span style="color:#b84">&#39;</span>;</code></pre></div>
<p>As you can see, we use the COPY command which copies the results into a CSV file on the local filesystem.
You can take the query a lot further. Here's a real life example of a project that I am
currently working on:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="font-weight:bold">COPY</span> (<span style="font-weight:bold">SELECT</span> price_rules.<span style="font-weight:bold">*</span> <span style="font-weight:bold">FROM</span> quotes <span style="font-weight:bold">LEFT</span> <span style="font-weight:bold">JOIN</span> price_rules <span style="font-weight:bold">ON</span> quotes.id <span style="font-weight:bold">=</span> price_rules.chargeable_id <span style="font-weight:bold">where</span> quotes.id <span style="font-weight:bold">=</span> <span style="color:#099">437</span>) <span style="font-weight:bold">TO</span> <span style="color:#b84">&#39;</span><span style="color:#b84">~/Desktop/exports/price_rules.csv</span><span style="color:#b84">&#39;</span> CSV;</code></pre></div>
<p>As you can see, you can use any SELECT query that can will return a data result set.
But, what's a CSV without headers, right? :-)</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="font-weight:bold">COPY</span> (<span style="font-weight:bold">SELECT</span> <span style="font-weight:bold">*</span> <span style="font-weight:bold">FROM</span> people <span style="font-weight:bold">WHERE</span> age <span style="font-weight:bold">&gt;</span> <span style="color:#099">21</span>) <span style="font-weight:bold">TO</span> <span style="color:#b84">&#39;</span><span style="color:#b84">~/Desktop/adults.csv</span><span style="color:#b84">&#39;</span> CSV HEADER;</code></pre></div>
<p>Adding the keyword HEADER at the end will include headers in the CSV file, which
are the table column names.</p>
<p>Also, another key feature of CSV files are the delimiters. Depending on what character
delimiter you want the CSV file to have, you can specify the character in the command:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="font-weight:bold">COPY</span> (<span style="font-weight:bold">SELECT</span> <span style="font-weight:bold">*</span> <span style="font-weight:bold">FROM</span> people <span style="font-weight:bold">WHERE</span> age <span style="font-weight:bold">&gt;</span> <span style="color:#099">21</span>) <span style="font-weight:bold">TO</span> <span style="color:#b84">&#39;</span><span style="color:#b84">~/Desktop/adults.csv</span><span style="color:#b84">&#39;</span> CSV <span style="font-weight:bold">DELIMITER</span> <span style="color:#b84">&#39;</span><span style="color:#b84">,</span><span style="color:#b84">&#39;</span> HEADER;</code></pre></div>
<h3 id="using-a-table-name">Using a table name</h3>
<p>When you want a whole table to be dumped into a CSV, the command is really simpler.
You just need to specify the table name and the target file:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="font-weight:bold">COPY</span> people <span style="font-weight:bold">TO</span> <span style="color:#b84">&#39;</span><span style="color:#b84">~/Desktop/people.csv</span><span style="color:#b84">&#39;</span> CSV <span style="font-weight:bold">DELIMITER</span> <span style="color:#b84">&#39;</span><span style="color:#b84">,</span><span style="color:#b84">&#39;</span> HEADER;</code></pre></div>
<p>That's it.</p>
<h2 id="copy-from">COPY FROM</h2>
<p>Now, when you want to inject the data from the CSV file into a table, you can use the
&ldquo;COPY &hellip; FROM &hellip;&rdquo; command. The syntax is very simillar, with only one key difference:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="font-weight:bold">COPY</span> <span style="font-weight:bold">&lt;</span><span style="font-weight:bold">table</span><span style="font-weight:bold">-</span>name<span style="font-weight:bold">&gt;</span> <span style="font-weight:bold">FROM</span> <span style="font-weight:bold">&lt;</span>file<span style="font-weight:bold">-</span>path<span style="font-weight:bold">&gt;</span> <span style="font-weight:bold">DELIMITER</span> <span style="color:#b84">&#39;</span><span style="color:#b84">,</span><span style="color:#b84">&#39;</span> CSV HEADER;</code></pre></div>
<p>Or, using a real life example:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="font-weight:bold">COPY</span> addresses <span style="font-weight:bold">FROM</span> <span style="color:#b84">&#39;</span><span style="color:#b84">~/Desktop/addresses.csv</span><span style="color:#b84">&#39;</span> <span style="font-weight:bold">DELIMITER</span> <span style="color:#b84">&#39;</span><span style="color:#b84">,</span><span style="color:#b84">&#39;</span> CSV HEADER;</code></pre></div>
<h2 id="outro">Outro</h2>
<p>COPY is a really neat and cool feature of Postgres. For brewity, I tried to keep this
blogpost short and simple. If you have any thoughts and questions feel free to drop me a comment.
Or, if you don't feel chatty, you can head over to the <a href="http://www.postgresql.org/docs/9.4/static/sql-copy.html">COPY documentation</a>.</p>







<div id="mc_embed_signup">
<form action="https://pm.us20.list-manage.com/subscribe/post?u=d9a6471309140dcd520d05346&amp;id=2aac491644" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
        <div class="heading">Join The Newsletter</div>
        <p>
            I write about backend technologies, programming and cloud architectures. Join hundreds of other developers that get my content, twice a month. Unsubscribe whenever. Never spam.
        </p>
	<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="Your email address" required>
        <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">

      
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_d9a6471309140dcd520d05346_2aac491644" tabindex="-1" value=""></div>

    <p>You can also subscribe <a href="/index.xml">via RSS</a>.</p>
    </div>
</form>
</div>



			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="/tags/copy">copy</a></li>
							
							<li><a href="/tags/csv">csv</a></li>
							
						</ul>
					
				
			</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = 'eftimov';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
		Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> Copyright © 2014 - 2019 Ilija Eftimov |  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-11264459-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
