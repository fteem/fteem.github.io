<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Refactoring in Ruby: TDD your way through Extract Class - Ilija Eftimov</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta itemprop="name" content="Refactoring in Ruby: TDD your way through Extract Class">
<meta itemprop="description" content="There are a lot of refactoring patterns available out there for us. I assume that most of us use these patterns, at certain times without being aware that those refactoring steps are defined as a pattern in the past. In this post, I will take you through an example of refactoring Ruby code with the Extract Class pattern by using Test-Driven Development.
Let&#39;s dive in!
What went wrong at the test?">

<meta itemprop="wordCount" content="1947">



<meta itemprop="keywords" content="tdd,extract,class," /><meta property="og:title" content="Refactoring in Ruby: TDD your way through Extract Class" />
<meta property="og:description" content="There are a lot of refactoring patterns available out there for us. I assume that most of us use these patterns, at certain times without being aware that those refactoring steps are defined as a pattern in the past. In this post, I will take you through an example of refactoring Ruby code with the Extract Class pattern by using Test-Driven Development.
Let&#39;s dive in!
What went wrong at the test?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ieftimov.com/post/tdd-extract-class/" />
<meta property="article:published_time" content="2015-12-28T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Refactoring in Ruby: TDD your way through Extract Class"/>
<meta name="twitter:description" content="There are a lot of refactoring patterns available out there for us. I assume that most of us use these patterns, at certain times without being aware that those refactoring steps are defined as a pattern in the past. In this post, I will take you through an example of refactoring Ruby code with the Extract Class pattern by using Test-Driven Development.
Let&#39;s dive in!
What went wrong at the test?"/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://ieftimov.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://ieftimov.com/css/main.css" />
		<link rel="stylesheet" type="text/css" href="https://ieftimov.com/css/overrides.css" />
	

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="https://ieftimov.com/css/dark.css" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="https://ieftimov.com/js/main.js"></script><script src="https://ieftimov.com/js/tooltip.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="https://ieftimov.com/">
				<img src="/avatar.png" alt="Ilija Eftimov" />
			</a>
		</div>
	
	<h1 class="site-title"><a href="https://ieftimov.com/">Ilija Eftimov</a></h1>
	<div class="site-description"><p>A human, interested in building products and software.</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/fteem" title="Github"><i data-feather="github"></i></a></li><li><a href="https://twitter.com/fteem" title="Twitter"><i data-feather="twitter"></i></a></li><li><a href="https://www.linkedin.com/in/ieftimov" title="Linkedin"><i data-feather="linkedin"></i></a></li><li><a href="mailto:blog@ieftimov.com" title="Email"><i data-feather="mail"></i></a></li><li><a href="https://t.me/ieftimovcom" title="Telegram Channel"><i data-feather="send"></i></a></li></ul>
		</nav><span class="scheme-toggle"><a href="#" id="scheme-toggle"></a></div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/categories/testing-in-go">Testing in Go</a>
			</li>
			
			<li>
				<a href="/posts">Archive</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="https://forms.gle/orfXK5jh1LRaiFzo8">Suggest a topic</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">28</span>
							<span class="rest">Dec 2015</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Refactoring in Ruby: TDD your way through Extract Class</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>There are a lot of refactoring patterns available out there for us. I assume
that most of us use these patterns, at certain times without being aware that
those refactoring steps are defined as a pattern in the past. In this post, I
will take you through an example of refactoring Ruby code with the Extract
Class pattern by using Test-Driven Development.</p>
<p>Let's dive in!</p>
<h2 id="what-went-wrong-at-the-test">What went wrong at the test?</h2>
<p>Say we are professors in university and we compile a CSV file with our
students&rsquo; grades. Some of them are good, some are not that good. We want to
have a small informal meeting with the students that did not pass the exam, in
a classroom and review the tests and discuss what went wrong. Given that there
are a lot of students in our class, writing an email for each of the students
is painful.  Well, good we are programming professors, so we can write our own
little program to automate sending those emails:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#999">require</span> <span style="color:#b84">&#39;csv&#39;</span>
<span style="color:#999">require</span> <span style="color:#b84">&#39;mail&#39;</span>

<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Parser</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span>(file_path)
    @file_path <span style="font-weight:bold">=</span> file_path
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">parse!</span>
    <span style="color:#008080">CSV</span><span style="font-weight:bold">.</span>foreach(@file_path, <span style="color:#b84">headers</span>: <span style="font-weight:bold">true</span>) <span style="font-weight:bold">do</span> <span style="font-weight:bold">|</span>row<span style="font-weight:bold">|</span>
      <span style="font-weight:bold">if</span> failed_test?(row<span style="font-weight:bold">[</span><span style="color:#b84">&#34;</span><span style="color:#b84">points</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">]</span>)
        <span style="color:#008080">Mail</span><span style="font-weight:bold">.</span>deliver <span style="font-weight:bold">do</span>
          to      row<span style="font-weight:bold">[</span><span style="color:#b84">&#34;</span><span style="color:#b84">email</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">]</span>
          from    <span style="color:#b84">&#39;John Doe &lt;john@doe.com&gt;&#39;</span>
          subject <span style="color:#b84">&#39;Post exam meeting invitation&#39;</span>
          body    failed_exam_body(row<span style="font-weight:bold">[</span><span style="color:#b84">&#34;</span><span style="color:#b84">first_name</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">]</span>, row<span style="font-weight:bold">[</span><span style="color:#b84">&#34;</span><span style="color:#b84">points</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">]</span>)
        <span style="font-weight:bold">end</span>
      <span style="font-weight:bold">else</span>
        <span style="color:#008080">Mail</span><span style="font-weight:bold">.</span>deliver <span style="font-weight:bold">do</span>
          to      row<span style="font-weight:bold">[</span><span style="color:#b84">&#34;</span><span style="color:#b84">email</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">]</span>
          from    <span style="color:#b84">&#39;John Doe &lt;john@doe.com&gt;&#39;</span>
          subject <span style="color:#b84">&#39;Exam results&#39;</span>
          body    passed_exam_body(row<span style="font-weight:bold">[</span><span style="color:#b84">&#34;</span><span style="color:#b84">first_name</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">]</span>, row<span style="font-weight:bold">[</span><span style="color:#b84">&#34;</span><span style="color:#b84">points</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">]</span>)
        <span style="font-weight:bold">end</span>
      <span style="font-weight:bold">end</span>
    <span style="font-weight:bold">end</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">private</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">failed_test?</span>(points)
    points <span style="font-weight:bold">&lt;</span> <span style="color:#099">50</span>
  <span style="font-weight:bold"></span><span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">failed_exam_body</span>(student_name, points)
    <span style="color:#b84">%Q{</span><span style="color:#b84">
</span><span style="color:#b84">      Hi </span><span style="color:#b84">#{</span>student_name<span style="color:#b84">}</span><span style="color:#b84">,
</span><span style="color:#b84">
</span><span style="color:#b84">      On the exam last week you got </span><span style="color:#b84">#{</span>points<span style="color:#b84">}</span><span style="color:#b84"> points.
</span><span style="color:#b84">      It seems to me that you ran into some problems with it so I would like to
</span><span style="color:#b84">      invite you to a meeting in classrom 201, tomorrow at 2PM.
</span><span style="color:#b84">
</span><span style="color:#b84">      Regards,
</span><span style="color:#b84">      Prof. John Doe
</span><span style="color:#b84">    </span><span style="color:#b84">}</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">passed_exam_body</span>(student_name, points)
    <span style="color:#b84">%Q{</span><span style="color:#b84">
</span><span style="color:#b84">      Hi </span><span style="color:#b84">#{</span>student_name<span style="color:#b84">}</span><span style="color:#b84">,
</span><span style="color:#b84">
</span><span style="color:#b84">      On the exam last week you got </span><span style="color:#b84">#{</span>scored_points<span style="color:#b84">}</span><span style="color:#b84"> points.
</span><span style="color:#b84">
</span><span style="color:#b84">      Congratulations,
</span><span style="color:#b84">      Prof. John Doe
</span><span style="color:#b84">    </span><span style="color:#b84">}</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>As you can see, it's quite a simple class. It takes a CSV file path and parses
it. For each row it checks if the points are less then the minimum amount to
pass the exam. If so, then a customised email is sent to each of the students.</p>
<p>Now, if we take a moment to think about the design of this class, there's a
question that we can ask ourselves: what does this class do? Although the
question is simple, the answer can reveal something very interesting.</p>
<p>The class parses a CSV file <strong>and</strong> sends an email to each of the students that
failed the test. You see, the word &ldquo;and&rdquo; is bolded because it points out to a
code smell - violation of the Single Responsibility Principle. If you don't
know what SRP is, I recommend you check out my <a href="/solid-principles">blog post</a>
on SOLID principles.</p>
<p>So, how can we refactor our class? Well, one of the options is using the
Extract Class pattern. Let's check it out.</p>
<h2 id="extract-class-pattern">Extract Class pattern</h2>
<p>This pattern falls into a group of patterns that are used for moving features
(or functionalities) between objects. The benefit of this refactor is to make
your classes adhere to the SRP. Classes that adhere to the SRP are much easier
to understand and expand onto.</p>
<p>Now, back to the design of the class. Since we agreed that it breaks the SRP,
we need to decide which functionality we will move out into a new class. For
our example, we will let the <code>Parser</code> class just parse the CSV, while we will
create a new class called <code>Exam</code> which will contain all of the data and
behaviour around the exam data that we parse from the CSV. After that, we will
create a <code>Mailer</code> class, whose role will be just to send the email.</p>
<p>With that, we will have three classes into play - all having just <strong>one
responsibility</strong>, whether is representing an <code>Exam</code>, parsing a CSV or sending
emails.</p>
<p>The first step will be to wish the interface of the <code>Exam</code> and <code>Mailer</code> classes
and use them in the <code>Parser</code> class. This is called &ldquo;programming by <a href="http://c2.com/cgi/wiki?WishfulThinking">wishful
thinking</a>&quot;.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># parser.rb</span>
<span style="color:#999">require</span> <span style="color:#b84">&#39;csv&#39;</span>

<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Parser</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span>(file_path)
    @file_path <span style="font-weight:bold">=</span> <span style="color:#008080">File</span><span style="font-weight:bold">.</span>expand_path(file_path)
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">parse!</span>
    <span style="color:#008080">CSV</span><span style="font-weight:bold">.</span>foreach(@file_path, <span style="color:#b84">headers</span>: <span style="font-weight:bold">true</span>) <span style="font-weight:bold">do</span> <span style="font-weight:bold">|</span>row<span style="font-weight:bold">|</span>
      exam <span style="font-weight:bold">=</span> <span style="color:#008080">Exam</span><span style="font-weight:bold">.</span>new(row)
      <span style="font-weight:bold">if</span> exam<span style="font-weight:bold">.</span>failed?
        <span style="color:#008080">ExamMailer</span><span style="font-weight:bold">.</span>failed!(exam)
      <span style="font-weight:bold">else</span>
        <span style="color:#008080">ExamMailer</span><span style="font-weight:bold">.</span>passed!(exam)
      <span style="font-weight:bold">end</span>
    <span style="font-weight:bold">end</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span>

<span style="color:#008080">Parser</span><span style="font-weight:bold">.</span>new(<span style="color:#b84">&#34;</span><span style="color:#b84">grades.csv</span><span style="color:#b84">&#34;</span>)<span style="font-weight:bold">.</span>parse!</code></pre></div>
<p>Good. As you can see, we've added the new classes in <code>Parser#parse!</code> method
which radically simplified the readiness and simplicity of it. Since we now
have the classes in place, let's take a step back and use TDD to create these
classes.</p>
<h2 id="introducing-the-exam">Introducing the Exam</h2>
<p>As we said before, the <code>Exam</code> class will hold the data and represent the
behaviour of an exam. But what does that mean? Well, simply put, it will have
methods that will decide if an exam is failed based on the data (points). Let's
TDD our way through this and write some tests before we implement the class:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># exam_test.rb</span>

<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ExamTest</span> <span style="font-weight:bold">&lt;</span> <span style="color:#008080">Minitest</span><span style="font-weight:bold">::</span><span style="color:#008080">Test</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">test_it_can_be_failed</span>
    exam <span style="font-weight:bold">=</span> <span style="color:#008080">Exam</span><span style="font-weight:bold">.</span>new({ <span style="color:#b84">&#39;points&#39;</span> <span style="font-weight:bold">=</span><span style="font-weight:bold">&gt;</span> <span style="color:#b84">&#39;20&#39;</span> })
    assert exam<span style="font-weight:bold">.</span>failed?
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">test_it_can_be_passed</span>
    exam <span style="font-weight:bold">=</span> <span style="color:#008080">Exam</span><span style="font-weight:bold">.</span>new({ <span style="color:#b84">&#39;points&#39;</span> <span style="font-weight:bold">=</span><span style="font-weight:bold">&gt;</span> <span style="color:#b84">&#39;51&#39;</span> })
    assert exam<span style="font-weight:bold">.</span>passed?
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>I assume the tests are quite self explanatory. The constructor will take a hash
as an argument and extract the points from it. Then the <code>Exam#passed?</code> and
<code>Exam#failed?</code> methods will check if the exam is passed or failed. The rule
here is that an exam is failed if it has less than 50 points scored. Let's
implement this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># exam.rb</span>

<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Exam</span>
  <span style="font-weight:bold">attr_reader</span> <span style="color:#b84">:scored_points</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span>(entry)
    @scored_points <span style="font-weight:bold">=</span> entry<span style="font-weight:bold">[</span><span style="color:#b84">&#39;points&#39;</span><span style="font-weight:bold">]</span><span style="font-weight:bold">.</span>to_i
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">failed?</span>
    @scored_points <span style="font-weight:bold">&lt;</span> <span style="color:#099">50</span>
  <span style="font-weight:bold"></span><span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">passed?</span>
    <span style="font-weight:bold">!</span>failed?
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>Really easy, right? If we run the tests, they will pass. Additionally we will
need the exam to contain the data for the student which has taken the exam.
Some of you might think that a student should be a separate object and I would
say that you are right. Also, others might say that there can be separate
classes for a failed and passed exams.</p>
<p>But, for this example we can keep it really simple. Let's add some tests for
the attribute readers:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ExamTest</span> <span style="font-weight:bold">&lt;</span> <span style="color:#008080">Minitest</span><span style="font-weight:bold">::</span><span style="color:#008080">Test</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">test_student_name</span>
    student_name <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;Ilija&#39;</span>
    exam <span style="font-weight:bold">=</span> <span style="color:#008080">Exam</span><span style="font-weight:bold">.</span>new({ <span style="color:#b84">&#39;first_name&#39;</span> <span style="font-weight:bold">=</span><span style="font-weight:bold">&gt;</span> student_name })

    assert_equal student_name, exam<span style="font-weight:bold">.</span>student_name
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">test_student_email</span>
    student_email <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;ile@eftimov.net&#39;</span>
    exam <span style="font-weight:bold">=</span> <span style="color:#008080">Exam</span><span style="font-weight:bold">.</span>new({ <span style="color:#b84">&#39;email&#39;</span> <span style="font-weight:bold">=</span><span style="font-weight:bold">&gt;</span> student_email })

    assert_equal student_email, exam<span style="font-weight:bold">.</span>student_email
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">test_failure</span>
    exam <span style="font-weight:bold">=</span> <span style="color:#008080">Exam</span><span style="font-weight:bold">.</span>new({ <span style="color:#b84">&#39;points&#39;</span> <span style="font-weight:bold">=</span><span style="font-weight:bold">&gt;</span> <span style="color:#b84">&#39;20&#39;</span> })
    assert exam<span style="font-weight:bold">.</span>failed?
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">test_success</span>
    exam <span style="font-weight:bold">=</span> <span style="color:#008080">Exam</span><span style="font-weight:bold">.</span>new({ <span style="color:#b84">&#39;points&#39;</span> <span style="font-weight:bold">=</span><span style="font-weight:bold">&gt;</span> <span style="color:#b84">&#39;51&#39;</span> })
    assert exam<span style="font-weight:bold">.</span>passed?
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>Implementing these methods is quite easy as well:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Exam</span>
  <span style="font-weight:bold">attr_reader</span> <span style="color:#b84">:student_name</span>, <span style="color:#b84">:student_email</span>, <span style="color:#b84">:scored_points</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span>(entry)
    @student_name  <span style="font-weight:bold">=</span> entry<span style="font-weight:bold">[</span><span style="color:#b84">&#39;first_name&#39;</span><span style="font-weight:bold">]</span>
    @student_email <span style="font-weight:bold">=</span> entry<span style="font-weight:bold">[</span><span style="color:#b84">&#39;email&#39;</span><span style="font-weight:bold">]</span>
    @scored_points <span style="font-weight:bold">=</span> entry<span style="font-weight:bold">[</span><span style="color:#b84">&#39;points&#39;</span><span style="font-weight:bold">]</span><span style="font-weight:bold">.</span>to_i
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">failed?</span>
    @scored_points <span style="font-weight:bold">&lt;</span> <span style="color:#099">50</span>
  <span style="font-weight:bold"></span><span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">passed?</span>
    <span style="font-weight:bold">!</span>failed?
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>That is our <code>Exam</code> class with all of it's glory. Did you think about what we
did in this step? Really simple stuff - noticing that there is room for a class
to encapsulate all of the required data so it can answer to the question &ldquo;is
this exam failed or not?&quot;. We first wished what the interfaces of our classes
should be and then we created the first class, using TDD.</p>
<p>This is the <strong>Extract Class</strong> pattern at it's core - reducing complexity and
improving readibility by extracting data and behaviour to a new class.</p>
<p>That would be it at this moment. The <code>Exam</code> holds enough behaviour and data so
we can continue with the other classes.</p>
<h2 id="building-the-mailer">Building the mailer</h2>
<p>The next step is the <code>ExamMailer</code>. The mailer should contain only the behaviour
required to send the emails - nothing else. As we decided in the first step,
the mailer will have two methods: <code>ExamMailer.passed!</code> and
<code>ExamMailer.failed!</code>. The mailer class will use the <a href="https://github.com/mikel/mail">Mail
gem</a> to send emails.</p>
<p>Let's write some tests around them first and implement them after:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#008080">Mail</span><span style="font-weight:bold">.</span>defaults <span style="font-weight:bold">do</span>
  delivery_method <span style="color:#b84">:test</span>
<span style="font-weight:bold">end</span>

<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">MailerTest</span> <span style="font-weight:bold">&lt;</span> <span style="color:#008080">Minitest</span><span style="font-weight:bold">::</span><span style="color:#008080">Test</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">setup</span>
    <span style="color:#008080">Mail</span><span style="font-weight:bold">::</span><span style="color:#008080">TestMailer</span><span style="font-weight:bold">.</span>deliveries<span style="font-weight:bold">.</span>clear
    @student_mail <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;john@doe.com&#39;</span>
    @student_name <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;John&#39;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">test_failed_exam_mail</span>
    points <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;49&#39;</span>
    exam <span style="font-weight:bold">=</span> <span style="color:#008080">Exam</span><span style="font-weight:bold">.</span>new({ <span style="color:#b84">&#39;points&#39;</span> <span style="font-weight:bold">=</span><span style="font-weight:bold">&gt;</span> points,
                      <span style="color:#b84">&#39;email&#39;</span> <span style="font-weight:bold">=</span><span style="font-weight:bold">&gt;</span> @student_mail,
                      <span style="color:#b84">&#39;first_name&#39;</span> <span style="font-weight:bold">=</span><span style="font-weight:bold">&gt;</span> @student_name })
    <span style="color:#008080">ExamMailer</span><span style="font-weight:bold">.</span>failed!(exam)
    mail <span style="font-weight:bold">=</span> <span style="color:#008080">Mail</span><span style="font-weight:bold">::</span><span style="color:#008080">TestMailer</span><span style="font-weight:bold">.</span>deliveries<span style="font-weight:bold">.</span>first

    assert_equal @student_mail, mail<span style="font-weight:bold">.</span>to<span style="font-weight:bold">.</span>first
    assert_equal <span style="color:#b84">&#34;</span><span style="color:#b84">Post exam meeting invitation</span><span style="color:#b84">&#34;</span>, mail<span style="font-weight:bold">.</span>subject
    assert_match <span style="color:#808000">/</span><span style="color:#808000">you got </span><span style="color:#b84">#{</span>points<span style="color:#b84">}</span><span style="color:#808000"> points</span><span style="color:#808000">/i</span>, mail<span style="font-weight:bold">.</span>body<span style="font-weight:bold">.</span>raw_source
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">test_passed_exam_mail</span>
    points <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;50&#39;</span>
    exam <span style="font-weight:bold">=</span> <span style="color:#008080">Exam</span><span style="font-weight:bold">.</span>new({ <span style="color:#b84">&#39;points&#39;</span> <span style="font-weight:bold">=</span><span style="font-weight:bold">&gt;</span> points,
                      <span style="color:#b84">&#39;email&#39;</span> <span style="font-weight:bold">=</span><span style="font-weight:bold">&gt;</span> @student_mail,
                      <span style="color:#b84">&#39;first_name&#39;</span> <span style="font-weight:bold">=</span><span style="font-weight:bold">&gt;</span> @student_name })
    <span style="color:#008080">ExamMailer</span><span style="font-weight:bold">.</span>passed!(exam)
    mail <span style="font-weight:bold">=</span> <span style="color:#008080">Mail</span><span style="font-weight:bold">::</span><span style="color:#008080">TestMailer</span><span style="font-weight:bold">.</span>deliveries<span style="font-weight:bold">.</span>first

    assert_equal @student_mail, mail<span style="font-weight:bold">.</span>to<span style="font-weight:bold">.</span>first
    assert_equal <span style="color:#b84">&#34;</span><span style="color:#b84">Exam results</span><span style="color:#b84">&#34;</span>, mail<span style="font-weight:bold">.</span>subject
    assert_match <span style="color:#808000">/</span><span style="color:#808000">you got </span><span style="color:#b84">#{</span>points<span style="color:#b84">}</span><span style="color:#808000"> points</span><span style="color:#808000">/i</span>, mail<span style="font-weight:bold">.</span>body<span style="font-weight:bold">.</span>raw_source
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>Now, there's a bit of boilerplate code here, which deals with the Mail gem. In
the beginning of the file, we set the delivery method of the Mail gem to be
<code>:test</code>. This means that the gem will hold all of the emails that are sent in
memory, without trying to make an actual delivery. Also, in our <code>setup</code> method
we invoke the <code>Mail::TestMailer.deliveries.clear</code> method, which clears the
deliveries collection before running each test. This is done so we have a fresh
collection of sent emails for each test, which helps with avoiding any
confusion.</p>
<p>As you can notice in the tests, we assert on the recipient email, on the e-mail
subject and on the e-mail body. With this step, we want to make sure that the
most essential parts of the e-mail (recipient, body and subject) are correct.</p>
<p>Extracting the mailer logic from the initial script to a new mailer class is
rather simple:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#999">require</span> <span style="color:#b84">&#39;mail&#39;</span>

<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ExamMailer</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold">self</span><span style="font-weight:bold">.</span><span style="color:#900;font-weight:bold">failed!</span>(exam)
    <span style="font-weight:bold">new</span>(exam)<span style="font-weight:bold">.</span>failed!
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold">self</span><span style="font-weight:bold">.</span><span style="color:#900;font-weight:bold">passed!</span>(exam)
    <span style="font-weight:bold">new</span>(exam)<span style="font-weight:bold">.</span>passed!
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span>(exam)
    @exam <span style="font-weight:bold">=</span> exam
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">failed!</span>
    send_mail!(<span style="color:#b84">&#39;Post exam meeting invitation&#39;</span>, failed_exam_email_body)
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">passed!</span>
    send_mail!(<span style="color:#b84">&#39;Exam results&#39;</span>, passed_exam_email_body)
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">private</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">send_mail!</span>(subject, body)
    mail <span style="font-weight:bold">=</span> <span style="color:#008080">Mail</span><span style="font-weight:bold">.</span>new
    mail<span style="font-weight:bold">.</span>to <span style="font-weight:bold">=</span> @exam<span style="font-weight:bold">.</span>student_email
    mail<span style="font-weight:bold">.</span>from <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;John Doe &lt;john@doe.com&gt;&#39;</span>
    mail<span style="font-weight:bold">.</span>subject <span style="font-weight:bold">=</span> subject
    mail<span style="font-weight:bold">.</span>body <span style="font-weight:bold">=</span> body
    mail<span style="font-weight:bold">.</span>deliver
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">passed_exam_email_body</span>
    <span style="color:#b84">%Q{</span><span style="color:#b84">
</span><span style="color:#b84">      Hi </span><span style="color:#b84">#{</span>@exam<span style="font-weight:bold">.</span>student_name<span style="color:#b84">}</span><span style="color:#b84">,
</span><span style="color:#b84">
</span><span style="color:#b84">      On the exam last week you got </span><span style="color:#b84">#{</span>@exam<span style="font-weight:bold">.</span>scored_points<span style="color:#b84">}</span><span style="color:#b84"> points.
</span><span style="color:#b84">
</span><span style="color:#b84">      Congratulations,
</span><span style="color:#b84">      Prof. John Doe
</span><span style="color:#b84">    </span><span style="color:#b84">}</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">failed_exam_email_body</span>
    <span style="color:#b84">%Q{</span><span style="color:#b84">
</span><span style="color:#b84">      Hi </span><span style="color:#b84">#{</span>@exam<span style="font-weight:bold">.</span>student_name<span style="color:#b84">}</span><span style="color:#b84">,
</span><span style="color:#b84">
</span><span style="color:#b84">      On the exam last week you got </span><span style="color:#b84">#{</span>@exam<span style="font-weight:bold">.</span>scored_points<span style="color:#b84">}</span><span style="color:#b84"> points.
</span><span style="color:#b84">      It seems to me that you ran into some problems with it so I would like to
</span><span style="color:#b84">      invite you to a group meeting in classrom 201, tomorrow at 2PM.
</span><span style="color:#b84">
</span><span style="color:#b84">      Regards,
</span><span style="color:#b84">      Prof. John Doe
</span><span style="color:#b84">    </span><span style="color:#b84">}</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>Most of the magic lies within the <code>send_mail!</code> method. It builds a new <code>Mail</code>
object and delivers it.</p>
<p>As you saw in this step, we extracted the mailing logic from the script to a
new well-defined class. The next (and last step) is reviewing the original
<code>Parser</code> class and pondering a bit with it.</p>
<h2 id="back-to-the-parser">Back to the parser</h2>
<p>After we did all of the hard work around extracting two new classes and writing
tests for them, it is time to take a look at the <code>Parser</code> class. I would say
that improving it further would be over-engineering it, at least in the scope
of this article. The only thing that I would like us to think about is the name
of the class. Does <code>Parser</code> do it?</p>
<p>This is quite subjective and I would guess some of you wouldn't agree with me,
but in my mind the <code>Parser</code> is quite broad term. In this instance, I think that
<code>Grader</code> is a better name for it.</p>
<h2 id="taking-a-step-back">Taking a step back</h2>
<p>As you could see in this article, there's quite a bit of work around
refactoring existing code. There are more than a two dozen patterns around
refactoring, with Extract Class being one of the simplest ones. Having this
said, I would like to ask you a question:</p>
<p>Do you really need to think in patterns? Do we really need to have a
&ldquo;predefined sequence of steps&rdquo; to make our code better?</p>
<p>I think that it's not really about applying a certain pattern, it's more about
caring about the design of the code and writing tests for it. As a rule of
thumb, I always try to think about the five <a href="/solid-principles">SOLID
principles</a> when writing my code.  And when you are
refactoring - understand the motivation and the context behind the code that
you are refactoring, without focusing on which pattern you will apply.</p>

			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="/tags/tdd">tdd</a></li>
							
							<li><a href="/tags/extract">extract</a></li>
							
							<li><a href="/tags/class">class</a></li>
							
						</ul>
					
				
			</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = 'eftimov';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the </a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2015  Copyright Â© Ilija Eftimov |  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-11264459-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
