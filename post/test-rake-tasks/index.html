<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Why and how to test Rake tasks in your Rails application - Ilija Eftimov</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta itemprop="name" content="Why and how to test Rake tasks in your Rails application">
<meta itemprop="description" content="Most of us write some Rake tasks and completely forget about them. In fact, we rarely give any love to our Rake tasks. Well, I think it&#39;s time we change that. Let&#39;s see why and how we can test our Rake tasks.
But, why? Yes, it&#39;s a legit question. You can always say &ldquo;I already tested my classes!&quot;. But, there are couple of reasons why you should always test your Rake tasks:">

<meta itemprop="wordCount" content="940">



<meta itemprop="keywords" content="rake," /><meta property="og:title" content="Why and how to test Rake tasks in your Rails application" />
<meta property="og:description" content="Most of us write some Rake tasks and completely forget about them. In fact, we rarely give any love to our Rake tasks. Well, I think it&#39;s time we change that. Let&#39;s see why and how we can test our Rake tasks.
But, why? Yes, it&#39;s a legit question. You can always say &ldquo;I already tested my classes!&quot;. But, there are couple of reasons why you should always test your Rake tasks:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ieftimov.com/post/test-rake-tasks/" />
<meta property="article:published_time" content="2015-12-03T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Why and how to test Rake tasks in your Rails application"/>
<meta name="twitter:description" content="Most of us write some Rake tasks and completely forget about them. In fact, we rarely give any love to our Rake tasks. Well, I think it&#39;s time we change that. Let&#39;s see why and how we can test our Rake tasks.
But, why? Yes, it&#39;s a legit question. You can always say &ldquo;I already tested my classes!&quot;. But, there are couple of reasons why you should always test your Rake tasks:"/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://ieftimov.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://ieftimov.com/css/main.css" />
		<link rel="stylesheet" type="text/css" href="https://ieftimov.com/css/overrides.css" />
	

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="https://ieftimov.com/css/dark.css" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="https://ieftimov.com/js/main.js"></script><script src="https://ieftimov.com/js/tooltip.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="https://ieftimov.com/">
				<img src="/avatar.png" alt="Ilija Eftimov" />
			</a>
		</div>
	
	<h1 class="site-title"><a href="https://ieftimov.com/">Ilija Eftimov</a></h1>
	<div class="site-description"><p>A human, interested in building products and software.</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/fteem" title="Github"><i data-feather="github"></i></a></li><li><a href="https://twitter.com/fteem" title="Twitter"><i data-feather="twitter"></i></a></li><li><a href="https://www.linkedin.com/in/ieftimov" title="Linkedin"><i data-feather="linkedin"></i></a></li><li><a href="mailto:blog@ieftimov.com" title="Email"><i data-feather="mail"></i></a></li></ul>
		</nav><span class="scheme-toggle"><a href="#" id="scheme-toggle"></a></div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/categories/testing-in-go">Testing in Go</a>
			</li>
			
			<li>
				<a href="/posts">Archive</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="https://forms.gle/orfXK5jh1LRaiFzo8">Suggest a topic</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">03</span>
							<span class="rest">Dec 2015</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Why and how to test Rake tasks in your Rails application</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>Most of us write some Rake tasks and completely forget about them. In fact, we
rarely give any love to our Rake tasks. Well, I think it's time we change that.
Let's see why and how we can test our Rake tasks.</p>
<h2 id="but-why">But, why?</h2>
<p>Yes, it's a legit question. You can always say &ldquo;I already tested my classes!&quot;.
But, there are couple of reasons why you should always test your Rake tasks:</p>
<ol>
<li>Rake tasks is code. And all code should be tested.</li>
<li>Rake tasks can use any part of your app. Models, service classes and what
not.  If one of the classes that the Rake task relies on changes, you have
to know if it will break it.</li>
<li>Rake tasks can do heavy lifting. Perhaps you have a cron on Heroku that runs
an email campaign that calls a Rake task. Or you generate reports with a
Rake task. This is important and you need to know if it actually works.</li>
<li>Forgetting about your Rake tasks is easy. Or, if you inherit a codebase it's
easy to not even notice them when beginning the project. Rake tasks are code
as well and breaking it is easy.</li>
</ol>
<p>So, yeah, test your Rake tasks!</p>
<h2 id="the-rake-task">The Rake task</h2>
<p>For our example application, let's imagine we have an application where users
can register. But, just like with most of the websites online, people sometimes
register but they do not finish the registration process. Often, the database
can be polluted with records of unfinished user registration.</p>
<p>The application has a Rake task that deletes users that haven't finished their
registration process.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># lib/tasks/users/remove_unconfirmed.rb</span>
namespace <span style="color:#b84">:users</span> <span style="font-weight:bold">do</span>
  desc <span style="color:#b84">&#34;</span><span style="color:#b84">Delete users that have not finished the registration process</span><span style="color:#b84">&#34;</span>
  task <span style="color:#b84">:remove_unconfirmed</span> <span style="font-weight:bold">do</span>
    <span style="color:#008080">User</span><span style="font-weight:bold">.</span>unconfirmed<span style="font-weight:bold">.</span>each {<span style="font-weight:bold">|</span>user<span style="font-weight:bold">|</span> user<span style="font-weight:bold">.</span>delete }
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>This task is run with as a cron job. Let's see how we can test it.</p>
<p>Lately, I prefer testing with Minitest. I like it because it's really tiny,
quite verbose, magic-less and it's pure Ruby. Now, since Test::Unit is
basically syntactic-sugar on top of Minitest, I will show you how to test the
Rake task with it.</p>
<h2 id="integration-test">Integration test</h2>
<p>We will take for granted that the <code>User</code> model and the <code>UserMailer</code> are already
tested. Our next objective is to test this Rake task. We will need one test for
this task - it will check that the task deletes the unconfirmed user. This is
basically an integration test that will work with actual records in the
database.</p>
<p>Whenever you are testing Rake tasks, you need to load the tasks from the Rails
application itself. Note that in your tests you should change <code>MyApplication</code>
to the name of your application.</p>
<p>The test will look like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># test/lib/user_notify_test.rb</span>
<span style="color:#999">require</span> <span style="color:#b84">&#39;test_helper&#39;</span>

<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">RemoveUnconfirmedTaskTest</span> <span style="font-weight:bold">&lt;</span> <span style="color:#008080">ActiveSupport</span><span style="font-weight:bold">::</span><span style="color:#008080">TestCase</span>
  setup <span style="font-weight:bold">do</span>
    @confirmed_user <span style="font-weight:bold">=</span> <span style="color:#008080">User</span><span style="font-weight:bold">.</span>create(<span style="color:#b84">email</span>: <span style="color:#b84">&#34;</span><span style="color:#b84">john@appleseed.com</span><span style="color:#b84">&#34;</span>, <span style="color:#b84">confirmed_at</span>: <span style="color:#008080">Time</span><span style="font-weight:bold">.</span>now)
    @unconfirmed_user <span style="font-weight:bold">=</span> <span style="color:#008080">User</span><span style="font-weight:bold">.</span>create(<span style="color:#b84">email</span>: <span style="color:#b84">&#34;</span><span style="color:#b84">jane@doe.com</span><span style="color:#b84">&#34;</span>, <span style="color:#b84">confirmed_at</span>: <span style="font-weight:bold">nil</span>)
    <span style="color:#008080">MyApplication</span><span style="font-weight:bold">::</span><span style="color:#008080">Application</span><span style="font-weight:bold">.</span>load_tasks
    <span style="color:#008080">Rake</span><span style="font-weight:bold">::</span><span style="color:#008080">Task</span><span style="font-weight:bold">[</span><span style="color:#b84">&#39;users:remove_unconfirmed&#39;</span><span style="font-weight:bold">]</span><span style="font-weight:bold">.</span>invoke
  <span style="font-weight:bold">end</span>

  <span style="color:#999">test</span> <span style="color:#b84">&#34;</span><span style="color:#b84">unconfirmed user is deleted</span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">do</span>
    assert_nil <span style="color:#008080">User</span><span style="font-weight:bold">.</span>find_by(<span style="color:#b84">email</span>: <span style="color:#b84">&#34;</span><span style="color:#b84">jane@doe.com</span><span style="color:#b84">&#34;</span>)
  <span style="font-weight:bold">end</span>

  <span style="color:#999">test</span> <span style="color:#b84">&#34;</span><span style="color:#b84">confimed user is not deleted</span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">do</span>
    assert_equal @confimed_user, <span style="color:#008080">User</span><span style="font-weight:bold">.</span>find_by(<span style="color:#b84">email</span>: <span style="color:#b84">&#34;</span><span style="color:#b84">john@appleseed.com</span><span style="color:#b84">&#34;</span>)
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>Now, in the <code>setup</code> step, we create two users - one which will be confirmed and
one unconfirmed. Then, we load the tasks from the application. This is done by
adding:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#008080">MyApplication</span><span style="font-weight:bold">::</span><span style="color:#008080">Application</span><span style="font-weight:bold">.</span>load_tasks</code></pre></div>
<p>This task basically requires rake and loads each file in the <code>lib/tasks</code> path.
You can see it's source
<a href="https://github.com/rails/rails/blob/0450642c27af3af35b449208b21695fd55c30f90/railties/lib/rails/engine.rb#L455">here</a>.
Next, we invoke the task itself. We do this by adding this in our test:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#008080">Rake</span><span style="font-weight:bold">::</span><span style="color:#008080">Task</span><span style="font-weight:bold">[</span><span style="color:#b84">&#39;users:remove_unconfirmed&#39;</span><span style="font-weight:bold">]</span><span style="font-weight:bold">.</span>invoke</code></pre></div>
<p>This line locates the task by it's name and returns a <code>Rake::Task</code> object.
Then, we call <code>invoke</code> on it, which executes the task. After that we make
assertions on the data in the database, expecting the unconfirmed user to be
removed from the database.</p>
<h2 id="unit-test">Unit test</h2>
<p>Another approach at testing this is exctracting the logic from the Rake task to
a utility class. Then, we would call the method from the class that contains
the logic in the Rake task.</p>
<p>Let's create a <code>UserRemoval</code> class, with a class method called
<code>remove_unconfirmed</code>.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserRemoval</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold">self</span><span style="font-weight:bold">.</span><span style="color:#900;font-weight:bold">remove_unconfirmed!</span>
    <span style="color:#008080">User</span><span style="font-weight:bold">.</span>unconfirmed<span style="font-weight:bold">.</span>each {<span style="font-weight:bold">|</span>user<span style="font-weight:bold">|</span> user<span style="font-weight:bold">.</span>delete }
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>Then, our Rake task would look like:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># lib/tasks/users/remove_unconfirmed.rb</span>
namespace <span style="color:#b84">:users</span> <span style="font-weight:bold">do</span>
  desc <span style="color:#b84">&#34;</span><span style="color:#b84">Delete users that have not finished the registration process</span><span style="color:#b84">&#34;</span>
  task <span style="color:#b84">:remove_unconfirmed</span> <span style="font-weight:bold">do</span>
    <span style="color:#008080">UserRemoval</span><span style="font-weight:bold">.</span>remove_unconfirmed!
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>Since all of the logic in the rake task is contained in another class, we can
test the class itself, instead of testing the task. This is quite trivial,
since we can pretty much use the same test, with some small changes.</p>
<p>The test would look like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># test/lib/user_notify_test.rb</span>
<span style="color:#999">require</span> <span style="color:#b84">&#39;test_helper&#39;</span>

<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserRemovalTest</span> <span style="font-weight:bold">&lt;</span> <span style="color:#008080">ActiveSupport</span><span style="font-weight:bold">::</span><span style="color:#008080">TestCase</span>
  setup <span style="font-weight:bold">do</span>
    @confirmed_user <span style="font-weight:bold">=</span> <span style="color:#008080">User</span><span style="font-weight:bold">.</span>create(<span style="color:#b84">email</span>: <span style="color:#b84">&#34;</span><span style="color:#b84">john@appleseed.com</span><span style="color:#b84">&#34;</span>, <span style="color:#b84">confirmed_at</span>: <span style="color:#008080">Time</span><span style="font-weight:bold">.</span>now)
    @unconfirmed_user <span style="font-weight:bold">=</span> <span style="color:#008080">User</span><span style="font-weight:bold">.</span>create(<span style="color:#b84">email</span>: <span style="color:#b84">&#34;</span><span style="color:#b84">jane@doe.com</span><span style="color:#b84">&#34;</span>, <span style="color:#b84">confirmed_at</span>: <span style="font-weight:bold">nil</span>)
    <span style="color:#008080">UserRemoval</span><span style="font-weight:bold">.</span>remove_unconfirmed!
  <span style="font-weight:bold">end</span>

  <span style="color:#999">test</span> <span style="color:#b84">&#34;</span><span style="color:#b84">unconfirmed user is deleted</span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">do</span>
    assert_nil <span style="color:#008080">User</span><span style="font-weight:bold">.</span>find_by(<span style="color:#b84">email</span>: <span style="color:#b84">&#34;</span><span style="color:#b84">jane@doe.com</span><span style="color:#b84">&#34;</span>)
  <span style="font-weight:bold">end</span>

  <span style="color:#999">test</span> <span style="color:#b84">&#34;</span><span style="color:#b84">confimed user is not deleted</span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">do</span>
    assert_equal @confimed_user, <span style="color:#008080">User</span><span style="font-weight:bold">.</span>find_by(<span style="color:#b84">email</span>: <span style="color:#b84">&#34;</span><span style="color:#b84">john@appleseed.com</span><span style="color:#b84">&#34;</span>)
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>As you can notice, the test is basically the same, without loading/invoking the
Rake task. Instead, we just call the <code>UserRemoval.remove_unconfirmed!</code> method.</p>
<p>Now, we could stub out the calls to the database and isolate the tests from
database IO, but I usually prefer to do these cheap tests with real databse
records.</p>
<h2 id="outro">Outro</h2>
<p>Now, I know that this is quite a beginner tutorial on testing Rake tasks and I
am sure it didn't rock the world of someone adept at Ruby and testing. But, I
have been asked on couple of occasions about this and have seen some questions
on Stack Overflow about it so I figured it would be nice to document it
somewhere.</p>
<p>What do you think about testing Rake tasks? Do you test them? If you do, do you
write integration tests or maybe you prefer unit tests with mocks? Or, maybe
you take another approach?</p>
<p>Let me know in the comments!</p>

			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="/tags/rake">rake</a></li>
							
						</ul>
					
				
			</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = 'eftimov';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the </a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2015  Copyright Â© Ilija Eftimov |  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-11264459-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
