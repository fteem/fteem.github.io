<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Four Steps to Daemonize Your Go Programs | Ilija Eftimov ⚡️</title><meta name=keywords content><meta name=description content="Hands-on introduction for the best four-step approach to daemonizing your Go programs"><meta name=author content="Ilija"><link rel=canonical href=https://ieftimov.com/post/four-steps-daemonize-your-golang-programs/><link href=/assets/css/stylesheet.min.css rel="preload stylesheet" as=style><link rel=icon href=https://ieftimov.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ieftimov.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ieftimov.com/favicon-32x32.png><link rel=apple-touch-icon href=https://ieftimov.com/apple-touch-icon.png><link rel=mask-icon href=https://ieftimov.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.81.0"><script async defer data-domain=ieftimov.com src=https://plausible.io/js/plausible.js></script><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=ieftimov data-description="Support me on Buy me a coffee!" data-message data-color=#FFDD00 data-position=Left data-x_margin=18 data-y_margin=18></script><meta property="og:title" content="Four Steps to Daemonize Your Go Programs"><meta property="og:description" content="Hands-on introduction for the best four-step approach to daemonizing your Go programs"><meta property="og:type" content="article"><meta property="og:url" content="https://ieftimov.com/post/four-steps-daemonize-your-golang-programs/"><meta property="og:image" content="https://ieftimov.com/cards/four-steps-daemonize-your-golang-programs.png"><meta property="article:published_time" content="2020-05-02T00:00:00+00:00"><meta property="article:modified_time" content="2020-05-02T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ieftimov.com/cards/four-steps-daemonize-your-golang-programs.png"><meta name=twitter:title content="Four Steps to Daemonize Your Go Programs"><meta name=twitter:description content="Hands-on introduction for the best four-step approach to daemonizing your Go programs"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ieftimov.com/posts/"},{"@type":"ListItem","position":2,"name":"Four Steps to Daemonize Your Go Programs","item":"https://ieftimov.com/post/four-steps-daemonize-your-golang-programs/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Four Steps to Daemonize Your Go Programs","name":"Four Steps to Daemonize Your Go Programs","description":"If you have ever worked with Ruby, or have maybe maintained a Rails application, I am sure the name Sidekiq will sound familiar. For those unfamiliar with the project, Sidekiq is a …","keywords":[],"articleBody":"If you have ever worked with Ruby, or have maybe maintained a Rails application, I am sure the name Sidekiq will sound familiar. For those unfamiliar with the project, Sidekiq is a job system for Ruby. It is a wildly popular project, and the author has turned it into a successful business.\nNone of the above would be relevant if Sidekiq’s author Mike Perham, in 2014, did not write a concise and informative post titled “Don’t Daemonize your Daemons!\". In it, he covers four guidelines to daemonizing programs correctly:\n Log to STDOUT Shut down on SIGTERM/SIGINT Reload config on SIGHUP Provide the necessary config file for your favorite init system to control your daemon  (You can also read the whole article on his website.)\nSo I was thinking, why don’t we explore how to apply these guidelines while daemonizing a Go program?\nWebsite Observer The program in question is a simple command-line program that can monitor any website by sending periodic HTTP requests to it. If you ever heard of Datadog’s synthetic tests or Pingdom, think of our program as their little sibling.\nThe observer program will read its configuration from flags, environment variables, or a configuration file. If the configuration is not present as a flag, it will look into the ENV vars for it and then in a configuration file (if present). If nothing is found, it will use the default value or exit with an error depending on how crucial the configuration is.\nTo do this, we will use the namsral/flag package, which is a drop-in replacement for Go’s flag package, with the addition of parsing files and environment variables. Being a drop-in replacement means that using the namsral/flag package is as simple as using the flag package from the standard library.\nFirst, observer will have a config type, which will encapsulate the configuration for the website that it will observe:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  const defaultTick = 60 * time.Second type config struct { contentType string server string statusCode int tick time.Duration url string userAgent string } func (c *config) init(args []string) error { flags := flag.NewFlagSet(args[0], flag.ExitOnError) flags.String(flag.DefaultConfigFlagname, \"\", \"Path to config file\") var ( statusCode = flags.Int(\"status\", 200, \"Response HTTP status code\") tick = flags.Duration(\"tick\", defaultTick, \"Ticking interval\") server = flags.String(\"server\", \"\", \"Server HTTP header value\") contentType = flags.String(\"content_type\", \"\", \"Content-Type HTTP header value\") userAgent = flags.String(\"user_agent\", \"\", \"User-Agent HTTP header value\") url = flags.String(\"url\", \"\", \"Request URL\") ) if err := flags.Parse(args[1:]); err != nil { return err } c.statusCode = *statusCode c.tick = *tick c.server = *server c.contentType = *contentType c.userAgent = *userAgent c.url = *url return nil }   The init function will take the command line arguments as input and build a FlagSet, which represents a set of defined flags. Each of the flags is listed and parsed; then, their values are assigned to the config. Additionally, having the flag.DefaultConfigFilename as a flag as well enables our observer to load the configuration from a config.conf file. The .conf file has a key=value format, with new lines after each key-value pair.\nHere’s the main function:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  func main() { ctx := context.Background() ctx, cancel := context.WithCancel(ctx) c := \u0026config{} defer func() { cancel() }() if err := run(ctx, c); err != nil { fmt.Fprintf(os.Stderr, \"%s\\n\", err) os.Exit(1) } }   Following Mat Ryer’s advice, we are going to keep main very thin while keeping the main logic of the observer in the run method. main here just sets up the main context that will propagate down to the run method, and it initializes the observer config. Then it passes all of the relevant arguments to the run method.\nHere’s the run method:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  func run(ctx context.Context, c *config) error { c.init(os.Args) for { select { case Done(): return nil case Tick(c.tick): resp, err := http.Get(c.url) if err != nil { return err } if resp.StatusCode != c.statusCode { log.Printf(\"Status code mismatch, got: %d\\n\", resp.StatusCode) } if s := resp.Header.Get(\"server\"); s != c.server { log.Printf(\"Server header mismatch, got: %s\\n\", s) } if ct := resp.Header.Get(\"content-type\"); ct != c.contentType { log.Printf(\"Content-Type header mismatch, got: %s\\n\", ct) } if ua := resp.Header.Get(\"user-agent\"); ua != c.userAgent { log.Printf(\"User-Agent header mismatch, got: %s\\n\", ua) } } } }   First, the run method initializes the config instance c, using the init method. Then, it loops infinitely until the context ctx is done. When ctx is done, it means the observer process is terminated, so it merely returns a nil and finishes with its execution.\nAlternatively, it will execute the other case every tick. By using the time.Tick channel here we run this code by receiving a signal through the channel every c.tick period. For example, if c.tick is 30 seconds, we will receive a signal every 30 seconds, meaning the code will run every 30 seconds.\nThe code itself is simple – it sends an HTTP GET request to the URL assigned to c.url. Once the response returns, the run method compares the relevant response headers and the status code with the once provided through the configuration. If any mismatch is detected, it logs the error.\nRunning the observer is relatively simple. One way is to supply a config file through the command line:\n1 2  $ ./observer -config ./config.conf 2020/04/23 19:41:54 Status code mismatch, got: 200   Alternatively, using flags:\n1 2 3 4  $ ./observer -status=500 -tick=10s -url=https://ieftimov.com -server=Cloudflare 2020/04/23 19:43:34 Status code mismatch, got: 200 2020/04/23 19:43:34 Server header mismatch, got: cloudflare 2020/04/23 19:43:34 Content-Type header mismatch, got: text/html; charset=utf-8   We can do the same using environment variables, or a combination of all three: config file, environment variables, and flags.\nNow, how can we apply the four simple rules of daemonization?\nLogging to STDOUT While daemons don’t have much to do with web services, one of the 12 factors of modern web services are treating logs as event streams. While the 12 factors in this particular case are not applicable, the guiding principle stays: the daemon itself should not manage log streams, nor it should not concern itself with writing to or managing log files. Instead, daemons should send their log stream, unbuffered, to STDOUT.\nThe service management system will capture each daemon’s stream. The init config file is what we will use to configure logging, such as where the logs should be stored or streamed.\nSo, how can we adapt the observer to log to STDOUT?\nFirst, we will add another argument to the run function, called out of type io.Writer. Then, we will invoke the log.SetOutput function passing the out as argument to it.\n1 2 3 4 5 6 7 8 9 10 11 12 13  func run(ctx context.Context, c *config, out io.Writer) error { c.init(os.Args) log.SetOutput(out) for { select { case Done(): return nil case Tick(c.tick): // Identical to above, removed from brewity \t} } }   By doing this, we will have to pass STDOUT from the main function, but we keep our run function more testable. Using a separate run method means we can invoke it with any instance that implements the io.Writer interface. We basically couple the run method to a behavior instead of type.\nThen, we need to update the main function to pass the additional argument to the run function when invoking it. And the io.Writer will be simple os.Stdout:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  func main() { ctx := context.Background() ctx, cancel := context.WithCancel(ctx) c := \u0026config{} defer func() { cancel() }() if err := run(ctx, c, os.Stdout); err != nil { fmt.Fprintf(os.Stderr, \"%s\\n\", err) os.Exit(1) } }   If we run the program again we won’t see a difference:\n1 2 3 4  $ ./observer -status=500 -tick=10s -url=https://ieftimov.com -server=Cloudflare 2020/04/23 19:43:34 Status code mismatch, got: 200 2020/04/23 19:43:34 Server header mismatch, got: cloudflare 2020/04/23 19:43:34 Content-Type header mismatch, got: text/html; charset=utf-8   Why is that? Well, the log package logs to STDERR by default, so there is no visible change of behavior there. Still, we make the dependency on an output stream explicit to the run function, which clearly states that run needs to know where to send its logs when running.\nShut down on SIGTERM/SIGINT In Go, having errors as values is very helpful to think about what will happen to our program if an error is returned. While this makes our Go programs always have some repetitive error handling, it also gives us confidence that our program will gracefully handle any error.\nTermination signals *nix operating systems (OS) employ a system of signals, which is a mechanism of the OS to ask a process to perform a particular action. There are two general types of signals: those that cause termination of a process and those that do not.\n(Refer to the full list of the POSIX-defined signals to learn more.)\nUsing these system signals, a process that has received one can choose one of the following behaviors to take place: perform the default POSIX-defined action, ignore the signal, or catch the signal with a signal handler and perform some sort of a custom action.\nSome signals that just can’t be caught or ignored; it means that the default action has to happen. For example, SIGSTOP and SIGKILL are such signals. Once a process receives any of these two signals, we just know that it will be stopped/killed by the OS.\nBut other signals are more polite. While we cannot ignore them, they give a chance to our process to clean up and go away with grace. Most of the ones on the list are of the polite kind. In this section, we will look into the SIGTERM and SIGINT signals and how we can treat them in our Go programs.\nHandling SIGTERM \u0026 SIGNIT The os/signal package implements access to incoming signals with the purpose of signal handling. Through the Notify function, a Go program can accept signals thorough a channel of type os.Signal.\nIn our observer’s case, we don’t have to do any cleanup once it receives a SIGTERM/SIGINT. All we have to do is to stop further execution and shut down gracefully. So, how can we achieve that?\nFirst, we need to create a channel through which we will accept these two signals:\n1 2  signalChan := make(chan os.Signal, 1) signal.Notify(signalChan, syscall.SIGINT, syscall.SIGTERM)   Once the observer process receives a SIGINT or a SIGTERM, it will proxy it through the signalChan channel. To process the signals, we would need to create a goroutine that will receive signals through the signalChan. Once it gets a signal, it will have to cancel() the context, which would stop the further execution of the run method:\n1 2 3 4 5 6 7 8 9 10 11  go func() { select { case = Printf(\"Got SIGINT/SIGTERM, exiting.\") cancel() os.Exit(1) case Done(): log.Printf(\"Done.\") os.Exit(1) } }()   So, once the cancel function is executed, in the for loop of the run method the execution will stop:\n1 2 3 4 5 6 7 8 9 10 11 12 13  func run(ctx context.Context, c *config, stdout io.Writer) error { c.init(os.Args) log.SetOutput(os.Stdout) for { select { case Done(): return nil case Tick(c.tick): // Same as above...  } } }   The last thing we need to do in the main function is to close the signalChan channel when the programs exits:\n1 2 3 4 5 6 7 8 9 10  func main() { // Same as above...  defer func() { signal.Stop(signalChan) cancel() }() // Same as above... }   The Stop function will stop relaying incoming signals to signalChan. When Stop returns, it is guaranteed that signalChan will receive no more signals.\nLet’s run the observer program and see the signal handling in action:\n1 2 3 4  $ ./observer -config=config.conf 2020/04/26 00:14:46 Status code mismatch, got: 200 ... 2020/04/26 00:15:46 Status code mismatch, got: 200   Now, having the PID of observer, we can send any signal using the kill command line tool:\n1  $ kill -SIGINT 37212   By executing the kill command, we will send a SIGINT to the observer process. This will force observer to wrap up the execution, log a line to STDOUT and exit:\n1 2 3 4  $ ./observer -config=config.conf 2020/04/26 00:29:22 Status code mismatch, got: 200 2020/04/26 00:29:22 Got SIGINT/SIGTERM, exiting. exit status 1   We can try the same exercise with SIGTERM as well:\n1  › kill -SIGTERM 37827   Causes observer to exit with the same behavior:\n1 2 3 4  $ ./observer -config=config.conf 2020/04/26 00:33:42 Status code mismatch, got: 200 2020/04/26 00:33:44 Got SIGINT/SIGTERM, exiting. exit status 1   Reload config on SIGHUP Now that we know how to handle signals, we need to add another signal to the mix - SIGHUP. To do that, we can just add syscall.SIGHUP to the signal.Notify call:\n1 2  signalChan := make(chan os.Signal, 1) signal.Notify(signalChan, syscall.SIGINT, syscall.SIGTERM, syscall.SIGHUP)   Now that we have SIGHUP covered, in the goroutine that handles the signals, once a SIGHUP is received, it should re-run the config.init method. By doing that, we will reload the configuration of the observer, loading any changes in the configuration:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  go func() { select { case s := switch s { case syscall.SIGINT, syscall.SIGTERM: log.Printf(\"Got SIGINT/SIGTERM, exiting.\") cancel() os.Exit(1) case syscall.SIGHUP: log.Printf(\"Got SIGHUP, reloading.\") c.init(os.Args) } case Done(): log.Printf(\"Done.\") os.Exit(1) } }()   The change is relatively small. By using a switch construct, detect the received signal. If it’s a SIGHUP, we invoke c.init(os.Args). Otherwise, we cancel() the context and os.Exit the program.\nWe can test this using the same trick from before:\n1  $ kill -SIGHUP 38761   Will cause the observer to reload:\n1 2 3  $ ./observer -config=config.conf 2020/04/26 01:15:40 Status code mismatch, got: 200 2020/04/26 01:15:44 Got SIGHUP, reloading.   This looks nice. Let’s shut down the server now by sending a SIGTERM:\n1  $ kill -SIGTERM 38761   In case you’re following along, you will find out that the observer is still running; this is a bug – the goroutine that was receiving signals exited because the select construct completed once it received the SIGHUP.\nTo make the goroutine accept signals without exiting, we need to make the goroutine run infinitely – using a for loop:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  go func() { for { select { case s := switch s { case syscall.SIGINT, syscall.SIGTERM: log.Printf(\"Got SIGINT/SIGTERM, exiting.\") cancel() os.Exit(1) case syscall.SIGHUP: log.Printf(\"Got SIGHUP, reloading.\") c.init(os.Args) } case Done(): log.Printf(\"Done.\") os.Exit(1) } } }()   By wrapping the whole goroutine in a for loop, we will make sure that it will not exit, except when a SIGINT/SIGTERM is received, or if the context is done. By having this endless goroutine, we also can send multiple SIGHUPs to the observer, and it will process them correctly.\nLet’s send two SIGHUPs, to perform two reloads, and SIGTERM to shut down the observer:\n1 2 3  $ kill -SIGHUP 38960 $ kill -SIGHUP 38960 $ kill -SIGTERM 38960   And the observer output:\n1 2 3 4 5  $ ./observer -config=config.conf 2020/04/26 01:25:02 Status code mismatch, got: 200 2020/04/26 01:25:03 Got SIGHUP, reloading. 2020/04/26 01:25:05 Got SIGHUP, reloading. 2020/04/26 01:25:08 Got SIGINT/SIGTERM, exiting.   And that’s it. The observer now knows how to log to STDOUT, gracefully exit when it receives SIGINT or SIGTERM and reloads the configuration when it receives a SIGHUP.\nProvide the necessary config file for your favorite init system to control your daemon Now, given that computer of choice is a MacBook, I will explain here how you can create a config file for launchd – macOS’s service management framework for starting, stopping and managing daemons, applications, processes, and scripts. In macOS, the system runs daemons, while the users run programs as agents. So, we will turn our observer into an agent.\nIn the past, I have written about creating and managing macOS agents, so if you would like to more about this topic, you can head read that as well. Still, let’s see a minimal launchd configuration for observer:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27     version=\"1.0\"  Label com.ieftimov.observer RunAtLoad  KeepAlive  ProgramArguments  /usr/local/bin/observer -config /etc/observer.conf  StandardOutPath /tmp/observer.log StandardErrorPath /tmp/observer.error.log     The configuration is relatively straightforward, here are all of the pieces in order:\n The Label identifies the job and has to be unique for the launchd instance. Think of it as a unique name for the given agent. RunAtLoad means launchd will start the job as soon as it loads it. KeepAlive tells launchd to keep the agent running no matter what. ProgramArguments provides command-line options to the agent command. In our case, this will create the following command: /usr/local/bin/observer -config /etc/observer.conf. StandardOutPath and StandardErrorPath are the paths to where launchd will write the respective output. In our case, we write these to the tmp directory. An alternative would be to add the log files to /var/log, but that requires granting write access of the agent to /var/log.  To make sure we can run the agent, we have to also supply the configuration file observer.conf in the /etc directory. On my machine, its contents are as follows:\n1 2 3 4 5 6  status=500 tick=30s url=https://ieftimov.com server=cloudflare content_type=text/html; charset=utf-8 user_agent=   After placing the observer.conf file in /etc, for the agent to work, we have to place its .plist file in ~/Library/LaunchAgents, and load it with:\n1  $ launchctl load ~/Library/LaunchAgents/com.ieftimov.observer.plist   Now, if we would tail -f the log files in /tmp we will see its outputs there:\n1 2 3 4 5 6  $ tail -f /tmp/observer.* == /tmp/observer.error.log /tmp/observer.log 200   Voila! The agent is running and its logging output to STDOUT, while launchd is redirecting that output to a log file.\nIf we would like to run the observer on GNU/Linux, we cannot use this launchd configuration.\nIn Linux-land, systemd is widespread and popular. If you are interested in a deeper explanation of systemd units and unit files, Digital Ocean’s blog has an article on “Understanding Systemd Units and Unit Files” by Justin Ellingwood. I recommend reading it! And keep in mind, the community’s opinion on systemd is pretty divided.\nThere are a bunch of other alternatives, but my knowledge of GNU/Linux init systems is minimal. Therefore, I will stop right here and ask for your help: if you would like to contribute a Linux init system configuration to this article, drop the link to a gist/repo in the comments, and I will include it in this article.\nOf course, with proper attribution.\nYou can see the final implementation of the observer here.\nLiked this article? Subscribe to my newsletter and get my fresh posts in your inbox. It's short and sweet, going out monthly to over 1,000 subscribers.  ","wordCount":"3236","inLanguage":"en","datePublished":"2020-05-02T00:00:00Z","dateModified":"2020-05-02T00:00:00Z","author":{"@type":"Person","name":"Ilija"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ieftimov.com/post/four-steps-daemonize-your-golang-programs/"},"publisher":{"@type":"Organization","name":"Ilija Eftimov ⚡️","logo":{"@type":"ImageObject","url":"https://ieftimov.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://ieftimov.com/ accesskey=h title="Ilija Eftimov ⚡️ (Alt + H)">Ilija Eftimov ⚡️</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://ieftimov.com/posts title=Archive><span>Archive</span></a></li><li><a href=https://ieftimov.com/about title=About><span>About</span></a></li><li><a href=https://ieftimov.com/newsletter title=Newsletter><span>Newsletter</span></a></li><li><a href=https://forms.gle/orfXK5jh1LRaiFzo8 title="Suggest a topic"><span>Suggest a topic</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Four Steps to Daemonize Your Go Programs</h1><div class=post-description>Hands-on introduction for the best four-step approach to daemonizing your Go programs</div><div class=post-meta>May 2, 2020&nbsp;·&nbsp;16 min&nbsp;·&nbsp;Ilija</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#website-observer aria-label="Website Observer">Website Observer</a></li><li><a href=#logging-to-stdout aria-label="Logging to STDOUT">Logging to <code>STDOUT</code></a></li><li><a href=#shut-down-on-sigtermsigint aria-label="Shut down on SIGTERM/SIGINT">Shut down on <code>SIGTERM</code>/<code>SIGINT</code></a><ul><li><a href=#termination-signals aria-label="Termination signals">Termination signals</a></li><li><a href=#handling-sigterm--signit aria-label="Handling SIGTERM &amp;amp; SIGNIT">Handling <code>SIGTERM</code> & <code>SIGNIT</code></a></li></ul></li><li><a href=#reload-config-on-sighup aria-label="Reload config on SIGHUP">Reload config on <code>SIGHUP</code></a></li><li><a href=#provide-the-necessary-config-file-for-your-favorite-init-system-to-control-your-daemon aria-label="Provide the necessary config file for your favorite init system to control your daemon">Provide the necessary config file for your favorite init system to control your daemon</a></li></ul></div></details></div><div class=post-content><p>If you have ever worked with Ruby, or have maybe maintained a Rails
application, I am sure the name Sidekiq will sound familiar. For those
unfamiliar with the project, Sidekiq is a job system for Ruby. It is a <a href=https://github.com/mperham/sidekiq>wildly
popular</a> project, and the author has turned
it into <a href=https://sidekiq.org/>a successful business</a>.</p><p>None of the above would be relevant if Sidekiq&rsquo;s author Mike Perham, in 2014,
did not write a concise and informative post titled <a href=https://www.mikeperham.com/2014/09/22/dont-daemonize-your-daemons>&ldquo;Don&rsquo;t Daemonize your
Daemons!"</a>.
In it, he covers four guidelines to daemonizing programs correctly:</p><ol><li>Log to <code>STDOUT</code></li><li>Shut down on <code>SIGTERM</code>/<code>SIGINT</code></li><li>Reload config on <code>SIGHUP</code></li><li>Provide the necessary config file for your favorite init system to control
your daemon</li></ol><p>(You can also read the whole article on <a href=https://www.mikeperham.com/2014/09/22/dont-daemonize-your-daemons/>his
website</a>.)</p><p>So I was thinking, why don&rsquo;t we explore how to apply these guidelines while
daemonizing a Go program?</p><h2 id=website-observer>Website Observer<a hidden class=anchor aria-hidden=true href=#website-observer>#</a></h2><p>The program in question is a simple command-line program that can monitor any
website by sending periodic HTTP requests to it. If you ever heard of
Datadog&rsquo;s synthetic tests or Pingdom, think of our program as their little
sibling.</p><p>The <code>observer</code> program will read its configuration from flags, environment
variables, or a configuration file. If the configuration is not present as a
flag, it will look into the <code>ENV</code> vars for it and then in a configuration file
(if present). If nothing is found, it will use the default value or exit with
an error depending on how crucial the configuration is.</p><p>To do this, we will use <a href=https://github.com/namsral/flag>the <code>namsral/flag</code>
package</a>, which is a drop-in replacement for
Go&rsquo;s flag package, with the addition of parsing files and environment
variables. Being a drop-in replacement means that using the <code>namsral/flag</code>
package is as simple as using the <code>flag</code> package from the standard library.</p><p>First, <code>observer</code> will have a <code>config</code> type, which will encapsulate the
configuration for the website that it will observe:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>const</span> defaultTick = <span style=color:#00afaf>60</span> * time.Second

<span style=color:#0087ff>type</span> config <span style=color:#0087ff>struct</span> {
	contentType <span style=color:#af0000>string</span>
	server      <span style=color:#af0000>string</span>
	statusCode  <span style=color:#af0000>int</span>
	tick        time.Duration
	url         <span style=color:#af0000>string</span>
	userAgent   <span style=color:#af0000>string</span>
}

<span style=color:#0087ff>func</span> (c *config) <span style=color:#0087ff>init</span>(args []<span style=color:#af0000>string</span>) <span style=color:#af0000>error</span> {
	flags := flag.<span style=color:#0087ff>NewFlagSet</span>(args[<span style=color:#00afaf>0</span>], flag.ExitOnError)
	flags.<span style=color:#0087ff>String</span>(flag.DefaultConfigFlagname, <span style=color:#00afaf>&#34;&#34;</span>, <span style=color:#00afaf>&#34;Path to config file&#34;</span>)

	<span style=color:#0087ff>var</span> (
		statusCode  = flags.<span style=color:#0087ff>Int</span>(<span style=color:#00afaf>&#34;status&#34;</span>, <span style=color:#00afaf>200</span>, <span style=color:#00afaf>&#34;Response HTTP status code&#34;</span>)
		tick        = flags.<span style=color:#0087ff>Duration</span>(<span style=color:#00afaf>&#34;tick&#34;</span>, defaultTick, <span style=color:#00afaf>&#34;Ticking interval&#34;</span>)
		server      = flags.<span style=color:#0087ff>String</span>(<span style=color:#00afaf>&#34;server&#34;</span>, <span style=color:#00afaf>&#34;&#34;</span>, <span style=color:#00afaf>&#34;Server HTTP header value&#34;</span>)
		contentType = flags.<span style=color:#0087ff>String</span>(<span style=color:#00afaf>&#34;content_type&#34;</span>, <span style=color:#00afaf>&#34;&#34;</span>, <span style=color:#00afaf>&#34;Content-Type HTTP header value&#34;</span>)
		userAgent   = flags.<span style=color:#0087ff>String</span>(<span style=color:#00afaf>&#34;user_agent&#34;</span>, <span style=color:#00afaf>&#34;&#34;</span>, <span style=color:#00afaf>&#34;User-Agent HTTP header value&#34;</span>)
		url         = flags.<span style=color:#0087ff>String</span>(<span style=color:#00afaf>&#34;url&#34;</span>, <span style=color:#00afaf>&#34;&#34;</span>, <span style=color:#00afaf>&#34;Request URL&#34;</span>)
	)

	<span style=color:#5f8700>if</span> err := flags.<span style=color:#0087ff>Parse</span>(args[<span style=color:#00afaf>1</span>:]); err != <span style=color:#d75f00>nil</span> {
		<span style=color:#5f8700>return</span> err
	}

	c.statusCode = *statusCode
	c.tick = *tick
	c.server = *server
	c.contentType = *contentType
	c.userAgent = *userAgent
	c.url = *url

	<span style=color:#5f8700>return</span> <span style=color:#d75f00>nil</span>
}
</code></pre></td></tr></table></div></div><p>The <code>init</code> function will take the command line arguments as input and build a
<code>FlagSet</code>, which represents a set of defined flags. Each of the flags is listed
and parsed; then, their values are assigned to the <code>config</code>. Additionally,
having the <code>flag.DefaultConfigFilename</code> as a flag as well enables our
<code>observer</code> to load the configuration from a <code>config.conf</code> file. The <code>.conf</code>
file has a <code>key=value</code> format, with new lines after each key-value pair.</p><p>Here&rsquo;s the main function:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>main</span>() {
	ctx := context.<span style=color:#0087ff>Background</span>()
	ctx, cancel := context.<span style=color:#0087ff>WithCancel</span>(ctx)

	c := &amp;config{}

	<span style=color:#5f8700>defer</span> <span style=color:#0087ff>func</span>() {
		<span style=color:#0087ff>cancel</span>()
	}()

	<span style=color:#5f8700>if</span> err := <span style=color:#0087ff>run</span>(ctx, c); err != <span style=color:#d75f00>nil</span> {
		fmt.<span style=color:#0087ff>Fprintf</span>(os.Stderr, <span style=color:#00afaf>&#34;%s\n&#34;</span>, err)
		os.<span style=color:#0087ff>Exit</span>(<span style=color:#00afaf>1</span>)
	}
}
</code></pre></td></tr></table></div></div><p>Following <a href=https://pace.dev/blog/2020/02/12/why-you-shouldnt-use-func-main-in-golang-by-mat-ryer.html>Mat Ryer&rsquo;s
advice</a>,
we are going to keep <code>main</code> very thin while keeping the main logic of the
<code>observer</code> in the <code>run</code> method. <code>main</code> here just sets up the main context that
will propagate down to the <code>run</code> method, and it initializes the observer
<code>config</code>. Then it passes all of the relevant arguments to the <code>run</code> method.</p><p>Here&rsquo;s the <code>run</code> method:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>run</span>(ctx context.Context, c *config) <span style=color:#af0000>error</span> {
	c.<span style=color:#0087ff>init</span>(os.Args)

	<span style=color:#5f8700>for</span> {
		<span style=color:#5f8700>select</span> {
		<span style=color:#5f8700>case</span> &lt;-ctx.<span style=color:#0087ff>Done</span>():
			<span style=color:#5f8700>return</span> <span style=color:#d75f00>nil</span>
		<span style=color:#5f8700>case</span> &lt;-time.<span style=color:#0087ff>Tick</span>(c.tick):
			resp, err := http.<span style=color:#0087ff>Get</span>(c.url)
			<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
				<span style=color:#5f8700>return</span> err
			}

			<span style=color:#5f8700>if</span> resp.StatusCode != c.statusCode {
				log.<span style=color:#0087ff>Printf</span>(<span style=color:#00afaf>&#34;Status code mismatch, got: %d\n&#34;</span>, resp.StatusCode)
			}

			<span style=color:#5f8700>if</span> s := resp.Header.<span style=color:#0087ff>Get</span>(<span style=color:#00afaf>&#34;server&#34;</span>); s != c.server {
				log.<span style=color:#0087ff>Printf</span>(<span style=color:#00afaf>&#34;Server header mismatch, got: %s\n&#34;</span>, s)
			}

			<span style=color:#5f8700>if</span> ct := resp.Header.<span style=color:#0087ff>Get</span>(<span style=color:#00afaf>&#34;content-type&#34;</span>); ct != c.contentType {
				log.<span style=color:#0087ff>Printf</span>(<span style=color:#00afaf>&#34;Content-Type header mismatch, got: %s\n&#34;</span>, ct)
			}

			<span style=color:#5f8700>if</span> ua := resp.Header.<span style=color:#0087ff>Get</span>(<span style=color:#00afaf>&#34;user-agent&#34;</span>); ua != c.userAgent {
				log.<span style=color:#0087ff>Printf</span>(<span style=color:#00afaf>&#34;User-Agent header mismatch, got: %s\n&#34;</span>, ua)
			}
		}
	}
}
</code></pre></td></tr></table></div></div><p>First, the <code>run</code> method initializes the <code>config</code> instance <code>c</code>, using the <code>init</code>
method. Then, it loops infinitely until the context <code>ctx</code> is done. When <code>ctx</code>
is done, it means the <code>observer</code> process is terminated, so it merely returns a
<code>nil</code> and finishes with its execution.</p><p>Alternatively, it will execute the other case every <code>tick</code>. By using the
<code>time.Tick</code> channel here we run this code by receiving a signal through the
channel every <code>c.tick</code> period. For example, if <code>c.tick</code> is 30 seconds, we will
receive a signal every 30 seconds, meaning the code will run every 30 seconds.</p><p>The code itself is simple – it sends an HTTP <code>GET</code> request to the URL assigned
to <code>c.url</code>. Once the response returns, the <code>run</code> method compares the relevant
response headers and the status code with the once provided through the
configuration. If any mismatch is detected, it logs the error.</p><p>Running the <code>observer</code> is relatively simple. One way is to supply a config file
through the command line:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ ./observer -config ./config.conf
2020/04/23 19:41:54 Status code mismatch, got: <span style=color:#00afaf>200</span>
</code></pre></td></tr></table></div></div><p>Alternatively, using flags:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ ./observer -status=<span style=color:#00afaf>500</span> -tick=10s -url=https://ieftimov.com -server=Cloudflare
2020/04/23 19:43:34 Status code mismatch, got: <span style=color:#00afaf>200</span>
2020/04/23 19:43:34 Server header mismatch, got: cloudflare
2020/04/23 19:43:34 Content-Type header mismatch, got: text/html; <span style=color:#0087ff>charset</span>=utf-8
</code></pre></td></tr></table></div></div><p>We can do the same using environment variables, or a combination of all three:
config file, environment variables, and flags.</p><p>Now, how can we apply the four simple rules of daemonization?</p><h2 id=logging-to-stdout>Logging to <code>STDOUT</code><a hidden class=anchor aria-hidden=true href=#logging-to-stdout>#</a></h2><p>While daemons don&rsquo;t have much to do with web services, one of the 12 factors of
modern web services are treating logs as event streams. While the 12 factors in
this particular case are not applicable, the guiding principle stays: the
daemon itself should not manage log streams, nor it should not concern itself
with writing to or managing log files. Instead, daemons should send their log
stream, unbuffered, to <code>STDOUT</code>.</p><p>The service management system will capture each daemon&rsquo;s stream. The <code>init</code>
config file is what we will use to configure logging, such as where the logs
should be stored or streamed.</p><p>So, how can we adapt the <code>observer</code> to log to <code>STDOUT</code>?</p><p>First, we will add another argument to the <code>run</code> function, called <code>out</code> of type
<code>io.Writer</code>. Then, we will invoke the <code>log.SetOutput</code> function passing the
<code>out</code> as argument to it.</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>run</span>(ctx context.Context, c *config, out io.Writer) <span style=color:#af0000>error</span> {
	c.<span style=color:#0087ff>init</span>(os.Args)
	log.<span style=color:#0087ff>SetOutput</span>(out)

	<span style=color:#5f8700>for</span> {
		<span style=color:#5f8700>select</span> {
		<span style=color:#5f8700>case</span> &lt;-ctx.<span style=color:#0087ff>Done</span>():
			<span style=color:#5f8700>return</span> <span style=color:#d75f00>nil</span>
		<span style=color:#5f8700>case</span> &lt;-time.<span style=color:#0087ff>Tick</span>(c.tick):
			<span style=color:#4e4e4e>// Identical to above, removed from brewity
</span><span style=color:#4e4e4e></span>		}
	}
}
</code></pre></td></tr></table></div></div><p>By doing this, we will have to pass <code>STDOUT</code> from the <code>main</code> function, but we
keep our <code>run</code> function more testable. Using a separate <code>run</code> method means we
can invoke it with any instance that implements the <code>io.Writer</code> interface. We
basically couple the <code>run</code> method to <strong>a behavior instead of type</strong>.</p><p>Then, we need to update the <code>main</code> function to pass the additional argument to
the <code>run</code> function when invoking it. And the <code>io.Writer</code> will be simple
<code>os.Stdout</code>:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>main</span>() {
	ctx := context.<span style=color:#0087ff>Background</span>()
	ctx, cancel := context.<span style=color:#0087ff>WithCancel</span>(ctx)

	c := &amp;config{}

	<span style=color:#5f8700>defer</span> <span style=color:#0087ff>func</span>() {
		<span style=color:#0087ff>cancel</span>()
	}()

	<span style=color:#5f8700>if</span> err := <span style=color:#0087ff>run</span>(ctx, c, os.Stdout); err != <span style=color:#d75f00>nil</span> {
		fmt.<span style=color:#0087ff>Fprintf</span>(os.Stderr, <span style=color:#00afaf>&#34;%s\n&#34;</span>, err)
		os.<span style=color:#0087ff>Exit</span>(<span style=color:#00afaf>1</span>)
	}
}
</code></pre></td></tr></table></div></div><p>If we run the program again we won&rsquo;t see a difference:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ ./observer -status=<span style=color:#00afaf>500</span> -tick=10s -url=https://ieftimov.com -server=Cloudflare
2020/04/23 19:43:34 Status code mismatch, got: <span style=color:#00afaf>200</span>
2020/04/23 19:43:34 Server header mismatch, got: cloudflare
2020/04/23 19:43:34 Content-Type header mismatch, got: text/html; <span style=color:#0087ff>charset</span>=utf-8
</code></pre></td></tr></table></div></div><p>Why is that? Well, the <code>log</code> package <a href=https://github.com/golang/go/blob/5477623/src/log/log.go#L76>logs to <code>STDERR</code> by
default</a>, so
there is no visible change of behavior there. Still, we make the dependency on
an output stream explicit to the <code>run</code> function, which clearly states that
<code>run</code> needs to know where to send its logs when running.</p><h2 id=shut-down-on-sigtermsigint>Shut down on <code>SIGTERM</code>/<code>SIGINT</code><a hidden class=anchor aria-hidden=true href=#shut-down-on-sigtermsigint>#</a></h2><p>In Go, having errors as values is very helpful to think about what will happen
to our program if an error is returned. While this makes our Go programs
always have some repetitive error handling, it also gives us confidence that
our program will gracefully handle any error.</p><h3 id=termination-signals>Termination signals<a hidden class=anchor aria-hidden=true href=#termination-signals>#</a></h3><p>*nix operating systems (OS) employ a system of signals, which is a mechanism
of the OS to ask a process to perform a particular action. There are two
general types of signals: those that cause termination of a process and those
that do not.</p><p>(Refer to <a href=https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/signal.h.html>the full
list</a>
of the POSIX-defined signals to learn more.)</p><p>Using these system signals, a process that has received one can choose one of
the following behaviors to take place: perform the default POSIX-defined
action, ignore the signal, or catch the signal with a signal handler and
perform some sort of a custom action.</p><p>Some signals that just can&rsquo;t be caught or ignored; it means that the default
action has to happen. For example, <code>SIGSTOP</code> and <code>SIGKILL</code> are such signals.
Once a process receives any of these two signals, we just know that it will be
stopped/killed by the OS.</p><p>But other signals are more polite. While we cannot ignore them, they give a
chance to our process to clean up and go away with grace. Most of the ones on
<a href=https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/signal.h.html>the
list</a>
are of the polite kind. In this section, we will look into the <code>SIGTERM</code> and
<code>SIGINT</code> signals and how we can treat them in our Go programs.</p><h3 id=handling-sigterm--signit>Handling <code>SIGTERM</code> & <code>SIGNIT</code><a hidden class=anchor aria-hidden=true href=#handling-sigterm--signit>#</a></h3><p>The <a href=https://golang.org/pkg/os/signal><code>os/signal</code></a> package implements access
to incoming signals with the purpose of signal handling. Through the
<a href=https://golang.org/pkg/os/signal/#Notify><code>Notify</code></a> function, a Go program can
accept signals thorough a channel of type <code>os.Signal</code>.</p><p>In our <code>observer</code>&rsquo;s case, we don&rsquo;t have to do any cleanup once it receives a
<code>SIGTERM</code>/<code>SIGINT</code>. All we have to do is to stop further execution and shut
down gracefully. So, how can we achieve that?</p><p>First, we need to create a channel through which we will accept these two signals:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>signalChan := <span style=color:#0087ff>make</span>(<span style=color:#0087ff>chan</span> os.Signal, <span style=color:#00afaf>1</span>)
signal.<span style=color:#0087ff>Notify</span>(signalChan, syscall.SIGINT, syscall.SIGTERM)
</code></pre></td></tr></table></div></div><p>Once the <code>observer</code> process receives a <code>SIGINT</code> or a <code>SIGTERM</code>, it will proxy
it through the <code>signalChan</code> channel. To process the signals, we would need to
create a goroutine that will receive signals through the <code>signalChan</code>. Once it
gets a signal, it will have to <code>cancel()</code> the context, which would stop the
further execution of the <code>run</code> method:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#5f8700>go</span> <span style=color:#0087ff>func</span>() {
        <span style=color:#5f8700>select</span> {
        <span style=color:#5f8700>case</span> = &lt;-signalChan:
                log.<span style=color:#0087ff>Printf</span>(<span style=color:#00afaf>&#34;Got SIGINT/SIGTERM, exiting.&#34;</span>)
                <span style=color:#0087ff>cancel</span>()
                os.<span style=color:#0087ff>Exit</span>(<span style=color:#00afaf>1</span>)
        <span style=color:#5f8700>case</span> &lt;-ctx.<span style=color:#0087ff>Done</span>():
                log.<span style=color:#0087ff>Printf</span>(<span style=color:#00afaf>&#34;Done.&#34;</span>)
                os.<span style=color:#0087ff>Exit</span>(<span style=color:#00afaf>1</span>)
        }
}()
</code></pre></td></tr></table></div></div><p>So, once the <code>cancel</code> function is executed, in the <code>for</code> loop of the <code>run</code>
method the execution will stop:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>run</span>(ctx context.Context, c *config, stdout io.Writer) <span style=color:#af0000>error</span> {
        c.<span style=color:#0087ff>init</span>(os.Args)
        log.<span style=color:#0087ff>SetOutput</span>(os.Stdout)

        <span style=color:#5f8700>for</span> {
                <span style=color:#5f8700>select</span> {
                <span style=color:#5f8700>case</span> &lt;-ctx.<span style=color:#0087ff>Done</span>():
                        <span style=color:#5f8700>return</span> <span style=color:#d75f00>nil</span>
                <span style=color:#5f8700>case</span> &lt;-time.<span style=color:#0087ff>Tick</span>(c.tick):
                        <span style=color:#4e4e4e>// Same as above...
</span><span style=color:#4e4e4e></span>                }
        }
}
</code></pre></td></tr></table></div></div><p>The last thing we need to do in the <code>main</code> function is to close the
<code>signalChan</code> channel when the programs exits:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>main</span>() {
	<span style=color:#4e4e4e>// Same as above...
</span><span style=color:#4e4e4e></span>
	<span style=color:#5f8700>defer</span> <span style=color:#0087ff>func</span>() {
                signal.<span style=color:#0087ff>Stop</span>(signalChan)
		<span style=color:#0087ff>cancel</span>()
	}()

	<span style=color:#4e4e4e>// Same as above...
</span><span style=color:#4e4e4e></span>}
</code></pre></td></tr></table></div></div><p>The <code>Stop</code> function will stop relaying incoming signals to <code>signalChan</code>. When
<code>Stop</code> returns, it is guaranteed that <code>signalChan</code> will receive no more
signals.</p><p>Let&rsquo;s run the <code>observer</code> program and see the signal handling in action:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ ./observer -config=config.conf
2020/04/26 00:14:46 Status code mismatch, got: <span style=color:#00afaf>200</span>
...
2020/04/26 00:15:46 Status code mismatch, got: <span style=color:#00afaf>200</span>
</code></pre></td></tr></table></div></div><p>Now, having the PID of <code>observer</code>, we can send any signal using the <code>kill</code>
command line tool:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ <span style=color:#0087ff>kill</span> -SIGINT <span style=color:#00afaf>37212</span>
</code></pre></td></tr></table></div></div><p>By executing the <code>kill</code> command, we will send a <code>SIGINT</code> to the <code>observer</code>
process. This will force <code>observer</code> to wrap up the execution, log a line to
<code>STDOUT</code> and exit:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ ./observer -config=config.conf
2020/04/26 00:29:22 Status code mismatch, got: <span style=color:#00afaf>200</span>
2020/04/26 00:29:22 Got SIGINT/SIGTERM, exiting.
<span style=color:#0087ff>exit</span> status <span style=color:#00afaf>1</span>
</code></pre></td></tr></table></div></div><p>We can try the same exercise with <code>SIGTERM</code> as well:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>› <span style=color:#0087ff>kill</span> -SIGTERM <span style=color:#00afaf>37827</span>
</code></pre></td></tr></table></div></div><p>Causes <code>observer</code> to exit with the same behavior:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ ./observer -config=config.conf
2020/04/26 00:33:42 Status code mismatch, got: <span style=color:#00afaf>200</span>
2020/04/26 00:33:44 Got SIGINT/SIGTERM, exiting.
<span style=color:#0087ff>exit</span> status <span style=color:#00afaf>1</span>
</code></pre></td></tr></table></div></div><h2 id=reload-config-on-sighup>Reload config on <code>SIGHUP</code><a hidden class=anchor aria-hidden=true href=#reload-config-on-sighup>#</a></h2><p>Now that we know how to handle signals, we need to add another signal to the
mix - <code>SIGHUP</code>. To do that, we can just add <code>syscall.SIGHUP</code> to the
<code>signal.Notify</code> call:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>signalChan := <span style=color:#0087ff>make</span>(<span style=color:#0087ff>chan</span> os.Signal, <span style=color:#00afaf>1</span>)
signal.<span style=color:#0087ff>Notify</span>(signalChan, syscall.SIGINT, syscall.SIGTERM, syscall.SIGHUP)
</code></pre></td></tr></table></div></div><p>Now that we have <code>SIGHUP</code> covered, in the goroutine that handles the signals,
once a <code>SIGHUP</code> is received, it should re-run the <code>config.init</code> method. By
doing that, we will reload the configuration of the <code>observer</code>, loading any
changes in the configuration:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#5f8700>go</span> <span style=color:#0087ff>func</span>() {
        <span style=color:#5f8700>select</span> {
        <span style=color:#5f8700>case</span> s := &lt;-signalChan:
                <span style=color:#5f8700>switch</span> s {
                <span style=color:#5f8700>case</span> syscall.SIGINT, syscall.SIGTERM:
                        log.<span style=color:#0087ff>Printf</span>(<span style=color:#00afaf>&#34;Got SIGINT/SIGTERM, exiting.&#34;</span>)
                        <span style=color:#0087ff>cancel</span>()
                        os.<span style=color:#0087ff>Exit</span>(<span style=color:#00afaf>1</span>)
                <span style=color:#5f8700>case</span> syscall.SIGHUP:
                        log.<span style=color:#0087ff>Printf</span>(<span style=color:#00afaf>&#34;Got SIGHUP, reloading.&#34;</span>)
                        c.<span style=color:#0087ff>init</span>(os.Args)
                }
        <span style=color:#5f8700>case</span> &lt;-ctx.<span style=color:#0087ff>Done</span>():
                log.<span style=color:#0087ff>Printf</span>(<span style=color:#00afaf>&#34;Done.&#34;</span>)
                os.<span style=color:#0087ff>Exit</span>(<span style=color:#00afaf>1</span>)
        }
}()
</code></pre></td></tr></table></div></div><p>The change is relatively small. By using a <code>switch</code> construct, detect the
received signal. If it&rsquo;s a <code>SIGHUP</code>, we invoke <code>c.init(os.Args)</code>. Otherwise,
we <code>cancel()</code> the context and <code>os.Exit</code> the program.</p><p>We can test this using the same trick from before:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ <span style=color:#0087ff>kill</span> -SIGHUP <span style=color:#00afaf>38761</span>
</code></pre></td></tr></table></div></div><p>Will cause the <code>observer</code> to reload:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ ./observer -config=config.conf
2020/04/26 01:15:40 Status code mismatch, got: <span style=color:#00afaf>200</span>
2020/04/26 01:15:44 Got SIGHUP, reloading.
</code></pre></td></tr></table></div></div><p>This looks nice. Let&rsquo;s shut down the server now by sending a <code>SIGTERM</code>:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ <span style=color:#0087ff>kill</span> -SIGTERM <span style=color:#00afaf>38761</span>
</code></pre></td></tr></table></div></div><p>In case you&rsquo;re following along, you will find out that the <code>observer</code> is still
running; this is a bug – the goroutine that was receiving signals exited
because the <code>select</code> construct completed once it received the <code>SIGHUP</code>.</p><p>To make the goroutine accept signals without exiting, we need to make the
goroutine run infinitely – using a <code>for</code> loop:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#5f8700>go</span> <span style=color:#0087ff>func</span>() {
        <span style=color:#5f8700>for</span> {
                <span style=color:#5f8700>select</span> {
                <span style=color:#5f8700>case</span> s := &lt;-signalChan:
                        <span style=color:#5f8700>switch</span> s {
                        <span style=color:#5f8700>case</span> syscall.SIGINT, syscall.SIGTERM:
                                log.<span style=color:#0087ff>Printf</span>(<span style=color:#00afaf>&#34;Got SIGINT/SIGTERM, exiting.&#34;</span>)
                                <span style=color:#0087ff>cancel</span>()
                                os.<span style=color:#0087ff>Exit</span>(<span style=color:#00afaf>1</span>)
                        <span style=color:#5f8700>case</span> syscall.SIGHUP:
                                log.<span style=color:#0087ff>Printf</span>(<span style=color:#00afaf>&#34;Got SIGHUP, reloading.&#34;</span>)
                                c.<span style=color:#0087ff>init</span>(os.Args)
                        }
                <span style=color:#5f8700>case</span> &lt;-ctx.<span style=color:#0087ff>Done</span>():
                        log.<span style=color:#0087ff>Printf</span>(<span style=color:#00afaf>&#34;Done.&#34;</span>)
                        os.<span style=color:#0087ff>Exit</span>(<span style=color:#00afaf>1</span>)
                }
        }
}()
</code></pre></td></tr></table></div></div><p>By wrapping the whole goroutine in a <code>for</code> loop, we will make sure that it will
not exit, except when a <code>SIGINT</code>/<code>SIGTERM</code> is received, or if the context is
done. By having this endless goroutine, we also can send multiple <code>SIGHUP</code>s to
the <code>observer</code>, and it will process them correctly.</p><p>Let&rsquo;s send two <code>SIGHUP</code>s, to perform two reloads, and <code>SIGTERM</code> to shut down
the <code>observer</code>:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ <span style=color:#0087ff>kill</span> -SIGHUP <span style=color:#00afaf>38960</span>
$ <span style=color:#0087ff>kill</span> -SIGHUP <span style=color:#00afaf>38960</span>
$ <span style=color:#0087ff>kill</span> -SIGTERM <span style=color:#00afaf>38960</span>
</code></pre></td></tr></table></div></div><p>And the <code>observer</code> output:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ ./observer -config=config.conf
2020/04/26 01:25:02 Status code mismatch, got: <span style=color:#00afaf>200</span>
2020/04/26 01:25:03 Got SIGHUP, reloading.
2020/04/26 01:25:05 Got SIGHUP, reloading.
2020/04/26 01:25:08 Got SIGINT/SIGTERM, exiting.
</code></pre></td></tr></table></div></div><p>And that&rsquo;s it. The <code>observer</code> now knows how to log to <code>STDOUT</code>, gracefully exit
when it receives <code>SIGINT</code> or <code>SIGTERM</code> and reloads the configuration when it
receives a <code>SIGHUP</code>.</p><h2 id=provide-the-necessary-config-file-for-your-favorite-init-system-to-control-your-daemon>Provide the necessary config file for your favorite init system to control your daemon<a hidden class=anchor aria-hidden=true href=#provide-the-necessary-config-file-for-your-favorite-init-system-to-control-your-daemon>#</a></h2><p>Now, given that computer of choice is a MacBook, I will explain here how you
can create a config file for <a href=https://www.launchd.info/><code>launchd</code></a> – macOS&rsquo;s
service management framework for starting, stopping and managing daemons,
applications, processes, and scripts. In macOS, the system runs daemons, while
the users run programs as agents. So, we will turn our <code>observer</code> into an
agent.</p><p>In the past, I have written about <a href=/create-manage-macos-launchd-agents-golang>creating and managing macOS
agents</a>, so if you would like to
more about this topic, you can head read that as well. Still, let&rsquo;s see a
minimal <code>launchd</code> configuration for <code>observer</code>:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#5f8700>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style=color:#5f8700>&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;</span>
<span style=color:#0087ff>&lt;plist</span> version=<span style=color:#00afaf>&#34;1.0&#34;</span><span style=color:#0087ff>&gt;</span>
    <span style=color:#0087ff>&lt;dict&gt;</span>
        <span style=color:#0087ff>&lt;key&gt;</span>Label<span style=color:#0087ff>&lt;/key&gt;</span>
        <span style=color:#0087ff>&lt;string&gt;</span>com.ieftimov.observer<span style=color:#0087ff>&lt;/string&gt;</span>

        <span style=color:#0087ff>&lt;key&gt;</span>RunAtLoad<span style=color:#0087ff>&lt;/key&gt;</span>
        <span style=color:#0087ff>&lt;true/&gt;</span>

        <span style=color:#0087ff>&lt;key&gt;</span>KeepAlive<span style=color:#0087ff>&lt;/key&gt;</span>
        <span style=color:#0087ff>&lt;true/&gt;</span>

        <span style=color:#0087ff>&lt;key&gt;</span>ProgramArguments<span style=color:#0087ff>&lt;/key&gt;</span>
        <span style=color:#0087ff>&lt;array&gt;</span>
          <span style=color:#0087ff>&lt;string&gt;</span>/usr/local/bin/observer<span style=color:#0087ff>&lt;/string&gt;</span>
          <span style=color:#0087ff>&lt;string&gt;</span>-config<span style=color:#0087ff>&lt;/string&gt;</span>
          <span style=color:#0087ff>&lt;string&gt;</span>/etc/observer.conf<span style=color:#0087ff>&lt;/string&gt;</span>
        <span style=color:#0087ff>&lt;/array&gt;</span>

        <span style=color:#0087ff>&lt;key&gt;</span>StandardOutPath<span style=color:#0087ff>&lt;/key&gt;</span>
        <span style=color:#0087ff>&lt;string&gt;</span>/tmp/observer.log<span style=color:#0087ff>&lt;/string&gt;</span>

        <span style=color:#0087ff>&lt;key&gt;</span>StandardErrorPath<span style=color:#0087ff>&lt;/key&gt;</span>
        <span style=color:#0087ff>&lt;string&gt;</span>/tmp/observer.error.log<span style=color:#0087ff>&lt;/string&gt;</span>
    <span style=color:#0087ff>&lt;/dict&gt;</span>
<span style=color:#0087ff>&lt;/plist&gt;</span>
</code></pre></td></tr></table></div></div><p>The configuration is relatively straightforward, here are all of the pieces in
order:</p><ul><li>The <code>Label</code> identifies the job and has to be unique for the launchd instance.
Think of it as a unique name for the given agent.</li><li><code>RunAtLoad</code> means <code>launchd</code> will start the job as soon as it loads it.</li><li><code>KeepAlive</code> tells launchd to keep the agent running no matter what.</li><li><code>ProgramArguments</code> provides command-line options to the agent command. In our
case, this will create the following command: <code>/usr/local/bin/observer -config /etc/observer.conf</code>.</li><li><code>StandardOutPath</code> and <code>StandardErrorPath</code> are the paths to where <code>launchd</code>
will write the respective output. In our case, we write these to the <code>tmp</code>
directory. An alternative would be to add the log files to <code>/var/log</code>, but
that requires granting write access of the agent to <code>/var/log</code>.</li></ul><p>To make sure we can run the agent, we have to also supply the configuration
file <code>observer.conf</code> in the <code>/etc</code> directory. On my machine, its contents are
as follows:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>status=500
tick=30s
url=https://ieftimov.com
server=cloudflare
content_type=text/html; charset=utf-8
user_agent=
</code></pre></td></tr></table></div></div><p>After placing the <code>observer.conf</code> file in <code>/etc</code>, for the agent to work, we
have to place its <code>.plist</code> file in <code>~/Library/LaunchAgents</code>, and load it with:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ launchctl load ~/Library/LaunchAgents/com.ieftimov.observer.plist
</code></pre></td></tr></table></div></div><p>Now, if we would <code>tail -f</code> the log files in <code>/tmp</code> we will see its outputs
there:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ tail -f /tmp/observer.*

==&gt; /tmp/observer.error.log &lt;==

==&gt; /tmp/observer.log &lt;==
2020/05/02 11:49:03 Status code mismatch, got: <span style=color:#00afaf>200</span>
</code></pre></td></tr></table></div></div><p>Voila! The agent is running and its logging output to <code>STDOUT</code>, while <code>launchd</code>
is redirecting that output to a log file.</p><p>If we would like to run the <code>observer</code> on GNU/Linux, we cannot use this
<code>launchd</code> configuration.</p><p>In Linux-land, <code>systemd</code> is widespread and popular. If you are interested in a
deeper explanation of <code>systemd</code> units and unit files, Digital Ocean&rsquo;s blog has
<a href=https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files>an
article</a>
on &ldquo;Understanding Systemd Units and Unit Files&rdquo; by Justin Ellingwood. I
recommend reading it! And keep in mind, the community&rsquo;s opinion on <code>systemd</code>
<a href=https://www.reddit.com/r/linux/comments/5n069y/why_do_people_not_like_systemd/>is pretty
divided</a>.</p><p>There are a bunch of other alternatives, but my knowledge of GNU/Linux init
systems is minimal. Therefore, I will stop right here and ask for your help: if
you would like to contribute a Linux init system configuration to this article,
drop the link to a gist/repo in the comments, and I will include it in this
article.</p><p>Of course, with proper attribution.</p><p>You can see the final implementation of the observer
<a href=https://github.com/fteem/go-playground/tree/master/observer>here</a>.</p><section class=subscribe><b>Liked this article?</b> <a href=/newsletter>Subscribe to my
newsletter</a> and get my fresh posts in your inbox. It's short and sweet,
going out monthly to over 1,000 subscribers.</section></div><footer class=post-footer><nav class=paginav><a class=prev href=https://ieftimov.com/post/testing-in-go-stop-leaking-files/><span class=title>« Prev Page</span><br><span>Testing in Go: Stop Leaking Files</span></a>
<a class=next href=https://ieftimov.com/post/understanding-bytes-golang-build-tcp-protocol/><span class=title>Next Page »</span><br><span>Understanding bytes in Go by building a TCP protocol</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Four Steps to Daemonize Your Go Programs on twitter" href="https://twitter.com/intent/tweet/?text=Four%20Steps%20to%20Daemonize%20Your%20Go%20Programs&url=https%3a%2f%2fieftimov.com%2fpost%2ffour-steps-daemonize-your-golang-programs%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Four Steps to Daemonize Your Go Programs on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fieftimov.com%2fpost%2ffour-steps-daemonize-your-golang-programs%2f&title=Four%20Steps%20to%20Daemonize%20Your%20Go%20Programs&summary=Four%20Steps%20to%20Daemonize%20Your%20Go%20Programs&source=https%3a%2f%2fieftimov.com%2fpost%2ffour-steps-daemonize-your-golang-programs%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Four Steps to Daemonize Your Go Programs on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fieftimov.com%2fpost%2ffour-steps-daemonize-your-golang-programs%2f&title=Four%20Steps%20to%20Daemonize%20Your%20Go%20Programs"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Four Steps to Daemonize Your Go Programs on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fieftimov.com%2fpost%2ffour-steps-daemonize-your-golang-programs%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Four Steps to Daemonize Your Go Programs on whatsapp" href="https://api.whatsapp.com/send?text=Four%20Steps%20to%20Daemonize%20Your%20Go%20Programs%20-%20https%3a%2f%2fieftimov.com%2fpost%2ffour-steps-daemonize-your-golang-programs%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Four Steps to Daemonize Your Go Programs on telegram" href="https://telegram.me/share/url?text=Four%20Steps%20to%20Daemonize%20Your%20Go%20Programs&url=https%3a%2f%2fieftimov.com%2fpost%2ffour-steps-daemonize-your-golang-programs%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>Copyright 2021 © Ilija Eftimov</span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position"))},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})});var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft)}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>