<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Four Steps to Daemonize Your Go Programs - Ilija Eftimov</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta itemprop="name" content="Four Steps to Daemonize Your Go Programs">
<meta itemprop="description" content="Hands-on introduction for the best four-step approach to daemonizing your Go programs">
<meta itemprop="datePublished" content="2020-05-02T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-05-02T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="3240">
<meta itemprop="image" content="https://ieftimov.com/cards/four-steps-daemonize-your-golang-programs.png">



<meta itemprop="keywords" content="" /><meta property="og:title" content="Four Steps to Daemonize Your Go Programs" />
<meta property="og:description" content="Hands-on introduction for the best four-step approach to daemonizing your Go programs" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ieftimov.com/post/four-steps-daemonize-your-golang-programs/" />
<meta property="og:image" content="https://ieftimov.com/cards/four-steps-daemonize-your-golang-programs.png" />
<meta property="article:published_time" content="2020-05-02T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-05-02T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://ieftimov.com/cards/four-steps-daemonize-your-golang-programs.png"/>

<meta name="twitter:title" content="Four Steps to Daemonize Your Go Programs"/>
<meta name="twitter:description" content="Hands-on introduction for the best four-step approach to daemonizing your Go programs"/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://ieftimov.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://ieftimov.com/css/main.css" />
		<link rel="stylesheet" type="text/css" href="https://ieftimov.com/css/overrides.css" />
	

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="https://ieftimov.com/css/dark.css" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="https://ieftimov.com/js/main.js"></script><script src="https://ieftimov.com/js/tooltip.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="https://ieftimov.com/">
				<img src="/avatar.png" alt="Ilija Eftimov" />
			</a>
		</div>
	
	<h1 class="site-title"><a href="https://ieftimov.com/">Ilija Eftimov</a></h1>
	<div class="site-description"><p>A human, interested in building products and software.</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/fteem" title="Github"><i data-feather="github"></i></a></li><li><a href="https://twitter.com/itsilija" title="Twitter"><i data-feather="twitter"></i></a></li><li><a href="https://www.linkedin.com/in/ieftimov" title="Linkedin"><i data-feather="linkedin"></i></a></li><li><a href="mailto:blog@ieftimov.com" title="Email"><i data-feather="mail"></i></a></li><li><a href="https://t.me/ieftimovcom" title="Telegram Channel"><i data-feather="send"></i></a></li><li><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></li></ul>
		</nav><span class="scheme-toggle"><a href="#" id="scheme-toggle"></a></div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/categories/testing-in-go">Testing in Go</a>
			</li>
			
			<li>
				<a href="/posts">Archive</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="https://forms.gle/orfXK5jh1LRaiFzo8">Suggest a topic</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">02</span>
							<span class="rest">May 2020</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Four Steps to Daemonize Your Go Programs</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>If you have ever worked with Ruby, or have maybe maintained a Rails
application, I am sure the name Sidekiq will sound familiar. For those
unfamiliar with the project, Sidekiq is a job system for Ruby. It is a <a href="https://github.com/mperham/sidekiq">wildly
popular</a> project, and the author has turned
it into <a href="https://sidekiq.org/">a successful business</a>.</p>
<p>None of the above would be relevant if Sidekiq's author Mike Perham, in 2014,
did not write a concise and informative post titled <a href="https://www.mikeperham.com/2014/09/22/dont-daemonize-your-daemons">&ldquo;Don't Daemonize your
Daemons!&quot;</a>.
In it, he covers four guidelines to daemonizing programs correctly:</p>
<ol>
<li>Log to <code>STDOUT</code></li>
<li>Shut down on <code>SIGTERM</code>/<code>SIGINT</code></li>
<li>Reload config on <code>SIGHUP</code></li>
<li>Provide the necessary config file for your favorite init system to control
your daemon</li>
</ol>
<p>(You can also read the whole article on <a href="https://www.mikeperham.com/2014/09/22/dont-daemonize-your-daemons/">his
website</a>.)</p>
<p>So I was thinking, why don't we explore how to apply these guidelines while
daemonizing a Go program?</p>
<h2 id="website-observer">Website Observer</h2>
<p>The program in question is a simple command-line program that can monitor any
website by sending periodic HTTP requests to it. If you ever heard of
Datadog's synthetic tests or Pingdom, think of our program as their little
sibling.</p>
<p>The <code>observer</code> program will read its configuration from flags, environment
variables, or a configuration file. If the configuration is not present as a
flag, it will look into the <code>ENV</code> vars for it and then in a configuration file
(if present). If nothing is found, it will use the default value or exit with
an error depending on how crucial the configuration is.</p>
<p>To do this, we will use <a href="https://github.com/namsral/flag">the <code>namsral/flag</code>
package</a>, which is a drop-in replacement for
Go's flag package, with the addition of parsing files and environment
variables. Being a drop-in replacement means that using the <code>namsral/flag</code>
package is as simple as using the <code>flag</code> package from the standard library.</p>
<p>First, <code>observer</code> will have a <code>config</code> type, which will encapsulate the
configuration for the website that it will observe:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="font-weight:bold">const</span> defaultTick = <span style="color:#099">60</span> <span style="font-weight:bold">*</span> time.Second

<span style="font-weight:bold">type</span> config <span style="font-weight:bold">struct</span> {
	contentType <span style="color:#458;font-weight:bold">string</span>
	server      <span style="color:#458;font-weight:bold">string</span>
	statusCode  <span style="color:#458;font-weight:bold">int</span>
	tick        time.Duration
	url         <span style="color:#458;font-weight:bold">string</span>
	userAgent   <span style="color:#458;font-weight:bold">string</span>
}

<span style="font-weight:bold">func</span> (c <span style="font-weight:bold">*</span>config) <span style="color:#900;font-weight:bold">init</span>(args []<span style="color:#458;font-weight:bold">string</span>) <span style="color:#458;font-weight:bold">error</span> {
	flags <span style="font-weight:bold">:=</span> flag.<span style="color:#900;font-weight:bold">NewFlagSet</span>(args[<span style="color:#099">0</span>], flag.ExitOnError)
	flags.<span style="color:#900;font-weight:bold">String</span>(flag.DefaultConfigFlagname, <span style="color:#b84">&#34;&#34;</span>, <span style="color:#b84">&#34;Path to config file&#34;</span>)

	<span style="font-weight:bold">var</span> (
		statusCode  = flags.<span style="color:#900;font-weight:bold">Int</span>(<span style="color:#b84">&#34;status&#34;</span>, <span style="color:#099">200</span>, <span style="color:#b84">&#34;Response HTTP status code&#34;</span>)
		tick        = flags.<span style="color:#900;font-weight:bold">Duration</span>(<span style="color:#b84">&#34;tick&#34;</span>, defaultTick, <span style="color:#b84">&#34;Ticking interval&#34;</span>)
		server      = flags.<span style="color:#900;font-weight:bold">String</span>(<span style="color:#b84">&#34;server&#34;</span>, <span style="color:#b84">&#34;&#34;</span>, <span style="color:#b84">&#34;Server HTTP header value&#34;</span>)
		contentType = flags.<span style="color:#900;font-weight:bold">String</span>(<span style="color:#b84">&#34;content_type&#34;</span>, <span style="color:#b84">&#34;&#34;</span>, <span style="color:#b84">&#34;Content-Type HTTP header value&#34;</span>)
		userAgent   = flags.<span style="color:#900;font-weight:bold">String</span>(<span style="color:#b84">&#34;user_agent&#34;</span>, <span style="color:#b84">&#34;&#34;</span>, <span style="color:#b84">&#34;User-Agent HTTP header value&#34;</span>)
		url         = flags.<span style="color:#900;font-weight:bold">String</span>(<span style="color:#b84">&#34;url&#34;</span>, <span style="color:#b84">&#34;&#34;</span>, <span style="color:#b84">&#34;Request URL&#34;</span>)
	)

	<span style="font-weight:bold">if</span> err <span style="font-weight:bold">:=</span> flags.<span style="color:#900;font-weight:bold">Parse</span>(args[<span style="color:#099">1</span>:]); err <span style="font-weight:bold">!=</span> <span style="font-weight:bold">nil</span> {
		<span style="font-weight:bold">return</span> err
	}

	c.statusCode = <span style="font-weight:bold">*</span>statusCode
	c.tick = <span style="font-weight:bold">*</span>tick
	c.server = <span style="font-weight:bold">*</span>server
	c.contentType = <span style="font-weight:bold">*</span>contentType
	c.userAgent = <span style="font-weight:bold">*</span>userAgent
	c.url = <span style="font-weight:bold">*</span>url

	<span style="font-weight:bold">return</span> <span style="font-weight:bold">nil</span>
}
</code></pre></div><p>The <code>init</code> function will take the command line arguments as input and build a
<code>FlagSet</code>, which represents a set of defined flags. Each of the flags is listed
and parsed; then, their values are assigned to the <code>config</code>. Additionally,
having the <code>flag.DefaultConfigFilename</code> as a flag as well enables our
<code>observer</code> to load the configuration from a <code>config.conf</code> file. The <code>.conf</code>
file has a <code>key=value</code> format, with new lines after each key-value pair.</p>
<p>Here's the main function:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="font-weight:bold">func</span> <span style="color:#900;font-weight:bold">main</span>() {
	ctx <span style="font-weight:bold">:=</span> context.<span style="color:#900;font-weight:bold">Background</span>()
	ctx, cancel <span style="font-weight:bold">:=</span> context.<span style="color:#900;font-weight:bold">WithCancel</span>(ctx)

	c <span style="font-weight:bold">:=</span> <span style="font-weight:bold">&amp;</span>config{}

	<span style="font-weight:bold">defer</span> <span style="font-weight:bold">func</span>() {
		<span style="color:#900;font-weight:bold">cancel</span>()
	}()

	<span style="font-weight:bold">if</span> err <span style="font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">run</span>(ctx, c); err <span style="font-weight:bold">!=</span> <span style="font-weight:bold">nil</span> {
		fmt.<span style="color:#900;font-weight:bold">Fprintf</span>(os.Stderr, <span style="color:#b84">&#34;%s\n&#34;</span>, err)
		os.<span style="color:#900;font-weight:bold">Exit</span>(<span style="color:#099">1</span>)
	}
}
</code></pre></div><p>Following <a href="https://pace.dev/blog/2020/02/12/why-you-shouldnt-use-func-main-in-golang-by-mat-ryer.html">Mat Ryer's
advice</a>,
we are going to keep <code>main</code> very thin while keeping the main logic of the
<code>observer</code> in the <code>run</code> method. <code>main</code> here just sets up the main context that
will propagate down to the <code>run</code> method, and it initializes the observer
<code>config</code>. Then it passes all of the relevant arguments to the <code>run</code> method.</p>
<p>Here's the <code>run</code> method:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="font-weight:bold">func</span> <span style="color:#900;font-weight:bold">run</span>(ctx context.Context, c <span style="font-weight:bold">*</span>config) <span style="color:#458;font-weight:bold">error</span> {
	c.<span style="color:#900;font-weight:bold">init</span>(os.Args)

	<span style="font-weight:bold">for</span> {
		<span style="font-weight:bold">select</span> {
		<span style="font-weight:bold">case</span> <span style="font-weight:bold">&lt;-</span>ctx.<span style="color:#900;font-weight:bold">Done</span>():
			<span style="font-weight:bold">return</span> <span style="font-weight:bold">nil</span>
		<span style="font-weight:bold">case</span> <span style="font-weight:bold">&lt;-</span>time.<span style="color:#900;font-weight:bold">Tick</span>(c.tick):
			resp, err <span style="font-weight:bold">:=</span> http.<span style="color:#900;font-weight:bold">Get</span>(c.url)
			<span style="font-weight:bold">if</span> err <span style="font-weight:bold">!=</span> <span style="font-weight:bold">nil</span> {
				<span style="font-weight:bold">return</span> err
			}

			<span style="font-weight:bold">if</span> resp.StatusCode <span style="font-weight:bold">!=</span> c.statusCode {
				log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#b84">&#34;Status code mismatch, got: %d\n&#34;</span>, resp.StatusCode)
			}

			<span style="font-weight:bold">if</span> s <span style="font-weight:bold">:=</span> resp.Header.<span style="color:#900;font-weight:bold">Get</span>(<span style="color:#b84">&#34;server&#34;</span>); s <span style="font-weight:bold">!=</span> c.server {
				log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#b84">&#34;Server header mismatch, got: %s\n&#34;</span>, s)
			}

			<span style="font-weight:bold">if</span> ct <span style="font-weight:bold">:=</span> resp.Header.<span style="color:#900;font-weight:bold">Get</span>(<span style="color:#b84">&#34;content-type&#34;</span>); ct <span style="font-weight:bold">!=</span> c.contentType {
				log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#b84">&#34;Content-Type header mismatch, got: %s\n&#34;</span>, ct)
			}

			<span style="font-weight:bold">if</span> ua <span style="font-weight:bold">:=</span> resp.Header.<span style="color:#900;font-weight:bold">Get</span>(<span style="color:#b84">&#34;user-agent&#34;</span>); ua <span style="font-weight:bold">!=</span> c.userAgent {
				log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#b84">&#34;User-Agent header mismatch, got: %s\n&#34;</span>, ua)
			}
		}
	}
}
</code></pre></div><p>First, the <code>run</code> method initializes the <code>config</code> instance <code>c</code>, using the <code>init</code>
method. Then, it loops infinitely until the context <code>ctx</code> is done. When <code>ctx</code>
is done, it means the <code>observer</code> process is terminated, so it merely returns a
<code>nil</code> and finishes with its execution.</p>
<p>Alternatively, it will execute the other case every <code>tick</code>. By using the
<code>time.Tick</code> channel here we run this code by receiving a signal through the
channel every <code>c.tick</code> period. For example, if <code>c.tick</code> is 30 seconds, we will
receive a signal every 30 seconds, meaning the code will run every 30 seconds.</p>
<p>The code itself is simple – it sends an HTTP <code>GET</code> request to the URL assigned
to <code>c.url</code>. Once the response returns, the <code>run</code> method compares the relevant
response headers and the status code with the once provided through the
configuration. If any mismatch is detected, it logs the error.</p>
<p>Running the <code>observer</code> is relatively simple. One way is to supply a config file
through the command line:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./observer -config ./config.conf
2020/04/23 19:41:54 Status code mismatch, got: <span style="color:#099">200</span>
</code></pre></div><p>Alternatively, using flags:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./observer -status<span style="font-weight:bold">=</span><span style="color:#099">500</span> -tick<span style="font-weight:bold">=</span>10s -url<span style="font-weight:bold">=</span>https://ieftimov.com -server<span style="font-weight:bold">=</span>Cloudflare
2020/04/23 19:43:34 Status code mismatch, got: <span style="color:#099">200</span>
2020/04/23 19:43:34 Server header mismatch, got: cloudflare
2020/04/23 19:43:34 Content-Type header mismatch, got: text/html; <span style="color:#008080">charset</span><span style="font-weight:bold">=</span>utf-8
</code></pre></div><p>We can do the same using environment variables, or a combination of all three:
config file, environment variables, and flags.</p>
<p>Now, how can we apply the four simple rules of daemonization?</p>
<h2 id="logging-to-stdout">Logging to <code>STDOUT</code></h2>
<p>While daemons don't have much to do with web services, one of the 12 factors of
modern web services are treating logs as event streams. While the 12 factors in
this particular case are not applicable, the guiding principle stays: the
daemon itself should not manage log streams, nor it should not concern itself
with writing to or managing log files. Instead, daemons should send their log
stream, unbuffered, to <code>STDOUT</code>.</p>
<p>The service management system will capture each daemon's stream. The <code>init</code>
config file is what we will use to configure logging, such as where the logs
should be stored or streamed.</p>
<p>So, how can we adapt the <code>observer</code> to log to <code>STDOUT</code>?</p>
<p>First, we will add another argument to the <code>run</code> function, called <code>out</code> of type
<code>io.Writer</code>. Then, we will invoke the <code>log.SetOutput</code> function passing the
<code>out</code> as argument to it.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="font-weight:bold">func</span> <span style="color:#900;font-weight:bold">run</span>(ctx context.Context, c <span style="font-weight:bold">*</span>config, out io.Writer) <span style="color:#458;font-weight:bold">error</span> {
	c.<span style="color:#900;font-weight:bold">init</span>(os.Args)
	log.<span style="color:#900;font-weight:bold">SetOutput</span>(out)

	<span style="font-weight:bold">for</span> {
		<span style="font-weight:bold">select</span> {
		<span style="font-weight:bold">case</span> <span style="font-weight:bold">&lt;-</span>ctx.<span style="color:#900;font-weight:bold">Done</span>():
			<span style="font-weight:bold">return</span> <span style="font-weight:bold">nil</span>
		<span style="font-weight:bold">case</span> <span style="font-weight:bold">&lt;-</span>time.<span style="color:#900;font-weight:bold">Tick</span>(c.tick):
			<span style="color:#998;font-style:italic">// Identical to above, removed from brewity
</span><span style="color:#998;font-style:italic"></span>		}
	}
}
</code></pre></div><p>By doing this, we will have to pass <code>STDOUT</code> from the <code>main</code> function, but we
keep our <code>run</code> function more testable. Using a separate <code>run</code> method means we
can invoke it with any instance that implements the <code>io.Writer</code> interface. We
basically couple the <code>run</code> method to <strong>a behavior instead of type</strong>.</p>
<p>Then, we need to update the <code>main</code> function to pass the additional argument to
the <code>run</code> function when invoking it. And the <code>io.Writer</code> will be simple
<code>os.Stdout</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="font-weight:bold">func</span> <span style="color:#900;font-weight:bold">main</span>() {
	ctx <span style="font-weight:bold">:=</span> context.<span style="color:#900;font-weight:bold">Background</span>()
	ctx, cancel <span style="font-weight:bold">:=</span> context.<span style="color:#900;font-weight:bold">WithCancel</span>(ctx)

	c <span style="font-weight:bold">:=</span> <span style="font-weight:bold">&amp;</span>config{}

	<span style="font-weight:bold">defer</span> <span style="font-weight:bold">func</span>() {
		<span style="color:#900;font-weight:bold">cancel</span>()
	}()

	<span style="font-weight:bold">if</span> err <span style="font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">run</span>(ctx, c, os.Stdout); err <span style="font-weight:bold">!=</span> <span style="font-weight:bold">nil</span> {
		fmt.<span style="color:#900;font-weight:bold">Fprintf</span>(os.Stderr, <span style="color:#b84">&#34;%s\n&#34;</span>, err)
		os.<span style="color:#900;font-weight:bold">Exit</span>(<span style="color:#099">1</span>)
	}
}
</code></pre></div><p>If we run the program again we won't see a difference:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./observer -status<span style="font-weight:bold">=</span><span style="color:#099">500</span> -tick<span style="font-weight:bold">=</span>10s -url<span style="font-weight:bold">=</span>https://ieftimov.com -server<span style="font-weight:bold">=</span>Cloudflare
2020/04/23 19:43:34 Status code mismatch, got: <span style="color:#099">200</span>
2020/04/23 19:43:34 Server header mismatch, got: cloudflare
2020/04/23 19:43:34 Content-Type header mismatch, got: text/html; <span style="color:#008080">charset</span><span style="font-weight:bold">=</span>utf-8
</code></pre></div><p>Why is that? Well, the <code>log</code> package <a href="https://github.com/golang/go/blob/5477623/src/log/log.go#L76">logs to <code>STDERR</code> by
default</a>, so
there is no visible change of behavior there. Still, we make the dependency on
an output stream explicit to the <code>run</code> function, which clearly states that
<code>run</code> needs to know where to send its logs when running.</p>
<h2 id="shut-down-on-sigtermsigint">Shut down on <code>SIGTERM</code>/<code>SIGINT</code></h2>
<p>In Go, having errors as values is very helpful to think about what will happen
to our program if an error is returned. While this makes our Go programs
always have some repetitive error handling, it also gives us confidence that
our program will gracefully handle any error.</p>
<h3 id="termination-signals">Termination signals</h3>
<p>*nix operating systems (OS) employ a system of signals, which is a mechanism
of the OS to ask a process to perform a particular action. There are two
general types of signals: those that cause termination of a process and those
that do not.</p>
<p>(Refer to <a href="https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/signal.h.html">the full
list</a>
of the POSIX-defined signals to learn more.)</p>
<p>Using these system signals, a process that has received one can choose one of
the following behaviors to take place: perform the default POSIX-defined
action, ignore the signal, or catch the signal with a signal handler and
perform some sort of a custom action.</p>
<p>Some signals that just can't be caught or ignored; it means that the default
action has to happen. For example, <code>SIGSTOP</code> and <code>SIGKILL</code> are such signals.
Once a process receives any of these two signals, we just know that it will be
stopped/killed by the OS.</p>
<p>But other signals are more polite. While we cannot ignore them, they give a
chance to our process to clean up and go away with grace. Most of the ones on
<a href="https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/signal.h.html">the
list</a>
are of the polite kind. In this section, we will look into the <code>SIGTERM</code> and
<code>SIGINT</code> signals and how we can treat them in our Go programs.</p>
<h3 id="handling-sigterm--signit">Handling <code>SIGTERM</code> &amp; <code>SIGNIT</code></h3>
<p>The <a href="https://golang.org/pkg/os/signal"><code>os/signal</code></a> package implements access
to incoming signals with the purpose of signal handling. Through the
<a href="https://golang.org/pkg/os/signal/#Notify"><code>Notify</code></a> function, a Go program can
accept signals thorough a channel of type <code>os.Signal</code>.</p>
<p>In our <code>observer</code>'s case, we don't have to do any cleanup once it receives a
<code>SIGTERM</code>/<code>SIGINT</code>. All we have to do is to stop further execution and shut
down gracefully. So, how can we achieve that?</p>
<p>First, we need to create a channel through which we will accept these two signals:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">signalChan <span style="font-weight:bold">:=</span> <span style="color:#999">make</span>(<span style="font-weight:bold">chan</span> os.Signal, <span style="color:#099">1</span>)
signal.<span style="color:#900;font-weight:bold">Notify</span>(signalChan, syscall.SIGINT, syscall.SIGTERM)
</code></pre></div><p>Once the <code>observer</code> process receives a <code>SIGINT</code> or a <code>SIGTERM</code>, it will proxy
it through the <code>signalChan</code> channel. To process the signals, we would need to
create a goroutine that will receive signals through the <code>signalChan</code>. Once it
gets a signal, it will have to <code>cancel()</code> the context, which would stop the
further execution of the <code>run</code> method:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="font-weight:bold">go</span> <span style="font-weight:bold">func</span>() {
        <span style="font-weight:bold">select</span> {
        <span style="font-weight:bold">case</span> = <span style="font-weight:bold">&lt;-</span>signalChan:
                log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#b84">&#34;Got SIGINT/SIGTERM, exiting.&#34;</span>)
                <span style="color:#900;font-weight:bold">cancel</span>()
                os.<span style="color:#900;font-weight:bold">Exit</span>(<span style="color:#099">1</span>)
        <span style="font-weight:bold">case</span> <span style="font-weight:bold">&lt;-</span>ctx.<span style="color:#900;font-weight:bold">Done</span>():
                log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#b84">&#34;Done.&#34;</span>)
                os.<span style="color:#900;font-weight:bold">Exit</span>(<span style="color:#099">1</span>)
        }
}()
</code></pre></div><p>So, once the <code>cancel</code> function is executed, in the <code>for</code> loop of the <code>run</code>
method the execution will stop:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="font-weight:bold">func</span> <span style="color:#900;font-weight:bold">run</span>(ctx context.Context, c <span style="font-weight:bold">*</span>config, stdout io.Writer) <span style="color:#458;font-weight:bold">error</span> {
        c.<span style="color:#900;font-weight:bold">init</span>(os.Args)
        log.<span style="color:#900;font-weight:bold">SetOutput</span>(os.Stdout)

        <span style="font-weight:bold">for</span> {
                <span style="font-weight:bold">select</span> {
                <span style="font-weight:bold">case</span> <span style="font-weight:bold">&lt;-</span>ctx.<span style="color:#900;font-weight:bold">Done</span>():
                        <span style="font-weight:bold">return</span> <span style="font-weight:bold">nil</span>
                <span style="font-weight:bold">case</span> <span style="font-weight:bold">&lt;-</span>time.<span style="color:#900;font-weight:bold">Tick</span>(c.tick):
                        <span style="color:#998;font-style:italic">// Same as above...
</span><span style="color:#998;font-style:italic"></span>                }
        }
}
</code></pre></div><p>The last thing we need to do in the <code>main</code> function is to close the
<code>signalChan</code> channel when the programs exits:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="font-weight:bold">func</span> <span style="color:#900;font-weight:bold">main</span>() {
	<span style="color:#998;font-style:italic">// Same as above...
</span><span style="color:#998;font-style:italic"></span>
	<span style="font-weight:bold">defer</span> <span style="font-weight:bold">func</span>() {
                signal.<span style="color:#900;font-weight:bold">Stop</span>(signalChan)
		<span style="color:#900;font-weight:bold">cancel</span>()
	}()

	<span style="color:#998;font-style:italic">// Same as above...
</span><span style="color:#998;font-style:italic"></span>}
</code></pre></div><p>The <code>Stop</code> function will stop relaying incoming signals to <code>signalChan</code>. When
<code>Stop</code> returns, it is guaranteed that <code>signalChan</code> will receive no more
signals.</p>
<p>Let's run the <code>observer</code> program and see the signal handling in action:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./observer -config<span style="font-weight:bold">=</span>config.conf
2020/04/26 00:14:46 Status code mismatch, got: <span style="color:#099">200</span>
...
2020/04/26 00:15:46 Status code mismatch, got: <span style="color:#099">200</span>
</code></pre></div><p>Now, having the PID of <code>observer</code>, we can send any signal using the <code>kill</code>
command line tool:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#999">kill</span> -SIGINT <span style="color:#099">37212</span>
</code></pre></div><p>By executing the <code>kill</code> command, we will send a <code>SIGINT</code> to the <code>observer</code>
process. This will force <code>observer</code> to wrap up the execution, log a line to
<code>STDOUT</code> and exit:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./observer -config<span style="font-weight:bold">=</span>config.conf
2020/04/26 00:29:22 Status code mismatch, got: <span style="color:#099">200</span>
2020/04/26 00:29:22 Got SIGINT/SIGTERM, exiting.
<span style="color:#999">exit</span> status <span style="color:#099">1</span>
</code></pre></div><p>We can try the same exercise with <code>SIGTERM</code> as well:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">› <span style="color:#999">kill</span> -SIGTERM <span style="color:#099">37827</span>
</code></pre></div><p>Causes <code>observer</code> to exit with the same behavior:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./observer -config<span style="font-weight:bold">=</span>config.conf
2020/04/26 00:33:42 Status code mismatch, got: <span style="color:#099">200</span>
2020/04/26 00:33:44 Got SIGINT/SIGTERM, exiting.
<span style="color:#999">exit</span> status <span style="color:#099">1</span>
</code></pre></div><h2 id="reload-config-on-sighup">Reload config on <code>SIGHUP</code></h2>
<p>Now that we know how to handle signals, we need to add another signal to the
mix - <code>SIGHUP</code>. To do that, we can just add <code>syscall.SIGHUP</code> to the
<code>signal.Notify</code> call:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">signalChan <span style="font-weight:bold">:=</span> <span style="color:#999">make</span>(<span style="font-weight:bold">chan</span> os.Signal, <span style="color:#099">1</span>)
signal.<span style="color:#900;font-weight:bold">Notify</span>(signalChan, syscall.SIGINT, syscall.SIGTERM, syscall.SIGHUP)
</code></pre></div><p>Now that we have <code>SIGHUP</code> covered, in the goroutine that handles the signals,
once a <code>SIGHUP</code> is received, it should re-run the <code>config.init</code> method. By
doing that, we will reload the configuration of the <code>observer</code>, loading any
changes in the configuration:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="font-weight:bold">go</span> <span style="font-weight:bold">func</span>() {
        <span style="font-weight:bold">select</span> {
        <span style="font-weight:bold">case</span> s <span style="font-weight:bold">:=</span> <span style="font-weight:bold">&lt;-</span>signalChan:
                <span style="font-weight:bold">switch</span> s {
                <span style="font-weight:bold">case</span> syscall.SIGINT, syscall.SIGTERM:
                        log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#b84">&#34;Got SIGINT/SIGTERM, exiting.&#34;</span>)
                        <span style="color:#900;font-weight:bold">cancel</span>()
                        os.<span style="color:#900;font-weight:bold">Exit</span>(<span style="color:#099">1</span>)
                <span style="font-weight:bold">case</span> syscall.SIGHUP:
                        log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#b84">&#34;Got SIGHUP, reloading.&#34;</span>)
                        c.<span style="color:#900;font-weight:bold">init</span>(os.Args)
                }
        <span style="font-weight:bold">case</span> <span style="font-weight:bold">&lt;-</span>ctx.<span style="color:#900;font-weight:bold">Done</span>():
                log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#b84">&#34;Done.&#34;</span>)
                os.<span style="color:#900;font-weight:bold">Exit</span>(<span style="color:#099">1</span>)
        }
}()
</code></pre></div><p>The change is relatively small. By using a <code>switch</code> construct, detect the
received signal. If it's a <code>SIGHUP</code>, we invoke <code>c.init(os.Args)</code>. Otherwise,
we <code>cancel()</code> the context and <code>os.Exit</code> the program.</p>
<p>We can test this using the same trick from before:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#999">kill</span> -SIGHUP <span style="color:#099">38761</span>
</code></pre></div><p>Will cause the <code>observer</code> to reload:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./observer -config<span style="font-weight:bold">=</span>config.conf
2020/04/26 01:15:40 Status code mismatch, got: <span style="color:#099">200</span>
2020/04/26 01:15:44 Got SIGHUP, reloading.
</code></pre></div><p>This looks nice. Let's shut down the server now by sending a <code>SIGTERM</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#999">kill</span> -SIGTERM <span style="color:#099">38761</span>
</code></pre></div><p>In case you're following along, you will find out that the <code>observer</code> is still
running; this is a bug – the goroutine that was receiving signals exited
because the <code>select</code> construct completed once it received the <code>SIGHUP</code>.</p>
<p>To make the goroutine accept signals without exiting, we need to make the
goroutine run infinitely – using a <code>for</code> loop:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="font-weight:bold">go</span> <span style="font-weight:bold">func</span>() {
        <span style="font-weight:bold">for</span> {
                <span style="font-weight:bold">select</span> {
                <span style="font-weight:bold">case</span> s <span style="font-weight:bold">:=</span> <span style="font-weight:bold">&lt;-</span>signalChan:
                        <span style="font-weight:bold">switch</span> s {
                        <span style="font-weight:bold">case</span> syscall.SIGINT, syscall.SIGTERM:
                                log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#b84">&#34;Got SIGINT/SIGTERM, exiting.&#34;</span>)
                                <span style="color:#900;font-weight:bold">cancel</span>()
                                os.<span style="color:#900;font-weight:bold">Exit</span>(<span style="color:#099">1</span>)
                        <span style="font-weight:bold">case</span> syscall.SIGHUP:
                                log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#b84">&#34;Got SIGHUP, reloading.&#34;</span>)
                                c.<span style="color:#900;font-weight:bold">init</span>(os.Args)
                        }
                <span style="font-weight:bold">case</span> <span style="font-weight:bold">&lt;-</span>ctx.<span style="color:#900;font-weight:bold">Done</span>():
                        log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#b84">&#34;Done.&#34;</span>)
                        os.<span style="color:#900;font-weight:bold">Exit</span>(<span style="color:#099">1</span>)
                }
        }
}()
</code></pre></div><p>By wrapping the whole goroutine in a <code>for</code> loop, we will make sure that it will
not exit, except when a <code>SIGINT</code>/<code>SIGTERM</code> is received, or if the context is
done. By having this endless goroutine, we also can send multiple <code>SIGHUP</code>s to
the <code>observer</code>, and it will process them correctly.</p>
<p>Let's send two <code>SIGHUP</code>s, to perform two reloads, and <code>SIGTERM</code> to shut down
the <code>observer</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#999">kill</span> -SIGHUP <span style="color:#099">38960</span>
$ <span style="color:#999">kill</span> -SIGHUP <span style="color:#099">38960</span>
$ <span style="color:#999">kill</span> -SIGTERM <span style="color:#099">38960</span>
</code></pre></div><p>And the <code>observer</code> output:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./observer -config<span style="font-weight:bold">=</span>config.conf
2020/04/26 01:25:02 Status code mismatch, got: <span style="color:#099">200</span>
2020/04/26 01:25:03 Got SIGHUP, reloading.
2020/04/26 01:25:05 Got SIGHUP, reloading.
2020/04/26 01:25:08 Got SIGINT/SIGTERM, exiting.
</code></pre></div><p>And that's it. The <code>observer</code> now knows how to log to <code>STDOUT</code>, gracefully exit
when it receives <code>SIGINT</code> or <code>SIGTERM</code> and reloads the configuration when it
receives a <code>SIGHUP</code>.</p>
<h2 id="provide-the-necessary-config-file-for-your-favorite-init-system-to-control-your-daemon">Provide the necessary config file for your favorite init system to control your daemon</h2>
<p>Now, given that computer of choice is a MacBook, I will explain here how you
can create a config file for <a href="https://www.launchd.info/"><code>launchd</code></a> – macOS's
service management framework for starting, stopping and managing daemons,
applications, processes, and scripts. In macOS, the system runs daemons, while
the users run programs as agents. So, we will turn our <code>observer</code> into an
agent.</p>
<p>In the past, I have written about <a href="/create-manage-macos-launchd-agents-golang">creating and managing macOS
agents</a>, so if you would like to
more about this topic, you can head read that as well. Still, let's see a
minimal <code>launchd</code> configuration for <code>observer</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#999;font-weight:bold">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style="color:#999;font-weight:bold">&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;</span>
<span style="color:#000080">&lt;plist</span> <span style="color:#008080">version=</span><span style="color:#b84">&#34;1.0&#34;</span><span style="color:#000080">&gt;</span>
    <span style="color:#000080">&lt;dict</span><span style="color:#000080">&gt;</span>
        <span style="color:#000080">&lt;key</span><span style="color:#000080">&gt;</span>Label<span style="color:#000080">&lt;/key&gt;</span>
        <span style="color:#000080">&lt;string</span><span style="color:#000080">&gt;</span>com.ieftimov.observer<span style="color:#000080">&lt;/string&gt;</span>

        <span style="color:#000080">&lt;key</span><span style="color:#000080">&gt;</span>RunAtLoad<span style="color:#000080">&lt;/key&gt;</span>
        <span style="color:#000080">&lt;true</span><span style="color:#000080">/&gt;</span>

        <span style="color:#000080">&lt;key</span><span style="color:#000080">&gt;</span>KeepAlive<span style="color:#000080">&lt;/key&gt;</span>
        <span style="color:#000080">&lt;true</span><span style="color:#000080">/&gt;</span>

        <span style="color:#000080">&lt;key</span><span style="color:#000080">&gt;</span>ProgramArguments<span style="color:#000080">&lt;/key&gt;</span>
        <span style="color:#000080">&lt;array</span><span style="color:#000080">&gt;</span>
          <span style="color:#000080">&lt;string</span><span style="color:#000080">&gt;</span>/usr/local/bin/observer<span style="color:#000080">&lt;/string&gt;</span>
          <span style="color:#000080">&lt;string</span><span style="color:#000080">&gt;</span>-config<span style="color:#000080">&lt;/string&gt;</span>
          <span style="color:#000080">&lt;string</span><span style="color:#000080">&gt;</span>/etc/observer.conf<span style="color:#000080">&lt;/string&gt;</span>
        <span style="color:#000080">&lt;/array&gt;</span>

        <span style="color:#000080">&lt;key</span><span style="color:#000080">&gt;</span>StandardOutPath<span style="color:#000080">&lt;/key&gt;</span>
        <span style="color:#000080">&lt;string</span><span style="color:#000080">&gt;</span>/tmp/observer.log<span style="color:#000080">&lt;/string&gt;</span>

        <span style="color:#000080">&lt;key</span><span style="color:#000080">&gt;</span>StandardErrorPath<span style="color:#000080">&lt;/key&gt;</span>
        <span style="color:#000080">&lt;string</span><span style="color:#000080">&gt;</span>/tmp/observer.error.log<span style="color:#000080">&lt;/string&gt;</span>
    <span style="color:#000080">&lt;/dict&gt;</span>
<span style="color:#000080">&lt;/plist&gt;</span>
</code></pre></div><p>The configuration is relatively straightforward, here are all of the pieces in
order:</p>
<ul>
<li>The <code>Label</code> identifies the job and has to be unique for the launchd instance.
Think of it as a unique name for the given agent.</li>
<li><code>RunAtLoad</code> means <code>launchd</code> will start the job as soon as it loads it.</li>
<li><code>KeepAlive</code> tells launchd to keep the agent running no matter what.</li>
<li><code>ProgramArguments</code> provides command-line options to the agent command. In our
case, this will create the following command: <code>/usr/local/bin/observer -config /etc/observer.conf</code>.</li>
<li><code>StandardOutPath</code> and <code>StandardErrorPath</code> are the paths to where <code>launchd</code>
will write the respective output. In our case, we write these to the <code>tmp</code>
directory. An alternative would be to add the log files to <code>/var/log</code>, but
that requires granting write access of the agent to <code>/var/log</code>.</li>
</ul>
<p>To make sure we can run the agent, we have to also supply the configuration
file <code>observer.conf</code> in the <code>/etc</code> directory. On my machine, its contents are
as follows:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">status=500
tick=30s
url=https://ieftimov.com
server=cloudflare
content_type=text/html; charset=utf-8
user_agent=
</code></pre></div><p>After placing the <code>observer.conf</code> file in <code>/etc</code>, for the agent to work, we
have to place its <code>.plist</code> file in <code>~/Library/LaunchAgents</code>, and load it with:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ launchctl load ~/Library/LaunchAgents/com.ieftimov.observer.plist
</code></pre></div><p>Now, if we would <code>tail -f</code> the log files in <code>/tmp</code> we will see its outputs
there:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ tail -f /tmp/observer.*

<span style="font-weight:bold">=</span><span style="font-weight:bold">=</span>&gt; /tmp/observer.error.log &lt;<span style="font-weight:bold">=</span><span style="font-weight:bold">=</span>

<span style="font-weight:bold">=</span><span style="font-weight:bold">=</span>&gt; /tmp/observer.log &lt;<span style="font-weight:bold">=</span><span style="font-weight:bold">=</span>
2020/05/02 11:49:03 Status code mismatch, got: <span style="color:#099">200</span>
</code></pre></div><p>Voila! The agent is running and its logging output to <code>STDOUT</code>, while <code>launchd</code>
is redirecting that output to a log file.</p>
<p>If we would like to run the <code>observer</code> on GNU/Linux, we cannot use this
<code>launchd</code> configuration.</p>
<p>In Linux-land, <code>systemd</code> is widespread and popular. If you are interested in a
deeper explanation of <code>systemd</code> units and unit files, Digital Ocean's blog has
<a href="https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files">an
article</a>
on &ldquo;Understanding Systemd Units and Unit Files&rdquo; by Justin Ellingwood. I
recommend reading it! And keep in mind, the community's opinion on <code>systemd</code>
<a href="https://www.reddit.com/r/linux/comments/5n069y/why_do_people_not_like_systemd/">is pretty
divided</a>.</p>
<p>There are a bunch of other alternatives, but my knowledge of GNU/Linux init
systems is minimal. Therefore, I will stop right here and ask for your help: if
you would like to contribute a Linux init system configuration to this article,
drop the link to a gist/repo in the comments, and I will include it in this
article.</p>
<p>Of course, with proper attribution.</p>
<p>You can see the final implementation of the observer
<a href="https://github.com/fteem/go-playground/tree/master/observer">here</a>.</p>
<script src="https://f.convertkit.com/ckjs/ck.5.js"></script>
      <form action="https://app.convertkit.com/forms/1215893/subscriptions" class="seva-form formkit-form" method="post" data-sv-form="1215893" data-uid="f786e71c27" data-format="inline" data-version="5" data-options="{&quot;settings&quot;:{&quot;after_subscribe&quot;:{&quot;action&quot;:&quot;message&quot;,&quot;success_message&quot;:&quot;Success! Now check your email to confirm your subscription.&quot;,&quot;redirect_url&quot;:&quot;&quot;},&quot;analytics&quot;:{&quot;google&quot;:null,&quot;facebook&quot;:null,&quot;segment&quot;:null,&quot;pinterest&quot;:null},&quot;modal&quot;:{&quot;trigger&quot;:&quot;timer&quot;,&quot;scroll_percentage&quot;:null,&quot;timer&quot;:5,&quot;devices&quot;:&quot;all&quot;,&quot;show_once_every&quot;:15},&quot;powered_by&quot;:{&quot;show&quot;:false,&quot;url&quot;:&quot;https://convertkit.com?utm_source=dynamic&amp;utm_medium=referral&amp;utm_campaign=poweredby&amp;utm_content=form&quot;},&quot;recaptcha&quot;:{&quot;enabled&quot;:false},&quot;return_visitor&quot;:{&quot;action&quot;:&quot;show&quot;,&quot;custom_content&quot;:&quot;&quot;},&quot;slide_in&quot;:{&quot;display_in&quot;:&quot;bottom_right&quot;,&quot;trigger&quot;:&quot;timer&quot;,&quot;scroll_percentage&quot;:null,&quot;timer&quot;:5,&quot;devices&quot;:&quot;all&quot;,&quot;show_once_every&quot;:15},&quot;sticky_bar&quot;:{&quot;display_in&quot;:&quot;top&quot;,&quot;trigger&quot;:&quot;timer&quot;,&quot;scroll_percentage&quot;:null,&quot;timer&quot;:5,&quot;devices&quot;:&quot;all&quot;,&quot;show_once_every&quot;:15}},&quot;version&quot;:&quot;5&quot;}" min-width="400 500 600 700 800" style="background-color: rgb(249, 250, 251); border-radius: 4px;"><div class="formkit-background" style="opacity: 0.2;"></div><div data-style="minimal"><div class="formkit-header" data-element="header" style="color: rgb(77, 77, 77); font-size: 27px; font-weight: 700;"><h1>Join the Newsletter</h1></div><div class="formkit-subheader" data-element="subheader" style="color: rgb(104, 104, 104); font-size: 18px;"><p>I write about backend technologies, programming and cloud architectures. Join hundreds of other developers that get my newsletter, once a month.</p></div><ul class="formkit-alert formkit-alert-error" data-element="errors" data-group="alert"></ul><div data-element="fields" data-stacked="false" class="seva-fields formkit-fields"><div class="formkit-field"><input class="formkit-input" name="email_address" placeholder="Your email address" required="" type="email" style="color: rgb(0, 0, 0); border-color: rgb(227, 227, 227); border-radius: 4px; font-weight: 400;"></div><button data-element="submit" class="formkit-submit formkit-submit" style="color: rgb(255, 255, 255); background-color: rgb(22, 119, 190); border-radius: 4px; font-weight: 400;"><div class="formkit-spinner"><div></div><div></div><div></div></div><span>Subscribe</span></button></div><div class="formkit-guarantee" data-element="guarantee" style="color: rgb(77, 77, 77); font-size: 13px; font-weight: 400;">

      <p>I respect your privacy. Never spam. Unsubscribe at any time.</p>
      <p>You can also subscribe <a href="/index.xml">via RSS</a> or <a href="https://t.me/ieftimovcom">to my Telegram channel</a>.</p>

      </div></div><style>.formkit-form[data-uid="f786e71c27"] *{box-sizing:border-box;}.formkit-form[data-uid="f786e71c27"]{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}.formkit-form[data-uid="f786e71c27"] legend{border:none;font-size:inherit;margin-bottom:10px;padding:0;position:relative;display:table;}.formkit-form[data-uid="f786e71c27"] fieldset{border:0;padding:0.01em 0 0 0;margin:0;min-width:0;}.formkit-form[data-uid="f786e71c27"] body:not(:-moz-handler-blocked) fieldset{display:table-cell;}.formkit-form[data-uid="f786e71c27"] h1,.formkit-form[data-uid="f786e71c27"] h2,.formkit-form[data-uid="f786e71c27"] h3,.formkit-form[data-uid="f786e71c27"] h4,.formkit-form[data-uid="f786e71c27"] h5,.formkit-form[data-uid="f786e71c27"] h6{color:inherit;font-size:inherit;font-weight:inherit;}.formkit-form[data-uid="f786e71c27"] p{color:inherit;font-size:inherit;font-weight:inherit;}.formkit-form[data-uid="f786e71c27"] ol:not([template-default]),.formkit-form[data-uid="f786e71c27"] ul:not([template-default]),.formkit-form[data-uid="f786e71c27"] blockquote:not([template-default]){text-align:left;}.formkit-form[data-uid="f786e71c27"] p:not([template-default]),.formkit-form[data-uid="f786e71c27"] hr:not([template-default]),.formkit-form[data-uid="f786e71c27"] blockquote:not([template-default]),.formkit-form[data-uid="f786e71c27"] ol:not([template-default]),.formkit-form[data-uid="f786e71c27"] ul:not([template-default]){color:inherit;font-style:initial;}.formkit-form[data-uid="f786e71c27"][data-format="modal"]{display:none;}.formkit-form[data-uid="f786e71c27"][data-format="slide in"]{display:none;}.formkit-form[data-uid="f786e71c27"] .formkit-input,.formkit-form[data-uid="f786e71c27"] .formkit-select,.formkit-form[data-uid="f786e71c27"] .formkit-checkboxes{width:100%;}.formkit-form[data-uid="f786e71c27"] .formkit-button,.formkit-form[data-uid="f786e71c27"] .formkit-submit{border:0;border-radius:5px;color:#ffffff;cursor:pointer;display:inline-block;text-align:center;font-size:15px;font-weight:500;cursor:pointer;margin-bottom:15px;overflow:hidden;padding:0;position:relative;vertical-align:middle;line-height:1.5;}.formkit-form[data-uid="f786e71c27"] .formkit-button:hover,.formkit-form[data-uid="f786e71c27"] .formkit-submit:hover,.formkit-form[data-uid="f786e71c27"] .formkit-button:focus,.formkit-form[data-uid="f786e71c27"] .formkit-submit:focus{outline:none;}.formkit-form[data-uid="f786e71c27"] .formkit-button:hover > span,.formkit-form[data-uid="f786e71c27"] .formkit-submit:hover > span,.formkit-form[data-uid="f786e71c27"] .formkit-button:focus > span,.formkit-form[data-uid="f786e71c27"] .formkit-submit:focus > span{background-color:rgba(0,0,0,0.1);}.formkit-form[data-uid="f786e71c27"] .formkit-button > span,.formkit-form[data-uid="f786e71c27"] .formkit-submit > span{display:block;-webkit-transition:all 300ms ease-in-out;transition:all 300ms ease-in-out;padding:12px 24px;}.formkit-form[data-uid="f786e71c27"] .formkit-input{background:#ffffff;font-size:15px;padding:12px;border:1px solid #e3e3e3;-webkit-flex:1 0 auto;-ms-flex:1 0 auto;flex:1 0 auto;line-height:1.4;margin:0;-webkit-transition:border-color ease-out 300ms;transition:border-color ease-out 300ms;}.formkit-form[data-uid="f786e71c27"] .formkit-input:focus{outline:none;border-color:#1677be;-webkit-transition:border-color ease 300ms;transition:border-color ease 300ms;}.formkit-form[data-uid="f786e71c27"] .formkit-input::-webkit-input-placeholder{color:inherit;opacity:0.8;}.formkit-form[data-uid="f786e71c27"] .formkit-input::-moz-placeholder{color:inherit;opacity:0.8;}.formkit-form[data-uid="f786e71c27"] .formkit-input:-ms-input-placeholder{color:inherit;opacity:0.8;}.formkit-form[data-uid="f786e71c27"] .formkit-input::placeholder{color:inherit;opacity:0.8;}.formkit-form[data-uid="f786e71c27"] [data-group="dropdown"]{position:relative;display:inline-block;width:100%;}.formkit-form[data-uid="f786e71c27"] [data-group="dropdown"]::before{content:"";top:calc(50% - 2.5px);right:10px;position:absolute;pointer-events:none;border-color:#4f4f4f transparent transparent transparent;border-style:solid;border-width:6px 6px 0 6px;height:0;width:0;z-index:999;}.formkit-form[data-uid="f786e71c27"] [data-group="dropdown"] select{height:auto;width:100%;cursor:pointer;color:#333333;line-height:1.4;margin-bottom:0;padding:0 6px;-webkit-appearance:none;-moz-appearance:none;appearance:none;font-size:15px;padding:12px;padding-right:25px;border:1px solid #e3e3e3;background:#ffffff;}.formkit-form[data-uid="f786e71c27"] [data-group="dropdown"] select:focus{outline:none;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"]{text-align:left;margin:0;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"]{margin-bottom:10px;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] *{cursor:pointer;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"]:last-of-type{margin-bottom:0;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] input[type="checkbox"]{display:none;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] input[type="checkbox"] + label::after{content:none;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] input[type="checkbox"]:checked + label::after{border-color:#ffffff;content:"";}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] input[type="checkbox"]:checked + label::before{background:#10bf7a;border-color:#10bf7a;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] label{position:relative;display:inline-block;padding-left:28px;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] label::before,.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] label::after{position:absolute;content:"";display:inline-block;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] label::before{height:16px;width:16px;border:1px solid #e3e3e3;background:#ffffff;left:0px;top:3px;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] label::after{height:4px;width:8px;border-left:2px solid #4d4d4d;border-bottom:2px solid #4d4d4d;-webkit-transform:rotate(-45deg);-ms-transform:rotate(-45deg);transform:rotate(-45deg);left:4px;top:8px;}.formkit-form[data-uid="f786e71c27"] .formkit-alert{background:#f9fafb;border:1px solid #e3e3e3;border-radius:5px;-webkit-flex:1 0 auto;-ms-flex:1 0 auto;flex:1 0 auto;list-style:none;margin:25px auto;padding:12px;text-align:center;width:100%;}.formkit-form[data-uid="f786e71c27"] .formkit-alert:empty{display:none;}.formkit-form[data-uid="f786e71c27"] .formkit-alert-success{background:#d3fbeb;border-color:#10bf7a;color:#0c905c;}.formkit-form[data-uid="f786e71c27"] .formkit-alert-error{background:#fde8e2;border-color:#f2643b;color:#ea4110;}.formkit-form[data-uid="f786e71c27"] .formkit-spinner{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:0px;width:0px;margin:0 auto;position:absolute;top:0;left:0;right:0;width:0px;overflow:hidden;text-align:center;-webkit-transition:all 300ms ease-in-out;transition:all 300ms ease-in-out;}.formkit-form[data-uid="f786e71c27"] .formkit-spinner > div{margin:auto;width:12px;height:12px;background-color:#fff;opacity:0.3;border-radius:100%;display:inline-block;-webkit-animation:formkit-bouncedelay-formkit-form-data-uid-f786e71c27- 1.4s infinite ease-in-out both;animation:formkit-bouncedelay-formkit-form-data-uid-f786e71c27- 1.4s infinite ease-in-out both;}.formkit-form[data-uid="f786e71c27"] .formkit-spinner > div:nth-child(1){-webkit-animation-delay:-0.32s;animation-delay:-0.32s;}.formkit-form[data-uid="f786e71c27"] .formkit-spinner > div:nth-child(2){-webkit-animation-delay:-0.16s;animation-delay:-0.16s;}.formkit-form[data-uid="f786e71c27"] .formkit-submit[data-active] .formkit-spinner{opacity:1;height:100%;width:50px;}.formkit-form[data-uid="f786e71c27"] .formkit-submit[data-active] .formkit-spinner ~ span{opacity:0;}.formkit-form[data-uid="f786e71c27"] .formkit-powered-by[data-active="false"]{opacity:0.35;}@-webkit-keyframes formkit-bouncedelay-formkit-form-data-uid-f786e71c27-{0%,80%,100%{-webkit-transform:scale(0);-ms-transform:scale(0);transform:scale(0);}40%{-webkit-transform:scale(1);-ms-transform:scale(1);transform:scale(1);}}@keyframes formkit-bouncedelay-formkit-form-data-uid-f786e71c27-{0%,80%,100%{-webkit-transform:scale(0);-ms-transform:scale(0);transform:scale(0);}40%{-webkit-transform:scale(1);-ms-transform:scale(1);transform:scale(1);}}.formkit-form[data-uid="f786e71c27"] blockquote{padding:10px 20px;margin:0 0 20px;border-left:5px solid #e1e1e1;} .formkit-form[data-uid="f786e71c27"]{border:1px solid #e3e3e3;max-width:700px;position:relative;overflow:hidden;margin:0 auto;}.formkit-form[data-uid="f786e71c27"] .formkit-background{width:100%;height:100%;position:absolute;top:0;left:0;background-size:cover;background-position:center;opacity:0.3;z-index:1;}.formkit-form[data-uid="f786e71c27"] [data-style="minimal"]{padding:20px;width:100%;z-index:2;position:relative;}.formkit-form[data-uid="f786e71c27"] .formkit-header{margin:0 0 27px 0;text-align:center;}.formkit-form[data-uid="f786e71c27"] .formkit-subheader{margin:18px 0;text-align:center;}.formkit-form[data-uid="f786e71c27"] .formkit-guarantee{font-size:13px;margin:10px 0 15px 0;text-align:center;}.formkit-form[data-uid="f786e71c27"] .formkit-guarantee > p{margin:0;}.formkit-form[data-uid="f786e71c27"] .formkit-powered-by{color:#7d7d7d;display:block;font-size:12px;margin:10px 0 0 0;text-align:center;}.formkit-form[data-uid="f786e71c27"] .formkit-fields{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin:25px auto 0 auto;}.formkit-form[data-uid="f786e71c27"] .formkit-field{min-width:220px;}.formkit-form[data-uid="f786e71c27"] .formkit-field,.formkit-form[data-uid="f786e71c27"] .formkit-submit{margin:0 0 15px 0;-webkit-flex:1 0 100%;-ms-flex:1 0 100%;flex:1 0 100%;}.formkit-form[data-uid="f786e71c27"][min-width~="600"] [data-style="minimal"]{}.formkit-form[data-uid="f786e71c27"][min-width~="600"] .formkit-fields[data-stacked="false"]{margin-left:-5px;margin-right:-5px;}.formkit-form[data-uid="f786e71c27"][min-width~="600"] .formkit-fields[data-stacked="false"] .formkit-field,.formkit-form[data-uid="f786e71c27"][min-width~="600"] .formkit-fields[data-stacked="false"] .formkit-submit{margin:0 5px 15px 5px;}.formkit-form[data-uid="f786e71c27"][min-width~="600"] .formkit-fields[data-stacked="false"] .formkit-field{-webkit-flex:100 1 auto;-ms-flex:100 1 auto;flex:100 1 auto;}.formkit-form[data-uid="f786e71c27"][min-width~="600"] .formkit-fields[data-stacked="false"] .formkit-submit{-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;} </style></form>


			</div>

			<div class="tags">
				
					
				
			</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = 'eftimov';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the </a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2020  Copyright © Ilija Eftimov |  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-11264459-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
