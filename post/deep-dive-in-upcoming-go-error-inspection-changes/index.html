<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Deep Dive in the Upcoming Go Error Inspection Changes - Ilija Eftimov</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Ilija Eftimov" />
  <meta name="description" content="The team behind the language started working on a document titled &amp;ldquo;Go 2 Draft Designs&amp;rdquo;. The draft document is part of the design process for Go v2.0. In this article we will zoom in at the proposal for error inspection in Go 2.
What&amp;rsquo;s worth noting is that this is still part of a draft proposal. Still, from where we are standing at the moment, it&amp;rsquo;s certain that these changes will be added to the language starting Go v1." />

  <meta name="keywords" content="Software, Programming, Computer Science, Products" />






<meta name="generator" content="Hugo 0.55.5" />


<link rel="canonical" href="https://ieftimov.com/post/deep-dive-in-upcoming-go-error-inspection-changes/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.ec807d8b802a40889537c26e014f733206312ea440d42e1f0dabed80918de1ac.css" integrity="sha256-7IB9i4AqQIiVN8JuAU9zMgYxLqRA1C4fDavtgJGN4aw=" media="screen" crossorigin="anonymous">




<link rel="stylesheet" href="/css/overrides.css">

<link rel="stylesheet" href="/css/subscribe.css">


<meta property="og:title" content="Deep Dive in the Upcoming Go Error Inspection Changes" />
<meta property="og:description" content="The team behind the language started working on a document titled &ldquo;Go 2 Draft Designs&rdquo;. The draft document is part of the design process for Go v2.0. In this article we will zoom in at the proposal for error inspection in Go 2.
What&rsquo;s worth noting is that this is still part of a draft proposal. Still, from where we are standing at the moment, it&rsquo;s certain that these changes will be added to the language starting Go v1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ieftimov.com/post/deep-dive-in-upcoming-go-error-inspection-changes/" />

<meta property="og:image" content="https://ieftimov.com/cards/deep-dive-in-upcoming-go-error-inspection-changes.png" />
<meta property="article:published_time" content="2019-04-23T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2019-04-23T00:00:00&#43;00:00"/>

<meta itemprop="name" content="Deep Dive in the Upcoming Go Error Inspection Changes">
<meta itemprop="description" content="The team behind the language started working on a document titled &ldquo;Go 2 Draft Designs&rdquo;. The draft document is part of the design process for Go v2.0. In this article we will zoom in at the proposal for error inspection in Go 2.
What&rsquo;s worth noting is that this is still part of a draft proposal. Still, from where we are standing at the moment, it&rsquo;s certain that these changes will be added to the language starting Go v1.">


<meta itemprop="datePublished" content="2019-04-23T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-04-23T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="3146">

  <meta itemprop="image" content="https://ieftimov.com/cards/deep-dive-in-upcoming-go-error-inspection-changes.png">



<meta itemprop="keywords" content="Go,proposal,inspection," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://ieftimov.com/cards/deep-dive-in-upcoming-go-error-inspection-changes.png"/>

<meta name="twitter:title" content="Deep Dive in the Upcoming Go Error Inspection Changes"/>
<meta name="twitter:description" content="The team behind the language started working on a document titled &ldquo;Go 2 Draft Designs&rdquo;. The draft document is part of the design process for Go v2.0. In this article we will zoom in at the proposal for error inspection in Go 2.
What&rsquo;s worth noting is that this is still part of a draft proposal. Still, from where we are standing at the moment, it&rsquo;s certain that these changes will be added to the language starting Go v1."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-11264459-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Ilija Eftimov</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://ieftimov.com/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://ieftimov.com/testing-in-go/">Testing in Go</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://ieftimov.com/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://ieftimov.com/about/">About</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Ilija Eftimov
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://ieftimov.com/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://ieftimov.com/testing-in-go/">Testing in Go</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://ieftimov.com/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://ieftimov.com/about/">About</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Deep Dive in the Upcoming Go Error Inspection Changes</h1>
      
      <div class="post-meta">
        <time datetime="2019-04-23" class="post-time">
          23-04-2019
        </time>
        <div class="post-category">
            <a href="https://ieftimov.com/categories/golang/"> golang </a>
            <a href="https://ieftimov.com/categories/errors/"> errors </a>
            
          </div>
        

        
        

        
        
      </div>
    </header>

    
    

    
    <div class="post-content">
      

<p>The team behind the language started working on a document titled <a href="https://go.googlesource.com/proposal/+/master/design/go2draft.md">&ldquo;Go 2 Draft
Designs&rdquo;</a>.
The draft document is part of the design process for Go v2.0. In this article
we will zoom in at the proposal for error inspection in Go 2.</p>

<p>What&rsquo;s worth noting is that this is still part of a draft proposal. Still, from
where we are standing at the moment, it&rsquo;s certain that these changes will be
added to the language starting Go v1.13 and v2.0.</p>

<p>Before we go on, it’s good to note that this article is aimed at folks that
consider themselves new to the language. Not just with time spent with the
language, but also in terms of size of projects/codebases. So if that sounds
like you - keep on reading, I promise it will be helpful to understand the pros
and cons of errors in Go.</p>

<p>If you have experience with Go and error handling you might have a good idea
about the topic. Still, you may find something of value in the article. Let me
know in the comments section below!</p>

<h2 id="go-2-draft-designs">Go 2 Draft Designs</h2>

<p>The intent behind the draft documents is to create a discussion cornerstone for
the community. They touch three important topics: generics, error handling and
error value semantics.</p>

<p>The reason for discussing these three topics is… well, us – the community. The
Go team got the community’s feedback on the shortcomings of the language via
the annual Go user survey. And there is no surprise on the prioritised areas
for v2.0: package management, errors and generics.</p>

<p>Package management was a big thing, but that area is already addressed with the
introduction of modules.</p>

<p>In fact, here&rsquo;s a more detailed breakdown of the biggest challenges that people
face with Go today:</p>











<span class="caption-wrapper">
  <img class="caption" src="https://blog.golang.org/survey2018/fig14.svg" title="" alt="">
  <span class="caption-text"></span>
</span>


<p>If you would like to learn more, the Go team
published <a href="https://blog.golang.org/survey2018-results">a blog post</a> with the
results and other insights.</p>

<p>As we said earlier, in this article we will focus on the error inspection
proposal. The error handling and formatting are quite interesting as well, but
those are topics for other articles.</p>

<h2 id="shortcomings-of-the-current-errors-inspection-approach">Shortcomings of the current errors inspection approach</h2>

<p>Before we go on to see what are the problems with the current situation in the
ecosystem, let’s get a better understanding of errors first. Looking at the
topic from my perspective, as a beginner in Go, it’s challenging to understand
the shortcomings here.</p>

<p>Go promotes the idea that errors are values. When something is a value, it
means that we can assign it to a variable. This implies that we can work with
errors via ordinary programming. No need for special exception flows or rescue
blocks. For example, this is an error that’s a value:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">r</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span></code></pre></td></tr></table>
</div>
</div>

<p>The the <code>os.Open</code> function returns a file for reading or an error. Assigning
the error to a variable and checking for its presence (<code>err != nil</code>) is
possible because errors are values. In contrast with other languages, when a
it&rsquo;s not possible to open a file, we have to catch/handle an exception.</p>

<p>This flexibility that Go unlocks is great. But also it changes they way we
perceive and use errors as values in our programs. A side-effect of this is
that equality checks and type assertion on errors has proved to be tricky and
have limitations.</p>

<p>If you read the <a href="https://go.googlesource.com/proposal/+/master/design/go2draft-error-values-overview.md">Problem Overview
document</a>
on error values by Russ Cox, he describes four ways of testing for specific
errors:</p>

<ol>
<li>Test for equality with sentinel errors, like <code>io.EOF</code></li>
<li>Check for an error implementation type using a type assertion or type switch</li>
<li>Ad-hoc checks, like <code>os.IsNotExist</code>, check for a specific kind of error</li>
<li>Substring searches in the error text reported by <code>err.Error()</code></li>
</ol>

<p>Let&rsquo;s take this a step further.</p>

<h3 id="error-wrapping">Error wrapping</h3>

<p>The people in the Go ecosystem have created various packages that aid error
inspection. For example, one of the most popular packages that serves this
purpose is <a href="https://github.com/pkg/errors"><code>pkg/errors</code></a>. Another one is Uber&rsquo;s
<a href="https://github.com/uber-go/multierr"><code>multierr</code></a>. Others include
<a href="https://godoc.org/github.com/spacemonkeygo/errors"><code>spacemonkeygo/errors</code></a>,
<a href="https://godoc.org/github.com/hashicorp/errwrap"><code>hashicorp/errwrap</code></a> and
<a href="https://godoc.org/upspin.io/errors"><code>upspin.io/error</code></a>.</p>

<p>If you would inspect each of these you would notice different patterns for
error wrapping. Error wrapping is a technique where we wrap one error value in
another error value, of a different type. The goal is to add more information
to it. In 2016 Dave Cheney wrote an article on the topic, titled &ldquo;<a href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully">Don’t just
check errors, handle them
gracefully</a>&rdquo;.</p>

<p>The basic idea is that any error that happens deeper in the call stack will be
unavailable for inspection on the surface. We have to annotate errors down the
stack, so we can inspect and handle the proper error at a certain level in the
stack.</p>

<p>Let&rsquo;s look at an example: imagine we want to open a file that doesn&rsquo;t exist.</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;os&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;notes.txt&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%+v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">f</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<p>If we run this small program, we will get the following output:</p>

<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">$ go run test.go
open notes.txt: no such file or directory</code></pre></div>

<p>There is no hint of the type of the error or where this error originated from,
such as function name or line number. To be able to get more information to
user, we would have to add annotation to our error:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;os&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;notes.txt&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Error opening file: %+v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">f</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<p>The output:</p>

<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">$ go run test.go
Error opening file: open notes.txt: no such file or directory%</code></pre></div>

<p>A better way to approach this is to use error wrapping.</p>

<p>Here’s a very simple example: our type will allow attaching of a timestamp to
the error. It will also print the timestamp as part of the error message. The
code:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;os&#34;</span>
    <span class="s">&#34;time&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">ErrorWithTime</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">err</span> <span class="kt">error</span> <span class="c1">// the wrapped error
</span><span class="c1"></span>    <span class="nx">t</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span> <span class="c1">// the time when the error happened
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ErrorWithTime</span><span class="p">)</span> <span class="nf">Error</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%v @ %s&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">err</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">wrap</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="o">*</span><span class="nx">ErrorWithTime</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">ErrorWithTime</span><span class="p">{</span><span class="nx">err</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">openFile</span><span class="p">(</span><span class="nx">filename</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">os</span><span class="p">.</span><span class="nx">File</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">f</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">file</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">openFile</span><span class="p">(</span><span class="s">&#34;notes.txt&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="nx">file</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<p>The <code>ErrorWithTime</code> struct has two attributes: the wrapped error <code>err</code> and the
time of the error occurrence <code>t</code>. The <code>Error()</code> function will include the
timestamp of the occurrence alongside with the error itself. The <code>wrap</code>
function is the one doing the magic. It takes an error as an argument and
returns the error wrapped in a <code>ErrorWithTime</code>, with the exception timestamp
attached (set to <code>time.Now()</code>).</p>

<p>The <code>main</code> function does not care about the type of the error. It checks for
its presence and <code>print</code>s (if present). If we run the program, this will be
the output:</p>

<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">$ go run test.go
open notes.txt: no such file or directory @ 2019-04-05 2106.055665 +0200 CEST m=+0.000287159%</code></pre></div>

<p>I admit - the timestamp of the error occurrence might not be that useful in
this context. What is important is that it paints the idea how we can attach
more information to errors by wrapping them. If you read Dave’s article I
linked above, you will see the shortcomings of this approach and the argument
for unwrapping.</p>

<p>Now, having this in mind, let&rsquo;s move back to the error inspection proposal
and see what the authors are proposing.</p>

<h2 id="go-2-error-inspection">Go 2 Error Inspection</h2>

<p>While wrapping works, it comes at a certain cost, which the draft design
document addresses:</p>

<blockquote>
<p>If a sentinel error is wrapped, then a program cannot check for the
sentinel by a simple equality comparison. And if an error of some type T is
wrapped (presumably in an error of a different type), then type-asserting the
result to T will fail. If we encourage wrapping, we must also support
alternatives to the two main techniques that a program can use to act on
errors, equality checks and type assertions.</p>
</blockquote>

<p>So, let&rsquo;s see how the authors of the proposal are going to address the two
most important aspects of error wrapping: equality comparison and type
assertion.</p>

<h3 id="unwrapping">Unwrapping</h3>

<p>In the draft document the authors acknowledge the need for an unwrapping
mechanism. The idea behind that to be able to do any comparisons or assertions,
we have to be able to unwrap errors. This is in fact a simple functionality of
the custom error type, but it’s of exceptional importance.</p>

<p>That&rsquo;s why they introduce the <code>Wrapper</code> interface:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">errors</span>

<span class="c1">// A Wrapper is an error implementation
</span><span class="c1">// wrapping context around another error.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Wrapper</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Unwrap returns the next error in the error chain.
</span><span class="c1"></span>	<span class="c1">// If there is no next error, Unwrap returns nil.
</span><span class="c1"></span>	<span class="nf">Unwrap</span><span class="p">()</span> <span class="kt">error</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<p>The <code>Unwrap</code> function here does not have a body because we’re looking at an
<code>interface</code> definition. This interface is quite important though. All types
that will implement <code>Wrapper</code> will have inspection of wrapped errors.</p>

<p>Let&rsquo;s see a contrived example of a custom error type that implements the
<code>Wrapper</code> interface:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ErrorWithTime is an error with a timestamp
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ErrorWithTime</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">err</span> <span class="kt">error</span>     <span class="c1">// the wrapped error
</span><span class="c1"></span>	<span class="nx">t</span>   <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span> <span class="c1">// the time when the error happened
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<p>For the <code>ErrorWithTime</code> to implement the <code>Wrapper</code> interface, it needs to have
a <code>Unwrap</code> function. The function will return the error that the custom error
type contains:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ErrorWithTime</span><span class="p">)</span> <span class="nf">Unwrap</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">err</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<p>That&rsquo;s all. This will allow any of the next aspects, that we will discuss
further, to function well with the <code>ErrorWithTime</code> type.</p>

<h3 id="type-assertion-using-as">Type assertion using <code>As</code></h3>

<p>Now, let’s combine two ideas: opening a file that does not exist and returning
an error that contains a time of occurrence. Let&rsquo;s reintroduce the
<code>ErrorWithTime</code> type and its related functions:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ErrorWithTime</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">err</span> <span class="kt">error</span>     <span class="c1">// the wrapped error
</span><span class="c1"></span>	<span class="nx">t</span>   <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span> <span class="c1">// the time when the error happened
</span><span class="c1"></span><span class="p">}</span>

<span class="c1">// Implements the Error interface
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ErrorWithTime</span><span class="p">)</span> <span class="nf">Error</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Error: %s, ocurred at: %s\n&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">err</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Implements the Wrapper interface
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ErrorWithTime</span><span class="p">)</span> <span class="nf">Unwrap</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">err</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<p>To reiterate, the <code>Unwrap</code> function is the one that implements the <code>Wrapper</code>
interface. And the <code>Error</code> function implements the <code>Error</code> interface. This means
that we can unwrap any error value of our <code>ErrorWithTime</code> type.</p>

<p>Now, let&rsquo;s create a simple function that can open a file and return an error
(if any):</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">openFile</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">ErrorWithTime</span><span class="p">{</span>
			<span class="nx">err</span><span class="p">:</span> <span class="nx">err</span><span class="p">,</span>
			<span class="nx">t</span><span class="p">:</span>   <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<p>This function is a tad useless because it only returns a potential error, but
it does the trick for our example. If the <code>os.Open</code> call returns an error we
will wrap it in a <code>ErrorWithTime</code> and attach the current time to it. Then,
we&rsquo;ll <code>return</code> it.</p>

<p>Now, let&rsquo;s see the <code>main</code> function:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nf">openFile</span><span class="p">(</span><span class="s">&#34;non-existent-file&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">timeError</span> <span class="o">*</span><span class="nx">ErrorWithTime</span>
		<span class="k">if</span> <span class="nx">xerrors</span><span class="p">.</span><span class="nf">As</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">timeError</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Failed at: &#34;</span><span class="p">,</span> <span class="nx">timeError</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span>
		<span class="p">}</span>

                <span class="kd">var</span> <span class="nx">pathError</span> <span class="o">*</span><span class="nx">os</span><span class="p">.</span><span class="nx">PathError</span>
                <span class="k">if</span> <span class="nx">xerrors</span><span class="p">.</span><span class="nf">As</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pathError</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Failed at path:&#34;</span><span class="p">,</span> <span class="nx">pathError</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span>
                <span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<p>Here&rsquo;s how the new <code>As</code> function helps by taking care of the type assertion. It
receives the error from the <code>openFile</code> function and asserts the error&rsquo;s type to
<code>*ErrorWithTime</code>. If the assertion is successful, it will use its <code>t</code> attribute
to display the time when the error happened.</p>

<p>The same goes for asserting the error type to <code>*os.PathError</code>. Again, the
<code>*ErrorWithTime</code> implements the <code>Wrapper</code> interface. This allows the
<code>xerrors.As</code> function to unwrap the error and check for the type of the error
under wraps.  Let’s run the <code>main</code> function:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="err">$</span> <span class="k">go</span> <span class="nx">run</span> <span class="nx">as</span><span class="p">.</span><span class="k">go</span>
<span class="nx">Failed</span> <span class="nx">at</span><span class="p">:</span>  <span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">21</span> <span class="mf">1801.922332</span> <span class="o">+</span><span class="mo">0200</span> <span class="nx">CEST</span> <span class="nx">m</span><span class="p">=</span><span class="o">+</span><span class="mf">0.000303480</span>
<span class="nx">Failed</span> <span class="nx">at</span> <span class="nx">path</span><span class="p">:</span> <span class="nx">non</span><span class="o">-</span><span class="nx">existent</span></code></pre></td></tr></table>
</div>
</div>

<p>Note that the error type returned from the <code>openFile</code> function is
<code>*ErrorWithTime</code>. But, once it’s casted to a <code>*os.PathError</code> we cannot access
the <code>t</code> attribute. This is because <code>*ErrorWithTime</code> implements <code>t</code> – not
<code>*os.PathError</code>.</p>

<p>Let&rsquo;s test that with code:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nf">openFile</span><span class="p">(</span><span class="s">&#34;non-existent-file&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">pathError</span> <span class="o">*</span><span class="nx">os</span><span class="p">.</span><span class="nx">PathError</span>
                <span class="k">if</span> <span class="nx">xerrors</span><span class="p">.</span><span class="nf">As</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pathError</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Failed at path:&#34;</span><span class="p">,</span> <span class="nx">pathError</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span>
                        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Failed at:&#34;</span><span class="p">,</span> <span class="nx">pathError</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span>
                <span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<p>This fails with the error:</p>

<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">./test.go44: pathError.t undefined (type *os.PathError has no field or method t)</code></pre></div>

<h3 id="value-checking-with-is">Value checking with <code>Is</code></h3>

<p>While <code>As</code> allows us to take a value and assert its type, Golang has errors
which are resistive to type assertions. They are special and have a special
name - sentinel errors. Their name descends from the practice in computer
programming of using a specific value to signify that no further processing is
possible.</p>

<p>When a caller handles a sentinel error, they have to compare the returned error
value to a predeclared value using the equality operator. Here&rsquo;s an example
(adapted from <a href="https://tour.golang.org/methods/21">A Tour of Go</a>) that handles
a <code>io.EOF</code> error:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;io&#34;</span>
	<span class="s">&#34;strings&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">r</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="s">&#34;Hello, Reader!&#34;</span><span class="p">)</span>

	<span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
			<span class="k">break</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<p>The example above creates a <code>strings.Reader</code> and consumes its output 8 bytes at
a time. When the reading hits a <code>io.EOF</code> (I/O End Of File) error, it will break
the <code>for</code> loop and exit the program.</p>

<p>So, how does the new <code>Is</code> function help us in such cases? Well, if we would use
the <code>xerrors</code> package in the same example, it would look like this:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;io&#34;</span>
	<span class="s">&#34;strings&#34;</span>

	<span class="s">&#34;golang.org/x/xerrors&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">r</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="s">&#34;Hello, Reader!&#34;</span><span class="p">)</span>

	<span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">xerrors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<p>The change is simple on the surface, but considerable under the hood.
The <code>Is</code> function takes an error value and a sentinel error as arguments. If
the error value implements <code>Wrapper</code>, it will unwrap its chain of error until
it reaches (or not) the sentinel error. Hence, if it finds the sentinel error it
will return <code>true</code>, otherwise <code>false</code>.</p>

<p>Let&rsquo;s expand the above example with our <code>ErrorWithTime</code> type and see the <code>Is</code>
function in action:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;io&#34;</span>
	<span class="s">&#34;strings&#34;</span>
	<span class="s">&#34;time&#34;</span>

	<span class="s">&#34;golang.org/x/xerrors&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">ErrorWithTime</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">err</span> <span class="kt">error</span>     <span class="c1">// the wrapped error
</span><span class="c1"></span>	<span class="nx">t</span>   <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span> <span class="c1">// the time when the error happened
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ErrorWithTime</span><span class="p">)</span> <span class="nf">Error</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Error: %s, ocurred at: %s\n&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">err</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ErrorWithTime</span><span class="p">)</span> <span class="nf">Unwrap</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">err</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">readReader</span><span class="p">(</span><span class="nx">r</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">buffer</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="nx">ErrorWithTime</span><span class="p">{</span>
				<span class="nx">err</span><span class="p">:</span> <span class="nx">err</span><span class="p">,</span>
				<span class="nx">t</span><span class="p">:</span>   <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">r</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="s">&#34;Hello, Reader!&#34;</span><span class="p">)</span>

	<span class="nx">err</span> <span class="o">:=</span> <span class="nf">readReader</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">xerrors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<p>When run, this will produce:</p>

<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">$ go run eof.go
Error: EOF, ocurred at: 2019-04-21 1141.842139 +0200 CEST m=+0.000228985</code></pre></div>

<p>The <code>readReader</code> function takes a <code>io.Reader</code> as argument and read it until the
reading returns an error. When it returns the error, it will wrap it in an
<code>&amp;ErrorWithTime</code> and returned to the caller (<code>main</code>). The caller then uses
<code>xerrors.Is</code> to check if the error returned is actually a <code>io.EOF</code> under wraps.
If it is, it will print the error.</p>

<p>This works because <code>ErrorWithType</code> implements <code>Wrapper</code>. This allows the caller
to print the error message from the error value, while still being able to
detect the error under wraps.</p>

<h2 id="putting-it-in-practice-with-xerrors">Putting it in practice with <code>xerrors</code></h2>

<p>So you might be wondering, how you can start using the <code>Is</code> and <code>As</code> functions
in your current Go programs. Well, as you have noticed in the examples we used
the <code>xerrors</code> package. This was in fact announced by Marcel van Lohuizen at
dotGo 2019 in Paris - you can check his talk
<a href="https://www.dotconferences.com/2019/03/marcel-van-lohuizen-go-2-error-values-today">here</a>.
(If you&rsquo;re curious how the event was in general, I published a report on it
<a href="/my-first-dotgo-conference">here</a>.)</p>

<p>The <code>xerrors</code> package is built to support transitioning to the Go 2 proposal
for error values. Most of the functions and types from <code>xerrors</code> will be
incorporated into the standard library’s errors package in Go 1.13. The idea is
that by using this package you can make your Go 1.12 code be compatible with
1.13 (and later version 2).</p>

<p>You can read its <a href="https://godoc.org/golang.org/x/xerrors">documentation</a> and
check out the examples included.</p>

<p>It is also worth mentioning that replacing equality checks with <code>xerrors.Is</code>
and type assertions with <code>xerrors.As</code> will not change the meaning of existing
programs that do not wrap errors and it will future-proof programs against
wrapping.</p>

<p>As with any language changes, there will be situations where the new functions
will not do the trick. For example, sometimes callers want to perform many
checks against the same error. One such case would be when the caller would
compare the error value against more than one sentinel value. In such cases we
can still use Is and As. The drawback is in the way these functions walk
through the chain of wrapped errors. This means they would walk up the chain
multiple times, which is wasteful.</p>

<p>In any case, improving the situation with error inspection in Go is a good step
forward. I am used to more conventional error handling. Still, I think that
this is not a step in the wrong direction when it comes to error inspection.
Also, I recommend reading the
<a href="https://go.googlesource.com/proposal/+/master/design/go2draft-error-inspection.md#discussion">discussion</a>
section of the error inspection draft. It lays out some good guidelines on how
to define and use your error types.</p>

<p>What is your opinion on the proposal? Do you think it will simplify your life
as a Go developer? Or do you maybe prefer a different approach? Let me know in
the comments below!</p>

    </div>

    
    


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://ieftimov.com/tags/go/">Go</a>
          <a href="https://ieftimov.com/tags/proposal/">proposal</a>
          <a href="https://ieftimov.com/tags/inspection/">inspection</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/testing-in-go-first-principles/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Testing in Go: First Principles</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/my-first-dotgo-conference/">
            <span class="next-text nav-default">My First dotGo Conference</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  

  

  

  <div class="disqus-comment">
  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
    Show Disqus Comments
  </div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = "https://ieftimov.com/post/deep-dive-in-upcoming-go-error-inspection-changes/";
    };
    function load_disqus() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'eftimov';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

      $('#load_disqus').remove();
    };
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
  </div>

    

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="https://stackoverflow.com/users/601555/ilija-eftimov" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="https://twitter.com/fteem" rel="me noopener" class="iconfont"
      title="twitter"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1264 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M1229.8616 18.043658c0 0-117.852626 63.135335-164.151872 67.344358-105.225559-164.151872-505.082682-92.598492-437.738325 223.078185C278.622548 312.675223 89.216542 47.506814 89.216542 47.506814s-117.852626 189.406006 75.762402 345.139833C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042C1179.353331 249.539887 1263.533778 123.269217 1263.533778 123.269217s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"></path>
</svg>

    </a>
  
    <a href="https://www.linkedin.com/in/ieftimov/" rel="me noopener" class="iconfont"
      title="linkedin"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="33" height="33">
  <path d="M872.405333 872.618667h-151.637333v-237.610667c0-56.661333-1.152-129.578667-79.018667-129.578667-79.061333 0-91.136 61.653333-91.136 125.397334v241.792H398.976V384h145.664v66.602667h1.962667c20.352-38.4 69.845333-78.933333 143.786666-78.933334 153.642667 0 182.058667 101.12 182.058667 232.746667v268.202667zM227.712 317.141333a87.978667 87.978667 0 0 1-88.021333-88.106666 88.064 88.064 0 1 1 88.021333 88.106666z m76.032 555.477334H151.68V384h152.064v488.618667zM948.266667 0H75.562667C33.792 0 0 33.024 0 73.770667v876.458666C0 991.018667 33.792 1024 75.562667 1024h872.576C989.866667 1024 1024 991.018667 1024 950.229333V73.770667C1024 33.024 989.866667 0 948.138667 0h0.128z"></path>
</svg>

    </a>
  
    <a href="https://github.com/fteem" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="ieftimovcom@gmail.com" rel="me noopener" class="iconfont"
      title="email"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>


<a href="https://ieftimov.com/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2014 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Ilija Eftimov
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>






  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  













</body>
</html>
