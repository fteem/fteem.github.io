<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Testing in Go: Subtests | Ilija Eftimov ⚡️</title><meta name=keywords content><meta name=description content="Before we begin: The content in this article assumes knowledge of table-driven tests in Go. If you are unfamiliar with the concept, read this article to familiarize yourself.
With table-driven tests as the most popular testing approach, there is one annoying problem that every programmer will face: running selective tests. That&rsquo;s because the traditional method of testing using table-driven tests in a single test function is not decomposable in granular subfunctions."><meta name=author content="Ilija"><link rel=canonical href=https://ieftimov.com/post/testing-in-go-subtests/><link crossorigin=anonymous href=/assets/css/stylesheet.min.css rel="preload stylesheet" as=style><link rel=icon href=https://ieftimov.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ieftimov.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ieftimov.com/favicon-32x32.png><link rel=apple-touch-icon href=https://ieftimov.com/apple-touch-icon.png><link rel=mask-icon href=https://ieftimov.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.83.1"><script async defer data-domain=ieftimov.com src=https://plausible.io/js/plausible.js></script><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel=stylesheet><meta property="og:title" content="Testing in Go: Subtests"><meta property="og:description" content="Before we begin: The content in this article assumes knowledge of table-driven tests in Go. If you are unfamiliar with the concept, read this article to familiarize yourself.
With table-driven tests as the most popular testing approach, there is one annoying problem that every programmer will face: running selective tests. That&rsquo;s because the traditional method of testing using table-driven tests in a single test function is not decomposable in granular subfunctions."><meta property="og:type" content="article"><meta property="og:url" content="https://ieftimov.com/post/testing-in-go-subtests/"><meta property="og:image" content="https://ieftimov.com/cards/testing-in-go-subtests.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-07-27T00:00:00+00:00"><meta property="article:modified_time" content="2021-06-12T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ieftimov.com/cards/testing-in-go-subtests.png"><meta name=twitter:title content="Testing in Go: Subtests"><meta name=twitter:description content="Before we begin: The content in this article assumes knowledge of table-driven tests in Go. If you are unfamiliar with the concept, read this article to familiarize yourself.
With table-driven tests as the most popular testing approach, there is one annoying problem that every programmer will face: running selective tests. That&rsquo;s because the traditional method of testing using table-driven tests in a single test function is not decomposable in granular subfunctions."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ieftimov.com/posts/"},{"@type":"ListItem","position":2,"name":"Testing in Go: Subtests","item":"https://ieftimov.com/post/testing-in-go-subtests/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Testing in Go: Subtests","name":"Testing in Go: Subtests","description":"Before we begin: The content in this article assumes knowledge of table-driven tests in Go. If you are unfamiliar with the concept, read this article to familiarize yourself.\nWith table-driven tests as the most popular testing approach, there is one annoying problem that every programmer will face: running selective tests. That\u0026rsquo;s because the traditional method of testing using table-driven tests in a single test function is not decomposable in granular subfunctions.","keywords":[],"articleBody":"Before we begin: The content in this article assumes knowledge of table-driven tests in Go. If you are unfamiliar with the concept, read this article to familiarize yourself.\nWith table-driven tests as the most popular testing approach, there is one annoying problem that every programmer will face: running selective tests. That’s because the traditional method of testing using table-driven tests in a single test function is not decomposable in granular subfunctions.\nIn other words, we cannot ask our go test tool to run a particular test case from a slice of test cases. Here’s an example of a small test function that uses table-driven tests:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  func TestOlder(t *testing.T) { cases := []struct { age1 int age2 int expected bool }{ // First test case \t{ age1: 1, age2: 2, expected: false, }, // Second test case \t{ age1: 2, age2: 1, expected: true, }, } for _, c := range cases { _, p1 := NewPerson(c.age1) _, p2 := NewPerson(c.age2) got := p1.older(p2) if got != c.expected { t.Errorf(\"Expected %v  %v, got %v\", p1.age, p2.age, got) } } }   There’s no need to understand what the function under test does, although you can figure it out by looking at the tests. How do I run the TestOlder function with the second test case without running the first case?\nWith the approach used above, that is not possible. go test -run regex can target function names based on the supplied regex. But it has no way of understanding the internals of the function.\nThat’s one reason Marcel van Lohuizen in 2016 proposed the addition of programmatic sub-tests and sub-benchmarks. The changes were added to the language as of version 1.7. You can read more about it in the proposal and the related discussion.\nWhat are subtests, and how do they work? Subtests are a construct in Go’s testing package that split our test functions into granular test processes. They unlock helpful functionality such as better handling of errors, more control over running tests, concurrency, and more straightforward code.\nThe actualization of subtests in the testing package is the Run method. It takes two arguments: the names of the subtest and the sub-test function. The name is an identifier of the subtests, which unlocks running a specific subtest using the go test command. Like with ordinary test functions, subtests are reported after the parent test function is done, meaning all subtests have finished running.\nWe will explore parallel tests in a different article, so feel free to ignore that part for now. If you would like to get familiar with it now, there is a good section about it on the official blog post about subtests.\nPlease note that there are caveats to parallel tests; that’s why we will look into them separately.\n Without going into too much detail, under the hood, Run runs the function in a separate goroutine and blocks until it returns or calls t.Parallel to become a parallel test. What happens under the hood and how subtests are architected is an exciting topic to explore. Yet, it’s pretty extensive to be covered in this article.\nHow to use t.Run Let’s look at the TestOlder function again, this time refactored to use t.Run for each of the test cases runs:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  func TestOlder(t *testing.T) { cases := []struct { name string age1 int age2 int expected bool }{ { name: \"FirstOlderThanSecond\", age1: 1, age2: 2, expected: false, }, { name: \"SecondOlderThanFirst\", age1: 2, age2: 1, expected: true, }, } for _, c := range cases { t.Run(c.name, func(t *testing.T) { _, p1 := NewPerson(c.age1) _, p2 := NewPerson(c.age2) got := p1.older(p2) if got != c.expected { t.Errorf(\"Expected %v  %v, got %v\", p1.age, p2.age, got) } }) } }   There are a few notable changes. We changed the struct of the cases to include a string attribute name. Each of the test cases has a name that describes the case itself. For example, the first case has the name FirstOlderThanSecond because age1 is larger than age2 in that case.\nNext, in the for loop, we wrap the whole test in a t.Run block, where the first argument is the name of the test case. The second argument is a function that will (not) mark the test as failed based on the inputs and expected output.\nIf we run the test, we’ll see something like this:\n1 2 3 4 5 6 7 8 9  $ go test -v -count=1 === RUN TestOlder === RUN TestOlder/FirstOlderThanSecond === RUN TestOlder/SecondOlderThanFirst --- PASS: TestOlder (0.00s) --- PASS: TestOlder/FirstOlderThanSecond (0.00s) --- PASS: TestOlder/SecondOlderThanFirst (0.00s) PASS ok person\t0.004s   From the output, it’s noticeable that right after go test runs TestOlder it spawns off two more test functions: TestOlder/FirstOlderThanSecond and TestOlder/SecondOlderThanFirst. It’s worth noting that TestOlder will not finish running until these two functions exit.\nThe following few lines of the output paint that picture better because the output is nested. It makes it clear that TestOlder is a parent to the other two functions. The change in the output is due to spawning off two subtests in a test function. We should also note the naming of the subtests – they are prefixed with the function that spawns them.\nSelectively running subtests with go test As we already saw when using the traditional approach, running a specific test case is impossible. One of the pros of using subtests is that running only a particular subtest is straightforward and intuitive.\nReusing the examples from before, running any of the subtests is just a matter of supplying the full name of the subtest: its parent test function, followed by a slash and the subtest name.\nFor example, if we would like to run the subtest FirstOlderThenSecond from the TestOlder test function, we can execute:\n1 2 3 4 5 6  $ go test -v -count=1 -run=\"TestOlder/FirstOlderThanSecond\" === RUN TestOlder === RUN TestOlder/FirstOlderThanSecond --- PASS: TestOlder (0.00s) --- PASS: TestOlder/FirstOlderThanSecond (0.00s) PASS   That’s it. Just by supplying the full name of the subtest, we can run a specific subtest. Remember, the -run flag can take any regex. So, if we would like to run all of the subtests under the TestOlder test, we can do it by providing an “umbrella” regex:\n1 2 3 4 5 6 7 8  $ go test -v -count=1 -run=\"TestOlder\" === RUN TestOlder === RUN TestOlder/FirstOlderThanSecond === RUN TestOlder/SecondOlderThanFirst --- PASS: TestOlder (0.00s) --- PASS: TestOlder/FirstOlderThanSecond (0.00s) --- PASS: TestOlder/SecondOlderThanFirst (0.00s) PASS   By supplying TestOlder to the -run flag, we run both the TestOlder/FirstOlderThanSecond and the TestOlder/SecondOlderThanFirst subtests.\nShared Setup and Teardown Another somewhat hidden side of subtests is unlocking the ability to create isolated setup and teardown functions.\nThe setup function is run to set up a test’s state before the actual testing happens. For example, if we had to open a connection to a database and fetch some records used in the test, we would put such functionality in the setup function. In line with that, the teardown function of that test would close down the connection to the database and clean up the state. That’s because teardown functions are run after the test finishes.\nLet’s use our TestOlder function from earlier to explore how setup and teardown are made and how they work:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47  func setupSubtest(t *testing.T) { t.Logf(\"[SETUP] Hello 👋!\") } func teardownSubtest(t *testing.T) { t.Logf(\"[TEARDOWN] Bye, bye 🖖!\") } func TestOlder(t *testing.T) { cases := []struct { name string age1 int age2 int expected bool }{ { name: \"FirstOlderThanSecond\", age1: 1, age2: 2, expected: false, }, { name: \"SecondOlderThanFirst\", age1: 2, age2: 1, expected: true, }, } for _, c := range cases { t.Run(c.name, func(t *testing.T) { setupSubtest(t) defer teardownSubtest(t) _, p1 := NewPerson(c.age1) _, p2 := NewPerson(c.age2) got := p1.older(p2) t.Logf(\"[TEST] Hello from subtest %s \\n\", c.name) if got != c.expected { t.Errorf(\"Expected %v  %v, got %v\", p1.age, p2.age, got) } }) } }   We introduce two new functions here: setupSubtest and teardownSubtest. While they do not contain any particular functionality, understanding their invocation is essential here. Looking at the two lines where they are invoked, we can see that the setupSubtest is called right inside when the subtest is run.\nThe following line is where the teardownSubtest function is invoked, but this time using the defer keyword. It’s a feature of Go that we use to our advantage here: defer allows us to invoke a function that will execute at the end of the calling function. In other words, when the subtest function finishes, the teardownSubtest function will be invoked. Go makes setup and teardown functions easy with' defer': they are not separately defined or contain any remarkable setup. They are two simple functions that use Go’s built-in functionality.\nIf we rerun the test, we will see the following output:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  $ go test -v -count=1 -run=\"TestOlder\" === RUN TestOlder === RUN TestOlder/FirstOlderThanSecond === RUN TestOlder/SecondOlderThanFirst --- PASS: TestOlder (0.00s) --- PASS: TestOlder/FirstOlderThanSecond (0.00s) person_test.go:33: [SETUP] Hello 👋! person_test.go:71: [TEST] Hello from subtest FirstOlderThanSecond person_test.go:37: [TEARDOWN] Bye, bye 🖖! --- PASS: TestOlder/SecondOlderThanFirst (0.00s) person_test.go:33: [SETUP] Hello 👋! person_test.go:71: [TEST] Hello from subtest SecondOlderThanFirst person_test.go:37: [TEARDOWN] Bye, bye 🖖! PASS ok person\t0.005s   We can see that the setup is always run before the teardown. By looking at the output, it is clear that the assertion and error marking are made in between. In cases where the assertion would fail, the particular subtest would be marked as failed, and Go will report the error at the end of the test run.\nTestMain Before we wrap up this post, we will look at one last feature that the testing package has: TestMain.\nThere are times when our test file has to do some extra setup or teardown before or after the tests in a file are run. Therefore, when a test file contains a TestMain function, the test will call TestMain(m *testing.M) instead of running the tests directly.\nThink of it in this way: every test file contains a “hidden” TestMain function, and its contents look something like this:\n1 2 3  func TestMain(m *testing.M) { os.Exit(m.Run()) }   TestMain will run in the main goroutine, and it does the setup or teardown necessary around a call to m.Run. m.Run runs all of the test functions in the test file. TestMain will take the result of the m.Run invocation and then call os.Exit with the result as an argument. One important thing to note is that when we use TestMain, flag.Parse is not run, so if our tests depend on command-line flags, we have to call it explicitly.\nThere are a few use-cases where you would use TestMain: global startup and shutdown callbacks or other state setups. You can read some more in Chris Hines' 2015 article on the topic.\nLiked this article? You can buy me a coffee. Or simply subscribe to my newsletter and get my fresh posts in your inbox. It's short and sweet, going out monthly to over 1,000 subscribers.  ","wordCount":"1948","inLanguage":"en","datePublished":"2019-07-27T00:00:00Z","dateModified":"2021-06-12T00:00:00Z","author":{"@type":"Person","name":"Ilija"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ieftimov.com/post/testing-in-go-subtests/"},"publisher":{"@type":"Organization","name":"Ilija Eftimov ⚡️","logo":{"@type":"ImageObject","url":"https://ieftimov.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://ieftimov.com/ accesskey=h title="Ilija Eftimov ⚡️ (Alt + H)">Ilija Eftimov ⚡️</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://ieftimov.com/ title=About><span>About</span></a></li><li><a href=https://ieftimov.com/posts title=Writing><span>Writing</span></a></li><li><a href=https://ieftimov.com/newsletter title=Newsletter><span>Newsletter</span></a></li><li><a href=https://forms.gle/orfXK5jh1LRaiFzo8 title="Suggest a topic"><span>Suggest a topic</span></a></li><li><a href=https://www.buymeacoffee.com/ieftimov title="Buy me a ☕"><span>Buy me a ☕</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Testing in Go: Subtests</h1><div class=post-meta>July 27, 2019&nbsp;·&nbsp;10 min&nbsp;·&nbsp;Ilija</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#what-are-subtests-and-how-do-they-work aria-label="What are subtests, and how do they work?">What are subtests, and how do they work?</a></li><li><a href=#how-to-use-trun aria-label="How to use t.Run">How to use <code>t.Run</code></a></li><li><a href=#selectively-running-subtests-with-go-test aria-label="Selectively running subtests with go test">Selectively running subtests with <code>go test</code></a></li><li><a href=#shared-setup-and-teardown aria-label="Shared Setup and Teardown">Shared Setup and Teardown</a></li><li><a href=#testmain aria-label=TestMain><code>TestMain</code></a></li></ul></div></details></div><div class=post-content><p><em>Before we begin:
The content in this article assumes knowledge of table-driven tests in Go. If
you are unfamiliar with the concept, read <a href=/post/testing-in-go-table-driven-tests>this
article</a> to familiarize yourself.</em></p><p>With table-driven tests as the most popular testing approach, there is one
annoying problem that every programmer will face: running selective tests.
That&rsquo;s because the traditional method of testing using table-driven tests in a
single test function is not decomposable in granular subfunctions.</p><p>In other words, we cannot ask our <code>go test</code> tool to run a particular test case
from a slice of test cases. Here&rsquo;s an example of a small test function that
uses table-driven tests:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>TestOlder</span>(t *testing.T) {
	cases := []<span style=color:#0087ff>struct</span> {
		age1     <span style=color:#af0000>int</span>
		age2     <span style=color:#af0000>int</span>
		expected <span style=color:#af0000>bool</span>
	}{
                <span style=color:#4e4e4e>// First test case
</span><span style=color:#4e4e4e></span>		{
			age1:     <span style=color:#00afaf>1</span>,
			age2:     <span style=color:#00afaf>2</span>,
			expected: <span style=color:#d75f00>false</span>,
		},

                <span style=color:#4e4e4e>// Second test case
</span><span style=color:#4e4e4e></span>		{

			age1:     <span style=color:#00afaf>2</span>,
			age2:     <span style=color:#00afaf>1</span>,
			expected: <span style=color:#d75f00>true</span>,
		},
	}

	<span style=color:#5f8700>for</span> _, c := <span style=color:#5f8700>range</span> cases {
		_, p1 := <span style=color:#0087ff>NewPerson</span>(c.age1)
		_, p2 := <span style=color:#0087ff>NewPerson</span>(c.age2)

		got := p1.<span style=color:#0087ff>older</span>(p2)

		<span style=color:#5f8700>if</span> got != c.expected {
			t.<span style=color:#0087ff>Errorf</span>(<span style=color:#00afaf>&#34;Expected %v &gt; %v, got %v&#34;</span>, p1.age, p2.age, got)
		}
	}

}</code></pre></td></tr></table></div></div><p>There&rsquo;s no need to understand what the function under test does, although you
can figure it out by looking at the tests. How do I run the <code>TestOlder</code>
function with the second test case without running the first case?</p><p>With the approach used above, that is not possible. <code>go test -run regex</code> can
target function names based on the supplied <code>regex</code>. But it has no way of
understanding the internals of the function.</p><p>That&rsquo;s one reason Marcel van Lohuizen in 2016 proposed the addition of
programmatic sub-tests and sub-benchmarks. The changes were added to the
language as of version 1.7. You can read more about it in <a href=https://github.com/golang/proposal/blob/master/design/12166-subtests.md>the
proposal</a>
and <a href=https://github.com/golang/go/issues/12166>the related discussion</a>.</p><h2 id=what-are-subtests-and-how-do-they-work>What are subtests, and how do they work?<a hidden class=anchor aria-hidden=true href=#what-are-subtests-and-how-do-they-work>#</a></h2><p>Subtests are a construct in Go&rsquo;s <code>testing</code> package that split our test
functions into granular test processes. They unlock helpful functionality such
as better handling of errors, more control over running tests, concurrency, and
more straightforward code.</p><p>The actualization of subtests in the <code>testing</code> package is the <a href=https://golang.org/pkg/testing/#T.Run><code>Run</code>
method</a>. It takes two arguments: the
names of the subtest and the sub-test function. The name is an identifier of
the subtests, which unlocks running a specific subtest using the <code>go test</code>
command. Like with ordinary test functions, subtests are reported after the
parent test function is done, meaning all subtests have finished running.</p><div class="notice note"><p class="first notice-title"></p><p>We will explore parallel tests in a different article, so feel free to ignore
that part for now. If you would like to get familiar with it now, there is a
good section about it on <a href=https://blog.golang.org/subtests>the official blog post about
subtests</a>.</p><p>Please note that there are caveats to parallel tests; that&rsquo;s why we will look
into them separately.</p></div><p>Without going into too much detail, under the hood, <code>Run</code> runs the function in
a separate goroutine and blocks until it returns or calls <code>t.Parallel</code> to
become a parallel test. What happens under the hood and how subtests are
architected is an exciting topic to explore. Yet, it&rsquo;s pretty extensive to be
covered in this article.</p><h2 id=how-to-use-trun>How to use <code>t.Run</code><a hidden class=anchor aria-hidden=true href=#how-to-use-trun>#</a></h2><p>Let&rsquo;s look at the <code>TestOlder</code> function again, this time refactored to use
<code>t.Run</code> for each of the test cases runs:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>TestOlder</span>(t *testing.T) {
	cases := []<span style=color:#0087ff>struct</span> {
		name     <span style=color:#af0000>string</span>
		age1     <span style=color:#af0000>int</span>
		age2     <span style=color:#af0000>int</span>
		expected <span style=color:#af0000>bool</span>
	}{
		{
			name:     <span style=color:#00afaf>&#34;FirstOlderThanSecond&#34;</span>,
			age1:     <span style=color:#00afaf>1</span>,
			age2:     <span style=color:#00afaf>2</span>,
			expected: <span style=color:#d75f00>false</span>,
		},
		{
			name:     <span style=color:#00afaf>&#34;SecondOlderThanFirst&#34;</span>,
			age1:     <span style=color:#00afaf>2</span>,
			age2:     <span style=color:#00afaf>1</span>,
			expected: <span style=color:#d75f00>true</span>,
		},
	}

	<span style=color:#5f8700>for</span> _, c := <span style=color:#5f8700>range</span> cases {
		t.<span style=color:#0087ff>Run</span>(c.name, <span style=color:#0087ff>func</span>(t *testing.T) {
			_, p1 := <span style=color:#0087ff>NewPerson</span>(c.age1)
			_, p2 := <span style=color:#0087ff>NewPerson</span>(c.age2)

			got := p1.<span style=color:#0087ff>older</span>(p2)

			<span style=color:#5f8700>if</span> got != c.expected {
				t.<span style=color:#0087ff>Errorf</span>(<span style=color:#00afaf>&#34;Expected %v &gt; %v, got %v&#34;</span>, p1.age, p2.age, got)
			}
		})
	}

}</code></pre></td></tr></table></div></div><p>There are a few notable changes. We changed the <code>struct</code> of the <code>cases</code> to
include a <code>string</code> attribute <code>name</code>. Each of the test cases has a name that
describes the case itself. For example, the first case has the name
<code>FirstOlderThanSecond</code> because <code>age1</code> is larger than <code>age2</code> in that case.</p><p>Next, in the <code>for</code> loop, we wrap the whole test in a <code>t.Run</code> block, where the
first argument is the name of the test case. The second argument is a function
that will (not) mark the test as failed based on the inputs and expected
output.</p><p>If we run the test, we&rsquo;ll see something like this:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ go <span style=color:#0087ff>test</span> -v -count=<span style=color:#0087ff>1</span>
=== RUN   <span style=color:#0087ff>TestOlder</span>
=== RUN   TestOlder/FirstOlderThanSecond
=== RUN   TestOlder/SecondOlderThanFirst
--- PASS: TestOlder (0.00s)
    --- PASS: TestOlder/FirstOlderThanSecond (0.00s)
    --- PASS: TestOlder/SecondOlderThanFirst (0.00s)
PASS
ok  	person	0.004s</code></pre></td></tr></table></div></div><p>From the output, it&rsquo;s noticeable that right after <code>go test</code> runs <code>TestOlder</code> it
spawns off two more test functions: <code>TestOlder/FirstOlderThanSecond</code> and
<code>TestOlder/SecondOlderThanFirst</code>. It&rsquo;s worth noting that <code>TestOlder</code> will not
finish running until these two functions exit.</p><p>The following few lines of the output paint that picture better because the
output is nested. It makes it clear that <code>TestOlder</code> is a parent to the other
two functions. The change in the output is due to spawning off two subtests in
a test function. We should also note the naming of the subtests – they are
prefixed with the function that spawns them.</p><h2 id=selectively-running-subtests-with-go-test>Selectively running subtests with <code>go test</code><a hidden class=anchor aria-hidden=true href=#selectively-running-subtests-with-go-test>#</a></h2><p>As we already saw when using the traditional approach, running a specific test
case is impossible. One of the pros of using subtests is that running only a
particular subtest is straightforward and intuitive.</p><p>Reusing the examples from before, running any of the subtests is just a matter
of supplying the full name of the subtest: its parent test function, followed
by a slash and the subtest name.</p><p>For example, if we would like to run the subtest <code>FirstOlderThenSecond</code> from
the <code>TestOlder</code> test function, we can execute:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ go <span style=color:#0087ff>test</span> -v -count=<span style=color:#00afaf>1</span> -run=<span style=color:#00afaf>&#34;TestOlder/FirstOlderThanSecond&#34;</span>
=== RUN   <span style=color:#0087ff>TestOlder</span>
=== RUN   TestOlder/FirstOlderThanSecond
--- PASS: TestOlder (0.00s)
    --- PASS: TestOlder/FirstOlderThanSecond (0.00s)
PASS</code></pre></td></tr></table></div></div><p>That&rsquo;s it. Just by supplying the full name of the subtest, we can run a
specific subtest. Remember, the <code>-run</code> flag can take any regex. So, if we would
like to run all of the subtests under the <code>TestOlder</code> test, we can do it by
providing an &ldquo;umbrella&rdquo; regex:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ go <span style=color:#0087ff>test</span> -v -count=<span style=color:#00afaf>1</span> -run=<span style=color:#00afaf>&#34;TestOlder&#34;</span>
=== RUN   <span style=color:#0087ff>TestOlder</span>
=== RUN   TestOlder/FirstOlderThanSecond
=== RUN   TestOlder/SecondOlderThanFirst
--- PASS: TestOlder (0.00s)
    --- PASS: TestOlder/FirstOlderThanSecond (0.00s)
    --- PASS: TestOlder/SecondOlderThanFirst (0.00s)
PASS</code></pre></td></tr></table></div></div><p>By supplying <code>TestOlder</code> to the <code>-run</code> flag, we run both the
<code>TestOlder/FirstOlderThanSecond</code> and the <code>TestOlder/SecondOlderThanFirst</code>
subtests.</p><h2 id=shared-setup-and-teardown>Shared Setup and Teardown<a hidden class=anchor aria-hidden=true href=#shared-setup-and-teardown>#</a></h2><p>Another somewhat hidden side of subtests is unlocking the ability to create
isolated setup and teardown functions.</p><p>The setup function is run to set up a test&rsquo;s state before the actual testing
happens. For example, if we had to open a connection to a database and fetch
some records used in the test, we would put such functionality in the setup
function. In line with that, the teardown function of that test would close
down the connection to the database and clean up the state. That&rsquo;s because
teardown functions are run after the test finishes.</p><p>Let&rsquo;s use our <code>TestOlder</code> function from earlier to explore how setup and
teardown are made and how they work:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">47
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>setupSubtest</span>(t *testing.T) {
	t.<span style=color:#0087ff>Logf</span>(<span style=color:#00afaf>&#34;[SETUP] Hello 👋!&#34;</span>)
}

<span style=color:#0087ff>func</span> <span style=color:#0087ff>teardownSubtest</span>(t *testing.T) {
	t.<span style=color:#0087ff>Logf</span>(<span style=color:#00afaf>&#34;[TEARDOWN] Bye, bye 🖖!&#34;</span>)
}

<span style=color:#0087ff>func</span> <span style=color:#0087ff>TestOlder</span>(t *testing.T) {
	cases := []<span style=color:#0087ff>struct</span> {
		name     <span style=color:#af0000>string</span>
		age1     <span style=color:#af0000>int</span>
		age2     <span style=color:#af0000>int</span>
		expected <span style=color:#af0000>bool</span>
	}{
		{
			name:     <span style=color:#00afaf>&#34;FirstOlderThanSecond&#34;</span>,
			age1:     <span style=color:#00afaf>1</span>,
			age2:     <span style=color:#00afaf>2</span>,
			expected: <span style=color:#d75f00>false</span>,
		},
		{
			name:     <span style=color:#00afaf>&#34;SecondOlderThanFirst&#34;</span>,
			age1:     <span style=color:#00afaf>2</span>,
			age2:     <span style=color:#00afaf>1</span>,
			expected: <span style=color:#d75f00>true</span>,
		},
	}

	<span style=color:#5f8700>for</span> _, c := <span style=color:#5f8700>range</span> cases {
		t.<span style=color:#0087ff>Run</span>(c.name, <span style=color:#0087ff>func</span>(t *testing.T) {
			<span style=color:#0087ff>setupSubtest</span>(t)
			<span style=color:#5f8700>defer</span> <span style=color:#0087ff>teardownSubtest</span>(t)

			_, p1 := <span style=color:#0087ff>NewPerson</span>(c.age1)
			_, p2 := <span style=color:#0087ff>NewPerson</span>(c.age2)

			got := p1.<span style=color:#0087ff>older</span>(p2)

			t.<span style=color:#0087ff>Logf</span>(<span style=color:#00afaf>&#34;[TEST] Hello from subtest %s \n&#34;</span>, c.name)
			<span style=color:#5f8700>if</span> got != c.expected {
				t.<span style=color:#0087ff>Errorf</span>(<span style=color:#00afaf>&#34;Expected %v &gt; %v, got %v&#34;</span>, p1.age, p2.age, got)
			}
		})
	}

}</code></pre></td></tr></table></div></div><p>We introduce two new functions here: <code>setupSubtest</code> and <code>teardownSubtest</code>.
While they do not contain any particular functionality, understanding their
invocation is essential here. Looking at the two lines where they are invoked,
we can see that the <code>setupSubtest</code> is called right inside when the subtest is
run.</p><p>The following line is where the <code>teardownSubtest</code> function is invoked, but this
time using the <code>defer</code> keyword. It&rsquo;s a feature of Go that we use to our
advantage here: <code>defer</code> allows us to invoke a function that will execute at the
end of the calling function. In other words, when the subtest function
finishes, the <code>teardownSubtest</code> function will be invoked. Go makes setup and
teardown functions easy with' defer': they are not separately defined or
contain any remarkable setup. They are two simple functions that use Go&rsquo;s
built-in functionality.</p><p>If we rerun the test, we will see the following output:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ go <span style=color:#0087ff>test</span> -v -count=<span style=color:#00afaf>1</span> -run=<span style=color:#00afaf>&#34;TestOlder&#34;</span>
=== RUN   <span style=color:#0087ff>TestOlder</span>
=== RUN   TestOlder/FirstOlderThanSecond
=== RUN   TestOlder/SecondOlderThanFirst
--- PASS: TestOlder (0.00s)
    --- PASS: TestOlder/FirstOlderThanSecond (0.00s)
        person_test.go:33: [SETUP] Hello 👋!
        person_test.go:71: [TEST] Hello from subtest FirstOlderThanSecond
        person_test.go:37: [TEARDOWN] Bye, bye 🖖!
    --- PASS: TestOlder/SecondOlderThanFirst (0.00s)
        person_test.go:33: [SETUP] Hello 👋!
        person_test.go:71: [TEST] Hello from subtest SecondOlderThanFirst
        person_test.go:37: [TEARDOWN] Bye, bye 🖖!
PASS
ok  	person	0.005s</code></pre></td></tr></table></div></div><p>We can see that the setup is always run before the teardown. By looking at the
output, it is clear that the assertion and error marking are made in between.
In cases where the assertion would fail, the particular subtest would be marked
as failed, and Go will report the error at the end of the test run.</p><h2 id=testmain><code>TestMain</code><a hidden class=anchor aria-hidden=true href=#testmain>#</a></h2><p>Before we wrap up this post, we will look at one last feature that the <code>testing</code>
package has: <code>TestMain</code>.</p><p>There are times when our test file has to do some extra setup or teardown
before or after the tests in a file are run. Therefore, when a test file
contains a <code>TestMain</code> function, the test will call <code>TestMain(m *testing.M)</code>
instead of running the tests directly.</p><p>Think of it in this way: every test file contains a &ldquo;hidden&rdquo; <code>TestMain</code>
function, and its contents look something like this:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>TestMain</span>(m *testing.M) {
	os.<span style=color:#0087ff>Exit</span>(m.<span style=color:#0087ff>Run</span>())
}</code></pre></td></tr></table></div></div><p><code>TestMain</code> will run in the main goroutine, and it does the setup or teardown
necessary around a call to <code>m.Run</code>. <code>m.Run</code> runs all of the test functions in
the test file. <code>TestMain</code> will take the result of the <code>m.Run</code> invocation and
then call <code>os.Exit</code> with the result as an argument. One important thing to note
is that when we use <code>TestMain</code>, <code>flag.Parse</code> is not run, so if our tests depend
on command-line flags, we have to call it explicitly.</p><p>There are a few use-cases where you would use <code>TestMain</code>: global startup and
shutdown callbacks or other state setups. You can read some more in Chris
Hines' 2015 <a href=http://cs-guy.com/blog/2015/01/test-main/>article</a> on the topic.</p><section class=subscribe><b>Liked this article?</b>
You can <a href=https://www.buymeacoffee.com/ieftimov>buy me a coffee</a>.
Or simply <a href=/newsletter>subscribe to my
newsletter</a> and get my fresh posts in your inbox. It's short and sweet,
going out monthly to over 1,000 subscribers.</section></div><footer class=post-footer><nav class=paginav><a class=prev href=https://ieftimov.com/post/testing-in-go-fixtures/><span class=title>« Prev Page</span><br><span>Testing in Go: Fixtures</span></a>
<a class=next href=https://ieftimov.com/post/testing-in-go-table-driven-tests/><span class=title>Next Page »</span><br><span>Testing in Go: Table-Driven Tests</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: Subtests on twitter" href="https://twitter.com/intent/tweet/?text=Testing%20in%20Go%3a%20Subtests&url=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-subtests%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: Subtests on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-subtests%2f&title=Testing%20in%20Go%3a%20Subtests&summary=Testing%20in%20Go%3a%20Subtests&source=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-subtests%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: Subtests on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-subtests%2f&title=Testing%20in%20Go%3a%20Subtests"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: Subtests on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-subtests%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: Subtests on whatsapp" href="https://api.whatsapp.com/send?text=Testing%20in%20Go%3a%20Subtests%20-%20https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-subtests%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: Subtests on telegram" href="https://telegram.me/share/url?text=Testing%20in%20Go%3a%20Subtests&url=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-subtests%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>Copyright 2021 © Ilija Eftimov</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>