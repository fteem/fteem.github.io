<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Simple Golang database seeding abstraction for Gorm - Ilija Eftimov</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta itemprop="name" content="Simple Golang database seeding abstraction for Gorm">
<meta itemprop="description" content="One of the most feature-full ORMs for Go that I have worked with is Gorm. If you would like to learn more about it, I recommend checking out its official website and its documentation.
Image taken from Undraw.  Recenlty I wanted to write a small database seeding abstraction. Database seeding is a process in which an initial set of data is provided to a database when it is being set up or installed.">
<meta itemprop="datePublished" content="2019-11-15T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-11-15T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="523">
<meta itemprop="image" content="https://ieftimov.com/cards/simple-golang-database-seeding-abstraction-gorm.png">



<meta itemprop="keywords" content="" /><meta property="og:title" content="Simple Golang database seeding abstraction for Gorm" />
<meta property="og:description" content="One of the most feature-full ORMs for Go that I have worked with is Gorm. If you would like to learn more about it, I recommend checking out its official website and its documentation.
Image taken from Undraw.  Recenlty I wanted to write a small database seeding abstraction. Database seeding is a process in which an initial set of data is provided to a database when it is being set up or installed." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ieftimov.com/post/simple-golang-database-seeding-abstraction-gorm/" />
<meta property="og:image" content="https://ieftimov.com/cards/simple-golang-database-seeding-abstraction-gorm.png" />
<meta property="article:published_time" content="2019-11-15T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-11-15T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://ieftimov.com/cards/simple-golang-database-seeding-abstraction-gorm.png"/>

<meta name="twitter:title" content="Simple Golang database seeding abstraction for Gorm"/>
<meta name="twitter:description" content="One of the most feature-full ORMs for Go that I have worked with is Gorm. If you would like to learn more about it, I recommend checking out its official website and its documentation.
Image taken from Undraw.  Recenlty I wanted to write a small database seeding abstraction. Database seeding is a process in which an initial set of data is provided to a database when it is being set up or installed."/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://ieftimov.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://ieftimov.com/css/main.css" />
		<link rel="stylesheet" type="text/css" href="https://ieftimov.com/css/overrides.css" />
	

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="https://ieftimov.com/css/dark.css" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="https://ieftimov.com/js/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="https://ieftimov.com/">
				<img src="/avatar.png" alt="Ilija Eftimov" />
			</a>
		</div>
	
	<h1 class="site-title"><a href="https://ieftimov.com/">Ilija Eftimov</a></h1>
	<div class="site-description"><p>Thoughts on simple software engineering</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/fteem" title="Github"><i data-feather="github"></i></a></li><li><a href="https://twitter.com/itsilija" title="Twitter"><i data-feather="twitter"></i></a></li><li><a href="https://www.linkedin.com/in/ieftimov" title="Linkedin"><i data-feather="linkedin"></i></a></li><li><a href="mailto:blog@ieftimov.com" title="Email"><i data-feather="mail"></i></a></li><li><a href="https://t.me/ieftimovcom" title="Telegram Channel"><i data-feather="send"></i></a></li><li><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></li><li><a href="#" class="scheme-toggle" id="scheme-toggle"></a></li></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/categories/testing-in-go">Testing in Go</a>
			</li>
			
			<li>
				<a href="/posts">Archive</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="https://forms.gle/orfXK5jh1LRaiFzo8">Suggest a topic</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">16</span>
							<span class="rest">Nov 2019</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Simple Golang database seeding abstraction for Gorm</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>One of the most feature-full ORMs for Go that I have worked with is Gorm. If
you would like to learn more about it, I recommend checking out its <a href="http://gorm.io/">official
website</a> and its <a href="https://gorm.io/docs/">documentation</a>.</p>












<figure class="imagecaption">
  <img class="caption" src="/simple-golang-database-seeding-abstraction-gorm/storage.png" title="Image taken from Undraw." alt="Person looking at hovering files graphic">
  <span class="caption-text">Image taken from <a href="https://undraw.co/">Undraw</a>.</span>
</figure>

<p>Recenlty I wanted to write a small database seeding abstraction. Database
seeding is a process in which an initial set of data is provided to a database
when it is being set up or installed.</p>
<p>Yet, in true Go fashion my goal was to keep the abstraction tiny, yet provide
some structure to folks that would write seeds in this application. This is
absolutely not the only way you can achieve this, the options are plenty.
Still, this is one approach that I have found to be working well.</p>
<p>We will have three different components:</p>
<ol>
<li>Create a <code>Seed</code> abstraction.</li>
<li>Identify path for the seeds and how to collect them in a single <code>seeds</code>
package.</li>
<li>Create a <code>seeder</code> command line tool that can run the seeds against a
database.</li>
</ol>
<p>First, to define a small <code>Seed</code> type that would be coupled to the <code>gorm.DB</code>
connection instance:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#998;font-style:italic">// pkg/seed/seed.go
</span><span style="color:#998;font-style:italic"></span><span style="font-weight:bold">package</span> seed

<span style="font-weight:bold">import</span> (
	<span style="color:#b84">&#34;github.com/jinzhu/gorm&#34;</span>
)

<span style="font-weight:bold">type</span> Seed <span style="font-weight:bold">struct</span> {
	Name <span style="color:#458;font-weight:bold">string</span>
	Run  <span style="font-weight:bold">func</span>(<span style="font-weight:bold">*</span>gorm.DB) <span style="color:#458;font-weight:bold">error</span>
}</code></pre></div>
<p>Next, we need to define a path where we'll store the seeds and how to collect
them:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#998;font-style:italic">// pkg/seeds/seeds.go
</span><span style="color:#998;font-style:italic"></span><span style="font-weight:bold">package</span> seeds

<span style="font-weight:bold">import</span> (
	<span style="color:#b84">&#34;github.com/fteem/seeding/pkg/seed&#34;</span>
)

<span style="font-weight:bold">func</span> <span style="color:#900;font-weight:bold">All</span>() []seed.Seed {
	<span style="font-weight:bold">return</span> []seed.Seed{}
}</code></pre></div>
<p>The <code>seeds</code> package will contain all instances of <code>seed.Seed</code> and collect them
in the <code>All</code> function. This will allow the third component, a CLI tool, to
iterate over them and execute them against a database. Additionally, in the same
<code>seeds</code> package we can have separate files for seeding various types of data.</p>
<p>For example:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#998;font-style:italic">// pkg/seeds/users.go
</span><span style="color:#998;font-style:italic"></span><span style="font-weight:bold">package</span> seeds

<span style="font-weight:bold">func</span> <span style="color:#900;font-weight:bold">CreateUser</span>(db <span style="font-weight:bold">*</span>gorm.DB, name <span style="color:#458;font-weight:bold">string</span>, age <span style="color:#458;font-weight:bold">int</span>) <span style="color:#458;font-weight:bold">error</span> {
        <span style="font-weight:bold">return</span> db.<span style="color:#900;font-weight:bold">Create</span>(<span style="font-weight:bold">&amp;</span>users.User{Name: name, Age: age}).Error
}</code></pre></div>
<p>The usage of the function in <code>All</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#998;font-style:italic">// pkg/seeds/seeds.go
</span><span style="color:#998;font-style:italic"></span><span style="font-weight:bold">import</span> (
	<span style="color:#b84">&#34;github.com/fteem/seeding/pkg/seed&#34;</span>
)

<span style="font-weight:bold">func</span> <span style="color:#900;font-weight:bold">All</span>() []seed.Seed {
	<span style="font-weight:bold">return</span> []seed.Seed{
        	seed.Seed{
                        Name: <span style="color:#b84">&#34;CreateJane&#34;</span>,
                        Run: <span style="font-weight:bold">func</span>(db <span style="font-weight:bold">*</span>gorm.DB) <span style="color:#458;font-weight:bold">error</span> {
                              <span style="color:#900;font-weight:bold">CreateUser</span>(db, <span style="color:#b84">&#34;Jane&#34;</span>, <span style="color:#099">30</span>)
                        },
                },
        	seed.Seed{
                        Name: <span style="color:#b84">&#34;CreateJohn&#34;</span>,
                        Run: <span style="font-weight:bold">func</span>(db <span style="font-weight:bold">*</span>gorm.DB) <span style="color:#458;font-weight:bold">error</span> {
                              <span style="color:#900;font-weight:bold">CreateUser</span>(db, <span style="color:#b84">&#34;John&#34;</span>, <span style="color:#099">30</span>)
                        },
                },
        }
}</code></pre></div>
<p>The example above is contrived, but it can work really well if you have to compose
seeds using multiple such functions.</p>
<p>Last, a very simple command line tool that can running the seeds we defined:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#998;font-style:italic">// pkg/seeder/seeder.go
</span><span style="color:#998;font-style:italic"></span><span style="font-weight:bold">package</span> main

<span style="font-weight:bold">import</span> (
	<span style="color:#b84">&#34;log&#34;</span>

	<span style="color:#b84">&#34;github.com/fteem/seeding/pkg/seeds&#34;</span>

	<span style="color:#b84">&#34;github.com/jinzhu/gorm&#34;</span>
	_ <span style="color:#b84">&#34;github.com/jinzhu/gorm/dialects/mysql&#34;</span>
)

<span style="font-weight:bold">func</span> <span style="color:#900;font-weight:bold">main</span>() {
	dbConn <span style="font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">openConnection</span>()
	<span style="font-weight:bold">defer</span> dbConn.<span style="color:#900;font-weight:bold">Close</span>()

	<span style="font-weight:bold">for</span> _, seed <span style="font-weight:bold">:=</span> <span style="font-weight:bold">range</span> seeds.<span style="color:#900;font-weight:bold">All</span>() {
		<span style="font-weight:bold">if</span> err <span style="font-weight:bold">:=</span> seed.<span style="color:#900;font-weight:bold">Run</span>(dbConn); err <span style="font-weight:bold">!=</span> <span style="font-weight:bold">nil</span> {
			log.<span style="color:#900;font-weight:bold">Fatalf</span>(<span style="color:#b84">&#34;Running seed &#39;%s&#39;, failed with error: %s&#34;</span>, seed.Name, err)
		}
	}
}

<span style="font-weight:bold">func</span> <span style="color:#900;font-weight:bold">openConnection</span>() <span style="font-weight:bold">*</span>gorm.DB {
        db, err <span style="font-weight:bold">:=</span> gorm.<span style="color:#900;font-weight:bold">Open</span>(<span style="color:#b84">&#34;mysql&#34;</span>, <span style="color:#b84">&#34;user:password@/dbname?charset=utf8&amp;parseTime=True&amp;loc=Local&#34;</span>)
	<span style="font-weight:bold">if</span> err <span style="font-weight:bold">!=</span> <span style="font-weight:bold">nil</span> {
		log.<span style="color:#900;font-weight:bold">Fatalf</span>(<span style="color:#b84">&#34;Couldn&#39;t establish database connection: %s&#34;</span>, err)
	}
	<span style="font-weight:bold">return</span> db
}</code></pre></div>
<p>The binary produced by this is quite a simple one: loads all of the seeds using
the <code>seeds.All</code> function, iterates over the collection and executes their <code>Run</code>
function. If an error occurs, the whole program bombs.</p>
<p>That's it. Very thin and simple way to abstract away your database seeds using
Gorm. Before you go, let me know in the comments how you approach database
seeding.</p>

			</div>

			<div class="tags">
				
					
				
			</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = 'eftimov';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the </a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2021  Copyright Â© Ilija Eftimov |  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-11264459-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
