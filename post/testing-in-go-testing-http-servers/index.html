<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Testing in Go: HTTP Servers | Ilija Eftimov ⚡️</title><meta name=keywords content><meta name=description content="Go&rsquo;s a great hammer for a lot of nails, one of the areas where I find it fitting is building HTTP servers. The net/http package of Go&rsquo;s standard library makes it easy to attach HTTP handlers to any Go program. What I find delightful is that Go&rsquo;s standard library, also has packages that make testing HTTP servers as easy as building them.
Nowadays, it&rsquo;s widely accepted that test coverage is important and useful."><meta name=author content="Ilija Eftimov"><link rel=canonical href=https://ieftimov.com/post/testing-in-go-testing-http-servers/><link crossorigin=anonymous href=/assets/css/stylesheet.min.css rel="preload stylesheet" as=style><link rel=icon href=https://ieftimov.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ieftimov.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ieftimov.com/favicon-32x32.png><link rel=apple-touch-icon href=https://ieftimov.com/apple-touch-icon.png><link rel=mask-icon href=https://ieftimov.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.83.1"><script async defer data-domain=ieftimov.com src=https://plausible.io/js/plausible.js></script><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel=stylesheet><meta property="og:title" content="Testing in Go: HTTP Servers"><meta property="og:description" content="Go&rsquo;s a great hammer for a lot of nails, one of the areas where I find it fitting is building HTTP servers. The net/http package of Go&rsquo;s standard library makes it easy to attach HTTP handlers to any Go program. What I find delightful is that Go&rsquo;s standard library, also has packages that make testing HTTP servers as easy as building them.
Nowadays, it&rsquo;s widely accepted that test coverage is important and useful."><meta property="og:type" content="article"><meta property="og:url" content="https://ieftimov.com/post/testing-in-go-testing-http-servers/"><meta property="og:image" content="https://ieftimov.com/cards/testing-in-go-testing-http-servers.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-02T00:00:00+00:00"><meta property="article:modified_time" content="2020-03-02T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ieftimov.com/cards/testing-in-go-testing-http-servers.png"><meta name=twitter:title content="Testing in Go: HTTP Servers"><meta name=twitter:description content="Go&rsquo;s a great hammer for a lot of nails, one of the areas where I find it fitting is building HTTP servers. The net/http package of Go&rsquo;s standard library makes it easy to attach HTTP handlers to any Go program. What I find delightful is that Go&rsquo;s standard library, also has packages that make testing HTTP servers as easy as building them.
Nowadays, it&rsquo;s widely accepted that test coverage is important and useful."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ieftimov.com/posts/"},{"@type":"ListItem","position":2,"name":"Testing in Go: HTTP Servers","item":"https://ieftimov.com/post/testing-in-go-testing-http-servers/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Testing in Go: HTTP Servers","name":"Testing in Go: HTTP Servers","description":"Go\u0026rsquo;s a great hammer for a lot of nails, one of the areas where I find it fitting is building HTTP servers. The net/http package of Go\u0026rsquo;s standard library makes it easy to attach HTTP handlers to any Go program. What I find delightful is that Go\u0026rsquo;s standard library, also has packages that make testing HTTP servers as easy as building them.\nNowadays, it\u0026rsquo;s widely accepted that test coverage is important and useful.","keywords":[],"articleBody":"Go’s a great hammer for a lot of nails, one of the areas where I find it fitting is building HTTP servers. The net/http package of Go’s standard library makes it easy to attach HTTP handlers to any Go program. What I find delightful is that Go’s standard library, also has packages that make testing HTTP servers as easy as building them.\nNowadays, it’s widely accepted that test coverage is important and useful. Having the quick feedback loop when changing your code is valuable, hence we invest time in testing our code. When combined with methodologies like continious integration and continious delivery, a good test suite becomes an invaluable part of the software project.\nKnowing the value of a good test suite, what approach should we - developers using Go to build HTTP servers - take to testing our HTTP servers?\nHere’s everything you need to know to test your Go HTTP servers well.\nOrdering some pizzas As with any other article in this series on testing in Go, let’s create an example implementation that we can use as a test subject.\nHere’s a small implementation of a pizza restaurant API with three endpoints:\n List all pizzas on the menu: GET /pizzas Make a simple pizza order: POST /orders List all orders in the system: GET /orders  Here’s the code:\npackage main import ( \"encoding/json\" \"fmt\" \"log\" \"net/http\" ) type Pizza struct { ID int `json:\"id\"` Name string `json:\"name\"` Price int `json:\"price\"` } type Pizzas []Pizza func (ps Pizzas) FindByID(ID int) (Pizza, error) { for _, pizza := range ps { if pizza.ID == ID { return pizza, nil } } return Pizza{}, fmt.Errorf(\"Couldn't find pizza with ID: %d\", ID) } type Order struct { PizzaID int `json:\"pizza_id\"` Quantity int `json:\"quantity\"` Total int `json:\"total\"` } type Orders []Order type pizzasHandler struct { pizzas *Pizzas } func (ph pizzasHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) { w.Header().Set(\"Content-Type\", \"application/json\") switch r.Method { case http.MethodGet: if len(*ph.pizzas) == 0 { http.Error(w, \"Error: No pizzas found\", http.StatusNotFound) return } json.NewEncoder(w).Encode(ph.pizzas) default: http.Error(w, \"Method not allowed\", http.StatusMethodNotAllowed) } } type ordersHandler struct { pizzas *Pizzas orders *Orders } func (oh ordersHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) { w.Header().Set(\"Content-Type\", \"application/json\") switch r.Method { case http.MethodPost: var o Order if len(*oh.pizzas) == 0 { http.Error(w, \"Error: No pizzas found\", http.StatusNotFound) return } err := json.NewDecoder(r.Body).Decode(\u0026o) if err != nil { http.Error(w, \"Can't decode body\", http.StatusBadRequest) return } p, err := oh.pizzas.FindByID(o.PizzaID) if err != nil { http.Error(w, fmt.Sprintf(\"Error: %s\", err), http.StatusBadRequest) return } o.Total = p.Price * o.Quantity *oh.orders = append(*oh.orders, o) json.NewEncoder(w).Encode(o) case http.MethodGet: json.NewEncoder(w).Encode(oh.orders) default: http.Error(w, \"Method not allowed\", http.StatusMethodNotAllowed) } } func main() { var orders Orders pizzas := Pizzas{ Pizza{ ID: 1, Name: \"Pepperoni\", Price: 12, }, Pizza{ ID: 2, Name: \"Capricciosa\", Price: 11, }, Pizza{ ID: 3, Name: \"Margherita\", Price: 10, }, } mux := http.NewServeMux() mux.Handle(\"/pizzas\", pizzasHandler{\u0026pizzas}) mux.Handle(\"/orders\", ordersHandler{\u0026pizzas, \u0026orders}) log.Fatal(http.ListenAndServe(\":8080\", mux)) } The orders and the pizzas are kept in-memory – the example is simple on purpose and adding any storage solution will greatly complicate the example. The body of the POST /orders endpoint expects a JSON body, with a pizza_id and quantity.\nThis server has a bunch of downsides and is absolutely not ready for production usage. It never checks the Accept header of the request, the errors responses are lacking additional details and proper envelopes. Our little HTTP server also never validates the data the client sends – if the quantity is missing from the request body of the POST /orders it will create a new order with a total of $0:\n$ curl -X POST localhost:8080/orders -d '{\"pizza_id\":1,\"quantity\":0}' | jq { \"pizza_id\": 1, \"quantity\": 0, \"total\": 0 } Lastly, it allows us to order only one type of pizza per order. What a weird pizza shop, isn’t it? Still, as an example for this article it will do just fine.\nLet’s run it locally and send a few requests using cURL. To see all of the available pizzas on the menu:\n$ curl -X GET localhost:8080/pizzas | jq [ { \"id\": 1, \"name\": \"Pepperoni\", \"price\": 12 }, { \"id\": 2, \"name\": \"Capricciosa\", \"price\": 11 }, { \"id\": 3, \"name\": \"Margherita\", \"price\": 10 } To see the (empty) list of orders:\n$ curl -X GET localhost:8080/orders null To create an order of four Pepperoni pizzas:\n$ curl -X POST localhost:8080/orders -d '{\"pizza_id\":1,\"quantity\":4}' | jq { \"pizza_id\": 1, \"quantity\": 4, \"total\": 48 } From the response it is clear that the total is $48. To see the new order in the list of orders:\n$ curl -X GET localhost:8080/orders | jq [ { \"pizza_id\": 1, \"quantity\": 4, \"total\": 48 } ] Great! Our simple HTTP server is working as it should. So, how do we test it?\nTesting the pizzasHandler As mentioned in the first section of this article, Go ships with everything we need to test our HTTP server in a single package called net/http/httptest (docs). Simply put, this package provides utilities for HTTP testing.\nLet’s create a main_test.go file where we will add our tests. First, we will test our pizzasHandler:\nfunc TestPizzasHandler(t *testing.T) { tt := []struct { name string method string input *Pizzas want string statusCode int }{ { name: \"without pizzas\", method: http.MethodGet, input: \u0026Pizzas{}, want: \"Error: No pizzas found\", statusCode: http.StatusNotFound, }, { name: \"with pizzas\", method: http.MethodGet, input: \u0026Pizzas{ Pizza{ ID: 1, Name: \"Foo\", Price: 10, }, }, want: `[{\"id\":1,\"name\":\"Foo\",\"price\":10}]`, statusCode: http.StatusOK, }, { name: \"with bad method\", method: http.MethodPost, input: \u0026Pizzas{}, want: \"Method not allowed\", statusCode: http.StatusMethodNotAllowed, }, } for _, tc := range tt { t.Run(tc.name, func(t *testing.T) { request := httptest.NewRequest(tc.method, \"/orders\", nil) responseRecorder := httptest.NewRecorder() pizzasHandler{tc.input}.ServeHTTP(responseRecorder, request) if responseRecorder.Code != tc.statusCode { t.Errorf(\"Want status '%d', got '%d'\", tc.statusCode, responseRecorder.Code) } if strings.TrimSpace(responseRecorder.Body.String()) != tc.want { t.Errorf(\"Want '%s', got '%s'\", tc.want, responseRecorder.Body) } }) } } In this test we take the common table-driven approach to testing the handler. We provide three cases: without any pizzas on the menu, with some pizzas on the menu and with a bad HTTP method being used.\nThen, for each of the test cases we run a subtest, which creates a new request and a responseRecorder.\nThe httptest.NewRequest function returns a new http.Request, which we can then use to invoke the handler with. The returned http.Request represents an incoming request to the handler. By creating this struct within the test we do not have to rely on booting up an actual HTTP server and sending an actual HTTP request to it. The http.Request struct gives us the ability to simulate a real request just by passing the struct to the handler under test.\nThe httptest.NewRequest function is essential to unit testing HTTP handlers here. Yet, it does only half of the job - “sending” a request to the handler. What about the other half - the response?\nWriting the response is done using the httptest.ResponseRecorder – it represents an actual implementation of http.ResponseWriter (the second argument of pizzasHandler’s ServeHTTP method). It records its mutations and allows us to make any assertions on it later in the test.\nThe httptest.ResponseRecorder and http.Request duo are all we need to sucessfully test any HTTP handler in Go.\nIf we run the above test, we’ll see the following output:\n$ go test -v -run PizzasHandler === RUN TestPizzasHandler === RUN TestPizzasHandler/without_pizzas === RUN TestPizzasHandler/with_pizzas === RUN TestPizzasHandler/with_bad_method --- PASS: TestPizzasHandler (0.00s) --- PASS: TestPizzasHandler/without_pizzas (0.00s) --- PASS: TestPizzasHandler/with_pizzas (0.00s) --- PASS: TestPizzasHandler/with_bad_method (0.00s) PASS ok _/Users/Ilija/Documents/go-playground/testing-in-go-http-servers\t0.023s (In case you’re following along, I recommend breaking the tests by changing any of the expected values and seeing how these tests fail.)\nTesting the pizzasHandler is straightforward - we have only one GET endpoint. How about we test our ordersHandler, which is a tad more complicated?\nTesting the ordersHandler The ordersHandler is more complicated relative to the pizzaHandler because it contains two endpoints, the POST one creates a new order while the GET one returns the list of all orders. This means that when testing, we will have to cover more cases.\nHere’s a test:\nfunc TestOrdersHandler(t *testing.T) { tt := []struct { name string method string pizzas *Pizzas orders *Orders body string want string statusCode int }{ { name: \"with a pizza ID and quantity\", method: http.MethodPost, pizzas: \u0026Pizzas{ Pizza{ ID: 1, Name: \"Margherita\", Price: 8, }, }, orders: \u0026Orders{}, body: `{\"pizza_id\":1,\"quantity\":1}`, want: `{\"pizza_id\":1,\"quantity\":1,\"total\":8}`, statusCode: http.StatusOK, }, { name: \"with a pizza and no quantity\", method: http.MethodPost, pizzas: \u0026Pizzas{ Pizza{ ID: 1, Name: \"Margherita\", Price: 8, }, }, orders: \u0026Orders{}, body: `{\"pizza_id\":1}`, want: `{\"pizza_id\":1,\"quantity\":0,\"total\":0}`, statusCode: http.StatusOK, }, { name: \"with no pizzas on menu\", method: http.MethodPost, pizzas: \u0026Pizzas{}, orders: \u0026Orders{}, body: `{\"pizza_id\":1,\"quantity\":1}`, want: \"Error: No pizzas found\", statusCode: http.StatusNotFound, }, { name: \"with GET method and no orders in memory\", method: http.MethodGet, pizzas: \u0026Pizzas{}, orders: \u0026Orders{}, body: \"\", want: \"[]\", statusCode: http.StatusOK, }, { name: \"with GET method and with orders in memory\", method: http.MethodGet, pizzas: \u0026Pizzas{}, orders: \u0026Orders{ Order{ Quantity: 10, PizzaID: 1, Total: 100, }, }, body: \"\", want: `[{\"pizza_id\":1,\"quantity\":10,\"total\":100}]`, statusCode: http.StatusOK, }, { name: \"with bad HTTP method\", method: http.MethodDelete, pizzas: \u0026Pizzas{}, orders: \u0026Orders{}, body: \"\", want: \"Method not allowed\", statusCode: http.StatusMethodNotAllowed, }, } for _, tc := range tt { t.Run(tc.name, func(t *testing.T) { request := httptest.NewRequest(tc.method, \"/orders\", strings.NewReader(tc.body)) responseRecorder := httptest.NewRecorder() handler := ordersHandler{tc.pizzas, tc.orders} handler.ServeHTTP(responseRecorder, request) if responseRecorder.Code != tc.statusCode { t.Errorf(\"Want status '%d', got '%d'\", tc.statusCode, responseRecorder.Code) } if strings.TrimSpace(responseRecorder.Body.String()) != tc.want { t.Errorf(\"Want '%s', got '%s'\", tc.want, responseRecorder.Body) } }) } } The tests are similar to the previous, but here each of the requests that we create using the httptest.NewRequest function also take a body as the third parameter. The body has to be of type io.Reader, which is an interface that wraps the basic Read method.\nIn cases where you need to wrap a simple string as an io.Reader one function that I’ve found fitting is string.NewReader. As you might notice if you visit its documentation, it is just a plain wrapper around the string as a read-only io.Reader.\nIn the rest of the test we - once again - create a responseRecorder and then pass it along with the request to the ordersHandler’s ServeHTTP function. Right after we compare the Body of the responseRecorder and the expected body from the test case.\nIf we run the test, we will see the following output:\n$ go test -v -run OrdersHandler === RUN TestOrdersHandler === RUN TestOrdersHandler/with_a_pizza_ID_and_quantity === RUN TestOrdersHandler/with_a_pizza_and_no_quantity === RUN TestOrdersHandler/with_no_pizzas_on_menu === RUN TestOrdersHandler/with_GET_method_and_no_orders_in_memory === RUN TestOrdersHandler/with_GET_method_and_with_orders_in_memory === RUN TestOrdersHandler/with_bad_HTTP_method --- PASS: TestOrdersHandler (0.00s) --- PASS: TestOrdersHandler/with_a_pizza_ID_and_quantity (0.00s) --- PASS: TestOrdersHandler/with_a_pizza_and_no_quantity (0.00s) --- PASS: TestOrdersHandler/with_no_pizzas_on_menu (0.00s) --- PASS: TestOrdersHandler/with_GET_method_and_no_orders_in_memory (0.00s) --- PASS: TestOrdersHandler/with_GET_method_and_with_orders_in_memory (0.00s) --- PASS: TestOrdersHandler/with_bad_HTTP_method (0.00s) PASS ok _/Users/Ilija/Documents/go-playground/testing-in-go-http-servers\t0.011s (In case you’re following along, I recommend breaking the tests by changing any of the expected values and seeing how these tests fail.)\nAs you can see, the testing package in combination with the net/http/httptest package, using the httptest.NewRequest and httptest.Recorder functions provide flexibility and enough power to test any HTTP server.\nTo undersand all of the possibilities, I recommend checking out the net/http/httptest package documentation.\nP.S. You can read more about the jq tool on its homepage.\nLiked this article? Subscribe to my newsletter and get future articles in your inbox. It's a short and sweet read, going out to hundreds of other engineers.\n    ","wordCount":"1877","inLanguage":"en","datePublished":"2020-03-02T00:00:00Z","dateModified":"2020-03-02T00:00:00Z","author":{"@type":"Person","name":"Ilija Eftimov"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ieftimov.com/post/testing-in-go-testing-http-servers/"},"publisher":{"@type":"Organization","name":"Ilija Eftimov ⚡️","logo":{"@type":"ImageObject","url":"https://ieftimov.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://ieftimov.com/ accesskey=h title="Ilija Eftimov ⚡️ (Alt + H)">Ilija Eftimov ⚡️</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://ieftimov.com/ title=About><span>About</span></a></li><li><a href=https://ieftimov.com/posts title=Writing><span>Writing</span></a></li><li><a href=https://www.getrevue.co/profile/itsilija title=Subscribe><span>Subscribe</span></a></li><li><a href=https://ieftimov.com/index.xml title=RSS><span>RSS</span></a></li><li><a href=https://forms.gle/orfXK5jh1LRaiFzo8 title="Suggest a topic"><span>Suggest a topic</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Testing in Go: HTTP Servers</h1><div class=post-meta>March 2, 2020&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Ilija Eftimov</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#ordering-some-pizzas aria-label="Ordering some pizzas">Ordering some pizzas</a></li><li><a href=#testing-the-pizzashandler aria-label="Testing the pizzasHandler">Testing the <code>pizzasHandler</code></a></li><li><a href=#testing-the-ordershandler aria-label="Testing the ordersHandler">Testing the <code>ordersHandler</code></a></li></ul></div></details></div><div class=post-content><p>Go&rsquo;s a great hammer for a lot of nails, one of the areas where I find it
fitting is building HTTP servers. The <code>net/http</code> package of Go&rsquo;s standard
library makes it easy to attach HTTP handlers to any Go program. What I find
delightful is that Go&rsquo;s standard library, also has packages that make testing
HTTP servers as easy as building them.</p><p>Nowadays, it&rsquo;s widely accepted that test coverage is important and useful.
Having the quick feedback loop when changing your code is valuable, hence we
invest time in testing our code. When combined with methodologies like
continious integration and continious delivery, a good test suite becomes an
invaluable part of the software project.</p><p>Knowing the value of a good test suite, what approach should we - developers
using Go to build HTTP servers - take to testing our HTTP servers?</p><p>Here&rsquo;s everything you need to know to test your Go HTTP servers well.</p><h2 id=ordering-some-pizzas>Ordering some pizzas<a hidden class=anchor aria-hidden=true href=#ordering-some-pizzas>#</a></h2><p>As with any other article in this series on <a href=/categories/testing-in-go>testing in
Go</a>, let&rsquo;s create an example implementation that we
can use as a test subject.</p><p>Here&rsquo;s a small implementation of a pizza restaurant API with three endpoints:</p><ol><li>List all pizzas on the menu: <code>GET /pizzas</code></li><li>Make a simple pizza order: <code>POST /orders</code></li><li>List all orders in the system: <code>GET /orders</code></li></ol><p>Here&rsquo;s the code:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#719e07>package</span> main

<span style=color:#719e07>import</span> (
	<span style=color:#2aa198>&#34;encoding/json&#34;</span>
	<span style=color:#2aa198>&#34;fmt&#34;</span>
	<span style=color:#2aa198>&#34;log&#34;</span>
	<span style=color:#2aa198>&#34;net/http&#34;</span>
)

<span style=color:#268bd2>type</span> Pizza <span style=color:#268bd2>struct</span> {
	ID    <span style=color:#dc322f>int</span>    <span style=color:#2aa198>`json:&#34;id&#34;`</span>
	Name  <span style=color:#dc322f>string</span> <span style=color:#2aa198>`json:&#34;name&#34;`</span>
	Price <span style=color:#dc322f>int</span>    <span style=color:#2aa198>`json:&#34;price&#34;`</span>
}

<span style=color:#268bd2>type</span> Pizzas []Pizza

<span style=color:#268bd2>func</span> (ps Pizzas) <span style=color:#268bd2>FindByID</span>(ID <span style=color:#dc322f>int</span>) (Pizza, <span style=color:#dc322f>error</span>) {
	<span style=color:#719e07>for</span> _, pizza <span style=color:#719e07>:=</span> <span style=color:#719e07>range</span> ps {
		<span style=color:#719e07>if</span> pizza.ID <span style=color:#719e07>==</span> ID {
			<span style=color:#719e07>return</span> pizza, <span style=color:#cb4b16>nil</span>
		}
	}

	<span style=color:#719e07>return</span> Pizza{}, fmt.<span style=color:#268bd2>Errorf</span>(<span style=color:#2aa198>&#34;Couldn&#39;t find pizza with ID: %d&#34;</span>, ID)
}

<span style=color:#268bd2>type</span> Order <span style=color:#268bd2>struct</span> {
	PizzaID  <span style=color:#dc322f>int</span> <span style=color:#2aa198>`json:&#34;pizza_id&#34;`</span>
	Quantity <span style=color:#dc322f>int</span> <span style=color:#2aa198>`json:&#34;quantity&#34;`</span>
	Total    <span style=color:#dc322f>int</span> <span style=color:#2aa198>`json:&#34;total&#34;`</span>
}

<span style=color:#268bd2>type</span> Orders []Order

<span style=color:#268bd2>type</span> pizzasHandler <span style=color:#268bd2>struct</span> {
	pizzas <span style=color:#719e07>*</span>Pizzas
}

<span style=color:#268bd2>func</span> (ph pizzasHandler) <span style=color:#268bd2>ServeHTTP</span>(w http.ResponseWriter, r <span style=color:#719e07>*</span>http.Request) {
	w.<span style=color:#268bd2>Header</span>().<span style=color:#268bd2>Set</span>(<span style=color:#2aa198>&#34;Content-Type&#34;</span>, <span style=color:#2aa198>&#34;application/json&#34;</span>)

	<span style=color:#719e07>switch</span> r.Method {
	<span style=color:#719e07>case</span> http.MethodGet:
		<span style=color:#719e07>if</span> <span style=color:#b58900>len</span>(<span style=color:#719e07>*</span>ph.pizzas) <span style=color:#719e07>==</span> <span style=color:#2aa198>0</span> {
			http.<span style=color:#268bd2>Error</span>(w, <span style=color:#2aa198>&#34;Error: No pizzas found&#34;</span>, http.StatusNotFound)
			<span style=color:#719e07>return</span>
		}

		json.<span style=color:#268bd2>NewEncoder</span>(w).<span style=color:#268bd2>Encode</span>(ph.pizzas)
	<span style=color:#719e07>default</span>:
		http.<span style=color:#268bd2>Error</span>(w, <span style=color:#2aa198>&#34;Method not allowed&#34;</span>, http.StatusMethodNotAllowed)
	}
}

<span style=color:#268bd2>type</span> ordersHandler <span style=color:#268bd2>struct</span> {
	pizzas <span style=color:#719e07>*</span>Pizzas
	orders <span style=color:#719e07>*</span>Orders
}

<span style=color:#268bd2>func</span> (oh ordersHandler) <span style=color:#268bd2>ServeHTTP</span>(w http.ResponseWriter, r <span style=color:#719e07>*</span>http.Request) {
	w.<span style=color:#268bd2>Header</span>().<span style=color:#268bd2>Set</span>(<span style=color:#2aa198>&#34;Content-Type&#34;</span>, <span style=color:#2aa198>&#34;application/json&#34;</span>)

	<span style=color:#719e07>switch</span> r.Method {
	<span style=color:#719e07>case</span> http.MethodPost:
		<span style=color:#268bd2>var</span> o Order

		<span style=color:#719e07>if</span> <span style=color:#b58900>len</span>(<span style=color:#719e07>*</span>oh.pizzas) <span style=color:#719e07>==</span> <span style=color:#2aa198>0</span> {
			http.<span style=color:#268bd2>Error</span>(w, <span style=color:#2aa198>&#34;Error: No pizzas found&#34;</span>, http.StatusNotFound)
			<span style=color:#719e07>return</span>
		}

		err <span style=color:#719e07>:=</span> json.<span style=color:#268bd2>NewDecoder</span>(r.Body).<span style=color:#268bd2>Decode</span>(<span style=color:#719e07>&amp;</span>o)
		<span style=color:#719e07>if</span> err <span style=color:#719e07>!=</span> <span style=color:#cb4b16>nil</span> {
			http.<span style=color:#268bd2>Error</span>(w, <span style=color:#2aa198>&#34;Can&#39;t decode body&#34;</span>, http.StatusBadRequest)
			<span style=color:#719e07>return</span>
		}

		p, err <span style=color:#719e07>:=</span> oh.pizzas.<span style=color:#268bd2>FindByID</span>(o.PizzaID)
		<span style=color:#719e07>if</span> err <span style=color:#719e07>!=</span> <span style=color:#cb4b16>nil</span> {
			http.<span style=color:#268bd2>Error</span>(w, fmt.<span style=color:#268bd2>Sprintf</span>(<span style=color:#2aa198>&#34;Error: %s&#34;</span>, err), http.StatusBadRequest)
			<span style=color:#719e07>return</span>
		}

		o.Total = p.Price <span style=color:#719e07>*</span> o.Quantity
		<span style=color:#719e07>*</span>oh.orders = <span style=color:#b58900>append</span>(<span style=color:#719e07>*</span>oh.orders, o)
		json.<span style=color:#268bd2>NewEncoder</span>(w).<span style=color:#268bd2>Encode</span>(o)
	<span style=color:#719e07>case</span> http.MethodGet:
		json.<span style=color:#268bd2>NewEncoder</span>(w).<span style=color:#268bd2>Encode</span>(oh.orders)
	<span style=color:#719e07>default</span>:
		http.<span style=color:#268bd2>Error</span>(w, <span style=color:#2aa198>&#34;Method not allowed&#34;</span>, http.StatusMethodNotAllowed)
	}
}

<span style=color:#268bd2>func</span> <span style=color:#268bd2>main</span>() {
	<span style=color:#268bd2>var</span> orders Orders
	pizzas <span style=color:#719e07>:=</span> Pizzas{
		Pizza{
			ID:    <span style=color:#2aa198>1</span>,
			Name:  <span style=color:#2aa198>&#34;Pepperoni&#34;</span>,
			Price: <span style=color:#2aa198>12</span>,
		},
		Pizza{
			ID:    <span style=color:#2aa198>2</span>,
			Name:  <span style=color:#2aa198>&#34;Capricciosa&#34;</span>,
			Price: <span style=color:#2aa198>11</span>,
		},
		Pizza{
			ID:    <span style=color:#2aa198>3</span>,
			Name:  <span style=color:#2aa198>&#34;Margherita&#34;</span>,
			Price: <span style=color:#2aa198>10</span>,
		},
	}

	mux <span style=color:#719e07>:=</span> http.<span style=color:#268bd2>NewServeMux</span>()
	mux.<span style=color:#268bd2>Handle</span>(<span style=color:#2aa198>&#34;/pizzas&#34;</span>, pizzasHandler{<span style=color:#719e07>&amp;</span>pizzas})
	mux.<span style=color:#268bd2>Handle</span>(<span style=color:#2aa198>&#34;/orders&#34;</span>, ordersHandler{<span style=color:#719e07>&amp;</span>pizzas, <span style=color:#719e07>&amp;</span>orders})

	log.<span style=color:#268bd2>Fatal</span>(http.<span style=color:#268bd2>ListenAndServe</span>(<span style=color:#2aa198>&#34;:8080&#34;</span>, mux))
}</code></pre></div><p>The orders and the pizzas are kept in-memory – the example is simple on purpose
and adding any storage solution will greatly complicate the example. The body
of the <code>POST /orders</code> endpoint expects a JSON body, with a <code>pizza_id</code> and
<code>quantity</code>.</p><p>This server has a bunch of downsides and is absolutely not ready for production
usage. It never checks the <code>Accept</code> header of the request, the errors responses
are lacking additional details and proper envelopes. Our little HTTP server
also never validates the data the client sends – if the quantity is missing
from the request body of the <code>POST /orders</code> it will create a new order with a
total of $0:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ curl -X POST localhost:8080/orders -d <span style=color:#2aa198>&#39;{&#34;pizza_id&#34;:1,&#34;quantity&#34;:0}&#39;</span> | jq
<span style=color:#719e07>{</span>
  <span style=color:#2aa198>&#34;pizza_id&#34;</span>: 1,
  <span style=color:#2aa198>&#34;quantity&#34;</span>: 0,
  <span style=color:#2aa198>&#34;total&#34;</span>: <span style=color:#2aa198>0</span>
<span style=color:#719e07>}</span></code></pre></div><p>Lastly, it allows us to order only one type of pizza per order. What a weird
pizza shop, isn&rsquo;t it? Still, as an example for this article it will do just
fine.</p><p>Let&rsquo;s run it locally and send a few requests using <code>cURL</code>. To see all of the
available pizzas on the menu:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ curl -X GET localhost:8080/pizzas | jq
<span style=color:#719e07>[</span>
  <span style=color:#719e07>{</span>
    <span style=color:#2aa198>&#34;id&#34;</span>: 1,
    <span style=color:#2aa198>&#34;name&#34;</span>: <span style=color:#2aa198>&#34;Pepperoni&#34;</span>,
    <span style=color:#2aa198>&#34;price&#34;</span>: <span style=color:#2aa198>12</span>
  <span style=color:#719e07>}</span>,
  <span style=color:#719e07>{</span>
    <span style=color:#2aa198>&#34;id&#34;</span>: 2,
    <span style=color:#2aa198>&#34;name&#34;</span>: <span style=color:#2aa198>&#34;Capricciosa&#34;</span>,
    <span style=color:#2aa198>&#34;price&#34;</span>: <span style=color:#2aa198>11</span>
  <span style=color:#719e07>}</span>,
  <span style=color:#719e07>{</span>
    <span style=color:#2aa198>&#34;id&#34;</span>: 3,
    <span style=color:#2aa198>&#34;name&#34;</span>: <span style=color:#2aa198>&#34;Margherita&#34;</span>,
    <span style=color:#2aa198>&#34;price&#34;</span>: <span style=color:#2aa198>10</span>
  <span style=color:#719e07>}</span></code></pre></div><p>To see the (empty) list of orders:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ curl -X GET localhost:8080/orders
null</code></pre></div><p>To create an order of four Pepperoni pizzas:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ curl -X POST localhost:8080/orders -d <span style=color:#2aa198>&#39;{&#34;pizza_id&#34;:1,&#34;quantity&#34;:4}&#39;</span> | jq
<span style=color:#719e07>{</span>
  <span style=color:#2aa198>&#34;pizza_id&#34;</span>: 1,
  <span style=color:#2aa198>&#34;quantity&#34;</span>: 4,
  <span style=color:#2aa198>&#34;total&#34;</span>: <span style=color:#2aa198>48</span>
<span style=color:#719e07>}</span></code></pre></div><p>From the response it is clear that the total is $48. To see the new order in
the list of orders:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ curl -X GET localhost:8080/orders | jq
<span style=color:#719e07>[</span>
  <span style=color:#719e07>{</span>
    <span style=color:#2aa198>&#34;pizza_id&#34;</span>: 1,
    <span style=color:#2aa198>&#34;quantity&#34;</span>: 4,
    <span style=color:#2aa198>&#34;total&#34;</span>: <span style=color:#2aa198>48</span>
  <span style=color:#719e07>}</span>
<span style=color:#719e07>]</span></code></pre></div><p>Great! Our simple HTTP server is working as it should. So, how do we test it?</p><h2 id=testing-the-pizzashandler>Testing the <code>pizzasHandler</code><a hidden class=anchor aria-hidden=true href=#testing-the-pizzashandler>#</a></h2><p>As mentioned in the first section of this article, Go ships with everything we
need to test our HTTP server in a single package called <code>net/http/httptest</code>
(<a href=https://golang.org/pkg/net/http/httptest>docs</a>). Simply put, this package
provides utilities for HTTP testing.</p><p>Let&rsquo;s create a <code>main_test.go</code> file where we will add our tests. First, we will
test our <code>pizzasHandler</code>:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#268bd2>func</span> <span style=color:#268bd2>TestPizzasHandler</span>(t <span style=color:#719e07>*</span>testing.T) {
	tt <span style=color:#719e07>:=</span> []<span style=color:#268bd2>struct</span> {
		name       <span style=color:#dc322f>string</span>
		method     <span style=color:#dc322f>string</span>
		input      <span style=color:#719e07>*</span>Pizzas
		want       <span style=color:#dc322f>string</span>
		statusCode <span style=color:#dc322f>int</span>
	}{
		{
			name:       <span style=color:#2aa198>&#34;without pizzas&#34;</span>,
			method:     http.MethodGet,
			input:      <span style=color:#719e07>&amp;</span>Pizzas{},
			want:       <span style=color:#2aa198>&#34;Error: No pizzas found&#34;</span>,
			statusCode: http.StatusNotFound,
		},
		{
			name:   <span style=color:#2aa198>&#34;with pizzas&#34;</span>,
			method: http.MethodGet,
			input: <span style=color:#719e07>&amp;</span>Pizzas{
				Pizza{
					ID:    <span style=color:#2aa198>1</span>,
					Name:  <span style=color:#2aa198>&#34;Foo&#34;</span>,
					Price: <span style=color:#2aa198>10</span>,
				},
			},
			want:       <span style=color:#2aa198>`[{&#34;id&#34;:1,&#34;name&#34;:&#34;Foo&#34;,&#34;price&#34;:10}]`</span>,
			statusCode: http.StatusOK,
		},
		{
			name:       <span style=color:#2aa198>&#34;with bad method&#34;</span>,
			method:     http.MethodPost,
			input:      <span style=color:#719e07>&amp;</span>Pizzas{},
			want:       <span style=color:#2aa198>&#34;Method not allowed&#34;</span>,
			statusCode: http.StatusMethodNotAllowed,
		},
	}

	<span style=color:#719e07>for</span> _, tc <span style=color:#719e07>:=</span> <span style=color:#719e07>range</span> tt {
		t.<span style=color:#268bd2>Run</span>(tc.name, <span style=color:#268bd2>func</span>(t <span style=color:#719e07>*</span>testing.T) {
			request <span style=color:#719e07>:=</span> httptest.<span style=color:#268bd2>NewRequest</span>(tc.method, <span style=color:#2aa198>&#34;/orders&#34;</span>, <span style=color:#cb4b16>nil</span>)
			responseRecorder <span style=color:#719e07>:=</span> httptest.<span style=color:#268bd2>NewRecorder</span>()

			pizzasHandler{tc.input}.<span style=color:#268bd2>ServeHTTP</span>(responseRecorder, request)

			<span style=color:#719e07>if</span> responseRecorder.Code <span style=color:#719e07>!=</span> tc.statusCode {
				t.<span style=color:#268bd2>Errorf</span>(<span style=color:#2aa198>&#34;Want status &#39;%d&#39;, got &#39;%d&#39;&#34;</span>, tc.statusCode, responseRecorder.Code)
			}

			<span style=color:#719e07>if</span> strings.<span style=color:#268bd2>TrimSpace</span>(responseRecorder.Body.<span style=color:#268bd2>String</span>()) <span style=color:#719e07>!=</span> tc.want {
				t.<span style=color:#268bd2>Errorf</span>(<span style=color:#2aa198>&#34;Want &#39;%s&#39;, got &#39;%s&#39;&#34;</span>, tc.want, responseRecorder.Body)
			}
		})
	}
}</code></pre></div><p>In this test we take the common <a href=/post/testing-in-go-table-driven-tests>table-driven
approach</a> to testing the handler. We
provide three cases: without any pizzas on the menu, with some pizzas on the
menu and with a bad HTTP method being used.</p><p>Then, for each of the test cases we run <a href=/post/testing-in-go-subtests>a
subtest</a>, which creates a new <code>request</code> and a
<code>responseRecorder</code>.</p><p>The <code>httptest.NewRequest</code> function returns a new <code>http.Request</code>, which we can
then use to invoke the handler with. The returned <code>http.Request</code> represents an
incoming request to the handler. By creating this struct within the test we do
not have to rely on booting up an actual HTTP server and sending an actual HTTP
request to it. The <code>http.Request</code> struct gives us the ability to simulate a
real request just by passing the struct to the handler under test.</p><p>The <code>httptest.NewRequest</code> function is essential to unit testing HTTP handlers
here. Yet, it does only half of the job - &ldquo;sending&rdquo; a request to the handler.
What about the other half - the response?</p><p>Writing the response is done using the <code>httptest.ResponseRecorder</code> – it
represents an actual implementation of <code>http.ResponseWriter</code> (the second
argument of <code>pizzasHandler</code>&rsquo;s <code>ServeHTTP</code> method). It records its mutations and
allows us to make any assertions on it later in the test.</p><p>The <code>httptest.ResponseRecorder</code> and <code>http.Request</code> duo are all we need to
sucessfully test any HTTP handler in Go.</p><p>If we run the above test, we&rsquo;ll see the following output:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>$ <span style=color:#719e07>go</span> test <span style=color:#719e07>-</span>v <span style=color:#719e07>-</span>run PizzasHandler
<span style=color:#719e07>==</span>= RUN   TestPizzasHandler
<span style=color:#719e07>==</span>= RUN   TestPizzasHandler<span style=color:#719e07>/</span>without_pizzas
<span style=color:#719e07>==</span>= RUN   TestPizzasHandler<span style=color:#719e07>/</span>with_pizzas
<span style=color:#719e07>==</span>= RUN   TestPizzasHandler<span style=color:#719e07>/</span>with_bad_method
<span style=color:#719e07>---</span> PASS: <span style=color:#268bd2>TestPizzasHandler</span> (<span style=color:#2aa198>0.00</span>s)
    <span style=color:#719e07>---</span> PASS: TestPizzasHandler<span style=color:#719e07>/</span><span style=color:#268bd2>without_pizzas</span> (<span style=color:#2aa198>0.00</span>s)
    <span style=color:#719e07>---</span> PASS: TestPizzasHandler<span style=color:#719e07>/</span><span style=color:#268bd2>with_pizzas</span> (<span style=color:#2aa198>0.00</span>s)
    <span style=color:#719e07>---</span> PASS: TestPizzasHandler<span style=color:#719e07>/</span><span style=color:#268bd2>with_bad_method</span> (<span style=color:#2aa198>0.00</span>s)
PASS
ok  	_<span style=color:#719e07>/</span>Users<span style=color:#719e07>/</span>Ilija<span style=color:#719e07>/</span>Documents<span style=color:#719e07>/</span><span style=color:#719e07>go</span><span style=color:#719e07>-</span>playground<span style=color:#719e07>/</span>testing<span style=color:#719e07>-</span>in<span style=color:#719e07>-</span><span style=color:#719e07>go</span><span style=color:#719e07>-</span>http<span style=color:#719e07>-</span>servers	<span style=color:#2aa198>0.023</span>s</code></pre></div><p>(In case you&rsquo;re following along, I recommend breaking the tests by changing any
of the expected values and seeing how these tests fail.)</p><p>Testing the <code>pizzasHandler</code> is straightforward - we have only one <code>GET</code>
endpoint. How about we test our <code>ordersHandler</code>, which is a tad more
complicated?</p><h2 id=testing-the-ordershandler>Testing the <code>ordersHandler</code><a hidden class=anchor aria-hidden=true href=#testing-the-ordershandler>#</a></h2><p>The <code>ordersHandler</code> is more complicated relative to the <code>pizzaHandler</code> because
it contains two endpoints, the <code>POST</code> one creates a new order while the <code>GET</code>
one returns the list of all orders. This means that when testing, we will have
to cover more cases.</p><p>Here&rsquo;s a test:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#268bd2>func</span> <span style=color:#268bd2>TestOrdersHandler</span>(t <span style=color:#719e07>*</span>testing.T) {
	tt <span style=color:#719e07>:=</span> []<span style=color:#268bd2>struct</span> {
		name       <span style=color:#dc322f>string</span>
		method     <span style=color:#dc322f>string</span>
		pizzas     <span style=color:#719e07>*</span>Pizzas
		orders     <span style=color:#719e07>*</span>Orders
		body       <span style=color:#dc322f>string</span>
		want       <span style=color:#dc322f>string</span>
		statusCode <span style=color:#dc322f>int</span>
	}{
		{
			name:   <span style=color:#2aa198>&#34;with a pizza ID and quantity&#34;</span>,
			method: http.MethodPost,
			pizzas: <span style=color:#719e07>&amp;</span>Pizzas{
				Pizza{
					ID:    <span style=color:#2aa198>1</span>,
					Name:  <span style=color:#2aa198>&#34;Margherita&#34;</span>,
					Price: <span style=color:#2aa198>8</span>,
				},
			},
			orders:     <span style=color:#719e07>&amp;</span>Orders{},
			body:       <span style=color:#2aa198>`{&#34;pizza_id&#34;:1,&#34;quantity&#34;:1}`</span>,
			want:       <span style=color:#2aa198>`{&#34;pizza_id&#34;:1,&#34;quantity&#34;:1,&#34;total&#34;:8}`</span>,
			statusCode: http.StatusOK,
		},
		{
			name:   <span style=color:#2aa198>&#34;with a pizza and no quantity&#34;</span>,
			method: http.MethodPost,
			pizzas: <span style=color:#719e07>&amp;</span>Pizzas{
				Pizza{
					ID:    <span style=color:#2aa198>1</span>,
					Name:  <span style=color:#2aa198>&#34;Margherita&#34;</span>,
					Price: <span style=color:#2aa198>8</span>,
				},
			},
			orders:     <span style=color:#719e07>&amp;</span>Orders{},
			body:       <span style=color:#2aa198>`{&#34;pizza_id&#34;:1}`</span>,
			want:       <span style=color:#2aa198>`{&#34;pizza_id&#34;:1,&#34;quantity&#34;:0,&#34;total&#34;:0}`</span>,
			statusCode: http.StatusOK,
		},
		{
			name:       <span style=color:#2aa198>&#34;with no pizzas on menu&#34;</span>,
			method:     http.MethodPost,
			pizzas:     <span style=color:#719e07>&amp;</span>Pizzas{},
			orders:     <span style=color:#719e07>&amp;</span>Orders{},
			body:       <span style=color:#2aa198>`{&#34;pizza_id&#34;:1,&#34;quantity&#34;:1}`</span>,
			want:       <span style=color:#2aa198>&#34;Error: No pizzas found&#34;</span>,
			statusCode: http.StatusNotFound,
		},
		{
			name:       <span style=color:#2aa198>&#34;with GET method and no orders in memory&#34;</span>,
			method:     http.MethodGet,
			pizzas:     <span style=color:#719e07>&amp;</span>Pizzas{},
			orders:     <span style=color:#719e07>&amp;</span>Orders{},
			body:       <span style=color:#2aa198>&#34;&#34;</span>,
			want:       <span style=color:#2aa198>&#34;[]&#34;</span>,
			statusCode: http.StatusOK,
		},
		{
			name:   <span style=color:#2aa198>&#34;with GET method and with orders in memory&#34;</span>,
			method: http.MethodGet,
			pizzas: <span style=color:#719e07>&amp;</span>Pizzas{},
			orders: <span style=color:#719e07>&amp;</span>Orders{
				Order{
					Quantity: <span style=color:#2aa198>10</span>,
					PizzaID:  <span style=color:#2aa198>1</span>,
					Total:    <span style=color:#2aa198>100</span>,
				},
			},
			body:       <span style=color:#2aa198>&#34;&#34;</span>,
			want:       <span style=color:#2aa198>`[{&#34;pizza_id&#34;:1,&#34;quantity&#34;:10,&#34;total&#34;:100}]`</span>,
			statusCode: http.StatusOK,
		},
		{
			name:       <span style=color:#2aa198>&#34;with bad HTTP method&#34;</span>,
			method:     http.MethodDelete,
			pizzas:     <span style=color:#719e07>&amp;</span>Pizzas{},
			orders:     <span style=color:#719e07>&amp;</span>Orders{},
			body:       <span style=color:#2aa198>&#34;&#34;</span>,
			want:       <span style=color:#2aa198>&#34;Method not allowed&#34;</span>,
			statusCode: http.StatusMethodNotAllowed,
		},
	}

	<span style=color:#719e07>for</span> _, tc <span style=color:#719e07>:=</span> <span style=color:#719e07>range</span> tt {
		t.<span style=color:#268bd2>Run</span>(tc.name, <span style=color:#268bd2>func</span>(t <span style=color:#719e07>*</span>testing.T) {
			request <span style=color:#719e07>:=</span> httptest.<span style=color:#268bd2>NewRequest</span>(tc.method, <span style=color:#2aa198>&#34;/orders&#34;</span>, strings.<span style=color:#268bd2>NewReader</span>(tc.body))
			responseRecorder <span style=color:#719e07>:=</span> httptest.<span style=color:#268bd2>NewRecorder</span>()

			handler <span style=color:#719e07>:=</span> ordersHandler{tc.pizzas, tc.orders}
			handler.<span style=color:#268bd2>ServeHTTP</span>(responseRecorder, request)

			<span style=color:#719e07>if</span> responseRecorder.Code <span style=color:#719e07>!=</span> tc.statusCode {
				t.<span style=color:#268bd2>Errorf</span>(<span style=color:#2aa198>&#34;Want status &#39;%d&#39;, got &#39;%d&#39;&#34;</span>, tc.statusCode, responseRecorder.Code)
			}

			<span style=color:#719e07>if</span> strings.<span style=color:#268bd2>TrimSpace</span>(responseRecorder.Body.<span style=color:#268bd2>String</span>()) <span style=color:#719e07>!=</span> tc.want {
				t.<span style=color:#268bd2>Errorf</span>(<span style=color:#2aa198>&#34;Want &#39;%s&#39;, got &#39;%s&#39;&#34;</span>, tc.want, responseRecorder.Body)
			}
		})
	}
}</code></pre></div><p>The tests are similar to the previous, but here each of the requests that we
create using the <code>httptest.NewRequest</code> function also take a body as the third
parameter. The body has to be of type <code>io.Reader</code>, which is <a href=https://golang.org/pkg/io/#Reader>an
interface</a> that wraps the basic <code>Read</code>
method.</p><p>In cases where you need to wrap a simple <code>string</code> as an <code>io.Reader</code> one
function that I&rsquo;ve found fitting is <code>string.NewReader</code>. As you might notice if
you visit <a href=https://golang.org/pkg/strings/#NewReader>its documentation</a>, it is
just a plain wrapper around the string as a read-only <code>io.Reader</code>.</p><p>In the rest of the test we - once again - create a <code>responseRecorder</code> and then
pass it along with the <code>request</code> to the <code>ordersHandler</code>&rsquo;s <code>ServeHTTP</code> function.
Right after we compare the <code>Body</code> of the <code>responseRecorder</code> and the expected
body from the test case.</p><p>If we run the test, we will see the following output:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ go <span style=color:#b58900>test</span> -v -run <span style=color:#268bd2>OrdersHandler</span>
<span style=color:#719e07>===</span> RUN   <span style=color:#268bd2>TestOrdersHandler</span>
<span style=color:#719e07>===</span> RUN   TestOrdersHandler/with_a_pizza_ID_and_quantity
<span style=color:#719e07>===</span> RUN   TestOrdersHandler/with_a_pizza_and_no_quantity
<span style=color:#719e07>===</span> RUN   TestOrdersHandler/with_no_pizzas_on_menu
<span style=color:#719e07>===</span> RUN   TestOrdersHandler/with_GET_method_and_no_orders_in_memory
<span style=color:#719e07>===</span> RUN   TestOrdersHandler/with_GET_method_and_with_orders_in_memory
<span style=color:#719e07>===</span> RUN   TestOrdersHandler/with_bad_HTTP_method
--- PASS: TestOrdersHandler <span style=color:#719e07>(</span>0.00s<span style=color:#719e07>)</span>
    --- PASS: TestOrdersHandler/with_a_pizza_ID_and_quantity <span style=color:#719e07>(</span>0.00s<span style=color:#719e07>)</span>
    --- PASS: TestOrdersHandler/with_a_pizza_and_no_quantity <span style=color:#719e07>(</span>0.00s<span style=color:#719e07>)</span>
    --- PASS: TestOrdersHandler/with_no_pizzas_on_menu <span style=color:#719e07>(</span>0.00s<span style=color:#719e07>)</span>
    --- PASS: TestOrdersHandler/with_GET_method_and_no_orders_in_memory <span style=color:#719e07>(</span>0.00s<span style=color:#719e07>)</span>
    --- PASS: TestOrdersHandler/with_GET_method_and_with_orders_in_memory <span style=color:#719e07>(</span>0.00s<span style=color:#719e07>)</span>
    --- PASS: TestOrdersHandler/with_bad_HTTP_method <span style=color:#719e07>(</span>0.00s<span style=color:#719e07>)</span>
PASS
ok  	_/Users/Ilija/Documents/go-playground/testing-in-go-http-servers	0.011s</code></pre></div><p>(In case you&rsquo;re following along, I recommend breaking the tests by changing any
of the expected values and seeing how these tests fail.)</p><p>As you can see, the <code>testing</code> package in combination with the
<code>net/http/httptest</code> package, using the <code>httptest.NewRequest</code> and
<code>httptest.Recorder</code> functions provide flexibility and enough power to test any
HTTP server.</p><p>To undersand all of the possibilities, I recommend checking out the
<code>net/http/httptest</code> <a href=https://golang.org/pkg/net/http/httptest>package
documentation</a>.</p><p><em>P.S. You can read more about the <code>jq</code> tool on <a href=https://stedolan.github.io/jq/>its
homepage</a>.</em></p><div id=revue-embed><form action=https://www.getrevue.co/profile/itsilija/add_subscriber method=post id=revue-form name=revue-form target=_blank><p><b>Liked this article?</b>
Subscribe to my newsletter and get future articles in your inbox. It's a
short and sweet read, going out to hundreds of other engineers.</p><div class=revue-form-group><input class=revue-form-field placeholder="Your email address..." type=email name=member[email] id=member_email></div><div class=revue-form-actions><input type=submit value=Subscribe name=member[subscribe] id=member_submit></div></form></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://ieftimov.com/post/testing-in-go-websockets/><span class=title>« Prev Page</span><br><span>Testing in Go: WebSockets</span></a>
<a class=next href=https://ieftimov.com/post/testing-in-go-clean-tests-using-t-cleanup/><span class=title>Next Page »</span><br><span>Testing in Go: Clean Tests Using t.Cleanup</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: HTTP Servers on twitter" href="https://twitter.com/intent/tweet/?text=Testing%20in%20Go%3a%20HTTP%20Servers&url=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-testing-http-servers%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: HTTP Servers on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-testing-http-servers%2f&title=Testing%20in%20Go%3a%20HTTP%20Servers&summary=Testing%20in%20Go%3a%20HTTP%20Servers&source=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-testing-http-servers%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: HTTP Servers on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-testing-http-servers%2f&title=Testing%20in%20Go%3a%20HTTP%20Servers"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: HTTP Servers on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-testing-http-servers%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: HTTP Servers on whatsapp" href="https://api.whatsapp.com/send?text=Testing%20in%20Go%3a%20HTTP%20Servers%20-%20https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-testing-http-servers%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: HTTP Servers on telegram" href="https://telegram.me/share/url?text=Testing%20in%20Go%3a%20HTTP%20Servers&url=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-testing-http-servers%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>Copyright 2022 © Ilija Eftimov</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>