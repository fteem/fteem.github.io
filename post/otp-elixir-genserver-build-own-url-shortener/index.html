<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OTP in Elixir: Learn GenServer by Building Your Own URL Shortener | Ilija Eftimov ‚ö°Ô∏è</title><meta name=keywords content="genserver,url shortener"><meta name=description content="Looking at any programming language you will (hopefully!) find a rich and useful standard library. I started my professional career as a software developer with Ruby, which has quite an easy-to-use and well-documented standard library with a plethora of modules and classes to use. Personally, I find the Enumerable module in Ruby with all its nice methods simply brilliant.
You might be coming from a different language, but I am sure that any serious programming language out there has a set of classes, modules, methods and functions to make your life (and work) easy."><meta name=author content="Ilija"><link rel=canonical href=https://ieftimov.com/post/otp-elixir-genserver-build-own-url-shortener/><link crossorigin=anonymous href=/assets/css/stylesheet.min.css rel="preload stylesheet" as=style><link rel=icon href=https://ieftimov.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ieftimov.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ieftimov.com/favicon-32x32.png><link rel=apple-touch-icon href=https://ieftimov.com/apple-touch-icon.png><link rel=mask-icon href=https://ieftimov.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.83.1"><script async defer data-domain=ieftimov.com src=https://plausible.io/js/plausible.js></script><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel=stylesheet><meta property="og:title" content="OTP in Elixir: Learn GenServer by Building Your Own URL Shortener"><meta property="og:description" content="Looking at any programming language you will (hopefully!) find a rich and useful standard library. I started my professional career as a software developer with Ruby, which has quite an easy-to-use and well-documented standard library with a plethora of modules and classes to use. Personally, I find the Enumerable module in Ruby with all its nice methods simply brilliant.
You might be coming from a different language, but I am sure that any serious programming language out there has a set of classes, modules, methods and functions to make your life (and work) easy."><meta property="og:type" content="article"><meta property="og:url" content="https://ieftimov.com/post/otp-elixir-genserver-build-own-url-shortener/"><meta property="og:image" content="https://ieftimov.com/cards/otp-elixir-genserver-build-own-url-shortener.png"><meta property="article:section" content="posts"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ieftimov.com/cards/otp-elixir-genserver-build-own-url-shortener.png"><meta name=twitter:title content="OTP in Elixir: Learn GenServer by Building Your Own URL Shortener"><meta name=twitter:description content="Looking at any programming language you will (hopefully!) find a rich and useful standard library. I started my professional career as a software developer with Ruby, which has quite an easy-to-use and well-documented standard library with a plethora of modules and classes to use. Personally, I find the Enumerable module in Ruby with all its nice methods simply brilliant.
You might be coming from a different language, but I am sure that any serious programming language out there has a set of classes, modules, methods and functions to make your life (and work) easy."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ieftimov.com/posts/"},{"@type":"ListItem","position":2,"name":"OTP in Elixir: Learn GenServer by Building Your Own URL Shortener","item":"https://ieftimov.com/post/otp-elixir-genserver-build-own-url-shortener/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"OTP in Elixir: Learn GenServer by Building Your Own URL Shortener","name":"OTP in Elixir: Learn GenServer by Building Your Own URL Shortener","description":"Looking at any programming language you will (hopefully!) find a rich and useful standard library. I started my professional career as a software developer with Ruby, which has quite an easy-to-use and well-documented standard library with a plethora of modules and classes to use. Personally, I find the Enumerable module in Ruby with all its nice methods simply brilliant.\nYou might be coming from a different language, but I am sure that any serious programming language out there has a set of classes, modules, methods and functions to make your life (and work) easy.","keywords":["genserver","url shortener"],"articleBody":"Looking at any programming language you will (hopefully!) find a rich and useful standard library. I started my professional career as a software developer with Ruby, which has quite an easy-to-use and well-documented standard library with a plethora of modules and classes to use. Personally, I find the Enumerable module in Ruby with all its nice methods simply brilliant.\nYou might be coming from a different language, but I am sure that any serious programming language out there has a set of classes, modules, methods and functions to make your life (and work) easy.\nSo, what about Elixirs stdlib?\nNo surprise there too ‚Äì Elixir has a well-documented and easy-to-use standard library. But, because it works on top of the BEAM virtual machine and inherits plenty from Erlang‚Äôs rich history, it also has a bit more ‚Äì something called OTP.\nPhoto by Mario Caruso on UnsplashMeet OTP üëã From Wikipedia‚Äôs article on OTP:\n OTP is a collection of useful middleware, libraries, and tools written in the Erlang programming language. It is an integral part of the open-source distribution of Erlang. The name OTP was originally an acronym for Open Telecom Platform, which was a branding attempt before Ericsson released Erlang/OTP as open source. However, neither Erlang nor OTP is specific to telecom applications.\n In continuation, it states:\n It (OTP) contains:\n an Erlang interpreter (called BEAM); an Erlang compiler; a protocol for communication between servers (nodes); a CORBA Object Request Broker; a static analysis tool called Dialyzer; a distributed database server (Mnesia); and many other libraries.   While I do not consider myself an expert in Elixir, Erlang, the BEAM or OTP by any stretch of the imagination, I would like to take you on a journey to one of the most useful and well-known behaviours of OTP ‚Äì GenServer.\n  In continuation, we will use BEAM processes, so if you‚Äôre not familiar with spawning new processes, sending and receiving messages to/from them, then it‚Äôs best to head over to ‚ÄúUnderstanding the basics of Elixir‚Äôs concurrency model‚Äù and give it a quick read. It will help you understand processes and concurrency in Elixir so you can apply the knowledge in the project that we work on in this article. I promise.\nShortening a link ‚úÇÔ∏è Let‚Äôs write a URL shortener module that will run in a BEAM process and can receive multiple commands:\n shorten ‚Äì takes a link, shortens it and returns the short link as a response get ‚Äì take a short link and return the original one flush ‚Äì erase the URL shortener memory stop ‚Äì stop the process  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  defmodule URLShortener do def start do spawn(__MODULE__, :loop, [%{}]) end def loop(state) do receive do {:stop, caller} - send caller, \"Shutting down.\" {:shorten, url, caller} - url_md5 = md5(url) new_state = Map.put(state, url_md5, url) send caller, url_md5 loop(new_state) {:get, md5, caller} - send caller, Map.fetch(state, md5) loop(state) :flush - loop(%{}) _ - loop(state) end end defp md5(url) do :crypto.hash(:md5, url) | Base.encode16(case: :lower) end end   What the module does is when the process starts it will recursively call the URLShortener.loop/1 function, until it receives the {:stop, caller} message.\nIf we zoom into the {:shorten, url, caller} case we notice that we generate a MD5 digest from the URL and then we update the state map which creates a new map (called new_state). Once we get the digest we store it in a map with the key being the MD5 and the value is the actual URL. The state map will look like:\n1 2 3 4 5 6  %{ \"99999ebcfdb78df077ad2727fd00969f\" = \"https://google.com\", \"76100d6f27db53fddb6c8fce320f5d21\" = \"https://elixir-lang.org\", \"3097fca9b1ec8942c4305e550ef1b50a\" = \"https://github.com\", ... }   Then, we send the MD5 value back to the caller. Obviously, this is not how bit.ly or the likes work, as their links are much shorter. (For those interested, here‚Äôs an interesting discussion on the topic). However, for the purpose of this article, we‚Äôll stick to simple MD5 digest of the URL.\nThe other two commands, get and flush, are pretty simple. get returns only a single value from the state map, while flush invokes loop/1 with an empty map, effectively removing all the shortened links from the process' state (memory).\nLet‚Äôs run our shortener in an IEx session:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  iex(22) shortener = URLShortener.start #PID iex(23) send shortener, {:shorten, \"https://ieftimov.com\", self()} {:shorten, \"https://ieftimov.com\", #PID} iex(24) send shortener, {:shorten, \"https://google.com\", self()} {:shorten, \"https://google.com\", #PID} iex(25) send shortener, {:shorten, \"https://github.com\", self()} {:shorten, \"https://github.com\", #PID} iex(26) flush \"8c4c7fbc57b08d379da5b1312690be04\" \"99999ebcfdb78df077ad2727fd00969f\" \"3097fca9b1ec8942c4305e550ef1b50a\" :ok iex(27) send shortener, {:get, \"99999ebcfdb78df077ad2727fd00969f\", self()} {:get, \"99999ebcfdb78df077ad2727fd00969f\", #PID} iex(28) flush \"https://google.com\" :ok iex(29) send shortener, {:get, \"8c4c7fbc57b08d379da5b1312690be04\", self()} {:get, \"8c4c7fbc57b08d379da5b1312690be04\", #PID} iex(30) flush \"https://ieftimov.com\" :ok iex(31) send shortener, {:get, \"3097fca9b1ec8942c4305e550ef1b50a\", self()} {:get, \"3097fca9b1ec8942c4305e550ef1b50a\", #PID} iex(32) flush \"https://github.com\" :ok   Working as expected ‚Äì we send three different URLs for shortening, we receive their MD5 digests back in the process mailbox and when we query for them we get each of them back.\nAlthough our URLShortener module works pretty neatly now, it actually lacks quite a bit of functionality. Sure, it does handle the happy path really well, but when it comes to error handling, tracing or error reporting it falls really short. Additionally, it does not have a standard interface to add more functions to the process ‚Äì we sort of came up with it as we went on.\nAfter reading all of that you‚Äôre probably thinking there is a better way to do this. And you‚Äôd be right to think so ‚Äì let‚Äôs learn more about GenServers.\nEnter GenServer üö™ GenServer is an OTP behaviour. Behaviour in this context refers to three things:\n an interface, which is a set of functions; an implementation, which is the application-specific code, and the container, which is a BEAM process  This means that a module can implement a certain group of functions (interface or signatures), that under the hood implement some callback functions (which are specific to the behaviour you work on), that are run within a BEAM process.\nFor example, GenServer is a generic server behaviour ‚Äì it expects for each of the functions defined in it‚Äôs interface a set of callbacks which will handle the requests to the server. This means that the interface functions will be used by the clients of the generic server, a.k.a. the client API, while the callbacks defined will essentially be the server internals (‚Äúthe backend‚Äù).\nSo, how does a GenServer work? Well, as you can imagine we cannot go too deep on the hows of GenServer, but we need to get a good grasp on some basics:\n Server start \u0026 state Asynchronous messages Synchronous messages  Server start \u0026 state Just like with our URLShortener we implemented, every GenServer is capable of holding state. In fact, GenServers must implement a init/1 function, which will set the initial state of the server (see the init/1 documentation here for more details).\nTo start the server we can run:\n1  GenServer.start_link(__MODULE__, :ok, [])   GenServer.start_link/3 will invoke the init/1 function of the __MODULE__, passing in :ok as an argument to init/1. This function call will block until init/1 returns, so usually in this function, we do any required setup of the server process (that might be needed). For example, in our case, to rebuild URLShortener using a GenServer behaviour, we will need an init/1 function to set the initial state (empty map) of the server:\n1 2 3  def init(:ok) do {:ok, %{}} end   That‚Äôs all. start_link/3 will call init/1 with the :ok argument, which will return an :ok and set the state of the process to an empty map.\nSync \u0026 async messages üì® As most servers out there, GenServers can also receive and reply to requests (if needed). As the heading suggests, there are two types of requests that GenServers handle ‚Äì the ones expect a response (call) and the others that don‚Äôt (cast). Therefore, GenServers define two callback functions - handle_call/3 and handle_cast/2.\nWe will look at these functions in more depth a bit later.\nReimplementing URLShortener, using GenServer ‚ôªÔ∏è Let‚Äôs look at how we can flip the implementation to use GenServer.\nFirst, let‚Äôs add the shell of the module, the start_link/1 function and the init/1 function that start_link/1 will invoke:\n1 2 3 4 5 6 7 8 9 10 11  defmodule URLShortener do use GenServer def start_link(opts \\\\ []) do GenServer.start_link(__MODULE__, :ok, opts) end def init(:ok) do {:ok, %{}} end end   The notable changes here are the use of the GenServer behaviour in the module, the start_link/1 function which invokes GenServer.start_link/3 which would, in fact, call the init/1 function with the :ok atom as an argument. Also, it‚Äôs worth noting that the empty map that the init/1 function returns in the tuple is the actual initial state of the URLShortener process.\nLet‚Äôs give it a spin in IEx:\n1 2  iex(1) {:ok, pid} = URLShortener.start_link {:ok, #PID}   That‚Äôs all we can do at this moment. The difference here is that the GenServer.start_link/3 function will return a tuple with an atom (:ok) and the PID of the server.\nStopping the server ‚úã Let‚Äôs add the stop command:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  defmodule URLShortener do use GenServer # Client API def start_link(opts \\\\ []), do: GenServer.start_link(__MODULE__, :ok, opts) def stop(pid) do GenServer.cast(pid, :stop) end # GenServer callbacks def init(:ok), do: {:ok, %{}} def handle_cast(:stop, state) do {:stop, :normal, state} end end   Yes, I know I said we‚Äôll add one command but ended up adding two functions: stop/1 and handle_cast/2. Bear with me now:\nBecause we do not want to get a response back on the stop command, we will use GenServer.cast/2 in the stop/1 function. This means that when that command is called by the client (user) of the server, the handle_cast/2 callback will be triggered on the server. In our case, the handle_cast/2 function will return a tuple of three items ‚Äì {:stop, :normal, state}.\nReturning this tuple stops the loop and another callback called terminate/2 is called (which is defined in the behaviour but not implemented by URLShortener) with the reason :normal and state state. The process will exit with reason :normal.\nThis way of working with GenServer allows us to only define callbacks and the GenServer behaviour will know how to handle the rest. The only complexity resides in the fact that we need to understand and know most types of returns that the callback functions can have.\nAnother thing worth pointing out is that each function that will be used by the client will take a PID as a first argument. This will allow us to send messages to the correct GenServer process. Going forward we will not acknowledge PIDs presence ‚Äì we accept that it‚Äôs mandatory for our URLShortener to work. Later we will look at ways we can skip passing the PIDs as arguments.\nLet‚Äôs jump back in IEx and start and stop a URLShortener server:\n1 2 3 4 5 6 7 8 9 10 11  iex(1) {:ok, pid} = URLShortener.start_link {:ok, #PID} iex(2) Process.alive?(pid) true iex(3) URLShortener.stop(pid) :ok iex(4) Process.alive?(pid) false   That‚Äôs starting and stopping in all of it‚Äôs glory.\nShortening a URL Another thing we wanted our server to have is the ability to shorten URLs, by using their MD5 digest as the short variant of the URL. Let‚Äôs do that using GenServer:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  defmodule URLShortener do use GenServer # Client API def start_link(opts \\\\ []), do: GenServer.start_link(__MODULE__, :ok, opts) def stop(pid), do: GenServer.cast(pid, :stop) def shorten(pid, url) do GenServer.call(pid, {:shorten, url}) end # GenServer callbacks def init(:ok), do: {:ok, %{}} def handle_cast(:stop, state), do: {:stop, :normal, state} def handle_call({:shorten, url}, _from, state) do short = md5(url) {:reply, short, Map.put(state, short, url)} end defp md5(url) do :crypto.hash(:md5, url) | Base.encode16(case: :lower) end end   Three functions this time, but at least the md5/1 is a replica of the one we had previously. So, let‚Äôs look at the other two.\nYou might be seeing a pattern - we have a function that will be used by the client (shorten/2) and a callback that will be invoked on the server (handle_call/3). This time, there‚Äôs a slight difference in the functions used and naming: in shorten/2 we call GenServer.call/2 instead of cast/2, and the callback name is handle_call/3 instead of handle_cast/2.\nWhy? Well, the difference lies in the response - handle_call/3 will send a reply back to the client (hence the :reply atom in the response tuple), while handle_cast/2 does not do that. Basically casting is an async call where the client does not expect a response, while calling is a sync call where the response is expected.\nSo, let‚Äôs look at the structure of the handle_call/3 callback.\nIt takes three arguments: the request from the client (in our case a tuple), a tuple describing the client of the request (which we ignore), and the state of the server (in our case a map).\nAs a response, it returns a tuple with :reply, stating that there will be a reply to the request, the reply itself (in our case the shortened link) and the state which is the state carried over to the next loop of the server.\nOf course, handle_call/3 has a bit more intricacies that we will look into later, but you can always check it‚Äôs documentation to learn more.\nFetching a shortened URL üîó Let‚Äôs implement the get command, which when provided with a short version of the link it will return the full URL:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  defmodule URLShortener do use GenServer # Client API # ... def get(pid, short_link) do GenServer.call(pid, {:get, short_link}) end # GenServer callbacks # ... def handle_call({:get, short_link}, _from, state) do {:reply, Map.get(state, short_link), state} end end   The double-function entry pattern again - we add URLShortener.get/2 and another head of the URLShortener.handle_call/3 function.\nThe URLShortener.get/2 will call GenServer.call/2 under the hood, which when executed will cause the handle_call/3 callback to fire.\nThe URLShortener.handle_call/3 this time will take the command (:get) and the short_link as the first argument. Looking inside we see that, again, it‚Äôs a short function - it only returns a tuple with :reply (which states that the call will have a reply), a call to Map.get/2, whose return will be the actual response of the call, and the state, so the GenServer process maintains the state in the next loop.\nAt this moment, we can safely say that we have a good idea of the basics on writing functionality for a module that implements the GenServer behaviour. As you might be thinking, there‚Äôs much to explore, but these basics will allow you to create GenServers and experiment.\nBefore you go on, try to implement two more commands:\n flush ‚Äì an async call which will erase the state of the server count ‚Äì a sync call returning the number of links in the server‚Äôs state  More configurations üéõ If we circle back to URLShortener.start_link/1 and it‚Äôs internals (namely the invocation of GenServer.start_link/3), we will also notice that we can pass options (opts) to the GenServer.start_link/3 function, that are defaulted to an empty list ([]).\nWhat are the options that we can add here? By looking at the documentation of GenServer.start_link/3 you‚Äôll notice multiple interesting options:\n :name - used for name registration. This means that instead of identifying a GenServer by PID, we can put a name on it. :timeout - sets the server startup timeout (in milliseconds) :debug - enables debugging by invoking the corresponding function in the :sys module :hibernate_after - sets the time (in milliseconds) after which the server process will go into hibernation automatically until a new request comes in. This is done by utilising :proc_lib.hibernate/3 :spawn_opt - enables passing more options to the underlying process  Most of these are advanced and are beyond our use-case here. However, there‚Äôs one configuration we could use right now: :name.\nNaming the server üì¢ Let‚Äôs modify our URLShortener to take a name in it‚Äôs start_link/1 function and test it in IEx. Additionally, since every URLShortener process will have a name, we can refer to the process by name instead of PID - let‚Äôs see how that would work in code:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  defmodule URLShortener do use GenServer # Client API def start_link(name, opts \\\\ []) do GenServer.start_link(__MODULE__, :ok, opts ++ [name: name]) end def stop(name), do: GenServer.cast(name, :stop) def shorten(name, url), do: GenServer.call(name, {:shorten, url}) def get(name, short_link) do GenServer.call(name, {:get, short_link}) end # GenServer callbacks def init(:ok), do: {:ok, %{}} def handle_cast(:stop, state), do: {:stop, :normal, state} def handle_call({:shorten, url}, _from, state), do: {:reply, md5(url), Map.put(state, md5(url), url)} def handle_call({:get, short_link}, _from, state) do {:reply, Map.get(state, short_link), state} end defp md5(url), do: :crypto.hash(:md5, url) | Base.encode16(case: :lower) end   That‚Äôs all. We added a new argument to URLShortener.start_link/2 and we dropped all usage of PID and replaced it with name.\nLet‚Äôs take it for a spin in IEx:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  iex(1) {:ok, pid} = URLShortener.start_link(:foo) {:ok, #PID} iex(2) URLShortener.shorten(:foo, \"https://google.com\") \"99999ebcfdb78df077ad2727fd00969f\" iex(3) URLShortener.get(:foo, \"99999ebcfdb78df077ad2727fd00969f\") \"https://google.com\" iex(4) URLShortener.stop(:foo) :ok iex(5) Process.alive?(pid) false   You can see that this is pretty cool - instead of using PID we added a name :foo to the process which allowed us to refer to it using the name instead of the PID. Obviously, you can see that to inspect the BEAM process in any fashion we will still need the PID, but for the client the name does the trick.\nThis combination of name and PID allows us to have reference to the BEAM process while improving the ease of use for the client.\nIf we would like to simplify things even more, we can turn the URLShortener into a ‚Äúsingleton‚Äù server. Before you freak out - it has none of the drawbacks that the singleton pattern that‚Äôs infamous in OO programming has. We‚Äôre merely stating that we could change the URLShortener to have one and only one process running at a certain time, by setting a static name to it:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  defmodule URLShortener do use GenServer @name :url_shortener_server # Client API def start_link(opts \\\\ []) do GenServer.start_link(__MODULE__, :ok, opts ++ [name: @name]) end def stop, do: GenServer.cast(@name, :stop) def shorten(url), do: GenServer.call(@name, {:shorten, url}) def get(short_link) do GenServer.call(@name, {:get, short_link}) end # GenServer callbacks # ... end   You can notice that we added a module attribute @name that holds the name of the process. In all the functions from the client API, we dropped the name from the arguments lists and we simply use @name as a reference to the process. This means that there‚Äôs going to be only one process for URLShortener with the name :url_shortener_server.\nLet‚Äôs take it for a spin in IEx:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  iex(1) {:ok, pid} = URLShortener.start_link {:ok, #PID} iex(2) URLShortener.shorten(\"https://google.com\") \"99999ebcfdb78df077ad2727fd00969f\" iex(3) URLShortener.shorten(\"https://yahoo.com\") \"c88f320dec138ba5ab0a5f990ff082ba\" iex(4) URLShortener.get(\"99999ebcfdb78df077ad2727fd00969f\") \"https://google.com\" iex(5) URLShortener.stop :ok iex(6) Process.alive?(pid) false   You can notice that although we captured the PID on the first line, we do not need it at all - all of the work is done for us by URLShortener.\nIn this section, you saw how you can utilise names to more easily work with processes. Let‚Äôs review our full implementation of the URLShortener module.\nOutro üññ Before we wrap up this long tutorial, let‚Äôs have a final look at our new URLShortener module, including the count/1 and flush/1 functions:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61  defmodule URLShortener do use GenServer # Client API def start_link(name, opts \\\\ []) do GenServer.start_link(__MODULE__, :ok, opts ++ [name: name]) end def shorten(name, url) do GenServer.call(name, {:shorten, url}) end def get(name, short) do GenServer.call(name, {:get, short}) end def flush(name) do GenServer.cast(name, :flush) end def stop(name) do GenServer.cast(name, :stop) end def count(name) do GenServer.call(name, :count) end # Callbacks def init(:ok) do {:ok, %{}} end def handle_cast(:flush, _state) do {:noreply, %{}} end def handle_cast(:stop, state) do {:stop, :normal, state} end def handle_call({:shorten, url}, _from, state) do shortened = md5(url) new_state = Map.put(state, shortened, url) {:reply, shortened, new_state} end def handle_call({:get, short}, _from, state) do {:reply, Map.get(state, short), state} end def handle_call(:count, _from, state) do count = Map.keys(state) | Enum.count {:reply, count, state} end defp md5(url) do :crypto.hash(:md5, url) | Base.encode16(case: :lower) end end   The two callbacks are faily simple - flush will just send a noreply and set the state to an empty map. count on the other hand will have a reply with the count of the items of the map, which is simply the numbers of keys there are in the state map. That‚Äôs all.\nWhile you got to the end of the article your journey with GenServer does not end here. In fact, it just started. GenServers and OTP are very powerful tools that you can use to build generic servers that can live in small BEAM processes and have a very generic approach to building functionality (calls and callbacks).\nWhile we did cover a lot of ground here we didn‚Äôt touch on why we named the starting function start_link instead of just start (hint: supervisors convention), or how we would approach testing such a GenServer like URLShortener.\nIn what kind of scenarios have you used GenServers? Or, if you do not have experience with it, where do you see yourself using it in the future?\nLiked this article? You can buy me a coffee. Or simply subscribe to my newsletter and get my fresh posts in your inbox. It's short and sweet, going out monthly to over 1,000 subscribers.  ","wordCount":"3758","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"Ilija"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ieftimov.com/post/otp-elixir-genserver-build-own-url-shortener/"},"publisher":{"@type":"Organization","name":"Ilija Eftimov ‚ö°Ô∏è","logo":{"@type":"ImageObject","url":"https://ieftimov.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://ieftimov.com/ accesskey=h title="Ilija Eftimov ‚ö°Ô∏è (Alt + H)">Ilija Eftimov ‚ö°Ô∏è</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://ieftimov.com/ title=About><span>About</span></a></li><li><a href=https://ieftimov.com/posts title=Writing><span>Writing</span></a></li><li><a href=https://ieftimov.com/newsletter title=Newsletter><span>Newsletter</span></a></li><li><a href=https://forms.gle/orfXK5jh1LRaiFzo8 title="Suggest a topic"><span>Suggest a topic</span></a></li><li><a href=https://www.buymeacoffee.com/ieftimov title="Buy me a ‚òï"><span>Buy me a ‚òï</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>OTP in Elixir: Learn GenServer by Building Your Own URL Shortener</h1><div class=post-meta>January 26, 2019&nbsp;¬∑&nbsp;18 min&nbsp;¬∑&nbsp;Ilija</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#meet-otp- aria-label="Meet OTP üëã">Meet OTP üëã</a></li><li><a href=#shortening-a-link- aria-label="Shortening a link ‚úÇÔ∏è">Shortening a link ‚úÇÔ∏è</a></li><li><a href=#enter-genserver- aria-label="Enter GenServer üö™">Enter GenServer üö™</a><ul><li><a href=#server-start--state aria-label="Server start &amp;amp; state">Server start & state</a></li><li><a href=#sync--async-messages- aria-label="Sync &amp;amp; async messages üì®">Sync & async messages üì®</a></li></ul></li><li><a href=#reimplementing-urlshortener-using-genserver- aria-label="Reimplementing URLShortener, using GenServer ‚ôªÔ∏è">Reimplementing <code>URLShortener</code>, using <code>GenServer</code> ‚ôªÔ∏è</a><ul><li><a href=#stopping-the-server- aria-label="Stopping the server ‚úã">Stopping the server ‚úã</a></li><li><a href=#shortening-a-url aria-label="Shortening a URL">Shortening a URL</a></li><li><a href=#fetching-a-shortened-url- aria-label="Fetching a shortened URL üîó">Fetching a shortened URL üîó</a></li></ul></li><li><a href=#more-configurations- aria-label="More configurations üéõ">More configurations üéõ</a><ul><li><a href=#naming-the-server- aria-label="Naming the server üì¢">Naming the server üì¢</a></li></ul></li><li><a href=#outro- aria-label="Outro üññ">Outro üññ</a></li></ul></div></details></div><div class=post-content><p>Looking at any programming language you will (hopefully!) find a rich and
useful standard library. I started my professional career as a software
developer with Ruby, which has quite an easy-to-use and well-documented
standard library with a plethora of modules and classes to use. Personally, I
find the <code>Enumerable</code> module in Ruby with all its nice methods simply
brilliant.</p><p>You might be coming from a different language, but I am sure that any serious
programming language out there has a set of classes, modules, methods and
functions to make your life (and work) easy.</p><p>So, what about Elixirs stdlib?</p><p>No surprise there too ‚Äì Elixir has a well-documented and easy-to-use standard
library. But, because it works on top of the BEAM virtual machine and inherits
plenty from Erlang&rsquo;s rich history, it also has a bit more ‚Äì something called
<em>OTP</em>.</p><p><img loading=lazy src=/mario-caruso-770233-unsplash.jpg alt>
Photo by Mario Caruso on Unsplash</p><h2 id=meet-otp->Meet OTP üëã<a hidden class=anchor aria-hidden=true href=#meet-otp->#</a></h2><p>From
<a href=https://en.wikipedia.org/wiki/Open_Telecom_Platform>Wikipedia&rsquo;s article on OTP</a>:</p><blockquote><p>OTP is a collection of useful middleware, libraries, and tools written in the
Erlang programming language. It is an integral part of the open-source
distribution of Erlang. The name OTP was originally an acronym for Open
Telecom Platform, which was a branding attempt before Ericsson released
Erlang/OTP as open source. However, neither Erlang nor OTP is specific to
telecom applications.</p></blockquote><p>In continuation, it states:</p><blockquote><p>It (OTP) contains:</p><ul><li>an Erlang interpreter (called BEAM);</li><li>an Erlang compiler;</li><li>a protocol for communication between servers (nodes);</li><li>a CORBA Object Request Broker;</li><li>a static analysis tool called Dialyzer;</li><li>a distributed database server (Mnesia); and</li><li>many other libraries.</li></ul></blockquote><p>While I do not consider myself an expert in Elixir, Erlang, the BEAM or OTP by
any stretch of the imagination, I would like to take you on a journey to one of
the most useful and well-known <em>behaviours</em> of OTP ‚Äì <code>GenServer</code>.</p><figure class=imagecaption><img class=caption src=/jon-flobrant-225260-unsplash.jpg caption alt>
<span class=caption-text style="font-size:.75em;display:table;margin:0 auto 1.5em"></span></figure><p>In continuation, we will use BEAM processes, so if you&rsquo;re not familiar with
spawning new processes, sending and receiving messages to/from them, then it&rsquo;s
best to head over to &ldquo;<a href=/understanding-basics-elixir-concurrency-model>Understanding the basics of Elixir&rsquo;s concurrency
model</a>&rdquo; and give it a quick
read. It will help you understand processes and concurrency in Elixir so you
can apply the knowledge in the project that we work on in this article. I
promise.</p><h2 id=shortening-a-link->Shortening a link ‚úÇÔ∏è<a hidden class=anchor aria-hidden=true href=#shortening-a-link->#</a></h2><p>Let&rsquo;s write a URL shortener module that will run in a BEAM process and can
receive multiple commands:</p><ul><li><code>shorten</code> ‚Äì takes a link, shortens it and returns the short link as a response</li><li><code>get</code> ‚Äì take a short link and return the original one</li><li><code>flush</code> ‚Äì erase the URL shortener memory</li><li><code>stop</code> ‚Äì stop the process</li></ul><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#0087ff>defmodule</span> <span style=color:#0087ff>URLShortener</span> <span style=color:#5f8700>do</span>
  <span style=color:#0087ff>def</span> start <span style=color:#5f8700>do</span>
    spawn(__MODULE__, <span style=color:#00afaf>:loop</span>, [%{}])
  <span style=color:#5f8700>end</span>

  <span style=color:#0087ff>def</span> loop(state) <span style=color:#5f8700>do</span>
    <span style=color:#5f8700>receive</span> <span style=color:#5f8700>do</span>
      {<span style=color:#00afaf>:stop</span>, caller} -&gt;
        send caller, <span style=color:#00afaf>&#34;Shutting down.&#34;</span>
      {<span style=color:#00afaf>:shorten</span>, url, caller} -&gt;
        url_md5 = md5(url)
        new_state = <span style=color:#0087ff>Map</span>.put(state, url_md5, url)
        send caller, url_md5
        loop(new_state)
      {<span style=color:#00afaf>:get</span>, md5, caller} -&gt;
        send caller, <span style=color:#0087ff>Map</span>.fetch(state, md5)
        loop(state)
      <span style=color:#00afaf>:flush</span> -&gt;
        loop(%{})
      _ -&gt;
        loop(state)
    <span style=color:#5f8700>end</span>
  <span style=color:#5f8700>end</span>

  <span style=color:#0087ff>defp</span> md5(url) <span style=color:#5f8700>do</span>
    <span style=color:#00afaf>:crypto</span>.hash(<span style=color:#00afaf>:md5</span>, url)
    |&gt; <span style=color:#0087ff>Base</span>.encode16(<span style=color:#00afaf>case</span>: <span style=color:#00afaf>:lower</span>)
  <span style=color:#5f8700>end</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>What the module does is when the process starts it will recursively call the
<code>URLShortener.loop/1</code> function, until it receives the <code>{:stop, caller}</code>
message.</p><p>If we zoom into the <code>{:shorten, url, caller}</code> case we notice that we generate a
<code>MD5</code> digest from the URL and then we update the <code>state</code> map which creates a
new map (called <code>new_state</code>). Once we get the digest we store it in a map with
the key being the MD5 and the value is the actual URL. The <code>state</code> map will
look like:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir>%{
  <span style=color:#00afaf>&#34;99999ebcfdb78df077ad2727fd00969f&#34;</span> =&gt; <span style=color:#00afaf>&#34;https://google.com&#34;</span>,
  <span style=color:#00afaf>&#34;76100d6f27db53fddb6c8fce320f5d21&#34;</span> =&gt; <span style=color:#00afaf>&#34;https://elixir-lang.org&#34;</span>,
  <span style=color:#00afaf>&#34;3097fca9b1ec8942c4305e550ef1b50a&#34;</span> =&gt; <span style=color:#00afaf>&#34;https://github.com&#34;</span>,
  ...
}</code></pre></td></tr></table></div></div><p>Then, we send the MD5 value back to the caller. Obviously, this is not how
bit.ly or the likes work, as their links are much shorter. (For those
interested,
<a href=https://stackoverflow.com/questions/742013/how-do-i-create-a-url-shortener>here&rsquo;s</a>
an interesting discussion on the topic). However, for the purpose of this
article, we&rsquo;ll stick to simple MD5 digest of the URL.</p><p>The other two commands, <code>get</code> and <code>flush</code>, are pretty simple. <code>get</code> returns
only a single value from the <code>state</code> map, while <code>flush</code> invokes <code>loop/1</code> with
an empty map, effectively removing all the shortened links from the process'
state (memory).</p><p>Let&rsquo;s run our shortener in an <code>IEx</code> session:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">38
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir>iex(<span style=color:#00afaf>22</span>)&gt; shortener = <span style=color:#0087ff>URLShortener</span>.start
<span style=color:#4e4e4e>#PID&lt;0.141.0&gt;</span>

iex(<span style=color:#00afaf>23</span>)&gt; send shortener, {<span style=color:#00afaf>:shorten</span>, <span style=color:#00afaf>&#34;https://ieftimov.com&#34;</span>, self()}
{<span style=color:#00afaf>:shorten</span>, <span style=color:#00afaf>&#34;https://ieftimov.com&#34;</span>, <span style=color:#4e4e4e>#PID&lt;0.102.0&gt;}</span>

iex(<span style=color:#00afaf>24</span>)&gt; send shortener, {<span style=color:#00afaf>:shorten</span>, <span style=color:#00afaf>&#34;https://google.com&#34;</span>, self()}
{<span style=color:#00afaf>:shorten</span>, <span style=color:#00afaf>&#34;https://google.com&#34;</span>, <span style=color:#4e4e4e>#PID&lt;0.102.0&gt;}</span>

iex(<span style=color:#00afaf>25</span>)&gt; send shortener, {<span style=color:#00afaf>:shorten</span>, <span style=color:#00afaf>&#34;https://github.com&#34;</span>, self()}
{<span style=color:#00afaf>:shorten</span>, <span style=color:#00afaf>&#34;https://github.com&#34;</span>, <span style=color:#4e4e4e>#PID&lt;0.102.0&gt;}</span>

iex(<span style=color:#00afaf>26</span>)&gt; flush
<span style=color:#00afaf>&#34;8c4c7fbc57b08d379da5b1312690be04&#34;</span>
<span style=color:#00afaf>&#34;99999ebcfdb78df077ad2727fd00969f&#34;</span>
<span style=color:#00afaf>&#34;3097fca9b1ec8942c4305e550ef1b50a&#34;</span>
<span style=color:#00afaf>:ok</span>

iex(<span style=color:#00afaf>27</span>)&gt; send shortener, {<span style=color:#00afaf>:get</span>, <span style=color:#00afaf>&#34;99999ebcfdb78df077ad2727fd00969f&#34;</span>, self()}
{<span style=color:#00afaf>:get</span>, <span style=color:#00afaf>&#34;99999ebcfdb78df077ad2727fd00969f&#34;</span>, <span style=color:#4e4e4e>#PID&lt;0.102.0&gt;}</span>

iex(<span style=color:#00afaf>28</span>)&gt; flush
<span style=color:#00afaf>&#34;https://google.com&#34;</span>
<span style=color:#00afaf>:ok</span>

iex(<span style=color:#00afaf>29</span>)&gt; send shortener, {<span style=color:#00afaf>:get</span>, <span style=color:#00afaf>&#34;8c4c7fbc57b08d379da5b1312690be04&#34;</span>, self()}
{<span style=color:#00afaf>:get</span>, <span style=color:#00afaf>&#34;8c4c7fbc57b08d379da5b1312690be04&#34;</span>, <span style=color:#4e4e4e>#PID&lt;0.102.0&gt;}</span>

iex(<span style=color:#00afaf>30</span>)&gt; flush
<span style=color:#00afaf>&#34;https://ieftimov.com&#34;</span>
<span style=color:#00afaf>:ok</span>

iex(<span style=color:#00afaf>31</span>)&gt; send shortener, {<span style=color:#00afaf>:get</span>, <span style=color:#00afaf>&#34;3097fca9b1ec8942c4305e550ef1b50a&#34;</span>, self()}
{<span style=color:#00afaf>:get</span>, <span style=color:#00afaf>&#34;3097fca9b1ec8942c4305e550ef1b50a&#34;</span>, <span style=color:#4e4e4e>#PID&lt;0.102.0&gt;}</span>

iex(<span style=color:#00afaf>32</span>)&gt; flush
<span style=color:#00afaf>&#34;https://github.com&#34;</span>
<span style=color:#00afaf>:ok</span></code></pre></td></tr></table></div></div><p>Working as expected ‚Äì we send three different URLs for shortening, we receive
their MD5 digests back in the process mailbox and when we query for them we get
each of them back.</p><p>Although our <code>URLShortener</code> module works pretty neatly now, it actually lacks
quite a bit of functionality. Sure, it does handle the happy path really well,
but when it comes to error handling, tracing or error reporting it falls really
short. Additionally, it does not have a standard interface to add more
functions to the process ‚Äì we sort of came up with it as we went on.</p><p>After reading all of that you&rsquo;re probably thinking there is a better way to do
this. And you&rsquo;d be right to think so ‚Äì let&rsquo;s learn more about <code>GenServer</code>s.</p><h2 id=enter-genserver->Enter GenServer üö™<a hidden class=anchor aria-hidden=true href=#enter-genserver->#</a></h2><p><code>GenServer</code> is an <em>OTP behaviour</em>. Behaviour in this context refers to three
things:</p><ul><li>an interface, which is a set of functions;</li><li>an implementation, which is the application-specific code, and</li><li>the container, which is a BEAM process</li></ul><p>This means that a module can implement a certain group of functions (interface
or signatures), that under the hood implement some callback functions (which
are specific to the behaviour you work on), that are run within a BEAM process.</p><p>For example, <code>GenServer</code> is a <strong>gen</strong>eric <strong>server</strong> behaviour ‚Äì it expects for
each of the functions defined in it&rsquo;s interface a set of callbacks which will
handle the requests to the server. This means that the interface functions will
be used by the clients of the generic server, a.k.a. the client API, while the
callbacks defined will essentially be the server internals (&ldquo;the backend&rdquo;).</p><p>So, how does a <code>GenServer</code> work? Well, as you can imagine we cannot go too deep
on the hows of <code>GenServer</code>, but we need to get a good grasp on some basics:</p><ol><li>Server start & state</li><li>Asynchronous messages</li><li>Synchronous messages</li></ol><h3 id=server-start--state>Server start & state<a hidden class=anchor aria-hidden=true href=#server-start--state>#</a></h3><p>Just like with our <code>URLShortener</code> we implemented, every <code>GenServer</code> is capable
of holding state. In fact, <code>GenServer</code>s must implement a <code>init/1</code> function,
which will set the initial state of the server (see the <code>init/1</code> documentation
<a href=https://hexdocs.pm/elixir/GenServer.html#c:init/1>here</a> for more details).</p><p>To start the server we can run:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#0087ff>GenServer</span>.start_link(__MODULE__, <span style=color:#00afaf>:ok</span>, [])</code></pre></td></tr></table></div></div><p><code>GenServer.start_link/3</code> will invoke the <code>init/1</code> function of the <code>__MODULE__</code>,
passing in <code>:ok</code> as an argument to <code>init/1</code>. This function call will block
until <code>init/1</code> returns, so usually in this function, we do any required setup
of the server process (that might be needed). For example, in our case, to
rebuild <code>URLShortener</code> using a <code>GenServer</code> behaviour, we will need an <code>init/1</code>
function to set the initial state (empty map) of the server:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#0087ff>def</span> init(<span style=color:#00afaf>:ok</span>) <span style=color:#5f8700>do</span>
  {<span style=color:#00afaf>:ok</span>, %{}}
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>That&rsquo;s all. <code>start_link/3</code> will call <code>init/1</code> with the <code>:ok</code> argument, which
will return an <code>:ok</code> and set the state of the process to an empty map.</p><h3 id=sync--async-messages->Sync & async messages üì®<a hidden class=anchor aria-hidden=true href=#sync--async-messages->#</a></h3><p>As most servers out there, <code>GenServer</code>s can also receive and reply to requests
(if needed). As the heading suggests, there are two types of requests that
<code>GenServers</code> handle ‚Äì the ones expect a response (<code>call</code>) and the others that
don&rsquo;t (<code>cast</code>). Therefore, <code>GenServer</code>s define two callback functions -
<code>handle_call/3</code> and <code>handle_cast/2</code>.</p><p>We will look at these functions in more depth a bit later.</p><h2 id=reimplementing-urlshortener-using-genserver->Reimplementing <code>URLShortener</code>, using <code>GenServer</code> ‚ôªÔ∏è<a hidden class=anchor aria-hidden=true href=#reimplementing-urlshortener-using-genserver->#</a></h2><p>Let&rsquo;s look at how we can flip the implementation to use <code>GenServer</code>.</p><p>First, let&rsquo;s add the shell of the module, the <code>start_link/1</code> function and the
<code>init/1</code> function that <code>start_link/1</code> will invoke:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#0087ff>defmodule</span> <span style=color:#0087ff>URLShortener</span> <span style=color:#5f8700>do</span>
  <span style=color:#d75f00>use</span> <span style=color:#0087ff>GenServer</span>

  <span style=color:#0087ff>def</span> start_link(opts \\ []) <span style=color:#5f8700>do</span>
    <span style=color:#0087ff>GenServer</span>.start_link(__MODULE__, <span style=color:#00afaf>:ok</span>, opts)
  <span style=color:#5f8700>end</span>

  <span style=color:#0087ff>def</span> init(<span style=color:#00afaf>:ok</span>) <span style=color:#5f8700>do</span>
    {<span style=color:#00afaf>:ok</span>, %{}}
  <span style=color:#5f8700>end</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>The notable changes here are the <code>use</code> of the <code>GenServer</code> behaviour in the
module, the <code>start_link/1</code> function which invokes <code>GenServer.start_link/3</code> which
would, in fact, call the <code>init/1</code> function with the <code>:ok</code> atom as an argument.
Also, it&rsquo;s worth noting that the empty map that the <code>init/1</code> function returns in
the tuple is the actual initial state of the <code>URLShortener</code> process.</p><p>Let&rsquo;s give it a spin in <code>IEx</code>:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir>iex(<span style=color:#00afaf>1</span>)&gt; {<span style=color:#00afaf>:ok</span>, pid} = <span style=color:#0087ff>URLShortener</span>.start_link
{<span style=color:#00afaf>:ok</span>, <span style=color:#4e4e4e>#PID&lt;0.108.0&gt;}</span></code></pre></td></tr></table></div></div><p>That&rsquo;s all we can do at this moment. The difference here is that the
<code>GenServer.start_link/3</code> function will return a tuple with an atom (<code>:ok</code>) and
the PID of the server.</p><h3 id=stopping-the-server->Stopping the server ‚úã<a hidden class=anchor aria-hidden=true href=#stopping-the-server->#</a></h3><p>Let&rsquo;s add the <code>stop</code> command:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#0087ff>defmodule</span> <span style=color:#0087ff>URLShortener</span> <span style=color:#5f8700>do</span>
  <span style=color:#d75f00>use</span> <span style=color:#0087ff>GenServer</span>

  <span style=color:#4e4e4e># Client API</span>
  <span style=color:#0087ff>def</span> start_link(opts \\ []), <span style=color:#00afaf>do</span>: <span style=color:#0087ff>GenServer</span>.start_link(__MODULE__, <span style=color:#00afaf>:ok</span>, opts)

  <span style=color:#0087ff>def</span> stop(pid) <span style=color:#5f8700>do</span>
    <span style=color:#0087ff>GenServer</span>.cast(pid, <span style=color:#00afaf>:stop</span>)
  <span style=color:#5f8700>end</span>

  <span style=color:#4e4e4e># GenServer callbacks</span>
  <span style=color:#0087ff>def</span> init(<span style=color:#00afaf>:ok</span>), <span style=color:#00afaf>do</span>: {<span style=color:#00afaf>:ok</span>, %{}}

  <span style=color:#0087ff>def</span> handle_cast(<span style=color:#00afaf>:stop</span>, state) <span style=color:#5f8700>do</span>
    {<span style=color:#00afaf>:stop</span>, <span style=color:#00afaf>:normal</span>, state}
  <span style=color:#5f8700>end</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>Yes, I know I said we&rsquo;ll add one command but ended up adding two functions:
<code>stop/1</code> and <code>handle_cast/2</code>. Bear with me now:</p><p>Because we do not want to get a response back on the <code>stop</code> command, we will use
<code>GenServer.cast/2</code> in the <code>stop/1</code> function. This means that when that command
is called by the client (user) of the server, the <code>handle_cast/2</code> callback will
be triggered on the server. In our case, the <code>handle_cast/2</code> function will return
a tuple of three items ‚Äì <code>{:stop, :normal, state}</code>.</p><p>Returning this tuple stops the loop and another callback called <code>terminate/2</code> is
called (which is defined in the behaviour but not implemented by <code>URLShortener</code>)
with the reason <code>:normal</code> and state <code>state</code>. The process will exit with reason
<code>:normal</code>.</p><p>This way of working with <code>GenServer</code> allows us to only define callbacks and
the <code>GenServer</code> behaviour will know how to handle the rest. The only complexity
resides in the fact that we need to understand and know most types of returns
that the callback functions can have.</p><p>Another thing worth pointing out is that each function that will be used by
the client will take a <code>PID</code> as a first argument. This will allow us to send
messages to the correct <code>GenServer</code> process. Going forward we will not
acknowledge <code>PID</code>s presence ‚Äì we accept that it&rsquo;s mandatory for our
<code>URLShortener</code> to work. Later we will look at ways we can skip passing the
<code>PID</code>s as arguments.</p><p>Let&rsquo;s jump back in <code>IEx</code> and start and stop a <code>URLShortener</code> server:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir>iex(<span style=color:#00afaf>1</span>)&gt; {<span style=color:#00afaf>:ok</span>, pid} = <span style=color:#0087ff>URLShortener</span>.start_link
{<span style=color:#00afaf>:ok</span>, <span style=color:#4e4e4e>#PID&lt;0.109.0&gt;}</span>

iex(<span style=color:#00afaf>2</span>)&gt; <span style=color:#0087ff>Process</span>.alive?(pid)
<span style=color:#d75f00>true</span>

iex(<span style=color:#00afaf>3</span>)&gt; <span style=color:#0087ff>URLShortener</span>.stop(pid)
<span style=color:#00afaf>:ok</span>

iex(<span style=color:#00afaf>4</span>)&gt; <span style=color:#0087ff>Process</span>.alive?(pid)
<span style=color:#d75f00>false</span></code></pre></td></tr></table></div></div><p>That&rsquo;s starting and stopping in all of it&rsquo;s glory.</p><h3 id=shortening-a-url>Shortening a URL<a hidden class=anchor aria-hidden=true href=#shortening-a-url>#</a></h3><p>Another thing we wanted our server to have is the ability to shorten URLs, by
using their MD5 digest as the short variant of the URL. Let&rsquo;s do that using
<code>GenServer</code>:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#0087ff>defmodule</span> <span style=color:#0087ff>URLShortener</span> <span style=color:#5f8700>do</span>
  <span style=color:#d75f00>use</span> <span style=color:#0087ff>GenServer</span>

  <span style=color:#4e4e4e># Client API</span>
  <span style=color:#0087ff>def</span> start_link(opts \\ []), <span style=color:#00afaf>do</span>: <span style=color:#0087ff>GenServer</span>.start_link(__MODULE__, <span style=color:#00afaf>:ok</span>, opts)
  <span style=color:#0087ff>def</span> stop(pid), <span style=color:#00afaf>do</span>: <span style=color:#0087ff>GenServer</span>.cast(pid, <span style=color:#00afaf>:stop</span>)

  <span style=color:#0087ff>def</span> shorten(pid, url) <span style=color:#5f8700>do</span>
    <span style=color:#0087ff>GenServer</span>.call(pid, {<span style=color:#00afaf>:shorten</span>, url})
  <span style=color:#5f8700>end</span>

  <span style=color:#4e4e4e># GenServer callbacks</span>
  <span style=color:#0087ff>def</span> init(<span style=color:#00afaf>:ok</span>), <span style=color:#00afaf>do</span>: {<span style=color:#00afaf>:ok</span>, %{}}
  <span style=color:#0087ff>def</span> handle_cast(<span style=color:#00afaf>:stop</span>, state), <span style=color:#00afaf>do</span>: {<span style=color:#00afaf>:stop</span>, <span style=color:#00afaf>:normal</span>, state}

  <span style=color:#0087ff>def</span> handle_call({<span style=color:#00afaf>:shorten</span>, url}, _from, state) <span style=color:#5f8700>do</span>
    short = md5(url)
    {<span style=color:#00afaf>:reply</span>, short, <span style=color:#0087ff>Map</span>.put(state, short, url)}
  <span style=color:#5f8700>end</span>

  <span style=color:#0087ff>defp</span> md5(url) <span style=color:#5f8700>do</span>
    <span style=color:#00afaf>:crypto</span>.hash(<span style=color:#00afaf>:md5</span>, url)
    |&gt; <span style=color:#0087ff>Base</span>.encode16(<span style=color:#00afaf>case</span>: <span style=color:#00afaf>:lower</span>)
  <span style=color:#5f8700>end</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>Three functions this time, but at least the <code>md5/1</code> is a replica of the one we
had previously. So, let&rsquo;s look at the other two.</p><p>You might be seeing a pattern - we have a function that will be used by the
client (<code>shorten/2</code>) and a callback that will be invoked on the server
(<code>handle_call/3</code>). This time, there&rsquo;s a slight difference in the functions used
and naming: in <code>shorten/2</code> we call <code>GenServer.call/2</code> instead of <code>cast/2</code>, and
the callback name is <code>handle_call/3</code> instead of <code>handle_cast/2</code>.</p><p>Why? Well, the difference lies in the response - <code>handle_call/3</code> will send a
reply back to the client (hence the <code>:reply</code> atom in the response tuple), while
<code>handle_cast/2</code> does not do that. Basically <code>cast</code>ing is an async call where the
client does not expect a response, while <code>call</code>ing is a sync call where the
response is expected.</p><p>So, let&rsquo;s look at the structure of the <code>handle_call/3</code> callback.</p><p>It takes three arguments: the request from the client (in our case a tuple), a
tuple describing the client of the request (which we ignore), and the state of
the server (in our case a map).</p><p>As a response, it returns a tuple with <code>:reply</code>, stating that there will be a
reply to the request, the reply itself (in our case the <code>short</code>ened link) and
the <code>state</code> which is the state carried over to the next loop of the server.</p><p>Of course, <code>handle_call/3</code> has a bit more intricacies that we will look into
later, but you can always check it&rsquo;s
<a href=https://hexdocs.pm/elixir/GenServer.html#c:handle_call/3>documentation</a> to
learn more.</p><h3 id=fetching-a-shortened-url->Fetching a shortened URL üîó<a hidden class=anchor aria-hidden=true href=#fetching-a-shortened-url->#</a></h3><p>Let&rsquo;s implement the <code>get</code> command, which when provided with a <code>short</code> version of
the link it will return the full URL:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#0087ff>defmodule</span> <span style=color:#0087ff>URLShortener</span> <span style=color:#5f8700>do</span>
  <span style=color:#d75f00>use</span> <span style=color:#0087ff>GenServer</span>

  <span style=color:#4e4e4e># Client API</span>
  <span style=color:#4e4e4e># ...</span>

  <span style=color:#0087ff>def</span> get(pid, short_link) <span style=color:#5f8700>do</span>
    <span style=color:#0087ff>GenServer</span>.call(pid, {<span style=color:#00afaf>:get</span>, short_link})
  <span style=color:#5f8700>end</span>

  <span style=color:#4e4e4e># GenServer callbacks</span>
  <span style=color:#4e4e4e># ...</span>

  <span style=color:#0087ff>def</span> handle_call({<span style=color:#00afaf>:get</span>, short_link}, _from, state) <span style=color:#5f8700>do</span>
    {<span style=color:#00afaf>:reply</span>, <span style=color:#0087ff>Map</span>.get(state, short_link), state}
  <span style=color:#5f8700>end</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>The double-function entry pattern again - we add <code>URLShortener.get/2</code> and
another head of the <code>URLShortener.handle_call/3</code> function.</p><p>The <code>URLShortener.get/2</code> will call <code>GenServer.call/2</code> under the hood, which when
executed will cause the <code>handle_call/3</code> callback to fire.</p><p>The <code>URLShortener.handle_call/3</code> this time will take the command (<code>:get</code>) and
the <code>short_link</code> as the first argument. Looking inside we see that, again, it&rsquo;s
a short function - it only returns a tuple with <code>:reply</code> (which states that the
call will have a reply), a call to <code>Map.get/2</code>, whose return will be the actual
response of the call, and the <code>state</code>, so the <code>GenServer</code> process maintains the
state in the next loop.</p><p>At this moment, we can safely say that we have a good idea of the basics on
writing functionality for a module that implements the <code>GenServer</code> behaviour.
As you might be thinking, there&rsquo;s much to explore, but these basics will allow
you to create <code>GenServer</code>s and experiment.</p><p>Before you go on, try to implement two more commands:</p><ul><li><code>flush</code> ‚Äì an async call which will erase the state of the server</li><li><code>count</code> ‚Äì a sync call returning the number of links in the server&rsquo;s state</li></ul><h2 id=more-configurations->More configurations üéõ<a hidden class=anchor aria-hidden=true href=#more-configurations->#</a></h2><p>If we circle back to <code>URLShortener.start_link/1</code> and it&rsquo;s internals (namely the
invocation of <code>GenServer.start_link/3</code>), we will also notice that we can pass
options (<code>opts</code>) to the <code>GenServer.start_link/3</code> function, that are defaulted to
an empty list (<code>[]</code>).</p><p>What are the options that we can add here? By looking at
<a href=https://hexdocs.pm/elixir/GenServer.html#start_link/3>the documentation</a> of
<code>GenServer.start_link/3</code> you&rsquo;ll notice multiple interesting options:</p><ul><li><code>:name</code> - used for name registration. This means that instead of identifying
a <code>GenServer</code> by <code>PID</code>, we can put a name on it.</li><li><code>:timeout</code> - sets the server startup timeout (in milliseconds)</li><li><code>:debug</code> - enables debugging by invoking the corresponding function in the
<code>:sys</code> module</li><li><code>:hibernate_after</code> - sets the time (in milliseconds) after which the server
process will go into hibernation automatically until a new request comes in.
This is done by utilising <code>:proc_lib.hibernate/3</code></li><li><code>:spawn_opt</code> - enables passing more options to the underlying process</li></ul><p>Most of these are advanced and are beyond our use-case here. However, there&rsquo;s
one configuration we could use right now: <code>:name</code>.</p><h3 id=naming-the-server->Naming the server üì¢<a hidden class=anchor aria-hidden=true href=#naming-the-server->#</a></h3><p>Let&rsquo;s modify our <code>URLShortener</code> to take a <code>name</code> in it&rsquo;s <code>start_link/1</code> function
and test it in <code>IEx</code>. Additionally, since every <code>URLShortener</code> process will have
a name, we can refer to the process by name instead of <code>PID</code> - let&rsquo;s see how that
would work in code:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>defmodule URLShortener do
  use GenServer

  # Client API
  def <span style=color:#0087ff>start_link</span>(name, opts \\ []) do
    GenServer.<span style=color:#0087ff>start_link</span>(__MODULE__, :ok, opts ++ [name: name])
  end

  def <span style=color:#0087ff>stop</span>(name), do: GenServer.<span style=color:#0087ff>cast</span>(name, :stop)
  def <span style=color:#0087ff>shorten</span>(name, url), do: GenServer.<span style=color:#0087ff>call</span>(name, {:shorten, url})

  def <span style=color:#0087ff>get</span>(name, short_link) do
    GenServer.<span style=color:#0087ff>call</span>(name, {:get, short_link})
  end

  # GenServer callbacks
  def <span style=color:#0087ff>init</span>(:ok), do: {:ok, %{}}
  def <span style=color:#0087ff>handle_cast</span>(:stop, state), do: {:stop, :normal, state}
  def <span style=color:#0087ff>handle_call</span>({:shorten, url}, _from, state), do: {:reply, <span style=color:#0087ff>md5</span>(url), Map.<span style=color:#0087ff>put</span>(state, <span style=color:#0087ff>md5</span>(url), url)}

  def <span style=color:#0087ff>handle_call</span>({:get, short_link}, _from, state) do
    {:reply, Map.<span style=color:#0087ff>get</span>(state, short_link), state}
  end

  defp <span style=color:#0087ff>md5</span>(url), do: :crypto.<span style=color:#0087ff>hash</span>(:md5, url) |&gt; Base.<span style=color:#0087ff>encode16</span>(<span style=color:#5f8700>case</span>: :lower)
end</code></pre></td></tr></table></div></div><p>That&rsquo;s all. We added a new argument to <code>URLShortener.start_link/2</code> and we dropped
all usage of <code>PID</code> and replaced it with <code>name</code>.</p><p>Let&rsquo;s take it for a spin in <code>IEx</code>:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir>iex(<span style=color:#00afaf>1</span>)&gt; {<span style=color:#00afaf>:ok</span>, pid} = <span style=color:#0087ff>URLShortener</span>.start_link(<span style=color:#00afaf>:foo</span>)
{<span style=color:#00afaf>:ok</span>, <span style=color:#4e4e4e>#PID&lt;0.109.0&gt;}</span>

iex(<span style=color:#00afaf>2</span>)&gt; <span style=color:#0087ff>URLShortener</span>.shorten(<span style=color:#00afaf>:foo</span>, <span style=color:#00afaf>&#34;https://google.com&#34;</span>)
<span style=color:#00afaf>&#34;99999ebcfdb78df077ad2727fd00969f&#34;</span>

iex(<span style=color:#00afaf>3</span>)&gt; <span style=color:#0087ff>URLShortener</span>.get(<span style=color:#00afaf>:foo</span>, <span style=color:#00afaf>&#34;99999ebcfdb78df077ad2727fd00969f&#34;</span>)
<span style=color:#00afaf>&#34;https://google.com&#34;</span>

iex(<span style=color:#00afaf>4</span>)&gt; <span style=color:#0087ff>URLShortener</span>.stop(<span style=color:#00afaf>:foo</span>)
<span style=color:#00afaf>:ok</span>

iex(<span style=color:#00afaf>5</span>)&gt; <span style=color:#0087ff>Process</span>.alive?(pid)
<span style=color:#d75f00>false</span></code></pre></td></tr></table></div></div><p>You can see that this is pretty cool - instead of using <code>PID</code> we added a name
<code>:foo</code> to the process which allowed us to refer to it using the name instead of
the <code>PID</code>. Obviously, you can see that to inspect the BEAM process in any
fashion we will still need the <code>PID</code>, but for the client the <code>name</code> does the
trick.</p><p>This combination of name and <code>PID</code> allows us to have reference to the BEAM
process while improving the ease of use for the client.</p><p>If we would like to simplify things even more, we can turn the <code>URLShortener</code>
into a &ldquo;singleton&rdquo; server. Before you freak out - it has none of the drawbacks
that the <a href=/singleton-pattern>singleton pattern</a> that&rsquo;s infamous in OO
programming has. We&rsquo;re merely stating that we could change the <code>URLShortener</code>
to have one and only one process running at a certain time, by setting a static
name to it:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#0087ff>defmodule</span> <span style=color:#0087ff>URLShortener</span> <span style=color:#5f8700>do</span>
  <span style=color:#d75f00>use</span> <span style=color:#0087ff>GenServer</span>

  @name <span style=color:#00afaf>:url_shortener_server</span>

  <span style=color:#4e4e4e># Client API</span>
  <span style=color:#0087ff>def</span> start_link(opts \\ []) <span style=color:#5f8700>do</span>
    <span style=color:#0087ff>GenServer</span>.start_link(__MODULE__, <span style=color:#00afaf>:ok</span>, opts ++ [<span style=color:#00afaf>name</span>: @name])
  <span style=color:#5f8700>end</span>

  <span style=color:#0087ff>def</span> stop, <span style=color:#00afaf>do</span>: <span style=color:#0087ff>GenServer</span>.cast(@name, <span style=color:#00afaf>:stop</span>)
  <span style=color:#0087ff>def</span> shorten(url), <span style=color:#00afaf>do</span>: <span style=color:#0087ff>GenServer</span>.call(@name, {<span style=color:#00afaf>:shorten</span>, url})

  <span style=color:#0087ff>def</span> get(short_link) <span style=color:#5f8700>do</span>
    <span style=color:#0087ff>GenServer</span>.call(@name, {<span style=color:#00afaf>:get</span>, short_link})
  <span style=color:#5f8700>end</span>

  <span style=color:#4e4e4e># GenServer callbacks</span>
  <span style=color:#4e4e4e># ...</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>You can notice that we added a module attribute <code>@name</code> that holds the name of
the process. In all the functions from the client API, we dropped the <code>name</code>
from the arguments lists and we simply use <code>@name</code> as a reference to the
process. This means that there&rsquo;s going to be only one process for
<code>URLShortener</code> with the name <code>:url_shortener_server</code>.</p><p>Let&rsquo;s take it for a spin in <code>IEx</code>:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir>iex(<span style=color:#00afaf>1</span>)&gt; {<span style=color:#00afaf>:ok</span>, pid} = <span style=color:#0087ff>URLShortener</span>.start_link
{<span style=color:#00afaf>:ok</span>, <span style=color:#4e4e4e>#PID&lt;0.108.0&gt;}</span>

iex(<span style=color:#00afaf>2</span>)&gt; <span style=color:#0087ff>URLShortener</span>.shorten(<span style=color:#00afaf>&#34;https://google.com&#34;</span>)
<span style=color:#00afaf>&#34;99999ebcfdb78df077ad2727fd00969f&#34;</span>

iex(<span style=color:#00afaf>3</span>)&gt; <span style=color:#0087ff>URLShortener</span>.shorten(<span style=color:#00afaf>&#34;https://yahoo.com&#34;</span>)
<span style=color:#00afaf>&#34;c88f320dec138ba5ab0a5f990ff082ba&#34;</span>

iex(<span style=color:#00afaf>4</span>)&gt; <span style=color:#0087ff>URLShortener</span>.get(<span style=color:#00afaf>&#34;99999ebcfdb78df077ad2727fd00969f&#34;</span>)
<span style=color:#00afaf>&#34;https://google.com&#34;</span>

iex(<span style=color:#00afaf>5</span>)&gt; <span style=color:#0087ff>URLShortener</span>.stop
<span style=color:#00afaf>:ok</span>

iex(<span style=color:#00afaf>6</span>)&gt; <span style=color:#0087ff>Process</span>.alive?(pid)
<span style=color:#d75f00>false</span></code></pre></td></tr></table></div></div><p>You can notice that although we captured the <code>PID</code> on the first line, we do not
need it at all - all of the work is done for us by <code>URLShortener</code>.</p><p>In this section, you saw how you can utilise names to more easily work with
processes. Let&rsquo;s review our full implementation of the <code>URLShortener</code> module.</p><h2 id=outro->Outro üññ<a hidden class=anchor aria-hidden=true href=#outro->#</a></h2><p>Before we wrap up this long tutorial, let&rsquo;s have a final look at our new
<code>URLShortener</code> module, including the <code>count/1</code> and <code>flush/1</code> functions:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">61
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#0087ff>defmodule</span> <span style=color:#0087ff>URLShortener</span> <span style=color:#5f8700>do</span>
  <span style=color:#d75f00>use</span> <span style=color:#0087ff>GenServer</span>

  <span style=color:#4e4e4e># Client API</span>
  <span style=color:#0087ff>def</span> start_link(name, opts \\ []) <span style=color:#5f8700>do</span>
    <span style=color:#0087ff>GenServer</span>.start_link(__MODULE__, <span style=color:#00afaf>:ok</span>, opts ++ [<span style=color:#00afaf>name</span>: name])
  <span style=color:#5f8700>end</span>

  <span style=color:#0087ff>def</span> shorten(name, url) <span style=color:#5f8700>do</span>
    <span style=color:#0087ff>GenServer</span>.call(name, {<span style=color:#00afaf>:shorten</span>, url})
  <span style=color:#5f8700>end</span>

  <span style=color:#0087ff>def</span> get(name, short) <span style=color:#5f8700>do</span>
    <span style=color:#0087ff>GenServer</span>.call(name, {<span style=color:#00afaf>:get</span>, short})
  <span style=color:#5f8700>end</span>

  <span style=color:#0087ff>def</span> flush(name) <span style=color:#5f8700>do</span>
    <span style=color:#0087ff>GenServer</span>.cast(name, <span style=color:#00afaf>:flush</span>)
  <span style=color:#5f8700>end</span>

  <span style=color:#0087ff>def</span> stop(name) <span style=color:#5f8700>do</span>
    <span style=color:#0087ff>GenServer</span>.cast(name, <span style=color:#00afaf>:stop</span>)
  <span style=color:#5f8700>end</span>

  <span style=color:#0087ff>def</span> count(name) <span style=color:#5f8700>do</span>
    <span style=color:#0087ff>GenServer</span>.call(name, <span style=color:#00afaf>:count</span>)
  <span style=color:#5f8700>end</span>

  <span style=color:#4e4e4e># Callbacks</span>
  <span style=color:#0087ff>def</span> init(<span style=color:#00afaf>:ok</span>) <span style=color:#5f8700>do</span>
    {<span style=color:#00afaf>:ok</span>, %{}}
  <span style=color:#5f8700>end</span>

  <span style=color:#0087ff>def</span> handle_cast(<span style=color:#00afaf>:flush</span>, _state) <span style=color:#5f8700>do</span>
    {<span style=color:#00afaf>:noreply</span>, %{}}
  <span style=color:#5f8700>end</span>

  <span style=color:#0087ff>def</span> handle_cast(<span style=color:#00afaf>:stop</span>, state) <span style=color:#5f8700>do</span>
    {<span style=color:#00afaf>:stop</span>, <span style=color:#00afaf>:normal</span>, state}
  <span style=color:#5f8700>end</span>

  <span style=color:#0087ff>def</span> handle_call({<span style=color:#00afaf>:shorten</span>, url}, _from, state) <span style=color:#5f8700>do</span>
    shortened = md5(url)
    new_state = <span style=color:#0087ff>Map</span>.put(state, shortened, url)
    {<span style=color:#00afaf>:reply</span>, shortened, new_state}
  <span style=color:#5f8700>end</span>

  <span style=color:#0087ff>def</span> handle_call({<span style=color:#00afaf>:get</span>, short}, _from, state) <span style=color:#5f8700>do</span>
    {<span style=color:#00afaf>:reply</span>, <span style=color:#0087ff>Map</span>.get(state, short), state}
  <span style=color:#5f8700>end</span>

  <span style=color:#0087ff>def</span> handle_call(<span style=color:#00afaf>:count</span>, _from, state) <span style=color:#5f8700>do</span>
    count = <span style=color:#0087ff>Map</span>.keys(state) |&gt; <span style=color:#0087ff>Enum</span>.count
    {<span style=color:#00afaf>:reply</span>, count, state}
  <span style=color:#5f8700>end</span>

  <span style=color:#0087ff>defp</span> md5(url) <span style=color:#5f8700>do</span>
    <span style=color:#00afaf>:crypto</span>.hash(<span style=color:#00afaf>:md5</span>, url)
    |&gt; <span style=color:#0087ff>Base</span>.encode16(<span style=color:#00afaf>case</span>: <span style=color:#00afaf>:lower</span>)
  <span style=color:#5f8700>end</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>The two callbacks are faily simple - <code>flush</code> will just send a <code>noreply</code> and set
the state to an empty map. <code>count</code> on the other hand will have a <code>reply</code> with
the count of the items of the map, which is simply the numbers of keys there
are in the <code>state</code> map. That&rsquo;s all.</p><p>While you got to the end of the article your journey with <code>GenServer</code> does not
end here. In fact, it just started. <code>GenServer</code>s and OTP are very powerful
tools that you can use to build generic servers that can live in small BEAM
processes and have a very generic approach to building functionality (calls and
callbacks).</p><p>While we did cover a lot of ground here we didn&rsquo;t touch on why we named the
starting function <code>start_link</code> instead of just <code>start</code> (hint: supervisors
convention), or how we would approach testing such a <code>GenServer</code> like
<code>URLShortener</code>.</p><p>In what kind of scenarios have you used <code>GenServers</code>? Or, if you do not have
experience with it, where do you see yourself using it in the future?</p><section class=subscribe><b>Liked this article?</b>
You can <a href=https://www.buymeacoffee.com/ieftimov>buy me a coffee</a>.
Or simply <a href=/newsletter>subscribe to my
newsletter</a> and get my fresh posts in your inbox. It's short and sweet,
going out monthly to over 1,000 subscribers.</section></div><footer class=post-footer><ul class=post-tags><li><a href=https://ieftimov.com/tags/genserver/>genserver</a></li><li><a href=https://ieftimov.com/tags/url-shortener/>url shortener</a></li></ul><nav class=paginav><a class=prev href=https://ieftimov.com/post/golang-datastructures-trees/><span class=title>¬´ Prev Page</span><br><span>Golang Datastructures: Trees</span></a>
<a class=next href=https://ieftimov.com/post/understanding-basics-elixir-concurrency-model/><span class=title>Next Page ¬ª</span><br><span>Understanding the basics of Elixir's concurrency model</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share OTP in Elixir: Learn GenServer by Building Your Own URL Shortener on twitter" href="https://twitter.com/intent/tweet/?text=OTP%20in%20Elixir%3a%20Learn%20GenServer%20by%20Building%20Your%20Own%20URL%20Shortener&url=https%3a%2f%2fieftimov.com%2fpost%2fotp-elixir-genserver-build-own-url-shortener%2f&hashtags=genserver%2curlshortener"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share OTP in Elixir: Learn GenServer by Building Your Own URL Shortener on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fieftimov.com%2fpost%2fotp-elixir-genserver-build-own-url-shortener%2f&title=OTP%20in%20Elixir%3a%20Learn%20GenServer%20by%20Building%20Your%20Own%20URL%20Shortener&summary=OTP%20in%20Elixir%3a%20Learn%20GenServer%20by%20Building%20Your%20Own%20URL%20Shortener&source=https%3a%2f%2fieftimov.com%2fpost%2fotp-elixir-genserver-build-own-url-shortener%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share OTP in Elixir: Learn GenServer by Building Your Own URL Shortener on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fieftimov.com%2fpost%2fotp-elixir-genserver-build-own-url-shortener%2f&title=OTP%20in%20Elixir%3a%20Learn%20GenServer%20by%20Building%20Your%20Own%20URL%20Shortener"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share OTP in Elixir: Learn GenServer by Building Your Own URL Shortener on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fieftimov.com%2fpost%2fotp-elixir-genserver-build-own-url-shortener%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share OTP in Elixir: Learn GenServer by Building Your Own URL Shortener on whatsapp" href="https://api.whatsapp.com/send?text=OTP%20in%20Elixir%3a%20Learn%20GenServer%20by%20Building%20Your%20Own%20URL%20Shortener%20-%20https%3a%2f%2fieftimov.com%2fpost%2fotp-elixir-genserver-build-own-url-shortener%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share OTP in Elixir: Learn GenServer by Building Your Own URL Shortener on telegram" href="https://telegram.me/share/url?text=OTP%20in%20Elixir%3a%20Learn%20GenServer%20by%20Building%20Your%20Own%20URL%20Shortener&url=https%3a%2f%2fieftimov.com%2fpost%2fotp-elixir-genserver-build-own-url-shortener%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>Copyright 2021 ¬© Ilija Eftimov</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>