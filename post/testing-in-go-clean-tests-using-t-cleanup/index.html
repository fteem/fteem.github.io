<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Testing in Go: Clean Tests Using t.Cleanup | Ilija Eftimov ⚡️</title><meta name=keywords content><meta name=description content="Go v1.14 ships with improvements across different aspects of the language. Two of them are brand new t.Cleanup, and b.Cleanup methods, added to the testing package.
The introduction of these methods will make it easier for our tests to clean up after themselves. This was always achievable through the careful composition of (sub)tests and helper functions, but since Go 1.14, the testing package will ship with one right way to do that."><meta name=author content="Ilija"><link rel=canonical href=https://ieftimov.com/post/testing-in-go-clean-tests-using-t-cleanup/><link href=/assets/css/stylesheet.min.css rel="preload stylesheet" as=style><link rel=icon href=https://ieftimov.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ieftimov.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ieftimov.com/favicon-32x32.png><link rel=apple-touch-icon href=https://ieftimov.com/apple-touch-icon.png><link rel=mask-icon href=https://ieftimov.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.81.0"><script async defer data-domain=ieftimov.com src=https://plausible.io/js/plausible.js></script><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel=stylesheet><meta property="og:title" content="Testing in Go: Clean Tests Using t.Cleanup"><meta property="og:description" content="Go v1.14 ships with improvements across different aspects of the language. Two of them are brand new t.Cleanup, and b.Cleanup methods, added to the testing package.
The introduction of these methods will make it easier for our tests to clean up after themselves. This was always achievable through the careful composition of (sub)tests and helper functions, but since Go 1.14, the testing package will ship with one right way to do that."><meta property="og:type" content="article"><meta property="og:url" content="https://ieftimov.com/post/testing-in-go-clean-tests-using-t-cleanup/"><meta property="og:image" content="https://ieftimov.com/cards/testing-in-go-clean-tests-using-t-cleanup.png"><meta property="article:published_time" content="2020-02-18T00:00:00+00:00"><meta property="article:modified_time" content="2020-02-18T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ieftimov.com/cards/testing-in-go-clean-tests-using-t-cleanup.png"><meta name=twitter:title content="Testing in Go: Clean Tests Using t.Cleanup"><meta name=twitter:description content="Go v1.14 ships with improvements across different aspects of the language. Two of them are brand new t.Cleanup, and b.Cleanup methods, added to the testing package.
The introduction of these methods will make it easier for our tests to clean up after themselves. This was always achievable through the careful composition of (sub)tests and helper functions, but since Go 1.14, the testing package will ship with one right way to do that."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ieftimov.com/posts/"},{"@type":"ListItem","position":2,"name":"Testing in Go: Clean Tests Using t.Cleanup","item":"https://ieftimov.com/post/testing-in-go-clean-tests-using-t-cleanup/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Testing in Go: Clean Tests Using t.Cleanup","name":"Testing in Go: Clean Tests Using t.Cleanup","description":"Go v1.14 ships with improvements across different aspects of the language. Two of them are brand new t.Cleanup, and b.Cleanup methods, added to the testing package.\nThe …","keywords":[],"articleBody":"Go v1.14 ships with improvements across different aspects of the language. Two of them are brand new t.Cleanup, and b.Cleanup methods, added to the testing package.\nThe introduction of these methods will make it easier for our tests to clean up after themselves. This was always achievable through the careful composition of (sub)tests and helper functions, but since Go 1.14, the testing package will ship with one right way to do that.\nLet’s explore through a scenario, one very common in web development, how these methods work, and how to put them in use.\nIn this article, we will focus on the t.Cleanup function, but the points made here apply to the b.Cleanup function too.\nVulnerable Authentication A web service that we own has an authentication middleware that uses HTTP Basic Authentication. The middleware takes the Authorization header values of an HTTP request using the BasicAuth helper method and authenticates the request. Depending on the authentication result, it will return an error response or let the request go through.\nThe AuthMiddleware authorization middleware:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  type AuthMiddleware struct { db *gorm.DB } func (am *AuthMiddleware) Validate(username, password string) bool { var u User if err := am.db.Where(\"username = ? AND password = ?\", username, password).First(\u0026u).Error; err != nil { return false } return true } func (am *AuthMiddleware) Middleware(next http.Handler) http.Handler { return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) { if u, p, ok := r.BasicAuth(); ok \u0026\u0026 am.Validate(u, p) { next.ServeHTTP(w, r) } else { http.Error(w, \"Forbidden\", http.StatusForbidden) } }) }    The AuthMiddleware is a struct that has a db attribute of the type *gorm.DB, which, in fact, is a Gorm database connection pool. The Validate method of the middleware will check the validity of the authorization credentials sent by the client. (Yes, this is a very dumb and vulnerable service - stores plain text passwords in the database. No, you should never keep your customers' passwords in plain text.)\nTo do that, it uses the Request.BasicAuth method that returns the username and password provided in the request’s Authorization header. Then, we invoke the Validate method with u (the username) and p (the password) as arguments, that returns a bool.\nWhen the request successfully authorized, the response of the endpoint will be returned. If the request does not supply proper HTTP Basic Authentication credentials, or the supplied credentials are invalid, it will return an HTTP 403 Forbidden error.\nThe simplistic server that builds the router and mounts the handler and the middleware:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  func main() { db, err := gorm.Open(\"sqlite3\", \"./cleanups.db\") if err != nil { log.Fatal(err) } defer db.Close() aum := \u0026AuthMiddleware{db} r := mux.NewRouter() r.Use(aum.Middleware) r.HandleFunc(\"/foo\", func(w http.ResponseWriter, r *http.Request) { io.WriteString(w, \"6 x 9 = 42\\n\") }) log.Fatal(http.ListenAndServe(\":8888\", r)) }    The main function opens a Gorm connection to an SQLite3 database, builds a mux router, and mounts a handler at the /foo URI. Then, it mounts the router on a server and starts listening on 127.0.0.1:8888.\nSo, a sensible question would be, how can we test such a middleware? Since there is a database connection in play here, we have to make sure the database contains the actual username and password we want to send in the test.\nTesting the Vulnerable Authentication Given that the authorization middleware expects a database connection, testing it can be a messy exercise. To test it, we will have to open a database connection (to a test database) and then use it to initialize a test server that mounts the router. Then, we have to send requests to that same server and run our assertions on its response body and status.\nLet’s take a stab at it:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81  package main import ( \"fmt\" \"io/ioutil\" \"log\" \"net/http\" \"net/http/httptest\" \"os\" \"strings\" \"testing\" \"github.com/jinzhu/gorm\" ) func TestServer(t *testing.T) { db, err := gorm.Open(\"sqlite3\", \"./cleanups_test.db\") if err != nil { t.Fatal(err) } defer db.Close() r := Router(db)  tcs := []struct { name string username string password string responseBody string responseStatus int }{ { name: \"with invalid username-password combo\", username: \"jane\", password: \"doe\", responseBody: \"Forbidden\", responseStatus: http.StatusForbidden, }, { name: \"with valid username-password combo\", username: \"jane\", password: \"doe123\", responseBody: \"6 x 9 = 42\", responseStatus: http.StatusOK, }, } ts := httptest.NewServer(r) defer ts.Close() client := ts.Client() req, err := http.NewRequest(\"GET\", fmt.Sprintf(\"%s/foo\", ts.URL), nil) if err != nil { t.Fatal(err) }  for _, tc := range tcs { t.Run(tc.name, func(t *testing.T) { req.SetBasicAuth(tc.username, tc.password)  res, err := client.Do(req) if err != nil { t.Fatal(err) } defer res.Body.Close() response, err := ioutil.ReadAll(res.Body) if err != nil { t.Errorf(err) } if res.StatusCode != tc.responseStatus { t.Errorf(\"Want '%d', got '%d'\", tc.responseStatus, res.StatusCode) } if strings.TrimSpace(string(response)) != tc.responseBody { t.Errorf(\"Want '%s', got '%s'\", tc.responseBody, string(response)) } }) } }    We first open a database connection to a test database and pass the connection as an argument to the Router function. In the second highlighted block, we mount the returned router from the Router function on the test HTTP server. Also, we create a client for the server that we will use to send requests to the server.\nWe then build a new request for the server, and in the next highlighted block, we attach the username and the password of the test case to the request using the Request.SetBasicAuth method.\nWe send the request to the HTTP server using the client.Do method, and get a response back. We then parse the response and do our assertions on the status code of the response and the contents of the body.\nIf we ran this test, it would fail. Why? Although the test setup is correct, the test database is empty. When we send a request to the HTTP server, it will try to validate the credentials our test sends, and it will find an empty database:\n1 2 3 4 5 6 7 8 9 10  $ go test ./... -v -count=1 === RUN TestServer TestServer: server_test.go:17: no such table: users (/app/server_test.go:16) [2020-02-16 17:29:26] no such table: users --- FAIL: TestServer (0.01s) FAIL FAIL\tgithub.com/fteem/go-playground/testing-in-go-cleanup\t0.015s FAIL   This means our test is missing an initial seed of test data, where we create the users table and put some records in it so we can use them in the test.\nAdding data and cleaning it up, the old way The widely-approved approach to seeding the test database is to insert some records before running the test and then remove them once the test is done. The benefit being that the database will always be empty after the tests are done running, without the need to recreate the database and its tables every time we run the tests. Precisely what our failing tests need.\nAchieving this in the most idiomatic way is by using a cleanup closure that is returned by the function that inserts the data. Usually, the returning cleanup function “pattern” looks like this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79  func createUser(t *testing.T, db *gorm.DB) func() { user := User{Username: \"jane\", Password: \"doe123\"} if err := db.Create(\u0026user).Error; err != nil { t.Fatal(err) } return func() { db.Delete(\u0026user) } }  func TestServer(t *testing.T) { db, err := gorm.Open(\"sqlite3\", \"./cleanups_test.db\") if err != nil { t.Fatal(err) } defer db.Close() cleanup := createUser(t, db) defer cleanup()  r := Router(db) tcs := []struct { name string username string password string responseBody string responseStatus int }{ { name: \"with invalid username-password combo\", username: \"jane\", password: \"doe\", responseBody: \"Forbidden\", responseStatus: http.StatusForbidden, }, { name: \"with valid username-password combo\", username: \"jane\", password: \"doe123\", responseBody: \"6 x 9 = 42\", responseStatus: http.StatusOK, }, } ts := httptest.NewServer(r) defer ts.Close() client := ts.Client() req, err := http.NewRequest(\"GET\", fmt.Sprintf(\"%s/foo\", ts.URL), nil) if err != nil { t.Fatal(err) } for _, tc := range tcs { t.Run(tc.name, func(t *testing.T) { req.SetBasicAuth(tc.username, tc.password) res, err := client.Do(req) if err != nil { t.Fatal(err) } defer res.Body.Close() response, err := ioutil.ReadAll(res.Body) if err != nil { t.Error(err) } if res.StatusCode != tc.responseStatus { t.Errorf(\"Want '%d', got '%d'\", tc.responseStatus, res.StatusCode) } if strings.TrimSpace(string(response)) != tc.responseBody { t.Errorf(\"Want '%s', got '%s'\", tc.responseBody, string(response)) } }) } }    The createUser function takes a database connection as an argument and uses it to insert a new User in the users table. After that, it will return a closure that, when invoked, will remove the added user.\nThe reason we pass the testing.T pointer to the createUser function is to be able to fail the test if the database cannot be opened for writing. We check the db.Error field on the Gorm database connection pool for any errors and invoke the t.Fatal function, if we hit any errors.\n(You can read more about the behavior of t.Fatal in my article on the topic.)\nIn the test itself, we invoke createUser with the test database connection and the testing.T pointer. The return value of createUser is a function which we store in the cleanup variable. Then, we defer the invocation of cleanup to happen at the exit of the test function. Using cleanup, we can remove the data from the test database before exiting the tests.\nWhile the approach above works and it’s idiomatic Go, it has a few downsides worth mentioning:\n It works fine for one test case, but if the test file has many tests that modify the state of the test database, they will get contaminated with cleanup-like functions. Adding to the above point, imagine tests where we have to clean up other things, such as processes, files, or open sockets. That will lead to a substantial increase in cleanup-closures pollution. It adds cognitive overhead when reading the code, which otherwise is a straightforward testing code The definition of the cleanup function is buried in the createUser function, visually separated from the test function that uses/invokes it. A reader of the test file can experience difficulty navigating the functions and putting the pieces together  Because of these reasons, the Go authors decided to add a t.Cleanup function to the testing package. The change was merged on November 4, 2019 – right on time to get into the v1.14 release.\nLet’s explore how t.Cleanup can make our life easier.\nAdding data and cleaning it up, using t.Cleanup With the t.Cleanup, and b.Cleanup methods, we get better control to cleaning up after our tests. t.Cleanup registers a function to be called when the test and all its subtests complete. This means that even if our tests run as subtests, which is the case in our example, the cleanup will only happen after all the subtests are done.\nHere’s the reworked version of our tests:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  func createUser(t *testing.T, db *gorm.DB) { user := User{Username: \"jane\", Password: \"doe123\"} if err := db.Create(\u0026user).Error; err != nil { t.Fatal(err) } t.Cleanup(func() { db.Delete(\u0026user) }) } func TestServer(t *testing.T) { db, err := gorm.Open(\"sqlite3\", \"./cleanups_test.db\") if err != nil { t.Fatal(err) } defer db.Close() createUser(t, db)  r := Router(db) // Snipped for brewity... }    While the code change is small, there is a substantial difference between the new and the old versions.\nThe most significant difference lies in the fact that the createUser function takes care of its clean up now. The invoker function (TestServer) does not need to worry about the cleanup of the data added in the database – we know that the createUser will remove the data. Most importantly, it will remove the data just in time – once all of the subtests are done.\nHaving t.Cleanup, and b.Cleanup in the standard library does not stop us from using the old way using composition and returning cleanup callbacks – it is still a valid way to clean up any state or files that our tests might create. But, using the new t.Cleanup \u0026 b.Cleanup functions things get a bit easier: there’s now a way to do just that, and the standard library supports it.\nAnd having the Go v1 compatibility promise in mind – it is here to stay.\nLiked this article? You can buy me a coffee. Or simply subscribe to my newsletter and get my fresh posts in your inbox. It's short and sweet, going out monthly to over 1,000 subscribers.  ","wordCount":"2212","inLanguage":"en","datePublished":"2020-02-18T00:00:00Z","dateModified":"2020-02-18T00:00:00Z","author":{"@type":"Person","name":"Ilija"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ieftimov.com/post/testing-in-go-clean-tests-using-t-cleanup/"},"publisher":{"@type":"Organization","name":"Ilija Eftimov ⚡️","logo":{"@type":"ImageObject","url":"https://ieftimov.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://ieftimov.com/ accesskey=h title="Ilija Eftimov ⚡️ (Alt + H)">Ilija Eftimov ⚡️</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://ieftimov.com/posts title=Archive><span>Archive</span></a></li><li><a href=https://ieftimov.com/about title=About><span>About</span></a></li><li><a href=https://ieftimov.com/newsletter title=Newsletter><span>Newsletter</span></a></li><li><a href=https://forms.gle/orfXK5jh1LRaiFzo8 title="Suggest a topic"><span>Suggest a topic</span></a></li><li><a href=https://www.buymeacoffee.com/ieftimov title="Buy me a ☕"><span>Buy me a ☕</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Testing in Go: Clean Tests Using t.Cleanup</h1><div class=post-meta>February 18, 2020&nbsp;·&nbsp;11 min&nbsp;·&nbsp;Ilija</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#vulnerable-authentication aria-label="Vulnerable Authentication">Vulnerable Authentication</a></li><li><a href=#testing-the-vulnerable-authentication aria-label="Testing the Vulnerable Authentication">Testing the Vulnerable Authentication</a></li><li><a href=#adding-data-and-cleaning-it-up-the-old-way aria-label="Adding data and cleaning it up, the old way">Adding data and cleaning it up, the old way</a></li><li><a href=#adding-data-and-cleaning-it-up-using-tcleanup aria-label="Adding data and cleaning it up, using t.Cleanup">Adding data and cleaning it up, using <code>t.Cleanup</code></a></li></ul></div></details></div><div class=post-content><p>Go v1.14 ships with improvements across different aspects of the language. Two
of them are brand new <code>t.Cleanup</code>, and <code>b.Cleanup</code> methods, added to the
<code>testing</code> package.</p><p>The introduction of these methods will make it easier for our tests to clean up
after themselves. This was always achievable through the careful composition of
(sub)tests and helper functions, but since Go 1.14, the <code>testing</code> package will
ship with one right way to do that.</p><p>Let&rsquo;s explore through a scenario, one very common in web development, how these
methods work, and how to put them in use.</p><p><em>In this article, we will focus on the <a href=https://tip.golang.org/pkg/testing/#T.Cleanup><code>t.Cleanup</code>
function</a>, but the points made
here apply to the <a href=https://tip.golang.org/pkg/testing/#B.Cleanup><code>b.Cleanup</code>
function</a> too.</em></p><h2 id=vulnerable-authentication>Vulnerable Authentication<a hidden class=anchor aria-hidden=true href=#vulnerable-authentication>#</a></h2><p>A web service that we own has an authentication middleware that uses HTTP
Basic Authentication. The middleware takes the <code>Authorization</code> header values of
an HTTP request using the <a href=https://golang.org/pkg/net/http/#Request.BasicAuth><code>BasicAuth</code> helper
method</a> and authenticates
the request. Depending on the authentication result, it will return an error
response or let the request go through.</p><p>The <code>AuthMiddleware</code> authorization middleware:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>type</span> AuthMiddleware <span style=color:#0087ff>struct</span> {
	db *gorm.DB
}

<span style=color:#0087ff>func</span> (am *AuthMiddleware) <span style=color:#0087ff>Validate</span>(username, password <span style=color:#af0000>string</span>) <span style=color:#af0000>bool</span> {
	<span style=color:#0087ff>var</span> u User

	<span style=color:#5f8700>if</span> err := am.db.<span style=color:#0087ff>Where</span>(<span style=color:#00afaf>&#34;username = ? AND password = ?&#34;</span>, username, password).<span style=color:#0087ff>First</span>(&amp;u).Error; err != <span style=color:#d75f00>nil</span> {
		<span style=color:#5f8700>return</span> <span style=color:#d75f00>false</span>
	}

	<span style=color:#5f8700>return</span> <span style=color:#d75f00>true</span>
}

<span style=color:#0087ff>func</span> (am *AuthMiddleware) <span style=color:#0087ff>Middleware</span>(next http.Handler) http.Handler {
	<span style=color:#5f8700>return</span> http.<span style=color:#0087ff>HandlerFunc</span>(<span style=color:#0087ff>func</span>(w http.ResponseWriter, r *http.Request) {
		<span style=color:#5f8700>if</span> u, p, ok := r.<span style=color:#0087ff>BasicAuth</span>(); ok &amp;&amp; am.<span style=color:#0087ff>Validate</span>(u, p) {
			next.<span style=color:#0087ff>ServeHTTP</span>(w, r)
		} <span style=color:#5f8700>else</span> {
			http.<span style=color:#0087ff>Error</span>(w, <span style=color:#00afaf>&#34;Forbidden&#34;</span>, http.StatusForbidden)
		}
	})
}
</code></pre></td></tr></table></div></div><p>The <code>AuthMiddleware</code> is a <code>struct</code> that has a <code>db</code> attribute of the type
<code>*gorm.DB</code>, which, in fact, is a <a href=https://gorm.io>Gorm</a> database connection
pool. The <code>Validate</code> method of the middleware will check the validity of the
authorization credentials sent by the client. (Yes, this is a very dumb and
vulnerable service - stores plain text passwords in the database. No, you
should <strong>never</strong> keep your customers' passwords in plain text.)</p><p>To do that, it uses the <a href=https://golang.org/pkg/net/http/#Request.BasicAuth><code>Request.BasicAuth</code>
method</a> that returns the
username and password provided in the request&rsquo;s <code>Authorization</code> header. Then,
we invoke the <code>Validate</code> method with <code>u</code> (the username) and <code>p</code> (the password)
as arguments, that returns a <code>bool</code>.</p><p>When the request successfully authorized, the response of the endpoint will be
returned. If the request does not supply proper HTTP Basic Authentication
credentials, or the supplied credentials are invalid, it will return an <code>HTTP 403</code> Forbidden error.</p><p>The simplistic server that builds the router and mounts the handler and the
middleware:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>main</span>() {
	db, err := gorm.<span style=color:#0087ff>Open</span>(<span style=color:#00afaf>&#34;sqlite3&#34;</span>, <span style=color:#00afaf>&#34;./cleanups.db&#34;</span>)
	<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
		log.<span style=color:#0087ff>Fatal</span>(err)
	}
	<span style=color:#5f8700>defer</span> db.<span style=color:#0087ff>Close</span>()

	aum := &amp;AuthMiddleware{db}
	r := mux.<span style=color:#0087ff>NewRouter</span>()
	r.<span style=color:#0087ff>Use</span>(aum.Middleware)
	r.<span style=color:#0087ff>HandleFunc</span>(<span style=color:#00afaf>&#34;/foo&#34;</span>, <span style=color:#0087ff>func</span>(w http.ResponseWriter, r *http.Request) {
                io.<span style=color:#0087ff>WriteString</span>(w, <span style=color:#00afaf>&#34;6 x 9 = 42\n&#34;</span>)
	})

	log.<span style=color:#0087ff>Fatal</span>(http.<span style=color:#0087ff>ListenAndServe</span>(<span style=color:#00afaf>&#34;:8888&#34;</span>, r))
}
</code></pre></td></tr></table></div></div><p>The <code>main</code> function opens a Gorm connection to an <code>SQLite3</code> database, builds a
<code>mux</code> router, and mounts a handler at the <code>/foo</code> URI. Then, it mounts the
router on a server and starts listening on <code>127.0.0.1:8888</code>.</p><p>So, a sensible question would be, how can we test such a middleware? Since
there is a database connection in play here, we have to make sure the database
contains the actual <code>username</code> and <code>password</code> we want to send in the test.</p><h2 id=testing-the-vulnerable-authentication>Testing the Vulnerable Authentication<a hidden class=anchor aria-hidden=true href=#testing-the-vulnerable-authentication>#</a></h2><p>Given that the authorization middleware expects a database connection, testing
it can be a messy exercise. To test it, we will have to open a database
connection (to a test database) and then use it to initialize a test server
that mounts the router. Then, we have to send requests to that same server and
run our assertions on its response body and status.</p><p>Let&rsquo;s take a stab at it:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">47
</span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">48
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">49
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">50
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">51
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">52
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">53
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">54
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">55
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#454545">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">58
</span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">59
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#454545">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">62
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">63
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">64
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">65
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">66
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">67
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">68
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">69
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">70
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">71
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">72
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">73
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">74
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">75
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">76
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">77
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">78
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">79
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">80
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">81
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#d75f00>package</span> main

<span style=color:#d75f00>import</span> (
	<span style=color:#00afaf>&#34;fmt&#34;</span>
	<span style=color:#00afaf>&#34;io/ioutil&#34;</span>
	<span style=color:#00afaf>&#34;log&#34;</span>
	<span style=color:#00afaf>&#34;net/http&#34;</span>
	<span style=color:#00afaf>&#34;net/http/httptest&#34;</span>
	<span style=color:#00afaf>&#34;os&#34;</span>
	<span style=color:#00afaf>&#34;strings&#34;</span>
	<span style=color:#00afaf>&#34;testing&#34;</span>

	<span style=color:#00afaf>&#34;github.com/jinzhu/gorm&#34;</span>
)

<span style=color:#0087ff>func</span> <span style=color:#0087ff>TestServer</span>(t *testing.T) {
<span style=display:block;width:100%;background-color:#323232>	db, err := gorm.<span style=color:#0087ff>Open</span>(<span style=color:#00afaf>&#34;sqlite3&#34;</span>, <span style=color:#00afaf>&#34;./cleanups_test.db&#34;</span>)
</span><span style=display:block;width:100%;background-color:#323232>	<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
</span><span style=display:block;width:100%;background-color:#323232>		t.<span style=color:#0087ff>Fatal</span>(err)
</span><span style=display:block;width:100%;background-color:#323232>	}
</span><span style=display:block;width:100%;background-color:#323232>	<span style=color:#5f8700>defer</span> db.<span style=color:#0087ff>Close</span>()
</span><span style=display:block;width:100%;background-color:#323232>
</span><span style=display:block;width:100%;background-color:#323232>	r := <span style=color:#0087ff>Router</span>(db)
</span>
	tcs := []<span style=color:#0087ff>struct</span> {
		name           <span style=color:#af0000>string</span>
		username       <span style=color:#af0000>string</span>
		password       <span style=color:#af0000>string</span>
		responseBody   <span style=color:#af0000>string</span>
		responseStatus <span style=color:#af0000>int</span>
	}{
		{
			name:           <span style=color:#00afaf>&#34;with invalid username-password combo&#34;</span>,
			username:       <span style=color:#00afaf>&#34;jane&#34;</span>,
			password:       <span style=color:#00afaf>&#34;doe&#34;</span>,
			responseBody:   <span style=color:#00afaf>&#34;Forbidden&#34;</span>,
			responseStatus: http.StatusForbidden,
		},
		{
			name:           <span style=color:#00afaf>&#34;with valid username-password combo&#34;</span>,
			username:       <span style=color:#00afaf>&#34;jane&#34;</span>,
			password:       <span style=color:#00afaf>&#34;doe123&#34;</span>,
			responseBody:   <span style=color:#00afaf>&#34;6 x 9 = 42&#34;</span>,
			responseStatus: http.StatusOK,
		},
	}

<span style=display:block;width:100%;background-color:#323232>	ts := httptest.<span style=color:#0087ff>NewServer</span>(r)
</span><span style=display:block;width:100%;background-color:#323232>	<span style=color:#5f8700>defer</span> ts.<span style=color:#0087ff>Close</span>()
</span><span style=display:block;width:100%;background-color:#323232>	client := ts.<span style=color:#0087ff>Client</span>()
</span><span style=display:block;width:100%;background-color:#323232>
</span><span style=display:block;width:100%;background-color:#323232>	req, err := http.<span style=color:#0087ff>NewRequest</span>(<span style=color:#00afaf>&#34;GET&#34;</span>, fmt.<span style=color:#0087ff>Sprintf</span>(<span style=color:#00afaf>&#34;%s/foo&#34;</span>, ts.URL), <span style=color:#d75f00>nil</span>)
</span><span style=display:block;width:100%;background-color:#323232>	<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
</span><span style=display:block;width:100%;background-color:#323232>		t.<span style=color:#0087ff>Fatal</span>(err)
</span><span style=display:block;width:100%;background-color:#323232>	}
</span>
	<span style=color:#5f8700>for</span> _, tc := <span style=color:#5f8700>range</span> tcs {
		t.<span style=color:#0087ff>Run</span>(tc.name, <span style=color:#0087ff>func</span>(t *testing.T) {
<span style=display:block;width:100%;background-color:#323232>			req.<span style=color:#0087ff>SetBasicAuth</span>(tc.username, tc.password)
</span>
			res, err := client.<span style=color:#0087ff>Do</span>(req)
			<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
				t.<span style=color:#0087ff>Fatal</span>(err)
			}
			<span style=color:#5f8700>defer</span> res.Body.<span style=color:#0087ff>Close</span>()

			response, err := ioutil.<span style=color:#0087ff>ReadAll</span>(res.Body)
			<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
				t.<span style=color:#0087ff>Errorf</span>(err)
			}

			<span style=color:#5f8700>if</span> res.StatusCode != tc.responseStatus {
				t.<span style=color:#0087ff>Errorf</span>(<span style=color:#00afaf>&#34;Want &#39;%d&#39;, got &#39;%d&#39;&#34;</span>, tc.responseStatus, res.StatusCode)
			}

			<span style=color:#5f8700>if</span> strings.<span style=color:#0087ff>TrimSpace</span>(<span style=color:#0087ff>string</span>(response)) != tc.responseBody {
				t.<span style=color:#0087ff>Errorf</span>(<span style=color:#00afaf>&#34;Want &#39;%s&#39;, got &#39;%s&#39;&#34;</span>, tc.responseBody, <span style=color:#0087ff>string</span>(response))
			}
		})
	}
}
</code></pre></td></tr></table></div></div><p>We first open a database connection to a test database and pass the
connection as an argument to the <code>Router</code> function. In the second highlighted
block, we mount the returned router from the <code>Router</code> function on the test HTTP
server. Also, we create a client for the server that we will use to send
requests to the server.</p><p>We then build a new request for the server, and in the next highlighted block,
we attach the <code>username</code> and the <code>password</code> of the test case to the request
using the <a href=https://golang.org/pkg/net/http/#Request.SetBasicAuth><code>Request.SetBasicAuth</code>
method</a>.</p><p>We send the request to the HTTP server using the <a href=https://golang.org/pkg/net/http/#Client.Do><code>client.Do</code>
method</a>, and get a response back.
We then parse the response and do our assertions on the status code of the
response and the contents of the body.</p><p>If we ran this test, it would fail. Why? Although the test setup is correct,
the test database is empty. When we send a request to the HTTP server, it will
try to validate the credentials our test sends, and it will find an empty
database:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ go <span style=color:#0087ff>test</span> ./... -v -count=<span style=color:#0087ff>1</span>
=== RUN   TestServer
    TestServer: server_test.go:17: no such table: users

(/app/server_test.go:16)
[2020-02-16 17:29:26]  no such table: users
--- FAIL: TestServer (0.01s)
FAIL
FAIL	github.com/fteem/go-playground/testing-in-go-cleanup	0.015s
FAIL</code></pre></td></tr></table></div></div><p>This means our test is missing an initial seed of test data, where we create
the <code>users</code> table and put some records in it so we can use them in the test.</p><h2 id=adding-data-and-cleaning-it-up-the-old-way>Adding data and cleaning it up, the old way<a hidden class=anchor aria-hidden=true href=#adding-data-and-cleaning-it-up-the-old-way>#</a></h2><p>The widely-approved approach to seeding the test database is to insert some
records before running the test and then remove them once the test is done.
The benefit being that the database will always be empty after the tests are
done running, without the need to recreate the database and its tables every
time we run the tests. Precisely what our failing tests need.</p><p>Achieving this in the most idiomatic way is by using a cleanup closure that is
returned by the function that inserts the data. Usually, the returning cleanup
function &ldquo;pattern&rdquo; looks like this:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">62
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">63
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">64
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">65
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">66
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">67
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">68
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">69
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">70
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">71
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">72
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">73
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">74
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">75
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">76
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">77
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">78
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">79
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:block;width:100%;background-color:#323232><span style=color:#0087ff>func</span> <span style=color:#0087ff>createUser</span>(t *testing.T, db *gorm.DB) <span style=color:#0087ff>func</span>() {
</span><span style=display:block;width:100%;background-color:#323232>	user := User{Username: <span style=color:#00afaf>&#34;jane&#34;</span>, Password: <span style=color:#00afaf>&#34;doe123&#34;</span>}
</span><span style=display:block;width:100%;background-color:#323232>	<span style=color:#5f8700>if</span> err := db.<span style=color:#0087ff>Create</span>(&amp;user).Error; err != <span style=color:#d75f00>nil</span> {
</span><span style=display:block;width:100%;background-color:#323232>		t.<span style=color:#0087ff>Fatal</span>(err)
</span><span style=display:block;width:100%;background-color:#323232>	}
</span><span style=display:block;width:100%;background-color:#323232>
</span><span style=display:block;width:100%;background-color:#323232>	<span style=color:#5f8700>return</span> <span style=color:#0087ff>func</span>() {
</span><span style=display:block;width:100%;background-color:#323232>		db.<span style=color:#0087ff>Delete</span>(&amp;user)
</span><span style=display:block;width:100%;background-color:#323232>	}
</span><span style=display:block;width:100%;background-color:#323232>}
</span>
<span style=color:#0087ff>func</span> <span style=color:#0087ff>TestServer</span>(t *testing.T) {
	db, err := gorm.<span style=color:#0087ff>Open</span>(<span style=color:#00afaf>&#34;sqlite3&#34;</span>, <span style=color:#00afaf>&#34;./cleanups_test.db&#34;</span>)
	<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
		t.<span style=color:#0087ff>Fatal</span>(err)
	}
	<span style=color:#5f8700>defer</span> db.<span style=color:#0087ff>Close</span>()

<span style=display:block;width:100%;background-color:#323232>	cleanup := <span style=color:#0087ff>createUser</span>(t, db)
</span><span style=display:block;width:100%;background-color:#323232>	<span style=color:#5f8700>defer</span> <span style=color:#0087ff>cleanup</span>()
</span>
	r := <span style=color:#0087ff>Router</span>(db)

	tcs := []<span style=color:#0087ff>struct</span> {
		name           <span style=color:#af0000>string</span>
		username       <span style=color:#af0000>string</span>
		password       <span style=color:#af0000>string</span>
		responseBody   <span style=color:#af0000>string</span> responseStatus <span style=color:#af0000>int</span>
	}{
		{
			name:           <span style=color:#00afaf>&#34;with invalid username-password combo&#34;</span>,
			username:       <span style=color:#00afaf>&#34;jane&#34;</span>,
			password:       <span style=color:#00afaf>&#34;doe&#34;</span>,
			responseBody:   <span style=color:#00afaf>&#34;Forbidden&#34;</span>,
			responseStatus: http.StatusForbidden,
		},
		{
			name:           <span style=color:#00afaf>&#34;with valid username-password combo&#34;</span>,
			username:       <span style=color:#00afaf>&#34;jane&#34;</span>,
			password:       <span style=color:#00afaf>&#34;doe123&#34;</span>,
			responseBody:   <span style=color:#00afaf>&#34;6 x 9 = 42&#34;</span>,
			responseStatus: http.StatusOK,
		},
	}

	ts := httptest.<span style=color:#0087ff>NewServer</span>(r)
	<span style=color:#5f8700>defer</span> ts.<span style=color:#0087ff>Close</span>()
	client := ts.<span style=color:#0087ff>Client</span>()

	req, err := http.<span style=color:#0087ff>NewRequest</span>(<span style=color:#00afaf>&#34;GET&#34;</span>, fmt.<span style=color:#0087ff>Sprintf</span>(<span style=color:#00afaf>&#34;%s/foo&#34;</span>, ts.URL), <span style=color:#d75f00>nil</span>)
	<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
		t.<span style=color:#0087ff>Fatal</span>(err)
	}

	<span style=color:#5f8700>for</span> _, tc := <span style=color:#5f8700>range</span> tcs {
		t.<span style=color:#0087ff>Run</span>(tc.name, <span style=color:#0087ff>func</span>(t *testing.T) {
			req.<span style=color:#0087ff>SetBasicAuth</span>(tc.username, tc.password)

			res, err := client.<span style=color:#0087ff>Do</span>(req)
			<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
				t.<span style=color:#0087ff>Fatal</span>(err)
			}
			<span style=color:#5f8700>defer</span> res.Body.<span style=color:#0087ff>Close</span>()

			response, err := ioutil.<span style=color:#0087ff>ReadAll</span>(res.Body)
			<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
				t.<span style=color:#0087ff>Error</span>(err)
			}

			<span style=color:#5f8700>if</span> res.StatusCode != tc.responseStatus {
				t.<span style=color:#0087ff>Errorf</span>(<span style=color:#00afaf>&#34;Want &#39;%d&#39;, got &#39;%d&#39;&#34;</span>, tc.responseStatus, res.StatusCode)
			}

			<span style=color:#5f8700>if</span> strings.<span style=color:#0087ff>TrimSpace</span>(<span style=color:#0087ff>string</span>(response)) != tc.responseBody {
				t.<span style=color:#0087ff>Errorf</span>(<span style=color:#00afaf>&#34;Want &#39;%s&#39;, got &#39;%s&#39;&#34;</span>, tc.responseBody, <span style=color:#0087ff>string</span>(response))
			}
		})
	}
}
</code></pre></td></tr></table></div></div><p>The <code>createUser</code> function takes a database connection as an argument and uses
it to insert a new <code>User</code> in the <code>users</code> table. After that, it will return a
closure that, when invoked, will remove the added user.</p><p>The reason we pass the <code>testing.T</code> pointer to the <code>createUser</code> function is to
be able to fail the test if the database cannot be opened for writing. We check
the <code>db.Error</code> field on the Gorm database connection pool for any errors and
invoke the <code>t.Fatal</code> function, if we hit any errors.</p><p><em>(You can read more about the behavior of <code>t.Fatal</code> in <a href=/post/testing-in-go-failing-tests>my article on the
topic</a>.)</em></p><p>In the test itself, we invoke <code>createUser</code> with the test database connection
and the <code>testing.T</code> pointer. The return value of <code>createUser</code> is a function
which we store in the <code>cleanup</code> variable. Then, we <code>defer</code> the invocation of
<code>cleanup</code> to happen at the exit of the test function. Using <code>cleanup</code>, we can
remove the data from the test database before exiting the tests.</p><p>While the approach above works and it&rsquo;s idiomatic Go, it has a few downsides
worth mentioning:</p><ul><li>It works fine for one test case, but if the test file has many tests that
modify the state of the test database, they will get contaminated with
cleanup-like functions.</li><li>Adding to the above point, imagine tests where we have to clean up other
things, such as processes, files, or open sockets. That will lead to a
substantial increase in cleanup-closures pollution.</li><li>It adds cognitive overhead when reading the code, which otherwise is
a straightforward testing code</li><li>The definition of the <code>cleanup</code> function is buried in the <code>createUser</code>
function, visually separated from the test function that uses/invokes it. A
reader of the test file can experience difficulty navigating the functions
and putting the pieces together</li></ul><p>Because of these reasons, the Go authors decided to add a <code>t.Cleanup</code> function
to the <code>testing</code> package. <a href=https://go-review.googlesource.com/c/go/+/201359/>The
change</a> was merged on
November 4, 2019 – right on time to get into the v1.14 release.</p><p>Let&rsquo;s explore how <code>t.Cleanup</code> can make our life easier.</p><h2 id=adding-data-and-cleaning-it-up-using-tcleanup>Adding data and cleaning it up, using <code>t.Cleanup</code><a hidden class=anchor aria-hidden=true href=#adding-data-and-cleaning-it-up-using-tcleanup>#</a></h2><p>With the <code>t.Cleanup</code>, and <code>b.Cleanup</code> methods, we get better control to
cleaning up after our tests. <code>t.Cleanup</code> registers a function to be called when
the test and all its subtests complete. This means that even if our tests run
as subtests, which is the case in our example, the cleanup will only happen
after all the subtests are done.</p><p>Here&rsquo;s the reworked version of our tests:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span></span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style=display:block;width:100%;background-color:#323232><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>createUser</span>(t *testing.T, db *gorm.DB) {
	user := User{Username: <span style=color:#00afaf>&#34;jane&#34;</span>, Password: <span style=color:#00afaf>&#34;doe123&#34;</span>}
	<span style=color:#5f8700>if</span> err := db.<span style=color:#0087ff>Create</span>(&amp;user).Error; err != <span style=color:#d75f00>nil</span> {
		t.<span style=color:#0087ff>Fatal</span>(err)
	}

<span style=display:block;width:100%;background-color:#323232>	t.<span style=color:#0087ff>Cleanup</span>(<span style=color:#0087ff>func</span>() {
</span><span style=display:block;width:100%;background-color:#323232>		db.<span style=color:#0087ff>Delete</span>(&amp;user)
</span><span style=display:block;width:100%;background-color:#323232>	})
</span>}

<span style=color:#0087ff>func</span> <span style=color:#0087ff>TestServer</span>(t *testing.T) {
	db, err := gorm.<span style=color:#0087ff>Open</span>(<span style=color:#00afaf>&#34;sqlite3&#34;</span>, <span style=color:#00afaf>&#34;./cleanups_test.db&#34;</span>)
	<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
		t.<span style=color:#0087ff>Fatal</span>(err)
	}
	<span style=color:#5f8700>defer</span> db.<span style=color:#0087ff>Close</span>()

<span style=display:block;width:100%;background-color:#323232>	<span style=color:#0087ff>createUser</span>(t, db)
</span>
	r := <span style=color:#0087ff>Router</span>(db)

    <span style=color:#4e4e4e>// Snipped for brewity...
</span><span style=color:#4e4e4e></span>}
</code></pre></td></tr></table></div></div><p>While the code change is small, there is a substantial difference between the
new and the old versions.</p><p>The most significant difference lies in the fact that the <code>createUser</code> function
takes care of its clean up now. The invoker function (<code>TestServer</code>) does not
need to worry about the cleanup of the data added in the database – we know
that the <code>createUser</code> will remove the data. Most importantly, it will remove
the data <strong>just in time</strong> – once all of the subtests are done.</p><p>Having <code>t.Cleanup</code>, and <code>b.Cleanup</code> in the standard library does not stop us
from using the old way using composition and returning cleanup callbacks – it
is still a valid way to clean up any state or files that our tests might
create. But, using the new <code>t.Cleanup</code> & <code>b.Cleanup</code> functions things get a bit
easier: there&rsquo;s now a way to do just that, and the standard library supports
it.</p><p>And having the <a href=https://golang.org/doc/go1compat>Go v1 compatibility promise</a>
in mind – it is here to stay.</p><section class=subscribe><b>Liked this article?</b>
You can <a href=https://www.buymeacoffee.com/ieftimov>buy me a coffee</a>.
Or simply <a href=/newsletter>subscribe to my
newsletter</a> and get my fresh posts in your inbox. It's short and sweet,
going out monthly to over 1,000 subscribers.</section></div><footer class=post-footer><nav class=paginav><a class=prev href=https://ieftimov.com/post/testing-in-go-testing-http-servers/><span class=title>« Prev Page</span><br><span>Testing in Go: HTTP Servers</span></a>
<a class=next href=https://ieftimov.com/post/testing-in-go-golden-files/><span class=title>Next Page »</span><br><span>Testing in Go: Golden Files</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: Clean Tests Using t.Cleanup on twitter" href="https://twitter.com/intent/tweet/?text=Testing%20in%20Go%3a%20Clean%20Tests%20Using%20t.Cleanup&url=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-clean-tests-using-t-cleanup%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: Clean Tests Using t.Cleanup on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-clean-tests-using-t-cleanup%2f&title=Testing%20in%20Go%3a%20Clean%20Tests%20Using%20t.Cleanup&summary=Testing%20in%20Go%3a%20Clean%20Tests%20Using%20t.Cleanup&source=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-clean-tests-using-t-cleanup%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: Clean Tests Using t.Cleanup on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-clean-tests-using-t-cleanup%2f&title=Testing%20in%20Go%3a%20Clean%20Tests%20Using%20t.Cleanup"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: Clean Tests Using t.Cleanup on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-clean-tests-using-t-cleanup%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: Clean Tests Using t.Cleanup on whatsapp" href="https://api.whatsapp.com/send?text=Testing%20in%20Go%3a%20Clean%20Tests%20Using%20t.Cleanup%20-%20https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-clean-tests-using-t-cleanup%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: Clean Tests Using t.Cleanup on telegram" href="https://telegram.me/share/url?text=Testing%20in%20Go%3a%20Clean%20Tests%20Using%20t.Cleanup&url=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-clean-tests-using-t-cleanup%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>Copyright 2021 © Ilija Eftimov</span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position"))},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})});var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft)}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>