<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>How to write RSpec formatters from scratch - Ilija Eftimov</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta itemprop="name" content="How to write RSpec formatters from scratch">
<meta itemprop="description" content="Recently I did an experiment with RSpec&#39;s formatters. Turns out, the output that RSpec returns when you run your specs can be very customized for your own needs. Read on to learn how you can write custom RSpec formatters.
Writing custom formatters RSpec allows customization of the output by creating your own Formatter class. Yep, it&#39;s that easy. You just need to write one class and than require it into RSpec&#39;s configuration to use it.">

<meta itemprop="wordCount" content="2415">



<meta itemprop="keywords" content="testing,formatters," /><meta property="og:title" content="How to write RSpec formatters from scratch" />
<meta property="og:description" content="Recently I did an experiment with RSpec&#39;s formatters. Turns out, the output that RSpec returns when you run your specs can be very customized for your own needs. Read on to learn how you can write custom RSpec formatters.
Writing custom formatters RSpec allows customization of the output by creating your own Formatter class. Yep, it&#39;s that easy. You just need to write one class and than require it into RSpec&#39;s configuration to use it." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ieftimov.com/post/how-to-write-rspec-formatters-from-scratch/" />
<meta property="article:published_time" content="2015-04-28T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to write RSpec formatters from scratch"/>
<meta name="twitter:description" content="Recently I did an experiment with RSpec&#39;s formatters. Turns out, the output that RSpec returns when you run your specs can be very customized for your own needs. Read on to learn how you can write custom RSpec formatters.
Writing custom formatters RSpec allows customization of the output by creating your own Formatter class. Yep, it&#39;s that easy. You just need to write one class and than require it into RSpec&#39;s configuration to use it."/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://ieftimov.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://ieftimov.com/css/main.css" />
		<link rel="stylesheet" type="text/css" href="https://ieftimov.com/css/overrides.css" />
	<link id="dark-scheme" rel="stylesheet" type="text/css" href="https://ieftimov.com/css/dark.css" media="(prefers-color-scheme: dark)" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="https://ieftimov.com/js/main.js"></script><script src="https://ieftimov.com/js/tooltip.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="https://ieftimov.com/">
				<img src="/avatar.png" alt="Ilija Eftimov" />
			</a>
		</div>
	
	<h1 class="site-title"><a href="https://ieftimov.com/">Ilija Eftimov</a></h1>
	<div class="site-description"><p>A human, interested in building products and software.</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/fteem" title="Github"><i data-feather="github"></i></a></li><li><a href="https://twitter.com/fteem" title="Twitter"><i data-feather="twitter"></i></a></li><li><a href="https://www.linkedin.com/in/ieftimov" title="Linkedin"><i data-feather="linkedin"></i></a></li><li><a href="mailto:blog@ieftimov.com" title="Email"><i data-feather="mail"></i></a></li></ul>
		</nav><span class="scheme-toggle"><a href="#" id="scheme-toggle"></a></div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/categories/testing-in-go">Testing in Go</a>
			</li>
			
			<li>
				<a href="/posts">Archive</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="https://forms.gle/orfXK5jh1LRaiFzo8">Suggest a topic</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">28</span>
							<span class="rest">Apr 2015</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">How to write RSpec formatters from scratch</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>Recently I did an experiment with RSpec's formatters. Turns out, the output
that RSpec returns when you run your specs can be very customized for your own
needs. Read on to learn how you can write custom RSpec formatters.</p>
<h2 id="writing-custom-formatters">Writing custom formatters</h2>
<p>RSpec allows customization of the output by creating your own Formatter class.
Yep, it's that easy. You just need to write one class and than require it into
RSpec's configuration to use it. Lets explore couple of key concepts about the
formatters and it's internals.</p>
<h3 id="the-protocol">The Protocol</h3>
<p>First thing to be aware of is the protocol (the order) that RSpec uses when
calling methods from the formatter. Keep in mind that every method receives
one argument, which is a Notification object. This is sent by the RSpec
reporter which notifies the formatter of the outcome of the example. On the
beginning **Formatter#start **is called. This method takes a notification
argument of the
class <a href="http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/StartNotification">StartNotification</a>.
On every example group, <strong>Formatter#example_group_started</strong> is called. This
method takes a notification argument of the class
<a href="http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/GroupNotification">GroupNotification</a>.
When an example is ran, one of these methods is called, based on the result of
the example:</p>
<ul>
<li>If the example passes, **Formatter#example_passed **is called. The
notification argument is of class
<a href="http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/ExampleNotification">ExampleNotification</a>.</li>
<li>If the example fails, **Formatter#example_failed **is called. The
notification argument is of class
 <a href="http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/FailedExampleNotification">FailedExampleNotification</a>.</li>
<li>If the example is pending, **Formatter#example_pending **is called. The
notification argument is of
class <a href="http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/ExampleNotification">ExampleNotification</a>.</li>
</ul>
<p>At the end of the spec suite, these methods are called in this order:</p>
<ul>
<li><strong>Formatter#stop</strong>. The notification passed as argument is of
class <a href="http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/ExamplesNotification">ExamplesNotification</a>.</li>
<li><strong>Formatter#start_dump</strong>. The notification passed as argument is of class
<a href="http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/NullNotification">NullNotification</a>.</li>
<li><strong>Formatter#dump_pending</strong>. The notification passed as argument is of class
<a href="http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/ExamplesNotification">ExamplesNotification</a>.</li>
<li><strong>Formatter#dump_failures</strong>. The notification passed as argument is of
class
<a href="http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/ExamplesNotification">ExamplesNotification</a>.</li>
<li><strong>Formatter#dump_summary</strong>. The notification passed as argument is of class
<a href="http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/SummaryNotification">SummaryNotification</a>.</li>
<li><strong>Formatter#seed</strong>. The notification passed as argument is of class
<a href="http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/SeedNotification">SeedNotification</a>.</li>
<li><strong>Formatter#close</strong>. The notification passed as argument is of class
<a href="http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/NullNotification">NullNotification</a>.</li>
</ul>
<p>I wont go into detail for every of the notification classes. You can dive in
the details about each of them in the links that I have attached.</p>
<h3 id="registering-your-formatter-class-to-rspec">Registering your formatter class to RSpec</h3>
<p>RSpec provides this neat feature of registering a class as a formatter. This is
done by creating the class and calling:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">.</span>register <span style="font-weight:bold">&lt;</span>the <span style="font-weight:bold">class</span> <span style="color:#999">name</span><span style="font-weight:bold">&gt;</span>, <span style="font-weight:bold">&lt;</span>array of symbols representing the <span style="color:#999">methods</span> that this formatter will provide<span style="font-weight:bold">&gt;</span></code></pre></div>
<p>So, say we want a formatter that shows the progress of the suite, just like the
built-in progress formatter, but it will group the failing and the pending
specs in the summary of the suite.</p>
<h3 id="creating-thethe-groupingformatter-class">Creating the the GroupingFormatter class</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">GroupingFormatter</span>
  <span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">.</span>register <span style="color:#999">self</span>, <span style="color:#b84">:dump_summary</span>, <span style="color:#b84">:close</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span> output
    @output <span style="font-weight:bold">=</span> output
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">dump_summary</span> notification <span style="color:#998;font-style:italic"># SummaryNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\n</span><span style="color:#b84">Finished in </span><span style="color:#b84">#{</span>notification<span style="font-weight:bold">.</span>duration<span style="color:#b84">}</span><span style="color:#b84">.</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">close</span> notification <span style="color:#998;font-style:italic"># NullNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>As you can see, the GroupingFormatter is just a class. In it's initializer
it takes the output as an argument and sets it as an instance variable. Also,
on line 2, you can see the aforementioned <strong>RSpec.register</strong> call. We pass
<em>self</em> as the first argument, because we want to register this class as a
formatter. The rest of the arguments are method names that RSpec will call when
using this formatter. What this means is that when you define a method for
**the protocol, **if you don't register it - it will not be called. Basically,
RSpec won't know it exists at all. Next, the <strong>dump_summary</strong> method calls the
duration method on the notification object, which returns a number representing
the time of the specs&rsquo; duration in seconds. So, how can we test if this is
working? The command is:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rspec some_file.rb --require ./grouping_formatter.rb --format GroupingFormatter</code></pre></div>
<p>And the output is:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Finished in 0.007552.</code></pre></div>
<p>Now, this doesn't tell much. Let's use RSpec's built in helpers to format this
number in a meaningful string.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">GroupingFormatter</span>
  <span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">.</span>register <span style="color:#999">self</span>, <span style="color:#b84">:dump_summary</span>, <span style="color:#b84">:close</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span> output
    @output <span style="font-weight:bold">=</span> output
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">dump_summary</span> notification <span style="color:#998;font-style:italic"># SummaryNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\n</span><span style="color:#b84">Finished in </span><span style="color:#b84">#{</span><span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">::</span><span style="color:#008080">Helpers</span><span style="font-weight:bold">.</span>format_duration(notification<span style="font-weight:bold">.</span>duration)<span style="color:#b84">}</span><span style="color:#b84">.</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">close</span> notification <span style="color:#998;font-style:italic"># NullNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>In the <strong>dump_summary</strong> method we use the
<a href="http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Formatters/Helpers">RSpec::Core::Formatters::Helpers</a>
module which has some methods that can help us turn the duration number into a
meaningful string. The output now looks like:</p>
<!-- raw HTML omitted -->
<p>Okay, great. Now, lets make this formatter mimic the reporting formatter that
comes with RSpec. We need the formatter to show a dot for every passing
example, F for every failing example and an asterisk for every pending example.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">GroupingFormatter</span>
  <span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">.</span>register <span style="color:#999">self</span>, <span style="color:#b84">:dump_summary</span>, <span style="color:#b84">:close</span>, <span style="color:#b84">:example_passed</span>, <span style="color:#b84">:example_failed</span>, <span style="color:#b84">:example_pending</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span> output
    @output <span style="font-weight:bold">=</span> output
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">example_passed</span> notification <span style="color:#998;font-style:italic"># ExampleNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">.</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">example_failed</span> notification <span style="color:#998;font-style:italic"># FailedExampleNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">F</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">example_pending</span> notification <span style="color:#998;font-style:italic"># ExampleNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">*</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">dump_summary</span> notification <span style="color:#998;font-style:italic"># SummaryNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\n</span><span style="color:#b84">Finished in </span><span style="color:#b84">#{</span><span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">::</span><span style="color:#008080">Helpers</span><span style="font-weight:bold">.</span>format_duration(notification<span style="font-weight:bold">.</span>duration)<span style="color:#b84">}</span><span style="color:#b84">.</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">close</span> notification <span style="color:#998;font-style:italic"># NullNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>So, the reporter (the algorithm that follows the protocol) will call
<strong>example_failed</strong> when an example fails, <strong>example_pending</strong> when an example
is pending and **example_passed **when an example passes. This is really
self-explanatory - we add the case specific character to the output for every
example. Take note that I added the method names to
the <strong>RSpec.register</strong> call. If I didn't - they'd be ignored. The output will
now look like:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Looking good, things are starting to take shape! Now for the more complicated
part. How can we group the pending/failing specs? First, lets group the pending
specs.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">GroupingFormatter</span>
  <span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">.</span>register <span style="color:#999">self</span>, <span style="color:#b84">:dump_summary</span>, <span style="color:#b84">:close</span>, <span style="color:#b84">:example_passed</span>,
    <span style="color:#b84">:example_failed</span>, <span style="color:#b84">:example_pending</span>, <span style="color:#b84">:dump_pending</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span> output
    @output <span style="font-weight:bold">=</span> output
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">example_passed</span> notification <span style="color:#998;font-style:italic"># ExampleNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">.</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">example_failed</span> notification <span style="color:#998;font-style:italic"># FailedExampleNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">F</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">example_pending</span> notification <span style="color:#998;font-style:italic"># ExampleNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">*</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">dump_pending</span> notification <span style="color:#998;font-style:italic"># ExamplesNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\n</span><span style="color:#b84">PENDING:</span><span style="color:#b84">\n</span><span style="color:#b84">\t</span><span style="color:#b84">&#34;</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> notification<span style="font-weight:bold">.</span>pending_examples<span style="font-weight:bold">.</span>map {<span style="font-weight:bold">|</span>example<span style="font-weight:bold">|</span> example<span style="font-weight:bold">.</span>full_description <span style="font-weight:bold">+</span> <span style="color:#b84">&#34;</span><span style="color:#b84"> - </span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">+</span> example<span style="font-weight:bold">.</span>location }<span style="font-weight:bold">.</span>join(<span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\t</span><span style="color:#b84">&#34;</span>)
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">dump_summary</span> notification <span style="color:#998;font-style:italic"># SummaryNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\n</span><span style="color:#b84">Finished in </span><span style="color:#b84">#{</span><span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">::</span><span style="color:#008080">Helpers</span><span style="font-weight:bold">.</span>format_duration(notification<span style="font-weight:bold">.</span>duration)<span style="color:#b84">}</span><span style="color:#b84">.</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">close</span> notification <span style="color:#998;font-style:italic"># NullNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>Lets look at the <strong>dump_pending</strong> method now. First, it adds &ldquo;PENDING&rdquo; to the
output. Next, it loops through the <em>pending_examples</em> array and creates an
array of strings for each of the pending examples. Note that I added the new
method to the RSpec.register call, it would be ignored otherwise. Each string
in the array will look something like this:</p>
<!-- raw HTML omitted -->
<p>At the end, we call _join _on the array of strings to build a single formatted
string that we append to the output. Now when we run the specs with the
formatter, the output will look like:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Looking good. Now, for the trickiest part, grouping the failing specs and
adding the error underneath every failing spec.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">GroupingFormatter</span>
  <span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">.</span>register <span style="color:#999">self</span>, <span style="color:#b84">:dump_pending</span>, <span style="color:#b84">:dump_failures</span>, <span style="color:#b84">:close</span>, <span style="color:#b84">:dump_summary</span>, <span style="color:#b84">:example_passed</span>, <span style="color:#b84">:example_failed</span>, <span style="color:#b84">:example_pending</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span> output
    @output <span style="font-weight:bold">=</span> output
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">example_passed</span> notification <span style="color:#998;font-style:italic"># ExampleNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">.</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">example_failed</span> notification <span style="color:#998;font-style:italic"># FailedExampleNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">F</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">example_pending</span> notification <span style="color:#998;font-style:italic"># ExampleNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">*</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">dump_pending</span> notification <span style="color:#998;font-style:italic"># ExamplesNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\n</span><span style="color:#b84">PENDING:</span><span style="color:#b84">\n</span><span style="color:#b84">\t</span><span style="color:#b84">&#34;</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> notification<span style="font-weight:bold">.</span>pending_examples<span style="font-weight:bold">.</span>map {<span style="font-weight:bold">|</span>example<span style="font-weight:bold">|</span> example<span style="font-weight:bold">.</span>full_description <span style="font-weight:bold">+</span> <span style="color:#b84">&#34;</span><span style="color:#b84"> - </span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">+</span> example<span style="font-weight:bold">.</span>location }<span style="font-weight:bold">.</span>join(<span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\t</span><span style="color:#b84">&#34;</span>)
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">dump_failures</span> notification <span style="color:#998;font-style:italic"># ExamplesNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">FAILING</span><span style="color:#b84">\n</span><span style="color:#b84">\t</span><span style="color:#b84">&#34;</span>
    <span style="color:#998;font-style:italic"># For every failed example...</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> notification<span style="font-weight:bold">.</span>failed_examples<span style="font-weight:bold">.</span>map <span style="font-weight:bold">do</span> <span style="font-weight:bold">|</span>example<span style="font-weight:bold">|</span>
      <span style="color:#998;font-style:italic"># Extract the full description of the example</span>
      full_description <span style="font-weight:bold">=</span> example<span style="font-weight:bold">.</span>full_description
      <span style="color:#998;font-style:italic"># Extract the example location in the file</span>
      location <span style="font-weight:bold">=</span> example<span style="font-weight:bold">.</span>location

      <span style="color:#b84">&#34;</span><span style="color:#b84">#{</span>full_description<span style="color:#b84">}</span><span style="color:#b84"> - </span><span style="color:#b84">#{</span>location<span style="color:#b84">}</span><span style="color:#b84">&#34;</span>
    <span style="font-weight:bold">end</span><span style="font-weight:bold">.</span>join(<span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\n</span><span style="color:#b84">\t</span><span style="color:#b84">&#34;</span>)
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">dump_summary</span> notification <span style="color:#998;font-style:italic"># SummaryNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\n</span><span style="color:#b84">Finished in </span><span style="color:#b84">#{</span><span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">::</span><span style="color:#008080">Helpers</span><span style="font-weight:bold">.</span>format_duration(notification<span style="font-weight:bold">.</span>duration)<span style="color:#b84">}</span><span style="color:#b84">.</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">close</span> notification <span style="color:#998;font-style:italic"># NullNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>In the new <strong>dump_failures</strong> method we loop through every failed example. Then,
we extract the description and the location of the failed example and we build
a string that we append to the output. After this change, the output will look
like this:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Next thing, how do we add the error messages underneath every failing spec?
Lets expand the **dump_failures **method just a bit.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">GroupingFormatter</span>
  <span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">.</span>register <span style="color:#999">self</span>, <span style="color:#b84">:dump_pending</span>, <span style="color:#b84">:dump_failures</span>, <span style="color:#b84">:close</span>, <span style="color:#b84">:dump_summary</span>, <span style="color:#b84">:example_passed</span>, <span style="color:#b84">:example_failed</span>, <span style="color:#b84">:example_pending</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span> output
    @output <span style="font-weight:bold">=</span> output
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">example_passed</span> notification <span style="color:#998;font-style:italic"># ExampleNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">.</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">example_failed</span> notification <span style="color:#998;font-style:italic"># FailedExampleNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">F</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">example_pending</span> notification <span style="color:#998;font-style:italic"># ExampleNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">*</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">dump_pending</span> notification <span style="color:#998;font-style:italic"># ExamplesNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\n</span><span style="color:#b84">PENDING:</span><span style="color:#b84">\n</span><span style="color:#b84">\t</span><span style="color:#b84">&#34;</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> notification<span style="font-weight:bold">.</span>pending_examples<span style="font-weight:bold">.</span>map {<span style="font-weight:bold">|</span>example<span style="font-weight:bold">|</span> example<span style="font-weight:bold">.</span>full_description <span style="font-weight:bold">+</span> <span style="color:#b84">&#34;</span><span style="color:#b84"> - </span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">+</span> example<span style="font-weight:bold">.</span>location }<span style="font-weight:bold">.</span>join(<span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\t</span><span style="color:#b84">&#34;</span>)
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">dump_failures</span> notification <span style="color:#998;font-style:italic"># ExamplesNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">FAILING</span><span style="color:#b84">\n</span><span style="color:#b84">\t</span><span style="color:#b84">&#34;</span>
    <span style="color:#998;font-style:italic"># For every failed example...</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> notification<span style="font-weight:bold">.</span>failed_examples<span style="font-weight:bold">.</span>map <span style="font-weight:bold">do</span> <span style="font-weight:bold">|</span>example<span style="font-weight:bold">|</span>
      <span style="color:#998;font-style:italic"># Extract the full description of the example</span>
      full_description <span style="font-weight:bold">=</span> example<span style="font-weight:bold">.</span>full_description
      <span style="color:#998;font-style:italic"># Extract the example location in the file</span>
      location <span style="font-weight:bold">=</span> example<span style="font-weight:bold">.</span>location
      <span style="color:#998;font-style:italic"># Get the Exception message</span>
      message <span style="font-weight:bold">=</span> example<span style="font-weight:bold">.</span>execution_result<span style="font-weight:bold">.</span>exception<span style="font-weight:bold">.</span>message

      <span style="color:#b84">&#34;</span><span style="color:#b84">#{</span>full_description<span style="color:#b84">}</span><span style="color:#b84"> - </span><span style="color:#b84">#{</span>location<span style="color:#b84">}</span><span style="color:#b84"> </span><span style="color:#b84">#{</span>message<span style="color:#b84">}</span><span style="color:#b84">&#34;</span>
    <span style="font-weight:bold">end</span><span style="font-weight:bold">.</span>join(<span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\n</span><span style="color:#b84">\t</span><span style="color:#b84">&#34;</span>)
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">dump_summary</span> notification <span style="color:#998;font-style:italic"># SummaryNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\n</span><span style="color:#b84">Finished in </span><span style="color:#b84">#{</span><span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">::</span><span style="color:#008080">Helpers</span><span style="font-weight:bold">.</span>format_duration(notification<span style="font-weight:bold">.</span>duration)<span style="color:#b84">}</span><span style="color:#b84">.</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">close</span> notification <span style="color:#998;font-style:italic"># NullNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>The only addition is on line 34 - we extract the result of the execution of the
example, then we get the message of the exception that RSpec raised when the
example failed. Now, lets test it:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>This is all good, but you can see that the text alignment is broken a bit. If
you look at the picture at the beginning, you will notice that the exceptions
should appear indented underneath the description of the failing example. Lets
fix this.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">GroupingFormatter</span>
  <span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">.</span>register <span style="color:#999">self</span>, <span style="color:#b84">:dump_pending</span>, <span style="color:#b84">:dump_failures</span>, <span style="color:#b84">:close</span>,
    <span style="color:#b84">:dump_summary</span>, <span style="color:#b84">:example_passed</span>, <span style="color:#b84">:example_failed</span>, <span style="color:#b84">:example_pending</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span> output
    @output <span style="font-weight:bold">=</span> output
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">example_passed</span> notification <span style="color:#998;font-style:italic"># ExampleNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">.</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">example_failed</span> notification <span style="color:#998;font-style:italic"># FailedExampleNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">F</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">example_pending</span> notification <span style="color:#998;font-style:italic"># ExampleNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">*</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">dump_pending</span> notification <span style="color:#998;font-style:italic"># ExamplesNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\n</span><span style="color:#b84">PENDING:</span><span style="color:#b84">\n</span><span style="color:#b84">\t</span><span style="color:#b84">&#34;</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> notification<span style="font-weight:bold">.</span>pending_examples<span style="font-weight:bold">.</span>map {<span style="font-weight:bold">|</span>example<span style="font-weight:bold">|</span> example<span style="font-weight:bold">.</span>full_description <span style="font-weight:bold">+</span> <span style="color:#b84">&#34;</span><span style="color:#b84"> - </span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">+</span> example<span style="font-weight:bold">.</span>location }<span style="font-weight:bold">.</span>join(<span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\t</span><span style="color:#b84">&#34;</span>)
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">dump_failures</span> notification <span style="color:#998;font-style:italic"># ExamplesNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">FAILING</span><span style="color:#b84">\n</span><span style="color:#b84">\t</span><span style="color:#b84">&#34;</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> failed_examples_output(notification)
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">dump_summary</span> notification <span style="color:#998;font-style:italic"># SummaryNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\n</span><span style="color:#b84">Finished in </span><span style="color:#b84">#{</span><span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">::</span><span style="color:#008080">Helpers</span><span style="font-weight:bold">.</span>format_duration(notification<span style="font-weight:bold">.</span>duration)<span style="color:#b84">}</span><span style="color:#b84">.</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">close</span> notification <span style="color:#998;font-style:italic"># NullNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">private</span>

  <span style="color:#998;font-style:italic"># Loops through all of the failed examples and rebuilds the exception message</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">failed_examples_output</span> notification
    failed_examples_output <span style="font-weight:bold">=</span> notification<span style="font-weight:bold">.</span>failed_examples<span style="font-weight:bold">.</span>map <span style="font-weight:bold">do</span> <span style="font-weight:bold">|</span>example<span style="font-weight:bold">|</span>
      failed_example_output example
    <span style="font-weight:bold">end</span>
    build_examples_output(failed_examples_output)
  <span style="font-weight:bold">end</span>

  <span style="color:#998;font-style:italic"># Joins all exception messages</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">build_examples_output</span> output
    output<span style="font-weight:bold">.</span>join(<span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\n</span><span style="color:#b84">\t</span><span style="color:#b84">&#34;</span>)
  <span style="font-weight:bold">end</span>

  <span style="color:#998;font-style:italic"># Extracts the full_description, location and formats the message of each example exception</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">failed_example_output</span> example
    full_description <span style="font-weight:bold">=</span> example<span style="font-weight:bold">.</span>full_description
    location <span style="font-weight:bold">=</span> example<span style="font-weight:bold">.</span>location
    formatted_message <span style="font-weight:bold">=</span> strip_message_from_whitespace(example<span style="font-weight:bold">.</span>execution_result<span style="font-weight:bold">.</span>exception<span style="font-weight:bold">.</span>message)

    <span style="color:#b84">&#34;</span><span style="color:#b84">#{</span>full_description<span style="color:#b84">}</span><span style="color:#b84"> - </span><span style="color:#b84">#{</span>location<span style="color:#b84">}</span><span style="color:#b84"> </span><span style="color:#b84">\n</span><span style="color:#b84">  </span><span style="color:#b84">#{</span>formatted_message<span style="color:#b84">}</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="color:#998;font-style:italic"># Removes whitespace from each of the exception message lines and reformats it</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">strip_message_from_whitespace</span> msg
    msg<span style="font-weight:bold">.</span>split(<span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">&#34;</span>)<span style="font-weight:bold">.</span>map(<span style="font-weight:bold">&amp;</span><span style="color:#b84">:strip</span>)<span style="font-weight:bold">.</span>join(<span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">#{</span>add_spaces(<span style="color:#099">10</span><span style="font-weight:bold"></span>)<span style="color:#b84">}</span><span style="color:#b84">&#34;</span>)
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">add_spaces</span> n
    <span style="color:#b84">&#34;</span><span style="color:#b84"> </span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">*</span> n
  <span style="font-weight:bold">end</span>

<span style="font-weight:bold">end</span></code></pre></div>
<p>In the example above we took the extra step to format the error messages
nicely. Basically, we split the exception message on a new-line character,
we remove all the whitespace and we rejoin the pieces with a newline between
them and add 10 spaces at the beginning of the message (for the indentation).
Now, the output will look like this:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>And voila, the formatter is working as supposed. Or, is it? :) Lets add some
colors! Adding colors is really easy, we just need to require the
<a href="http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Formatters/ConsoleCodes">ConsoleCodes</a> module.
The ConsoleCodes module provides helpers for formatting console output with
ANSI codes, for example colors and bold. So, the final version of our
GroupingFormatter is:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#999">require</span> <span style="color:#b84">&#39;rspec/core/formatters/console_codes&#39;</span>

<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">GroupingFormatter</span>
  <span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">.</span>register <span style="color:#999">self</span>, <span style="color:#b84">:dump_pending</span>, <span style="color:#b84">:dump_failures</span>, <span style="color:#b84">:close</span>,
    <span style="color:#b84">:dump_summary</span>, <span style="color:#b84">:example_passed</span>, <span style="color:#b84">:example_failed</span>, <span style="color:#b84">:example_pending</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span> output
    @output <span style="font-weight:bold">=</span> output
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">example_passed</span> notification <span style="color:#998;font-style:italic"># ExampleNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">::</span><span style="color:#008080">ConsoleCodes</span><span style="font-weight:bold">.</span>wrap(<span style="color:#b84">&#34;</span><span style="color:#b84">.</span><span style="color:#b84">&#34;</span>, <span style="color:#b84">:success</span>)
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">example_failed</span> notification <span style="color:#998;font-style:italic"># FailedExampleNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">::</span><span style="color:#008080">ConsoleCodes</span><span style="font-weight:bold">.</span>wrap(<span style="color:#b84">&#34;</span><span style="color:#b84">F</span><span style="color:#b84">&#34;</span>, <span style="color:#b84">:failure</span>)
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">example_pending</span> notification <span style="color:#998;font-style:italic"># ExampleNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">::</span><span style="color:#008080">ConsoleCodes</span><span style="font-weight:bold">.</span>wrap(<span style="color:#b84">&#34;</span><span style="color:#b84">*</span><span style="color:#b84">&#34;</span>, <span style="color:#b84">:pending</span>)
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">dump_pending</span> notification <span style="color:#998;font-style:italic"># ExamplesNotification</span>
    <span style="font-weight:bold">if</span> notification<span style="font-weight:bold">.</span>pending_examples<span style="font-weight:bold">.</span>length <span style="font-weight:bold">&gt;</span> <span style="color:#099">0</span>
      <span style="font-weight:bold"></span>@output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\n</span><span style="color:#b84">#{</span><span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">::</span><span style="color:#008080">ConsoleCodes</span><span style="font-weight:bold">.</span>wrap(<span style="color:#b84">&#34;</span><span style="color:#b84">PENDING:</span><span style="color:#b84">&#34;</span>, <span style="color:#b84">:pending</span>)<span style="color:#b84">}</span><span style="color:#b84">\n</span><span style="color:#b84">\t</span><span style="color:#b84">&#34;</span>
      @output <span style="font-weight:bold">&lt;&lt;</span> notification<span style="font-weight:bold">.</span>pending_examples<span style="font-weight:bold">.</span>map {<span style="font-weight:bold">|</span>example<span style="font-weight:bold">|</span> example<span style="font-weight:bold">.</span>full_description <span style="font-weight:bold">+</span> <span style="color:#b84">&#34;</span><span style="color:#b84"> - </span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">+</span> example<span style="font-weight:bold">.</span>location }<span style="font-weight:bold">.</span>join(<span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\t</span><span style="color:#b84">&#34;</span>)
    <span style="font-weight:bold">end</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">dump_failures</span> notification <span style="color:#998;font-style:italic"># ExamplesNotification</span>
    <span style="font-weight:bold">if</span> notification<span style="font-weight:bold">.</span>failed_examples<span style="font-weight:bold">.</span>length <span style="font-weight:bold">&gt;</span> <span style="color:#099">0</span>
      <span style="font-weight:bold"></span>@output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">#{</span><span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">::</span><span style="color:#008080">ConsoleCodes</span><span style="font-weight:bold">.</span>wrap(<span style="color:#b84">&#34;</span><span style="color:#b84">FAILING:</span><span style="color:#b84">&#34;</span>, <span style="color:#b84">:failure</span>)<span style="color:#b84">}</span><span style="color:#b84">\n</span><span style="color:#b84">\t</span><span style="color:#b84">&#34;</span>
      @output <span style="font-weight:bold">&lt;&lt;</span> failed_examples_output(notification)
    <span style="font-weight:bold">end</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">dump_summary</span> notification <span style="color:#998;font-style:italic"># SummaryNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\n</span><span style="color:#b84">Finished in </span><span style="color:#b84">#{</span><span style="color:#008080">RSpec</span><span style="font-weight:bold">::</span><span style="color:#008080">Core</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatters</span><span style="font-weight:bold">::</span><span style="color:#008080">Helpers</span><span style="font-weight:bold">.</span>format_duration(notification<span style="font-weight:bold">.</span>duration)<span style="color:#b84">}</span><span style="color:#b84">.</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">close</span> notification <span style="color:#998;font-style:italic"># NullNotification</span>
    @output <span style="font-weight:bold">&lt;&lt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">private</span>

  <span style="color:#998;font-style:italic"># Loops through all of the failed examples and rebuilds the exception message</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">failed_examples_output</span> notification
    failed_examples_output <span style="font-weight:bold">=</span> notification<span style="font-weight:bold">.</span>failed_examples<span style="font-weight:bold">.</span>map <span style="font-weight:bold">do</span> <span style="font-weight:bold">|</span>example<span style="font-weight:bold">|</span>
      failed_example_output example
    <span style="font-weight:bold">end</span>
    build_examples_output(failed_examples_output)
  <span style="font-weight:bold">end</span>

  <span style="color:#998;font-style:italic"># Joins all exception messages</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">build_examples_output</span> output
    output<span style="font-weight:bold">.</span>join(<span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">\n</span><span style="color:#b84">\t</span><span style="color:#b84">&#34;</span>)
  <span style="font-weight:bold">end</span>

  <span style="color:#998;font-style:italic"># Extracts the full_description, location and formats the message of each example exception</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">failed_example_output</span> example
    full_description <span style="font-weight:bold">=</span> example<span style="font-weight:bold">.</span>full_description
    location <span style="font-weight:bold">=</span> example<span style="font-weight:bold">.</span>location
    formatted_message <span style="font-weight:bold">=</span> strip_message_from_whitespace(example<span style="font-weight:bold">.</span>execution_result<span style="font-weight:bold">.</span>exception<span style="font-weight:bold">.</span>message)

    <span style="color:#b84">&#34;</span><span style="color:#b84">#{</span>full_description<span style="color:#b84">}</span><span style="color:#b84"> - </span><span style="color:#b84">#{</span>location<span style="color:#b84">}</span><span style="color:#b84"> </span><span style="color:#b84">\n</span><span style="color:#b84">  </span><span style="color:#b84">#{</span>formatted_message<span style="color:#b84">}</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>

  <span style="color:#998;font-style:italic"># Removes whitespace from each of the exception message lines and reformats it</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">strip_message_from_whitespace</span> msg
    msg<span style="font-weight:bold">.</span>split(<span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">&#34;</span>)<span style="font-weight:bold">.</span>map(<span style="font-weight:bold">&amp;</span><span style="color:#b84">:strip</span>)<span style="font-weight:bold">.</span>join(<span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">#{</span>add_spaces(<span style="color:#099">10</span><span style="font-weight:bold"></span>)<span style="color:#b84">}</span><span style="color:#b84">&#34;</span>)
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">add_spaces</span> n
    <span style="color:#b84">&#34;</span><span style="color:#b84"> </span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">*</span> n
  <span style="font-weight:bold">end</span>

<span style="font-weight:bold">end</span></code></pre></div>
<p>As you can see, we are using the <em>ConsoleCodes.wrap</em> method which wraps a piece
of text in ANSI codes with the supplied code in the arguments. You can now test
our new colored formatter:</p>
<!-- raw HTML omitted -->
<h2 id="using-your-new-groupingformatter">Using your new GroupingFormatter</h2>
<p>Our formatter is now working, but how can we put it to use? One way to use it
is by running the specs and requiring the formatter in the RSpec command:</p>
<!-- raw HTML omitted -->
<p>This works alright. But, requiring your formatter every time you run your specs is boring.</p>
<h3 id="meet-rspec">Meet .rspec</h3>
<p>RSpec's documentation says that RSpec reads command line configuration options
from files in three different locations:</p>
<ul>
<li>Local: <code>./.rspec-local - </code>This file should exist in the project's root
directory. It can contain some private customizations (in the scope of the
project) of RSpec and should be ignored by git.</li>
<li>Project: <code>./.rspec</code>  - This file should exist in the project's root
directory. It usually contains public project-wide customizations of RSpec and
is usually checked into the git repo.</li>
<li>Global: <code>~/.rspec</code> - This file exists in the user's home directory. It can
contain some personal customizations of your RSpec and is applied to every
project where RSpec is used on your machine.</li>
</ul>
<p>So, we can add a <em>.rspec</em> file in our project's folder with the following
contents:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>RSpec will read this file every time we run our specs, so this means that we
can run our specs without specifying these options in the rspec command:</p>
<!-- raw HTML omitted -->
<p>This will now work with our new formatter.</p>
<h3 id="using-it-in-a-rails-app">Using it in a Rails app</h3>
<p>Lets integrate our new formatter in a Rails application. Using the formatter in
your Rails application is done in two steps:</p>
<ol>
<li>
<p>The formatter class must either be in Rails&rsquo; autoload path, or manually
required in the <em>spec_helper</em>. My personal preference is to require it manually
because it's more verbose.</p>
</li>
<li>
<p>In the <strong>RSpec.configure</strong> block in the <em>spec_helper</em>, you need to register
the formatter to RSpec. This is done by:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">    config<span style="font-weight:bold">.</span>formatter <span style="font-weight:bold">=</span> <span style="color:#008080">NameOfTheClass</span>
    </code></pre></div>
</li>
</ol>
<p>or, in our case:</p>
<pre><code><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">    config<span style="font-weight:bold">.</span>formatter <span style="font-weight:bold">=</span> <span style="color:#008080">GroupingFormatter</span>
    </code></pre></div>
</code></pre>
<p>That's it. Now when you run your specs the new formatter will be used by RSpec.</p>
<h2 id="outro">Outro</h2>
<p>I hope you found this (quite long) post informative and interesting. If any of
you wrote your own RSpec formatters, please, share them with me and the
others in the comments - I am very curious to see what you've come up with.
Thanks for reading to the very end!</p>

			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="/tags/testing">testing</a></li>
							
							<li><a href="/tags/formatters">formatters</a></li>
							
						</ul>
					
				
			</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = 'eftimov';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the </a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2015  Copyright © Ilija Eftimov |  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-11264459-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
