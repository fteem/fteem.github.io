<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to write RSpec formatters from scratch | Ilija Eftimov ⚡️</title><meta name=keywords content="testing,formatters"><meta name=description content="Recently I did an experiment with RSpec&rsquo;s formatters. Turns out, the output that RSpec returns when you run your specs can be very customized for your own needs. Read on to learn how you can write custom RSpec formatters.
Writing custom formatters RSpec allows customization of the output by creating your own Formatter class. Yep, it&rsquo;s that easy. You just need to write one class and than require it into RSpec&rsquo;s configuration to use it."><meta name=author content="Ilija Eftimov"><link rel=canonical href=https://ieftimov.com/post/how-to-write-rspec-formatters-from-scratch/><link crossorigin=anonymous href=/assets/css/stylesheet.min.css rel="preload stylesheet" as=style><link rel=icon href=https://ieftimov.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ieftimov.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ieftimov.com/favicon-32x32.png><link rel=apple-touch-icon href=https://ieftimov.com/apple-touch-icon.png><link rel=mask-icon href=https://ieftimov.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.83.1"><script async defer data-domain=ieftimov.com src=https://plausible.io/js/plausible.js></script><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel=stylesheet><meta property="og:title" content="How to write RSpec formatters from scratch"><meta property="og:description" content="Recently I did an experiment with RSpec&rsquo;s formatters. Turns out, the output that RSpec returns when you run your specs can be very customized for your own needs. Read on to learn how you can write custom RSpec formatters.
Writing custom formatters RSpec allows customization of the output by creating your own Formatter class. Yep, it&rsquo;s that easy. You just need to write one class and than require it into RSpec&rsquo;s configuration to use it."><meta property="og:type" content="article"><meta property="og:url" content="https://ieftimov.com/post/how-to-write-rspec-formatters-from-scratch/"><meta property="article:section" content="posts"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to write RSpec formatters from scratch"><meta name=twitter:description content="Recently I did an experiment with RSpec&rsquo;s formatters. Turns out, the output that RSpec returns when you run your specs can be very customized for your own needs. Read on to learn how you can write custom RSpec formatters.
Writing custom formatters RSpec allows customization of the output by creating your own Formatter class. Yep, it&rsquo;s that easy. You just need to write one class and than require it into RSpec&rsquo;s configuration to use it."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ieftimov.com/posts/"},{"@type":"ListItem","position":2,"name":"How to write RSpec formatters from scratch","item":"https://ieftimov.com/post/how-to-write-rspec-formatters-from-scratch/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to write RSpec formatters from scratch","name":"How to write RSpec formatters from scratch","description":"Recently I did an experiment with RSpec\u0026rsquo;s formatters. Turns out, the output that RSpec returns when you run your specs can be very customized for your own needs. Read on to learn how you can write custom RSpec formatters.\nWriting custom formatters RSpec allows customization of the output by creating your own Formatter class. Yep, it\u0026rsquo;s that easy. You just need to write one class and than require it into RSpec\u0026rsquo;s configuration to use it.","keywords":["testing","formatters"],"articleBody":"Recently I did an experiment with RSpec’s formatters. Turns out, the output that RSpec returns when you run your specs can be very customized for your own needs. Read on to learn how you can write custom RSpec formatters.\nWriting custom formatters RSpec allows customization of the output by creating your own Formatter class. Yep, it’s that easy. You just need to write one class and than require it into RSpec’s configuration to use it. Lets explore couple of key concepts about the formatters and it’s internals.\nThe Protocol First thing to be aware of is the protocol (the order) that RSpec uses when calling methods from the formatter. Keep in mind that every method receives one argument, which is a Notification object. This is sent by the RSpec reporter which notifies the formatter of the outcome of the example. On the beginning **Formatter#start **is called. This method takes a notification argument of the class StartNotification. On every example group, Formatter#example_group_started is called. This method takes a notification argument of the class GroupNotification. When an example is ran, one of these methods is called, based on the result of the example:\n If the example passes, **Formatter#example_passed **is called. The notification argument is of class ExampleNotification. If the example fails, **Formatter#example_failed **is called. The notification argument is of class FailedExampleNotification. If the example is pending, **Formatter#example_pending **is called. The notification argument is of class ExampleNotification.  At the end of the spec suite, these methods are called in this order:\n Formatter#stop. The notification passed as argument is of class ExamplesNotification. Formatter#start_dump. The notification passed as argument is of class NullNotification. Formatter#dump_pending. The notification passed as argument is of class ExamplesNotification. Formatter#dump_failures. The notification passed as argument is of class ExamplesNotification. Formatter#dump_summary. The notification passed as argument is of class SummaryNotification. Formatter#seed. The notification passed as argument is of class SeedNotification. Formatter#close. The notification passed as argument is of class NullNotification.  I wont go into detail for every of the notification classes. You can dive in the details about each of them in the links that I have attached.\nRegistering your formatter class to RSpec RSpec provides this neat feature of registering a class as a formatter. This is done by creating the class and calling:\nRSpec::Core::Formatters.register the class name, array of symbols representing the methods that this formatter will provide So, say we want a formatter that shows the progress of the suite, just like the built-in progress formatter, but it will group the failing and the pending specs in the summary of the suite.\nCreating the the GroupingFormatter class class GroupingFormatter RSpec::Core::Formatters.register self, :dump_summary, :close def initialize output @output = output end def dump_summary notification # SummaryNotification @output  \"\\n\\nFinished in #{notification.duration}.\" end def close notification # NullNotification @output  \"\\n\" end end As you can see, the GroupingFormatter is just a class. In it’s initializer it takes the output as an argument and sets it as an instance variable. Also, on line 2, you can see the aforementioned RSpec.register call. We pass self as the first argument, because we want to register this class as a formatter. The rest of the arguments are method names that RSpec will call when using this formatter. What this means is that when you define a method for **the protocol, **if you don’t register it - it will not be called. Basically, RSpec won’t know it exists at all. Next, the dump_summary method calls the duration method on the notification object, which returns a number representing the time of the specs' duration in seconds. So, how can we test if this is working? The command is:\nrspec some_file.rb --require ./grouping_formatter.rb --format GroupingFormatter And the output is:\nFinished in 0.007552. Now, this doesn’t tell much. Let’s use RSpec’s built in helpers to format this number in a meaningful string.\nclass GroupingFormatter RSpec::Core::Formatters.register self, :dump_summary, :close def initialize output @output = output end def dump_summary notification # SummaryNotification @output  \"\\n\\nFinished in #{RSpec::Core::Formatters::Helpers.format_duration(notification.duration)}.\" end def close notification # NullNotification @output  \"\\n\" end end In the dump_summary method we use the RSpec::Core::Formatters::Helpers module which has some methods that can help us turn the duration number into a meaningful string. The output now looks like:\nOkay, great. Now, lets make this formatter mimic the reporting formatter that comes with RSpec. We need the formatter to show a dot for every passing example, F for every failing example and an asterisk for every pending example.\nclass GroupingFormatter RSpec::Core::Formatters.register self, :dump_summary, :close, :example_passed, :example_failed, :example_pending def initialize output @output = output end def example_passed notification # ExampleNotification @output  \".\" end def example_failed notification # FailedExampleNotification @output  \"F\" end def example_pending notification # ExampleNotification @output  \"*\" end def dump_summary notification # SummaryNotification @output  \"\\n\\nFinished in #{RSpec::Core::Formatters::Helpers.format_duration(notification.duration)}.\" end def close notification # NullNotification @output  \"\\n\" end end So, the reporter (the algorithm that follows the protocol) will call example_failed when an example fails, example_pending when an example is pending and **example_passed **when an example passes. This is really self-explanatory - we add the case specific character to the output for every example. Take note that I added the method names to the RSpec.register call. If I didn’t - they’d be ignored. The output will now look like:\nLooking good, things are starting to take shape! Now for the more complicated part. How can we group the pending/failing specs? First, lets group the pending specs.\nclass GroupingFormatter RSpec::Core::Formatters.register self, :dump_summary, :close, :example_passed, :example_failed, :example_pending, :dump_pending def initialize output @output = output end def example_passed notification # ExampleNotification @output  \".\" end def example_failed notification # FailedExampleNotification @output  \"F\" end def example_pending notification # ExampleNotification @output  \"*\" end def dump_pending notification # ExamplesNotification @output  \"\\n\\nPENDING:\\n\\t\" @output  notification.pending_examples.map {|example| example.full_description + \" - \" + example.location }.join(\"\\n\\t\") end def dump_summary notification # SummaryNotification @output  \"\\n\\nFinished in #{RSpec::Core::Formatters::Helpers.format_duration(notification.duration)}.\" end def close notification # NullNotification @output  \"\\n\" end end Lets look at the dump_pending method now. First, it adds “PENDING” to the output. Next, it loops through the pending_examples array and creates an array of strings for each of the pending examples. Note that I added the new method to the RSpec.register call, it would be ignored otherwise. Each string in the array will look something like this:\nAt the end, we call _join _on the array of strings to build a single formatted string that we append to the output. Now when we run the specs with the formatter, the output will look like:\nLooking good. Now, for the trickiest part, grouping the failing specs and adding the error underneath every failing spec.\nclass GroupingFormatter RSpec::Core::Formatters.register self, :dump_pending, :dump_failures, :close, :dump_summary, :example_passed, :example_failed, :example_pending def initialize output @output = output end def example_passed notification # ExampleNotification @output  \".\" end def example_failed notification # FailedExampleNotification @output  \"F\" end def example_pending notification # ExampleNotification @output  \"*\" end def dump_pending notification # ExamplesNotification @output  \"\\n\\nPENDING:\\n\\t\" @output  notification.pending_examples.map {|example| example.full_description + \" - \" + example.location }.join(\"\\n\\t\") end def dump_failures notification # ExamplesNotification @output  \"\\nFAILING\\n\\t\" # For every failed example... @output  notification.failed_examples.map do |example| # Extract the full description of the example full_description = example.full_description # Extract the example location in the file location = example.location \"#{full_description}- #{location}\" end.join(\"\\n\\n\\t\") end def dump_summary notification # SummaryNotification @output  \"\\n\\nFinished in #{RSpec::Core::Formatters::Helpers.format_duration(notification.duration)}.\" end def close notification # NullNotification @output  \"\\n\" end end In the new dump_failures method we loop through every failed example. Then, we extract the description and the location of the failed example and we build a string that we append to the output. After this change, the output will look like this:\nNext thing, how do we add the error messages underneath every failing spec? Lets expand the **dump_failures **method just a bit.\nclass GroupingFormatter RSpec::Core::Formatters.register self, :dump_pending, :dump_failures, :close, :dump_summary, :example_passed, :example_failed, :example_pending def initialize output @output = output end def example_passed notification # ExampleNotification @output  \".\" end def example_failed notification # FailedExampleNotification @output  \"F\" end def example_pending notification # ExampleNotification @output  \"*\" end def dump_pending notification # ExamplesNotification @output  \"\\n\\nPENDING:\\n\\t\" @output  notification.pending_examples.map {|example| example.full_description + \" - \" + example.location }.join(\"\\n\\t\") end def dump_failures notification # ExamplesNotification @output  \"\\nFAILING\\n\\t\" # For every failed example... @output  notification.failed_examples.map do |example| # Extract the full description of the example full_description = example.full_description # Extract the example location in the file location = example.location # Get the Exception message message = example.execution_result.exception.message \"#{full_description}- #{location}#{message}\" end.join(\"\\n\\n\\t\") end def dump_summary notification # SummaryNotification @output  \"\\n\\nFinished in #{RSpec::Core::Formatters::Helpers.format_duration(notification.duration)}.\" end def close notification # NullNotification @output  \"\\n\" end end The only addition is on line 34 - we extract the result of the execution of the example, then we get the message of the exception that RSpec raised when the example failed. Now, lets test it:\nThis is all good, but you can see that the text alignment is broken a bit. If you look at the picture at the beginning, you will notice that the exceptions should appear indented underneath the description of the failing example. Lets fix this.\nclass GroupingFormatter RSpec::Core::Formatters.register self, :dump_pending, :dump_failures, :close, :dump_summary, :example_passed, :example_failed, :example_pending def initialize output @output = output end def example_passed notification # ExampleNotification @output  \".\" end def example_failed notification # FailedExampleNotification @output  \"F\" end def example_pending notification # ExampleNotification @output  \"*\" end def dump_pending notification # ExamplesNotification @output  \"\\n\\nPENDING:\\n\\t\" @output  notification.pending_examples.map {|example| example.full_description + \" - \" + example.location }.join(\"\\n\\t\") end def dump_failures notification # ExamplesNotification @output  \"\\nFAILING\\n\\t\" @output  failed_examples_output(notification) end def dump_summary notification # SummaryNotification @output  \"\\n\\nFinished in #{RSpec::Core::Formatters::Helpers.format_duration(notification.duration)}.\" end def close notification # NullNotification @output  \"\\n\" end private # Loops through all of the failed examples and rebuilds the exception message def failed_examples_output notification failed_examples_output = notification.failed_examples.map do |example| failed_example_output example end build_examples_output(failed_examples_output) end # Joins all exception messages def build_examples_output output output.join(\"\\n\\n\\t\") end # Extracts the full_description, location and formats the message of each example exception def failed_example_output example full_description = example.full_description location = example.location formatted_message = strip_message_from_whitespace(example.execution_result.exception.message) \"#{full_description}- #{location}\\n#{formatted_message}\" end # Removes whitespace from each of the exception message lines and reformats it def strip_message_from_whitespace msg msg.split(\"\\n\").map(\u0026:strip).join(\"\\n#{add_spaces(10)}\") end def add_spaces n \" \" * n end end In the example above we took the extra step to format the error messages nicely. Basically, we split the exception message on a new-line character, we remove all the whitespace and we rejoin the pieces with a newline between them and add 10 spaces at the beginning of the message (for the indentation). Now, the output will look like this:\nAnd voila, the formatter is working as supposed. Or, is it? :) Lets add some colors! Adding colors is really easy, we just need to require the ConsoleCodes module. The ConsoleCodes module provides helpers for formatting console output with ANSI codes, for example colors and bold. So, the final version of our GroupingFormatter is:\nrequire 'rspec/core/formatters/console_codes' class GroupingFormatter RSpec::Core::Formatters.register self, :dump_pending, :dump_failures, :close, :dump_summary, :example_passed, :example_failed, :example_pending def initialize output @output = output end def example_passed notification # ExampleNotification @output  RSpec::Core::Formatters::ConsoleCodes.wrap(\".\", :success) end def example_failed notification # FailedExampleNotification @output  RSpec::Core::Formatters::ConsoleCodes.wrap(\"F\", :failure) end def example_pending notification # ExampleNotification @output  RSpec::Core::Formatters::ConsoleCodes.wrap(\"*\", :pending) end def dump_pending notification # ExamplesNotification if notification.pending_examples.length  0 @output  \"\\n\\n#{RSpec::Core::Formatters::ConsoleCodes.wrap(\"PENDING:\", :pending)}\\n\\t\" @output  notification.pending_examples.map {|example| example.full_description + \" - \" + example.location }.join(\"\\n\\t\") end end def dump_failures notification # ExamplesNotification if notification.failed_examples.length  0 @output  \"\\n#{RSpec::Core::Formatters::ConsoleCodes.wrap(\"FAILING:\", :failure)}\\n\\t\" @output  failed_examples_output(notification) end end def dump_summary notification # SummaryNotification @output  \"\\n\\nFinished in #{RSpec::Core::Formatters::Helpers.format_duration(notification.duration)}.\" end def close notification # NullNotification @output  \"\\n\" end private # Loops through all of the failed examples and rebuilds the exception message def failed_examples_output notification failed_examples_output = notification.failed_examples.map do |example| failed_example_output example end build_examples_output(failed_examples_output) end # Joins all exception messages def build_examples_output output output.join(\"\\n\\n\\t\") end # Extracts the full_description, location and formats the message of each example exception def failed_example_output example full_description = example.full_description location = example.location formatted_message = strip_message_from_whitespace(example.execution_result.exception.message) \"#{full_description}- #{location}\\n#{formatted_message}\" end # Removes whitespace from each of the exception message lines and reformats it def strip_message_from_whitespace msg msg.split(\"\\n\").map(\u0026:strip).join(\"\\n#{add_spaces(10)}\") end def add_spaces n \" \" * n end end As you can see, we are using the ConsoleCodes.wrap method which wraps a piece of text in ANSI codes with the supplied code in the arguments. You can now test our new colored formatter:\nUsing your new GroupingFormatter Our formatter is now working, but how can we put it to use? One way to use it is by running the specs and requiring the formatter in the RSpec command:\nThis works alright. But, requiring your formatter every time you run your specs is boring.\nMeet .rspec RSpec’s documentation says that RSpec reads command line configuration options from files in three different locations:\n Local: ./.rspec-local - This file should exist in the project’s root directory. It can contain some private customizations (in the scope of the project) of RSpec and should be ignored by git. Project: ./.rspec - This file should exist in the project’s root directory. It usually contains public project-wide customizations of RSpec and is usually checked into the git repo. Global: ~/.rspec - This file exists in the user’s home directory. It can contain some personal customizations of your RSpec and is applied to every project where RSpec is used on your machine.  So, we can add a .rspec file in our project’s folder with the following contents:\nRSpec will read this file every time we run our specs, so this means that we can run our specs without specifying these options in the rspec command:\nThis will now work with our new formatter.\nUsing it in a Rails app Lets integrate our new formatter in a Rails application. Using the formatter in your Rails application is done in two steps:\n  The formatter class must either be in Rails' autoload path, or manually required in the spec_helper. My personal preference is to require it manually because it’s more verbose.\n  In the RSpec.configure block in the spec_helper, you need to register the formatter to RSpec. This is done by:\nconfig.formatter = NameOfTheClass    or, in our case:\nconfig.formatter = GroupingFormatter   That’s it. Now when you run your specs the new formatter will be used by RSpec.\nOutro I hope you found this (quite long) post informative and interesting. If any of you wrote your own RSpec formatters, please, share them with me and the others in the comments - I am very curious to see what you’ve come up with. Thanks for reading to the very end!\nLiked this article? Subscribe to my newsletter and get future articles in your inbox. It's a short and sweet read, going out to hundreds of other engineers.\n    ","wordCount":"2449","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"Ilija Eftimov"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ieftimov.com/post/how-to-write-rspec-formatters-from-scratch/"},"publisher":{"@type":"Organization","name":"Ilija Eftimov ⚡️","logo":{"@type":"ImageObject","url":"https://ieftimov.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://ieftimov.com/ accesskey=h title="Ilija Eftimov ⚡️ (Alt + H)">Ilija Eftimov ⚡️</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://ieftimov.com/ title=About><span>About</span></a></li><li><a href=https://ieftimov.com/posts title=Writing><span>Writing</span></a></li><li><a href=https://ieftimov.com/newsletter title=Newsletter><span>Newsletter</span></a></li><li><a href=https://forms.gle/orfXK5jh1LRaiFzo8 title="Suggest a topic"><span>Suggest a topic</span></a></li><li><a href=https://www.buymeacoffee.com/ieftimov title="Buy me a ☕"><span>Buy me a ☕</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>How to write RSpec formatters from scratch</h1><div class=post-meta>April 28, 2015&nbsp;·&nbsp;12 min&nbsp;·&nbsp;Ilija Eftimov</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#writing-custom-formatters aria-label="Writing custom formatters">Writing custom formatters</a><ul><li><a href=#the-protocol aria-label="The Protocol">The Protocol</a></li><li><a href=#registering-your-formatter-class-to-rspec aria-label="Registering your formatter class to RSpec">Registering your formatter class to RSpec</a></li><li><a href=#creating-thethe-groupingformatter-class aria-label="Creating the the GroupingFormatter class">Creating the the GroupingFormatter class</a></li></ul></li><li><a href=#using-your-new-groupingformatter aria-label="Using your new GroupingFormatter">Using your new GroupingFormatter</a><ul><li><a href=#meet-rspec aria-label="Meet .rspec">Meet .rspec</a></li><li><a href=#using-it-in-a-rails-app aria-label="Using it in a Rails app">Using it in a Rails app</a></li></ul></li><li><a href=#outro aria-label=Outro>Outro</a></li></ul></div></details></div><div class=post-content><p>Recently I did an experiment with RSpec&rsquo;s formatters. Turns out, the output
that RSpec returns when you run your specs can be very customized for your own
needs. Read on to learn how you can write custom RSpec formatters.</p><h2 id=writing-custom-formatters>Writing custom formatters<a hidden class=anchor aria-hidden=true href=#writing-custom-formatters>#</a></h2><p>RSpec allows customization of the output by creating your own Formatter class.
Yep, it&rsquo;s that easy. You just need to write one class and than require it into
RSpec&rsquo;s configuration to use it. Lets explore couple of key concepts about the
formatters and it&rsquo;s internals.</p><h3 id=the-protocol>The Protocol<a hidden class=anchor aria-hidden=true href=#the-protocol>#</a></h3><p>First thing to be aware of is the protocol (the order) that RSpec uses when
calling methods from the formatter. Keep in mind that every method receives
one argument, which is a Notification object. This is sent by the RSpec
reporter which notifies the formatter of the outcome of the example. On the
beginning **Formatter#start **is called. This method takes a notification
argument of the
class <a href=http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/StartNotification>StartNotification</a>.
On every example group, <strong>Formatter#example_group_started</strong> is called. This
method takes a notification argument of the class
<a href=http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/GroupNotification>GroupNotification</a>.
When an example is ran, one of these methods is called, based on the result of
the example:</p><ul><li>If the example passes, **Formatter#example_passed **is called. The
notification argument is of class
<a href=http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/ExampleNotification>ExampleNotification</a>.</li><li>If the example fails, **Formatter#example_failed **is called. The
notification argument is of class
 <a href=http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/FailedExampleNotification>FailedExampleNotification</a>.</li><li>If the example is pending, **Formatter#example_pending **is called. The
notification argument is of
class <a href=http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/ExampleNotification>ExampleNotification</a>.</li></ul><p>At the end of the spec suite, these methods are called in this order:</p><ul><li><strong>Formatter#stop</strong>. The notification passed as argument is of
class <a href=http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/ExamplesNotification>ExamplesNotification</a>.</li><li><strong>Formatter#start_dump</strong>. The notification passed as argument is of class
<a href=http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/NullNotification>NullNotification</a>.</li><li><strong>Formatter#dump_pending</strong>. The notification passed as argument is of class
<a href=http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/ExamplesNotification>ExamplesNotification</a>.</li><li><strong>Formatter#dump_failures</strong>. The notification passed as argument is of
class
<a href=http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/ExamplesNotification>ExamplesNotification</a>.</li><li><strong>Formatter#dump_summary</strong>. The notification passed as argument is of class
<a href=http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/SummaryNotification>SummaryNotification</a>.</li><li><strong>Formatter#seed</strong>. The notification passed as argument is of class
<a href=http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/SeedNotification>SeedNotification</a>.</li><li><strong>Formatter#close</strong>. The notification passed as argument is of class
<a href=http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Notifications/NullNotification>NullNotification</a>.</li></ul><p>I wont go into detail for every of the notification classes. You can dive in
the details about each of them in the links that I have attached.</p><h3 id=registering-your-formatter-class-to-rspec>Registering your formatter class to RSpec<a hidden class=anchor aria-hidden=true href=#registering-your-formatter-class-to-rspec>#</a></h3><p>RSpec provides this neat feature of registering a class as a formatter. This is
done by creating the class and calling:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>.</span>register <span style=color:#719e07>&lt;</span>the <span style=color:#719e07>class</span> <span style=color:#b58900>name</span><span style=color:#719e07>&gt;</span>, <span style=color:#719e07>&lt;</span>array of symbols representing the <span style=color:#b58900>methods</span> that this formatter will provide<span style=color:#719e07>&gt;</span></code></pre></div><p>So, say we want a formatter that shows the progress of the suite, just like the
built-in progress formatter, but it will group the failing and the pending
specs in the summary of the suite.</p><h3 id=creating-thethe-groupingformatter-class>Creating the the GroupingFormatter class<a hidden class=anchor aria-hidden=true href=#creating-thethe-groupingformatter-class>#</a></h3><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#719e07>class</span> <span style=color:#268bd2>GroupingFormatter</span>
  <span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>.</span>register <span style=color:#b58900>self</span>, <span style=color:#2aa198>:dump_summary</span>, <span style=color:#2aa198>:close</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>initialize</span> output
    @output <span style=color:#719e07>=</span> output
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>dump_summary</span> notification <span style=color:#586e75># SummaryNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\n</span><span style=color:#2aa198>Finished in </span><span style=color:#2aa198>#{</span>notification<span style=color:#719e07>.</span>duration<span style=color:#2aa198>}</span><span style=color:#2aa198>.&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>close</span> notification <span style=color:#586e75># NullNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>
  <span style=color:#719e07>end</span>
<span style=color:#719e07>end</span></code></pre></div><p>As you can see, the GroupingFormatter is just a class. In it&rsquo;s initializer
it takes the output as an argument and sets it as an instance variable. Also,
on line 2, you can see the aforementioned <strong>RSpec.register</strong> call. We pass
<em>self</em> as the first argument, because we want to register this class as a
formatter. The rest of the arguments are method names that RSpec will call when
using this formatter. What this means is that when you define a method for
**the protocol, **if you don&rsquo;t register it - it will not be called. Basically,
RSpec won&rsquo;t know it exists at all. Next, the <strong>dump_summary</strong> method calls the
duration method on the notification object, which returns a number representing
the time of the specs' duration in seconds. So, how can we test if this is
working? The command is:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>rspec some_file.rb --require ./grouping_formatter.rb --format GroupingFormatter</code></pre></div><p>And the output is:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Finished in 0.007552.</code></pre></div><p>Now, this doesn&rsquo;t tell much. Let&rsquo;s use RSpec&rsquo;s built in helpers to format this
number in a meaningful string.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#719e07>class</span> <span style=color:#268bd2>GroupingFormatter</span>
  <span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>.</span>register <span style=color:#b58900>self</span>, <span style=color:#2aa198>:dump_summary</span>, <span style=color:#2aa198>:close</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>initialize</span> output
    @output <span style=color:#719e07>=</span> output
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>dump_summary</span> notification <span style=color:#586e75># SummaryNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\n</span><span style=color:#2aa198>Finished in </span><span style=color:#2aa198>#{</span><span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Helpers</span><span style=color:#719e07>.</span>format_duration(notification<span style=color:#719e07>.</span>duration)<span style=color:#2aa198>}</span><span style=color:#2aa198>.&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>close</span> notification <span style=color:#586e75># NullNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>
  <span style=color:#719e07>end</span>
<span style=color:#719e07>end</span></code></pre></div><p>In the <strong>dump_summary</strong> method we use the
<a href=http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Formatters/Helpers>RSpec::Core::Formatters::Helpers</a>
module which has some methods that can help us turn the duration number into a
meaningful string. The output now looks like:</p><p>Okay, great. Now, lets make this formatter mimic the reporting formatter that
comes with RSpec. We need the formatter to show a dot for every passing
example, F for every failing example and an asterisk for every pending example.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#719e07>class</span> <span style=color:#268bd2>GroupingFormatter</span>
  <span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>.</span>register <span style=color:#b58900>self</span>, <span style=color:#2aa198>:dump_summary</span>, <span style=color:#2aa198>:close</span>, <span style=color:#2aa198>:example_passed</span>, <span style=color:#2aa198>:example_failed</span>, <span style=color:#2aa198>:example_pending</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>initialize</span> output
    @output <span style=color:#719e07>=</span> output
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>example_passed</span> notification <span style=color:#586e75># ExampleNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;.&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>example_failed</span> notification <span style=color:#586e75># FailedExampleNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;F&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>example_pending</span> notification <span style=color:#586e75># ExampleNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;*&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>dump_summary</span> notification <span style=color:#586e75># SummaryNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\n</span><span style=color:#2aa198>Finished in </span><span style=color:#2aa198>#{</span><span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Helpers</span><span style=color:#719e07>.</span>format_duration(notification<span style=color:#719e07>.</span>duration)<span style=color:#2aa198>}</span><span style=color:#2aa198>.&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>close</span> notification <span style=color:#586e75># NullNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>
  <span style=color:#719e07>end</span>
<span style=color:#719e07>end</span></code></pre></div><p>So, the reporter (the algorithm that follows the protocol) will call
<strong>example_failed</strong> when an example fails, <strong>example_pending</strong> when an example
is pending and **example_passed **when an example passes. This is really
self-explanatory - we add the case specific character to the output for every
example. Take note that I added the method names to
the <strong>RSpec.register</strong> call. If I didn&rsquo;t - they&rsquo;d be ignored. The output will
now look like:</p><p>Looking good, things are starting to take shape! Now for the more complicated
part. How can we group the pending/failing specs? First, lets group the pending
specs.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#719e07>class</span> <span style=color:#268bd2>GroupingFormatter</span>
  <span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>.</span>register <span style=color:#b58900>self</span>, <span style=color:#2aa198>:dump_summary</span>, <span style=color:#2aa198>:close</span>, <span style=color:#2aa198>:example_passed</span>,
    <span style=color:#2aa198>:example_failed</span>, <span style=color:#2aa198>:example_pending</span>, <span style=color:#2aa198>:dump_pending</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>initialize</span> output
    @output <span style=color:#719e07>=</span> output
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>example_passed</span> notification <span style=color:#586e75># ExampleNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;.&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>example_failed</span> notification <span style=color:#586e75># FailedExampleNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;F&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>example_pending</span> notification <span style=color:#586e75># ExampleNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;*&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>dump_pending</span> notification <span style=color:#586e75># ExamplesNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\n</span><span style=color:#2aa198>PENDING:</span><span style=color:#cb4b16>\n\t</span><span style=color:#2aa198>&#34;</span>
    @output <span style=color:#719e07>&lt;&lt;</span> notification<span style=color:#719e07>.</span>pending_examples<span style=color:#719e07>.</span>map {<span style=color:#719e07>|</span>example<span style=color:#719e07>|</span> example<span style=color:#719e07>.</span>full_description <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34; - &#34;</span> <span style=color:#719e07>+</span> example<span style=color:#719e07>.</span>location }<span style=color:#719e07>.</span>join(<span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\t</span><span style=color:#2aa198>&#34;</span>)
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>dump_summary</span> notification <span style=color:#586e75># SummaryNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\n</span><span style=color:#2aa198>Finished in </span><span style=color:#2aa198>#{</span><span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Helpers</span><span style=color:#719e07>.</span>format_duration(notification<span style=color:#719e07>.</span>duration)<span style=color:#2aa198>}</span><span style=color:#2aa198>.&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>close</span> notification <span style=color:#586e75># NullNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>
  <span style=color:#719e07>end</span>
<span style=color:#719e07>end</span></code></pre></div><p>Lets look at the <strong>dump_pending</strong> method now. First, it adds &ldquo;PENDING&rdquo; to the
output. Next, it loops through the <em>pending_examples</em> array and creates an
array of strings for each of the pending examples. Note that I added the new
method to the RSpec.register call, it would be ignored otherwise. Each string
in the array will look something like this:</p><p>At the end, we call _join _on the array of strings to build a single formatted
string that we append to the output. Now when we run the specs with the
formatter, the output will look like:</p><p>Looking good. Now, for the trickiest part, grouping the failing specs and
adding the error underneath every failing spec.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#719e07>class</span> <span style=color:#268bd2>GroupingFormatter</span>
  <span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>.</span>register <span style=color:#b58900>self</span>, <span style=color:#2aa198>:dump_pending</span>, <span style=color:#2aa198>:dump_failures</span>, <span style=color:#2aa198>:close</span>, <span style=color:#2aa198>:dump_summary</span>, <span style=color:#2aa198>:example_passed</span>, <span style=color:#2aa198>:example_failed</span>, <span style=color:#2aa198>:example_pending</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>initialize</span> output
    @output <span style=color:#719e07>=</span> output
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>example_passed</span> notification <span style=color:#586e75># ExampleNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;.&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>example_failed</span> notification <span style=color:#586e75># FailedExampleNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;F&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>example_pending</span> notification <span style=color:#586e75># ExampleNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;*&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>dump_pending</span> notification <span style=color:#586e75># ExamplesNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\n</span><span style=color:#2aa198>PENDING:</span><span style=color:#cb4b16>\n\t</span><span style=color:#2aa198>&#34;</span>
    @output <span style=color:#719e07>&lt;&lt;</span> notification<span style=color:#719e07>.</span>pending_examples<span style=color:#719e07>.</span>map {<span style=color:#719e07>|</span>example<span style=color:#719e07>|</span> example<span style=color:#719e07>.</span>full_description <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34; - &#34;</span> <span style=color:#719e07>+</span> example<span style=color:#719e07>.</span>location }<span style=color:#719e07>.</span>join(<span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\t</span><span style=color:#2aa198>&#34;</span>)
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>dump_failures</span> notification <span style=color:#586e75># ExamplesNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>FAILING</span><span style=color:#cb4b16>\n\t</span><span style=color:#2aa198>&#34;</span>
    <span style=color:#586e75># For every failed example...</span>
    @output <span style=color:#719e07>&lt;&lt;</span> notification<span style=color:#719e07>.</span>failed_examples<span style=color:#719e07>.</span>map <span style=color:#719e07>do</span> <span style=color:#719e07>|</span>example<span style=color:#719e07>|</span>
      <span style=color:#586e75># Extract the full description of the example</span>
      full_description <span style=color:#719e07>=</span> example<span style=color:#719e07>.</span>full_description
      <span style=color:#586e75># Extract the example location in the file</span>
      location <span style=color:#719e07>=</span> example<span style=color:#719e07>.</span>location

      <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>#{</span>full_description<span style=color:#2aa198>}</span><span style=color:#2aa198> - </span><span style=color:#2aa198>#{</span>location<span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>
    <span style=color:#719e07>end</span><span style=color:#719e07>.</span>join(<span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\n\t</span><span style=color:#2aa198>&#34;</span>)
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>dump_summary</span> notification <span style=color:#586e75># SummaryNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\n</span><span style=color:#2aa198>Finished in </span><span style=color:#2aa198>#{</span><span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Helpers</span><span style=color:#719e07>.</span>format_duration(notification<span style=color:#719e07>.</span>duration)<span style=color:#2aa198>}</span><span style=color:#2aa198>.&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>close</span> notification <span style=color:#586e75># NullNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>
  <span style=color:#719e07>end</span>
<span style=color:#719e07>end</span></code></pre></div><p>In the new <strong>dump_failures</strong> method we loop through every failed example. Then,
we extract the description and the location of the failed example and we build
a string that we append to the output. After this change, the output will look
like this:</p><p>Next thing, how do we add the error messages underneath every failing spec?
Lets expand the **dump_failures **method just a bit.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#719e07>class</span> <span style=color:#268bd2>GroupingFormatter</span>
  <span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>.</span>register <span style=color:#b58900>self</span>, <span style=color:#2aa198>:dump_pending</span>, <span style=color:#2aa198>:dump_failures</span>, <span style=color:#2aa198>:close</span>, <span style=color:#2aa198>:dump_summary</span>, <span style=color:#2aa198>:example_passed</span>, <span style=color:#2aa198>:example_failed</span>, <span style=color:#2aa198>:example_pending</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>initialize</span> output
    @output <span style=color:#719e07>=</span> output
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>example_passed</span> notification <span style=color:#586e75># ExampleNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;.&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>example_failed</span> notification <span style=color:#586e75># FailedExampleNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;F&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>example_pending</span> notification <span style=color:#586e75># ExampleNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;*&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>dump_pending</span> notification <span style=color:#586e75># ExamplesNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\n</span><span style=color:#2aa198>PENDING:</span><span style=color:#cb4b16>\n\t</span><span style=color:#2aa198>&#34;</span>
    @output <span style=color:#719e07>&lt;&lt;</span> notification<span style=color:#719e07>.</span>pending_examples<span style=color:#719e07>.</span>map {<span style=color:#719e07>|</span>example<span style=color:#719e07>|</span> example<span style=color:#719e07>.</span>full_description <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34; - &#34;</span> <span style=color:#719e07>+</span> example<span style=color:#719e07>.</span>location }<span style=color:#719e07>.</span>join(<span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\t</span><span style=color:#2aa198>&#34;</span>)
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>dump_failures</span> notification <span style=color:#586e75># ExamplesNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>FAILING</span><span style=color:#cb4b16>\n\t</span><span style=color:#2aa198>&#34;</span>
    <span style=color:#586e75># For every failed example...</span>
    @output <span style=color:#719e07>&lt;&lt;</span> notification<span style=color:#719e07>.</span>failed_examples<span style=color:#719e07>.</span>map <span style=color:#719e07>do</span> <span style=color:#719e07>|</span>example<span style=color:#719e07>|</span>
      <span style=color:#586e75># Extract the full description of the example</span>
      full_description <span style=color:#719e07>=</span> example<span style=color:#719e07>.</span>full_description
      <span style=color:#586e75># Extract the example location in the file</span>
      location <span style=color:#719e07>=</span> example<span style=color:#719e07>.</span>location
      <span style=color:#586e75># Get the Exception message</span>
      message <span style=color:#719e07>=</span> example<span style=color:#719e07>.</span>execution_result<span style=color:#719e07>.</span>exception<span style=color:#719e07>.</span>message

      <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>#{</span>full_description<span style=color:#2aa198>}</span><span style=color:#2aa198> - </span><span style=color:#2aa198>#{</span>location<span style=color:#2aa198>}</span><span style=color:#2aa198> </span><span style=color:#2aa198>#{</span>message<span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>
    <span style=color:#719e07>end</span><span style=color:#719e07>.</span>join(<span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\n\t</span><span style=color:#2aa198>&#34;</span>)
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>dump_summary</span> notification <span style=color:#586e75># SummaryNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\n</span><span style=color:#2aa198>Finished in </span><span style=color:#2aa198>#{</span><span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Helpers</span><span style=color:#719e07>.</span>format_duration(notification<span style=color:#719e07>.</span>duration)<span style=color:#2aa198>}</span><span style=color:#2aa198>.&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>close</span> notification <span style=color:#586e75># NullNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>
  <span style=color:#719e07>end</span>
<span style=color:#719e07>end</span></code></pre></div><p>The only addition is on line 34 - we extract the result of the execution of the
example, then we get the message of the exception that RSpec raised when the
example failed. Now, lets test it:</p><p>This is all good, but you can see that the text alignment is broken a bit. If
you look at the picture at the beginning, you will notice that the exceptions
should appear indented underneath the description of the failing example. Lets
fix this.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#719e07>class</span> <span style=color:#268bd2>GroupingFormatter</span>
  <span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>.</span>register <span style=color:#b58900>self</span>, <span style=color:#2aa198>:dump_pending</span>, <span style=color:#2aa198>:dump_failures</span>, <span style=color:#2aa198>:close</span>,
    <span style=color:#2aa198>:dump_summary</span>, <span style=color:#2aa198>:example_passed</span>, <span style=color:#2aa198>:example_failed</span>, <span style=color:#2aa198>:example_pending</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>initialize</span> output
    @output <span style=color:#719e07>=</span> output
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>example_passed</span> notification <span style=color:#586e75># ExampleNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;.&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>example_failed</span> notification <span style=color:#586e75># FailedExampleNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;F&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>example_pending</span> notification <span style=color:#586e75># ExampleNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;*&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>dump_pending</span> notification <span style=color:#586e75># ExamplesNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\n</span><span style=color:#2aa198>PENDING:</span><span style=color:#cb4b16>\n\t</span><span style=color:#2aa198>&#34;</span>
    @output <span style=color:#719e07>&lt;&lt;</span> notification<span style=color:#719e07>.</span>pending_examples<span style=color:#719e07>.</span>map {<span style=color:#719e07>|</span>example<span style=color:#719e07>|</span> example<span style=color:#719e07>.</span>full_description <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34; - &#34;</span> <span style=color:#719e07>+</span> example<span style=color:#719e07>.</span>location }<span style=color:#719e07>.</span>join(<span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\t</span><span style=color:#2aa198>&#34;</span>)
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>dump_failures</span> notification <span style=color:#586e75># ExamplesNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>FAILING</span><span style=color:#cb4b16>\n\t</span><span style=color:#2aa198>&#34;</span>
    @output <span style=color:#719e07>&lt;&lt;</span> failed_examples_output(notification)
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>dump_summary</span> notification <span style=color:#586e75># SummaryNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\n</span><span style=color:#2aa198>Finished in </span><span style=color:#2aa198>#{</span><span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Helpers</span><span style=color:#719e07>.</span>format_duration(notification<span style=color:#719e07>.</span>duration)<span style=color:#2aa198>}</span><span style=color:#2aa198>.&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>close</span> notification <span style=color:#586e75># NullNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>private</span>

  <span style=color:#586e75># Loops through all of the failed examples and rebuilds the exception message</span>
  <span style=color:#719e07>def</span> <span style=color:#268bd2>failed_examples_output</span> notification
    failed_examples_output <span style=color:#719e07>=</span> notification<span style=color:#719e07>.</span>failed_examples<span style=color:#719e07>.</span>map <span style=color:#719e07>do</span> <span style=color:#719e07>|</span>example<span style=color:#719e07>|</span>
      failed_example_output example
    <span style=color:#719e07>end</span>
    build_examples_output(failed_examples_output)
  <span style=color:#719e07>end</span>

  <span style=color:#586e75># Joins all exception messages</span>
  <span style=color:#719e07>def</span> <span style=color:#268bd2>build_examples_output</span> output
    output<span style=color:#719e07>.</span>join(<span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\n\t</span><span style=color:#2aa198>&#34;</span>)
  <span style=color:#719e07>end</span>

  <span style=color:#586e75># Extracts the full_description, location and formats the message of each example exception</span>
  <span style=color:#719e07>def</span> <span style=color:#268bd2>failed_example_output</span> example
    full_description <span style=color:#719e07>=</span> example<span style=color:#719e07>.</span>full_description
    location <span style=color:#719e07>=</span> example<span style=color:#719e07>.</span>location
    formatted_message <span style=color:#719e07>=</span> strip_message_from_whitespace(example<span style=color:#719e07>.</span>execution_result<span style=color:#719e07>.</span>exception<span style=color:#719e07>.</span>message)

    <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>#{</span>full_description<span style=color:#2aa198>}</span><span style=color:#2aa198> - </span><span style=color:#2aa198>#{</span>location<span style=color:#2aa198>}</span><span style=color:#2aa198> </span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>  </span><span style=color:#2aa198>#{</span>formatted_message<span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#586e75># Removes whitespace from each of the exception message lines and reformats it</span>
  <span style=color:#719e07>def</span> <span style=color:#268bd2>strip_message_from_whitespace</span> msg
    msg<span style=color:#719e07>.</span>split(<span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>)<span style=color:#719e07>.</span>map(<span style=color:#719e07>&amp;</span><span style=color:#2aa198>:strip</span>)<span style=color:#719e07>.</span>join(<span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>#{</span>add_spaces(<span style=color:#2aa198>10</span>)<span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>)
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>add_spaces</span> n
    <span style=color:#2aa198>&#34; &#34;</span> <span style=color:#719e07>*</span> n
  <span style=color:#719e07>end</span>

<span style=color:#719e07>end</span></code></pre></div><p>In the example above we took the extra step to format the error messages
nicely. Basically, we split the exception message on a new-line character,
we remove all the whitespace and we rejoin the pieces with a newline between
them and add 10 spaces at the beginning of the message (for the indentation).
Now, the output will look like this:</p><p>And voila, the formatter is working as supposed. Or, is it? :) Lets add some
colors! Adding colors is really easy, we just need to require the
<a href=http://www.rubydoc.info/gems/rspec-core/RSpec/Core/Formatters/ConsoleCodes>ConsoleCodes</a> module.
The ConsoleCodes module provides helpers for formatting console output with
ANSI codes, for example colors and bold. So, the final version of our
GroupingFormatter is:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#b58900>require</span> <span style=color:#2aa198>&#39;rspec/core/formatters/console_codes&#39;</span>

<span style=color:#719e07>class</span> <span style=color:#268bd2>GroupingFormatter</span>
  <span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>.</span>register <span style=color:#b58900>self</span>, <span style=color:#2aa198>:dump_pending</span>, <span style=color:#2aa198>:dump_failures</span>, <span style=color:#2aa198>:close</span>,
    <span style=color:#2aa198>:dump_summary</span>, <span style=color:#2aa198>:example_passed</span>, <span style=color:#2aa198>:example_failed</span>, <span style=color:#2aa198>:example_pending</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>initialize</span> output
    @output <span style=color:#719e07>=</span> output
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>example_passed</span> notification <span style=color:#586e75># ExampleNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>::</span><span style=color:#cb4b16>ConsoleCodes</span><span style=color:#719e07>.</span>wrap(<span style=color:#2aa198>&#34;.&#34;</span>, <span style=color:#2aa198>:success</span>)
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>example_failed</span> notification <span style=color:#586e75># FailedExampleNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>::</span><span style=color:#cb4b16>ConsoleCodes</span><span style=color:#719e07>.</span>wrap(<span style=color:#2aa198>&#34;F&#34;</span>, <span style=color:#2aa198>:failure</span>)
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>example_pending</span> notification <span style=color:#586e75># ExampleNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>::</span><span style=color:#cb4b16>ConsoleCodes</span><span style=color:#719e07>.</span>wrap(<span style=color:#2aa198>&#34;*&#34;</span>, <span style=color:#2aa198>:pending</span>)
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>dump_pending</span> notification <span style=color:#586e75># ExamplesNotification</span>
    <span style=color:#719e07>if</span> notification<span style=color:#719e07>.</span>pending_examples<span style=color:#719e07>.</span>length <span style=color:#719e07>&gt;</span> <span style=color:#2aa198>0</span>
      @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\n</span><span style=color:#2aa198>#{</span><span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>::</span><span style=color:#cb4b16>ConsoleCodes</span><span style=color:#719e07>.</span>wrap(<span style=color:#2aa198>&#34;PENDING:&#34;</span>, <span style=color:#2aa198>:pending</span>)<span style=color:#2aa198>}</span><span style=color:#cb4b16>\n\t</span><span style=color:#2aa198>&#34;</span>
      @output <span style=color:#719e07>&lt;&lt;</span> notification<span style=color:#719e07>.</span>pending_examples<span style=color:#719e07>.</span>map {<span style=color:#719e07>|</span>example<span style=color:#719e07>|</span> example<span style=color:#719e07>.</span>full_description <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34; - &#34;</span> <span style=color:#719e07>+</span> example<span style=color:#719e07>.</span>location }<span style=color:#719e07>.</span>join(<span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\t</span><span style=color:#2aa198>&#34;</span>)
    <span style=color:#719e07>end</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>dump_failures</span> notification <span style=color:#586e75># ExamplesNotification</span>
    <span style=color:#719e07>if</span> notification<span style=color:#719e07>.</span>failed_examples<span style=color:#719e07>.</span>length <span style=color:#719e07>&gt;</span> <span style=color:#2aa198>0</span>
      @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>#{</span><span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>::</span><span style=color:#cb4b16>ConsoleCodes</span><span style=color:#719e07>.</span>wrap(<span style=color:#2aa198>&#34;FAILING:&#34;</span>, <span style=color:#2aa198>:failure</span>)<span style=color:#2aa198>}</span><span style=color:#cb4b16>\n\t</span><span style=color:#2aa198>&#34;</span>
      @output <span style=color:#719e07>&lt;&lt;</span> failed_examples_output(notification)
    <span style=color:#719e07>end</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>dump_summary</span> notification <span style=color:#586e75># SummaryNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\n</span><span style=color:#2aa198>Finished in </span><span style=color:#2aa198>#{</span><span style=color:#cb4b16>RSpec</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Formatters</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Helpers</span><span style=color:#719e07>.</span>format_duration(notification<span style=color:#719e07>.</span>duration)<span style=color:#2aa198>}</span><span style=color:#2aa198>.&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>close</span> notification <span style=color:#586e75># NullNotification</span>
    @output <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>private</span>

  <span style=color:#586e75># Loops through all of the failed examples and rebuilds the exception message</span>
  <span style=color:#719e07>def</span> <span style=color:#268bd2>failed_examples_output</span> notification
    failed_examples_output <span style=color:#719e07>=</span> notification<span style=color:#719e07>.</span>failed_examples<span style=color:#719e07>.</span>map <span style=color:#719e07>do</span> <span style=color:#719e07>|</span>example<span style=color:#719e07>|</span>
      failed_example_output example
    <span style=color:#719e07>end</span>
    build_examples_output(failed_examples_output)
  <span style=color:#719e07>end</span>

  <span style=color:#586e75># Joins all exception messages</span>
  <span style=color:#719e07>def</span> <span style=color:#268bd2>build_examples_output</span> output
    output<span style=color:#719e07>.</span>join(<span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n\n\t</span><span style=color:#2aa198>&#34;</span>)
  <span style=color:#719e07>end</span>

  <span style=color:#586e75># Extracts the full_description, location and formats the message of each example exception</span>
  <span style=color:#719e07>def</span> <span style=color:#268bd2>failed_example_output</span> example
    full_description <span style=color:#719e07>=</span> example<span style=color:#719e07>.</span>full_description
    location <span style=color:#719e07>=</span> example<span style=color:#719e07>.</span>location
    formatted_message <span style=color:#719e07>=</span> strip_message_from_whitespace(example<span style=color:#719e07>.</span>execution_result<span style=color:#719e07>.</span>exception<span style=color:#719e07>.</span>message)

    <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>#{</span>full_description<span style=color:#2aa198>}</span><span style=color:#2aa198> - </span><span style=color:#2aa198>#{</span>location<span style=color:#2aa198>}</span><span style=color:#2aa198> </span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>  </span><span style=color:#2aa198>#{</span>formatted_message<span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>
  <span style=color:#719e07>end</span>

  <span style=color:#586e75># Removes whitespace from each of the exception message lines and reformats it</span>
  <span style=color:#719e07>def</span> <span style=color:#268bd2>strip_message_from_whitespace</span> msg
    msg<span style=color:#719e07>.</span>split(<span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>)<span style=color:#719e07>.</span>map(<span style=color:#719e07>&amp;</span><span style=color:#2aa198>:strip</span>)<span style=color:#719e07>.</span>join(<span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>#{</span>add_spaces(<span style=color:#2aa198>10</span>)<span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>)
  <span style=color:#719e07>end</span>

  <span style=color:#719e07>def</span> <span style=color:#268bd2>add_spaces</span> n
    <span style=color:#2aa198>&#34; &#34;</span> <span style=color:#719e07>*</span> n
  <span style=color:#719e07>end</span>

<span style=color:#719e07>end</span></code></pre></div><p>As you can see, we are using the <em>ConsoleCodes.wrap</em> method which wraps a piece
of text in ANSI codes with the supplied code in the arguments. You can now test
our new colored formatter:</p><h2 id=using-your-new-groupingformatter>Using your new GroupingFormatter<a hidden class=anchor aria-hidden=true href=#using-your-new-groupingformatter>#</a></h2><p>Our formatter is now working, but how can we put it to use? One way to use it
is by running the specs and requiring the formatter in the RSpec command:</p><p>This works alright. But, requiring your formatter every time you run your specs is boring.</p><h3 id=meet-rspec>Meet .rspec<a hidden class=anchor aria-hidden=true href=#meet-rspec>#</a></h3><p>RSpec&rsquo;s documentation says that RSpec reads command line configuration options
from files in three different locations:</p><ul><li>Local: <code>./.rspec-local - </code>This file should exist in the project&rsquo;s root
directory. It can contain some private customizations (in the scope of the
project) of RSpec and should be ignored by git.</li><li>Project: <code>./.rspec</code>  - This file should exist in the project&rsquo;s root
directory. It usually contains public project-wide customizations of RSpec and
is usually checked into the git repo.</li><li>Global: <code>~/.rspec</code> - This file exists in the user&rsquo;s home directory. It can
contain some personal customizations of your RSpec and is applied to every
project where RSpec is used on your machine.</li></ul><p>So, we can add a <em>.rspec</em> file in our project&rsquo;s folder with the following
contents:</p><p>RSpec will read this file every time we run our specs, so this means that we
can run our specs without specifying these options in the rspec command:</p><p>This will now work with our new formatter.</p><h3 id=using-it-in-a-rails-app>Using it in a Rails app<a hidden class=anchor aria-hidden=true href=#using-it-in-a-rails-app>#</a></h3><p>Lets integrate our new formatter in a Rails application. Using the formatter in
your Rails application is done in two steps:</p><ol><li><p>The formatter class must either be in Rails' autoload path, or manually
required in the <em>spec_helper</em>. My personal preference is to require it manually
because it&rsquo;s more verbose.</p></li><li><p>In the <strong>RSpec.configure</strong> block in the <em>spec_helper</em>, you need to register
the formatter to RSpec. This is done by:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>    config<span style=color:#719e07>.</span>formatter <span style=color:#719e07>=</span> <span style=color:#cb4b16>NameOfTheClass</span>
    </code></pre></div></li></ol><p>or, in our case:</p><pre><code><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>    config<span style=color:#719e07>.</span>formatter <span style=color:#719e07>=</span> <span style=color:#cb4b16>GroupingFormatter</span>
    </code></pre></div></code></pre><p>That&rsquo;s it. Now when you run your specs the new formatter will be used by RSpec.</p><h2 id=outro>Outro<a hidden class=anchor aria-hidden=true href=#outro>#</a></h2><p>I hope you found this (quite long) post informative and interesting. If any of
you wrote your own RSpec formatters, please, share them with me and the
others in the comments - I am very curious to see what you&rsquo;ve come up with.
Thanks for reading to the very end!</p><div id=revue-embed><form action=https://www.getrevue.co/profile/itsilija/add_subscriber method=post id=revue-form name=revue-form target=_blank><p><b>Liked this article?</b>
Subscribe to my newsletter and get future articles in your inbox. It's a
short and sweet read, going out to hundreds of other engineers.</p><div class=revue-form-group><input class=revue-form-field placeholder="Your email address..." type=email name=member[email] id=member_email></div><div class=revue-form-actions><input type=submit value=Subscribe name=member[subscribe] id=member_submit></div></form></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://ieftimov.com/tags/testing/>testing</a></li><li><a href=https://ieftimov.com/tags/formatters/>formatters</a></li></ul><nav class=paginav><a class=prev href=https://ieftimov.com/post/railsconf-2015-talks-that-you-should-watch/><span class=title>« Prev Page</span><br><span>RailsConf 2015 talks that you should watch</span></a>
<a class=next href=https://ieftimov.com/post/pattern-to-pattern-template-method-and-strategy/><span class=title>Next Page »</span><br><span>Pattern to pattern: Template Method & Strategy</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share How to write RSpec formatters from scratch on twitter" href="https://twitter.com/intent/tweet/?text=How%20to%20write%20RSpec%20formatters%20from%20scratch&url=https%3a%2f%2fieftimov.com%2fpost%2fhow-to-write-rspec-formatters-from-scratch%2f&hashtags=testing%2cformatters"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to write RSpec formatters from scratch on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fieftimov.com%2fpost%2fhow-to-write-rspec-formatters-from-scratch%2f&title=How%20to%20write%20RSpec%20formatters%20from%20scratch&summary=How%20to%20write%20RSpec%20formatters%20from%20scratch&source=https%3a%2f%2fieftimov.com%2fpost%2fhow-to-write-rspec-formatters-from-scratch%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to write RSpec formatters from scratch on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fieftimov.com%2fpost%2fhow-to-write-rspec-formatters-from-scratch%2f&title=How%20to%20write%20RSpec%20formatters%20from%20scratch"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to write RSpec formatters from scratch on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fieftimov.com%2fpost%2fhow-to-write-rspec-formatters-from-scratch%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to write RSpec formatters from scratch on whatsapp" href="https://api.whatsapp.com/send?text=How%20to%20write%20RSpec%20formatters%20from%20scratch%20-%20https%3a%2f%2fieftimov.com%2fpost%2fhow-to-write-rspec-formatters-from-scratch%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to write RSpec formatters from scratch on telegram" href="https://telegram.me/share/url?text=How%20to%20write%20RSpec%20formatters%20from%20scratch&url=https%3a%2f%2fieftimov.com%2fpost%2fhow-to-write-rspec-formatters-from-scratch%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>Copyright 2021 © Ilija Eftimov</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>