<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>How to write Rails middleware - Ilija Eftimov ⚡️</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Ilija Eftimov" />
  <meta name="description" content="In my last two posts about Rack, I wrote about the basics of Rack and how to write middleware. If you have no idea what this is about, I recommend reading the last two posts (in the order above). For the rest of you, carry on - today we will see how to write awesome Rails middleware and how to use it in any Rails application. Rails and Rack play together really nice, so keep on reading!" />

  <meta name="keywords" content="Software, Programming, Computer Science, Products" />






<meta name="generator" content="Hugo 0.55.6" />


<link rel="canonical" href="https://ieftimov.com/post/writing-rails-middleware/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.ec807d8b802a40889537c26e014f733206312ea440d42e1f0dabed80918de1ac.css" integrity="sha256-7IB9i4AqQIiVN8JuAU9zMgYxLqRA1C4fDavtgJGN4aw=" media="screen" crossorigin="anonymous">




<link rel="stylesheet" href="/css/overrides.css">

<link rel="stylesheet" href="/css/subscribe.css">


<meta property="og:title" content="How to write Rails middleware" />
<meta property="og:description" content="In my last two posts about Rack, I wrote about the basics of Rack and how to write middleware. If you have no idea what this is about, I recommend reading the last two posts (in the order above). For the rest of you, carry on - today we will see how to write awesome Rails middleware and how to use it in any Rails application. Rails and Rack play together really nice, so keep on reading!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ieftimov.com/post/writing-rails-middleware/" />
<meta property="article:published_time" content="2015-07-07T00:00:00&#43;00:00"/>


<meta itemprop="name" content="How to write Rails middleware">
<meta itemprop="description" content="In my last two posts about Rack, I wrote about the basics of Rack and how to write middleware. If you have no idea what this is about, I recommend reading the last two posts (in the order above). For the rest of you, carry on - today we will see how to write awesome Rails middleware and how to use it in any Rails application. Rails and Rack play together really nice, so keep on reading!">



<meta itemprop="wordCount" content="2295">



<meta itemprop="keywords" content="middleware," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to write Rails middleware"/>
<meta name="twitter:description" content="In my last two posts about Rack, I wrote about the basics of Rack and how to write middleware. If you have no idea what this is about, I recommend reading the last two posts (in the order above). For the rest of you, carry on - today we will see how to write awesome Rails middleware and how to use it in any Rails application. Rails and Rack play together really nice, so keep on reading!"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-11264459-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Ilija Eftimov ⚡️</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://ieftimov.com/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://ieftimov.com/testing-in-go/">Testing in Go</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://ieftimov.com/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://ieftimov.com/about/">About</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Ilija Eftimov ⚡️
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://ieftimov.com/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://ieftimov.com/testing-in-go/">Testing in Go</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://ieftimov.com/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://ieftimov.com/about/">About</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">How to write Rails middleware</h1>
      
      <div class="post-meta">
        <time datetime="2015-07-07" class="post-time">
          07-07-2015
        </time>
        <div class="post-category">
            <a href="https://ieftimov.com/categories/rails/"> Rails </a>
            
          </div>
        

        
        

        
        
      </div>
    </header>

    
    

    
    <div class="post-content">
      

<p>In my last two posts about Rack, I wrote about <a href="/rack-first-principles">the basics of Rack</a>
and <a href="/writing-rack-middleware">how to write middleware</a>. If you have no idea
what this is about, I recommend reading the last two posts (in the order above).
For the rest of you, carry on - today we will see how to write awesome Rails
middleware and how to use it in any Rails application. Rails and Rack play
together really nice, so keep on reading!</p>

<h2 id="rails-on-rack">Rails on Rack</h2>

<p>Rails by default has bunch of middleware loaded that is crucial to Rails&rsquo; working. If you want
to see what middleware your Rails app is using, open it up in command line and run:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">rake middleware</code></pre></div>

<p>You will see a big list of middleware classes that your current Rails app is using.
This is a sample output on a app that I am working on. Keep in mind that your output
may vary.</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">use ActionDispatch::Static
use Rack::Lock
use <span class="c1">#&lt;ActiveSupport:0x007f93ff6810d8&gt;</span>
use Rack::Runtime
use Rack::MethodOverride
use ActionDispatch::RequestId
use Rails::Logger
use ActionDispatch::ShowExceptions
use ActionDispatch::DebugExceptions
use BetterErrors::Middleware
use ActionDispatch::RemoteIp
use ActionDispatch::Reloader
use ActionDispatch::Callbacks
use ActiveRecord::ConnectionManagement
use ActiveRecord::QueryCache
use ActionDispatch::Cookies
use ActionDispatch::CookieStore
use ActionDispatch::Flash
use ActionDispatch::ParamsParser
use ActionDispatch::Head
use Rack::ConditionalGet
use Rack::ETag
use ActionDispatch::BestStandardsSupport
use Warden::Manager
run MyApplication::Application.routes</code></pre></div>

<p>The list of middleware is quite big. If you are curious what any of these middleware classes do,
check <a href="http://guides.rubyonrails.org/rails_on_rack.html#internal-middleware-stack">this list out</a>{:target=&rdquo;_blank&rdquo;}.
Cool stuff, right? Lets see what rules and conventions apply to writing Rails middleware
and how we can leverage those to write our own middleware.</p>

<h2 id="setting-up-a-middleware-class">Setting up a middleware class</h2>

<p>Just like any Rack middleware that we wrote before, we will need to write a middleware class.
Since v3.2, Rails gave us the ability to add middleware classes to <code>app/middleware</code>.
So, lets add that class.</p>

<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># app/middleware/my_middleware.rb</span>

<span class="k">class</span> <span class="nc">MyMiddleware</span>
<span class="k">end</span></code></pre></div>

<p>Also, another option is using the <code>lib</code> directory, but you have to make sure that
the directory is in the autoload path. Or, you can manually require the middleware class
in the initializer.</p>

<p>As always, there are some conventions of how Rails middleware should be created.
Like any other middleware class, the class needs an <code>initialize</code> method and a <code>call</code> method.
Also, the first argument of the initialize method is the application itself, and
the first argument of the call method is the request environment.</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># app/middleware/my_middleware.rb</span>

<span class="k">class</span> <span class="nc">MyMiddleware</span>
  <span class="k">def</span> <span class="nf">initialize</span> <span class="n">app</span>
    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span> <span class="n">env</span>
    <span class="c1"># do something...</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></td></tr></table>
</div>
</div>

<h2 id="using-our-middleware">Using our middleware</h2>

<p>Rails allows us to mount this middleware class in the middleware stack so
the application can use it in runtime. Again, you can see the middleware stack by running
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">rake middleware</code></pre></div>
in your command line.</p>








<div id="mc_embed_signup">
<form action="https://pm.us20.list-manage.com/subscribe/post?u=d9a6471309140dcd520d05346&amp;id=2aac491644" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
        <div class="heading">Join The Newsletter</div>
        <p>
            I write about backend technologies, programming and cloud architectures. Join hundreds of other developers that get my content, twice a month. Unsubscribe whenever. Never any spam, ads, or affiliate links.
        </p>
	<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="Your email address" required>
        <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">

      
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_d9a6471309140dcd520d05346_2aac491644" tabindex="-1" value=""></div>

    <p>You can also subscribe <a href="https://ieftimov.com/index.xml">via RSS</a>.</p>
    </div>
</form>
</div>



<h3 id="mounting">Mounting</h3>

<p>Mounting middleware is usually done in the <code>config/application.rb</code> file.
But, Rails also allows us to mount different middleware for different environment. This means that
you can mount middleware in any of the <code>config/environments</code> files. Mounting a
middleware class is done with the command:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">MyRailsApplication</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="o">*</span><span class="n">snip</span><span class="o">*</span>

    <span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="o">&lt;</span><span class="n">class</span><span class="o">-</span><span class="nb">name</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">first</span><span class="o">-</span><span class="n">argument</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">nth</span><span class="o">-</span><span class="n">argument</span><span class="o">&gt;</span>

    <span class="o">*</span><span class="n">snip</span><span class="o">*</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></td></tr></table>
</div>
</div>

<p>Or, in our case:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># config/application.rb</span>
<span class="k">module</span> <span class="nn">MyRailsApplication</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="o">*</span><span class="n">snip</span><span class="o">*</span>

    <span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="s2">&#34;MyMiddleware&#34;</span>

    <span class="o">*</span><span class="n">snip</span><span class="o">*</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></td></tr></table>
</div>
</div>

<p>There is this tiny caveat when mounting middleware - note that the class name
is written as a string, not as a constant. If you mount a middleware class in the
<code>config/application.rb</code> file the class name has to be a string. But, if you load
the middleware class in the environment files (i.e. <code>config/environment/development.rb</code>)
you can mount is as a constant:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># config/environment/development.rb</span>
<span class="k">module</span> <span class="nn">MyRailsApplication</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="o">*</span><span class="n">snip</span><span class="o">*</span>

    <span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="no">MyMiddleware</span>

    <span class="o">*</span><span class="n">snip</span><span class="o">*</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></td></tr></table>
</div>
</div>

<p>As far as I can tell, the reason for this tiny caveat is when Rails is loading
all the required files on server boot, when <code>config/application.rb</code> is loaded
not all constants are loaded. But, due to the nature of the envronment files, they
seem to be autoloaded at the end, when all of the constants are present in memory.</p>

<h3 id="mounting-the-middleware-in-the-stack">Mounting the middleware in the stack</h3>

<p>Adding our middleware at a certain point of the middleware stack is done via
the <code>insert_before</code> and <code>insert_after</code> commands.</p>

<p>For example, if we, for whatever reason, want to add our <code>MyMiddleware</code> class
just before the <code>Rails::Rack::Logger</code> middleware, we can use this line:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">MyRailsApplication</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="o">*</span><span class="n">snip</span><span class="o">*</span>

    <span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">insert_before</span> <span class="s2">&#34;Rails::Logger&#34;</span><span class="p">,</span> <span class="s2">&#34;MyMiddleware&#34;</span>

    <span class="o">*</span><span class="n">snip</span><span class="o">*</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></td></tr></table>
</div>
</div>

<p>On the flipside, if we want to add our <code>MyMiddleware</code> class after the
<code>Rails::Rack::Logger</code> middleware, we can use this line:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">insert_after</span> <span class="s2">&#34;Rails::Logger&#34;</span><span class="p">,</span> <span class="s2">&#34;MyMiddleware&#34;</span></code></pre></td></tr></table>
</div>
</div>

<p>Another convenience method that Rails provides us is <code>swap</code>, as in swapping middleware.
For example, if you wrote your own params parser middleware, that will substitute
<code>ActionDispatch::ParamsParser</code>, you can swap it using:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">swap</span> <span class="s2">&#34;ActionDispatch::ParamsParser&#34;</span><span class="p">,</span> <span class="s2">&#34;MyParamsParser&#34;</span></code></pre></td></tr></table>
</div>
</div>

<p>This will swap the middleware classes, as in, it will use <code>MyParamsParser</code> instead
of <code>ActionDispatch::ParamsParser</code>.</p>

<p>Just to give you an idea, this can be useful when debugging - you can extend the
existing middleware, add some logging so you can see how the data mutates in the
params parsers and continue with the normal execution of parsing the params.
One can enable that middleware just in development mode, so the middleware is swapped only in
development environment.</p>

<p>That being said, lets see how we can write our own tiny middleware and mount it to an existing Rails application.</p>

<h2 id="deltalogger">DeltaLogger</h2>

<p>We will write a tiny middleware class that will calculate the delta time of the request
and log it to the Rails console. You can open any Rails application that you have
laying in your computer and play with it. I promise we won&rsquo;t do anything malicious. :-)</p>

<p>First, we need a middleware class. Lets add it to the <code>app/middleware</code> directory.
It&rsquo;s worth mentioning that the directory does not exist by default.
So, if it is missing - feel free to create it.</p>

<p>Next, we&rsquo;ll need to add the <code>initialize</code> and the <code>call</code> method. Remember, the first
argument of the <code>initialize</code> method is the application, and the first argument of the <code>call</code> method
is the request environment.</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># app/middleware/delta_logger.rb</span>

<span class="k">class</span> <span class="nc">DeltaLogger</span>
  <span class="k">def</span> <span class="nf">initialize</span> <span class="n">app</span>
    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span> <span class="n">env</span>
    <span class="c1"># do something...</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></td></tr></table>
</div>
</div>

<p>Next, we&rsquo;ll need to calculate the total time that the applicaiton took to process the request
and log it:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># app/middleware/delta_logger.rb</span>

<span class="k">class</span> <span class="nc">DeltaLogger</span>
  <span class="k">def</span> <span class="nf">initialize</span> <span class="n">app</span>
    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span> <span class="n">env</span>
    <span class="n">request_started_on</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
    <span class="vi">@status</span><span class="p">,</span> <span class="vi">@headers</span><span class="p">,</span> <span class="vi">@response</span> <span class="o">=</span> <span class="vi">@app</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">request_ended_on</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>

    <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span>
    <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&#34;Request delta time: </span><span class="si">#{</span><span class="n">request_ended_on</span> <span class="o">-</span> <span class="n">request_started_on</span><span class="si">}</span><span class="s2"> seconds.&#34;</span>
    <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span>

    <span class="o">[</span><span class="vi">@status</span><span class="p">,</span> <span class="vi">@headers</span><span class="p">,</span> <span class="vi">@response</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></td></tr></table>
</div>
</div>

<p>As you can see, this is quite trivial. We save the time before the request has been
passed onto the rest of the middleware stack and the time after the middleware has finished with
the request. Then, we subtract the start time from the end time and we get a number of seconds
that the request processing took.</p>

<p>What&rsquo;s cool in Rails middleware is that we have the Rails application available to us in
the scope of the middleware. This allows us to use to Rails logger and log the delta time.</p>

<p>If you managed to add your middleware to the Rails app, go ahead and boot it. When
the server boots, issue any request to it. In the logs you will see something like:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">==================================================</span>
Request delta time: <span class="m">1</span>.40877 seconds.
<span class="o">==================================================</span></code></pre></div>

<p>This is our <code>DeltaLogger</code> logging the delta time.</p>

<h3 id="formatting-the-output">Formatting the output</h3>

<p>In one of the examples in the introduction of this post, I mentioned the option
of passing arguments to the middleware class. Lets see how we can use this
feature to improve the formatting of the <code>DeltaLogger</code>.</p>

<p>Passing arguments is done by adding the arguments after the class name in the mounting command:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="s2">&#34;MyMiddleware&#34;</span><span class="p">,</span> <span class="s2">&#34;First Argument&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="ss">second</span><span class="p">:</span> <span class="s2">&#34;argument&#34;</span> <span class="p">},</span> <span class="o">[</span><span class="s2">&#34;nth-argument&#34;</span><span class="o">]</span></code></pre></td></tr></table>
</div>
</div>

<p>In our tiny example, we can send through the character that we want the output
to be formatted with. Currently, our default formatting is done with the equals sign.
Making this customizable is easily done by sending this character as the first argument:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># app/middleware/delta_logger.rb</span>

<span class="k">class</span> <span class="nc">DeltaLogger</span>
  <span class="k">def</span> <span class="nf">initialize</span> <span class="n">app</span><span class="p">,</span> <span class="n">formatting_char</span> <span class="o">=</span> <span class="s1">&#39;=&#39;</span>
    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
    <span class="vi">@formatting_char</span> <span class="o">=</span> <span class="n">formatting_char</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span> <span class="n">env</span>
    <span class="n">request_started_on</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
    <span class="vi">@status</span><span class="p">,</span> <span class="vi">@headers</span><span class="p">,</span> <span class="vi">@response</span> <span class="o">=</span> <span class="vi">@app</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">request_ended_on</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>

    <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="vi">@formatting_char</span> <span class="o">*</span> <span class="mi">50</span>
    <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&#34;Request delta time: </span><span class="si">#{</span><span class="n">request_ended_on</span> <span class="o">-</span> <span class="n">request_started_on</span><span class="si">}</span><span class="s2"> seconds.&#34;</span>
    <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="vi">@formatting_char</span> <span class="o">*</span> <span class="mi">50</span>

    <span class="o">[</span><span class="vi">@status</span><span class="p">,</span> <span class="vi">@headers</span><span class="p">,</span> <span class="vi">@response</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></td></tr></table>
</div>
</div>

<p>Now, we can change the output when adding the <code>DeltaLogger</code> to the middleware stack:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="s2">&#34;DeltaLogger&#34;</span><span class="p">,</span> <span class="s2">&#34;*&#34;</span></code></pre></td></tr></table>
</div>
</div>

<p>It&rsquo;s worth mentioning that if your Rails application is running, when changing
a middleware class you will have to reboot the application so the new changes in
the middleware can be picked up. This happens because Rails loads the middleware only once -
on boot.</p>

<p>Now, when we send a request in the logs we can see that the <code>DeltaLogger</code> output changed:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">**************************************************
Request delta time: <span class="m">1</span>.40877 seconds.
**************************************************</code></pre></div>








<div id="mc_embed_signup">
<form action="https://pm.us20.list-manage.com/subscribe/post?u=d9a6471309140dcd520d05346&amp;id=2aac491644" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
        <div class="heading">Join The Newsletter</div>
        <p>
            I write about backend technologies, programming and cloud architectures. Join hundreds of other developers that get my content, twice a month. Unsubscribe whenever. Never any spam, ads, or affiliate links.
        </p>
	<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="Your email address" required>
        <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">

      
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_d9a6471309140dcd520d05346_2aac491644" tabindex="-1" value=""></div>

    <p>You can also subscribe <a href="https://ieftimov.com/index.xml">via RSS</a>.</p>
    </div>
</form>
</div>



<h3 id="logging-levels">Logging levels</h3>

<p>Another way to leverage arguments is to make the logging level customizable. For example,
you might want to change the logging level. In Rails, there are six different
logging levels: <code>:debug</code>, <code>:info</code>, <code>:warn</code>, <code>:error</code>, <code>:fatal</code>, and <code>:unknown</code>.
Lets make the logging level customizable.</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># app/middleware/delta_logger.rb</span>

<span class="no">VALID_LOG_LEVELS</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:debug</span><span class="p">,</span> <span class="ss">:info</span><span class="p">,</span> <span class="ss">:warn</span><span class="p">,</span> <span class="ss">:error</span><span class="p">,</span> <span class="ss">:fatal</span><span class="p">,</span> <span class="ss">:unknown</span><span class="o">]</span>

<span class="k">class</span> <span class="nc">DeltaLogger</span>
  <span class="k">def</span> <span class="nf">initialize</span> <span class="n">app</span><span class="p">,</span> <span class="n">log_level</span>
    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
    <span class="c1"># Default to :info log level if the user sets an invalid log level.</span>
    <span class="vi">@log_level</span> <span class="o">=</span> <span class="no">VALID_LOG_LEVELS</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span> <span class="p">?</span>  <span class="n">log_level</span> <span class="p">:</span> <span class="ss">:info</span> 
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span> <span class="n">env</span>
    <span class="n">request_started_on</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
    <span class="vi">@status</span><span class="p">,</span> <span class="vi">@headers</span><span class="p">,</span> <span class="vi">@response</span> <span class="o">=</span> <span class="vi">@app</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">request_ended_on</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>

    <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="vi">@log_level</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="vi">@log_level</span><span class="p">,</span> <span class="s2">&#34;Request delta time: </span><span class="si">#{</span><span class="n">request_ended_on</span> <span class="o">-</span> <span class="n">request_started_on</span><span class="si">}</span><span class="s2"> seconds.&#34;</span><span class="p">)</span>
    <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="vi">@log_level</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

    <span class="o">[</span><span class="vi">@status</span><span class="p">,</span> <span class="vi">@headers</span><span class="p">,</span> <span class="vi">@response</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></td></tr></table>
</div>
</div>

<p>Now, in our application.rb (or environment.rb) file, we can set the logger to
use the desired loging level:</p>

<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="s2">&#34;DeltaLogger&#34;</span><span class="p">,</span> <span class="ss">:warn</span></code></pre></div>

<p>If we reboot the Rails app and send a new request, the logs will show:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>WARN<span class="o">]</span> <span class="o">==================================================</span>
<span class="o">[</span>WARN<span class="o">]</span> Request delta time: <span class="m">0</span>.270595 seconds.
<span class="o">[</span>WARN<span class="o">]</span> <span class="o">==================================================</span></code></pre></div>

<p>Be aware that your output may vary because logging output relies on the <a href="http://api.rubyonrails.org/classes/ActiveSupport/Logger/SimpleFormatter.html">logger formatter</a>{:target=&rdquo;_blank&rdquo;} that your application is using.</p>

<p>If you are not seeing the exact output, you can plug this logging formatter in your app:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># lib/delta_formatter.rb</span>

<span class="k">class</span> <span class="nc">DeltaFormatter</span> <span class="o">&lt;</span> <span class="no">Logger</span><span class="o">::</span><span class="no">Formatter</span>
  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">severity</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">program_name</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="s2">&#34;[</span><span class="si">#{</span><span class="n">severity</span><span class="si">}</span><span class="s2">] </span><span class="si">#{</span><span class="nb">String</span> <span class="o">===</span> <span class="n">msg</span> <span class="p">?</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></td></tr></table>
</div>
</div>

<p>You can use this formatter by including it into <code>application.rb</code>:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="o">*</span><span class="n">snipped</span><span class="o">*</span>
<span class="nb">require</span> <span class="s2">&#34;./lib/delta_formatter&#34;</span>

<span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="n">config</span><span class="o">.</span><span class="n">autoload_paths</span> <span class="o">+=</span> <span class="sx">%W( </span><span class="si">#{</span><span class="n">config</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="sx">/lib/**/*)</span>

    <span class="o">*</span><span class="n">snipped</span><span class="o">*</span>

    <span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="s2">&#34;DeltaLogger&#34;</span><span class="p">,</span> <span class="ss">:warn</span>
    <span class="n">config</span><span class="o">.</span><span class="n">log_formatter</span> <span class="o">=</span> <span class="no">DeltaFormatter</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></td></tr></table>
</div>
</div>

<p>After adding this, you&rsquo;ll need to reboot your server and you should see the output with
the severity tag.</p>

<h2 id="thread-safety">Thread safety</h2>

<p>Last of the important topics about Rails middleware is thread-safety. When using Puma or Unicorn web servers,
one of the strong sides of these servers is that they are threaded. Since
our middleware runs on these servers, it has to be thread-safe, meaning, it should
easily spawn multiple duplicates of it so different threads can use different objects of
the same middleware.</p>

<p>The easiest and most efficient way to do this is to <code>dup</code> the middleware object
that is created in runtime.</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># app/middleware/delta_logger.rb</span>

<span class="no">VALID_LOG_LEVELS</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:debug</span><span class="p">,</span> <span class="ss">:info</span><span class="p">,</span> <span class="ss">:warn</span><span class="p">,</span> <span class="ss">:error</span><span class="p">,</span> <span class="ss">:fatal</span><span class="p">,</span> <span class="ss">:unknown</span><span class="o">]</span>

<span class="k">class</span> <span class="nc">DeltaLogger</span>
  <span class="k">def</span> <span class="nf">initialize</span> <span class="n">app</span><span class="p">,</span> <span class="n">log_level</span>
    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
    <span class="c1"># Default to :info log level if the user sets an invalid log level.</span>
    <span class="vi">@log_level</span> <span class="o">=</span> <span class="no">VALID_LOG_LEVELS</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span> <span class="p">?</span> <span class="n">log_level</span> <span class="p">:</span> <span class="ss">:info</span> 
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span> <span class="n">env</span>
    <span class="nb">dup</span><span class="o">.</span><span class="n">_call</span> <span class="n">env</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">_call</span> <span class="n">env</span>
    <span class="n">request_started_on</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
    <span class="vi">@status</span><span class="p">,</span> <span class="vi">@headers</span><span class="p">,</span> <span class="vi">@response</span> <span class="o">=</span> <span class="vi">@app</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">request_ended_on</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>

    <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="vi">@log_level</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="vi">@log_level</span><span class="p">,</span> <span class="s2">&#34;Request delta time: </span><span class="si">#{</span><span class="n">request_ended_on</span> <span class="o">-</span> <span class="n">request_started_on</span><span class="si">}</span><span class="s2"> seconds.&#34;</span><span class="p">)</span>
    <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="vi">@log_level</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

    <span class="o">[</span><span class="vi">@status</span><span class="p">,</span> <span class="vi">@headers</span><span class="p">,</span> <span class="vi">@response</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></td></tr></table>
</div>
</div>

<p>By adding the <code>_call</code> method and duplicating the object we make sure that any instance variables
we set in <code>_call</code> will be set on the duped instance, not the original. This allows the
web server to use a separate (duped) object for each thread which will contain different
data, based on it&rsquo;s execution.</p>

<h2 id="outro">Outro</h2>

<p>As you can see, there&rsquo;s quite a bit that needed to be covered in this post. I hope that
this explained how you can write your own Rails middleware and mount it in the middleware stack.
It&rsquo;s very easy to get creative with Rails middleware as it iss highly customizable, quite
low-level(ish) while you have the whole app available in runtime. Next time, we will work
together on building and testing a real-life example of Rails middleware.</p>

<p>Until then, feel free to drop a comment, I would love to hear your opinions, problems and
code that you&rsquo;ve come up with.</p>

    </div>

    
    


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://ieftimov.com/tags/middleware/">middleware</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/migrate-rspec-to-minitest/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Migrating a test suite from RSpec to Minitest</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/test-driven-thinking/">
            <span class="next-text nav-default">Test-Driven Thinking</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  

  

  

  <div class="disqus-comment">
  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
    Show Disqus Comments
  </div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = "https://ieftimov.com/post/writing-rails-middleware/";
    };
    function load_disqus() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'eftimov';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

      $('#load_disqus').remove();
    };
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
  </div>

    

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="https://stackoverflow.com/users/601555/ilija-eftimov" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="https://twitter.com/fteem" rel="me noopener" class="iconfont"
      title="twitter"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1264 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M1229.8616 18.043658c0 0-117.852626 63.135335-164.151872 67.344358-105.225559-164.151872-505.082682-92.598492-437.738325 223.078185C278.622548 312.675223 89.216542 47.506814 89.216542 47.506814s-117.852626 189.406006 75.762402 345.139833C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042C1179.353331 249.539887 1263.533778 123.269217 1263.533778 123.269217s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"></path>
</svg>

    </a>
  
    <a href="https://www.linkedin.com/in/ieftimov/" rel="me noopener" class="iconfont"
      title="linkedin"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="33" height="33">
  <path d="M872.405333 872.618667h-151.637333v-237.610667c0-56.661333-1.152-129.578667-79.018667-129.578667-79.061333 0-91.136 61.653333-91.136 125.397334v241.792H398.976V384h145.664v66.602667h1.962667c20.352-38.4 69.845333-78.933333 143.786666-78.933334 153.642667 0 182.058667 101.12 182.058667 232.746667v268.202667zM227.712 317.141333a87.978667 87.978667 0 0 1-88.021333-88.106666 88.064 88.064 0 1 1 88.021333 88.106666z m76.032 555.477334H151.68V384h152.064v488.618667zM948.266667 0H75.562667C33.792 0 0 33.024 0 73.770667v876.458666C0 991.018667 33.792 1024 75.562667 1024h872.576C989.866667 1024 1024 991.018667 1024 950.229333V73.770667C1024 33.024 989.866667 0 948.138667 0h0.128z"></path>
</svg>

    </a>
  
    <a href="https://github.com/fteem" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="ieftimovcom@gmail.com" rel="me noopener" class="iconfont"
      title="email"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>


<a href="https://ieftimov.com/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2014 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Ilija Eftimov
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>






  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  













</body>
</html>
