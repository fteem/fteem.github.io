<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to write Rails middleware | Ilija Eftimov ⚡️</title><meta name=keywords content="middleware"><meta name=description content="In my last two posts about Rack, I wrote about the basics of Rack and how to write middleware. If you have no idea what this is about, I recommend reading the last two posts (in the order above). For the rest of you, carry on - today we will see how to write awesome Rails middleware and how to use it in any Rails application. Rails and Rack play together really nice, so keep on reading!"><meta name=author content="Ilija"><link rel=canonical href=https://ieftimov.com/post/writing-rails-middleware/><link crossorigin=anonymous href=/assets/css/stylesheet.min.css rel="preload stylesheet" as=style><link rel=icon href=https://ieftimov.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ieftimov.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ieftimov.com/favicon-32x32.png><link rel=apple-touch-icon href=https://ieftimov.com/apple-touch-icon.png><link rel=mask-icon href=https://ieftimov.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.83.1"><script async defer data-domain=ieftimov.com src=https://plausible.io/js/plausible.js></script><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel=stylesheet><meta property="og:title" content="How to write Rails middleware"><meta property="og:description" content="In my last two posts about Rack, I wrote about the basics of Rack and how to write middleware. If you have no idea what this is about, I recommend reading the last two posts (in the order above). For the rest of you, carry on - today we will see how to write awesome Rails middleware and how to use it in any Rails application. Rails and Rack play together really nice, so keep on reading!"><meta property="og:type" content="article"><meta property="og:url" content="https://ieftimov.com/post/writing-rails-middleware/"><meta property="article:section" content="posts"><meta property="article:modified_time" content="2021-03-15T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to write Rails middleware"><meta name=twitter:description content="In my last two posts about Rack, I wrote about the basics of Rack and how to write middleware. If you have no idea what this is about, I recommend reading the last two posts (in the order above). For the rest of you, carry on - today we will see how to write awesome Rails middleware and how to use it in any Rails application. Rails and Rack play together really nice, so keep on reading!"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ieftimov.com/posts/"},{"@type":"ListItem","position":2,"name":"How to write Rails middleware","item":"https://ieftimov.com/post/writing-rails-middleware/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to write Rails middleware","name":"How to write Rails middleware","description":"In my last two posts about Rack, I wrote about the basics of Rack and how to write middleware. If you have no idea what this is about, I recommend reading the last two posts (in the order above). For the rest of you, carry on - today we will see how to write awesome Rails middleware and how to use it in any Rails application. Rails and Rack play together really nice, so keep on reading!","keywords":["middleware"],"articleBody":"In my last two posts about Rack, I wrote about the basics of Rack and how to write middleware. If you have no idea what this is about, I recommend reading the last two posts (in the order above). For the rest of you, carry on - today we will see how to write awesome Rails middleware and how to use it in any Rails application. Rails and Rack play together really nice, so keep on reading!\nRails on Rack Rails by default has bunch of middleware loaded that is crucial to Rails' working. If you want to see what middleware your Rails app is using, open it up in command line and run:\n1  rake middleware   You will see a big list of middleware classes that your current Rails app is using. This is a sample output on a app that I am working on. Keep in mind that your output may vary.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  use ActionDispatch::Static use Rack::Lock use # use Rack::Runtime use Rack::MethodOverride use ActionDispatch::RequestId use Rails::Rack::Logger use ActionDispatch::ShowExceptions use ActionDispatch::DebugExceptions use BetterErrors::Middleware use ActionDispatch::RemoteIp use ActionDispatch::Reloader use ActionDispatch::Callbacks use ActiveRecord::ConnectionAdapters::ConnectionManagement use ActiveRecord::QueryCache use ActionDispatch::Cookies use ActionDispatch::Session::CookieStore use ActionDispatch::Flash use ActionDispatch::ParamsParser use ActionDispatch::Head use Rack::ConditionalGet use Rack::ETag use ActionDispatch::BestStandardsSupport use Warden::Manager run MyApplication::Application.routes   The list of middleware is quite big. If you are curious what any of these middleware classes do, check this list out. Cool stuff, right? Lets see what rules and conventions apply to writing Rails middleware and how we can leverage those to write our own middleware.\nSetting up a middleware class Just like any Rack middleware that we wrote before, we will need to write a middleware class. Since v3.2, Rails gave us the ability to add middleware classes to lib/middleware. So, lets add that class.\n1 2 3 4  # lib/middleware/my_middleware.rb class MyMiddleware end   As always, there are some conventions of how Rails middleware should be created. Like any other middleware class, the class needs an initialize method and a call method. Also, the first argument of the initialize method is the application itself, and the first argument of the call method is the request environment.\n1 2 3 4 5 6 7 8 9 10 11  # lib/middleware/my_middleware.rb class MyMiddleware def initialize app @app = app end def call env # do something... end end   Using our middleware Rails allows us to mount this middleware class in the middleware stack so the application can use it in runtime. Again, you can see the middleware stack by running\n1  rake middleware   in your command line.\nMounting Mounting middleware is usually done in the config/application.rb file. But, Rails also allows us to mount different middleware for different environment. This means that you can mount middleware in any of the config/environments files. Mounting a middleware class is done with the command:\n1 2 3 4 5 6 7 8 9  module MyRailsApplication class Application Rails::Application *snip* config.middleware.use name, ,  *snip* end end   Or, in our case:\n1 2 3 4 5 6 7 8 9 10  # config/application.rb module MyRailsApplication class Application Rails::Application *snip* config.middleware.use \"MyMiddleware\" *snip* end end   There is this tiny caveat when mounting middleware - note that the class name is written as a string, not as a constant. If you mount a middleware class in the config/application.rb file the class name has to be a string. But, if you load the middleware class in the environment files (i.e. config/environment/development.rb) you can mount is as a constant:\n1 2 3 4 5 6 7 8 9 10  # config/environment/development.rb module MyRailsApplication class Application Rails::Application *snip* config.middleware.use MyMiddleware *snip* end end   As far as I can tell, the reason for this tiny caveat is when Rails is loading all the required files on server boot, when config/application.rb is loaded not all constants are loaded. But, due to the nature of the envronment files, they seem to be autoloaded at the end, when all of the constants are present in memory.\nMounting the middleware in the stack Adding our middleware at a certain point of the middleware stack is done via the insert_before and insert_after commands.\nFor example, if we, for whatever reason, want to add our MyMiddleware class just before the Rails::Rack::Logger middleware, we can use this line:\n1 2 3 4 5 6 7 8 9  module MyRailsApplication class Application Rails::Application *snip* config.middleware.insert_before \"Rails::Rack::Logger\", \"MyMiddleware\" *snip* end end   On the flipside, if we want to add our MyMiddleware class after the Rails::Rack::Logger middleware, we can use this line:\n1  config.middleware.insert_after \"Rails::Rack::Logger\", \"MyMiddleware\"   Another convenience method that Rails provides us is swap, as in swapping middleware. For example, if you wrote your own params parser middleware, that will substitute ActionDispatch::ParamsParser, you can swap it using:\n1  config.middleware.swap \"ActionDispatch::ParamsParser\", \"MyParamsParser\"   This will swap the middleware classes, as in, it will use MyParamsParser instead of ActionDispatch::ParamsParser.\nJust to give you an idea, this can be useful when debugging - you can extend the existing middleware, add some logging so you can see how the data mutates in the params parsers and continue with the normal execution of parsing the params. One can enable that middleware just in development mode, so the middleware is swapped only in development environment.\nThat being said, lets see how we can write our own tiny middleware and mount it to an existing Rails application.\nDeltaLogger We will write a tiny middleware class that will calculate the delta time of the request and log it to the Rails console. You can open any Rails application that you have laying in your computer and play with it. I promise we won’t do anything malicious. :-)\nFirst, we need a middleware class. Lets add it to the lib/middleware directory. It’s worth mentioning that the directory does not exist by default. So, if it is missing - feel free to create it.\nNext, we’ll need to add the initialize and the call method. Remember, the first argument of the initialize method is the application, and the first argument of the call method is the request environment.\n1 2 3 4 5 6 7 8 9 10 11  # lib/middleware/delta_logger.rb class DeltaLogger def initialize app @app = app end def call env # do something... end end   Next, we’ll need to calculate the total time that the applicaiton took to process the request and log it:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  # lib/middleware/delta_logger.rb class DeltaLogger def initialize app @app = app end def call env request_started_on = Time.now @status, @headers, @response = @app.call(env) request_ended_on = Time.now Rails.logger.debug \"=\" * 50 Rails.logger.debug \"Request delta time: #{request_ended_on - request_started_on}seconds.\" Rails.logger.debug \"=\" * 50 [@status, @headers, @response] end end   As you can see, this is quite trivial. We save the time before the request has been passed onto the rest of the middleware stack and the time after the middleware has finished with the request. Then, we subtract the start time from the end time and we get a number of seconds that the request processing took.\nWhat’s cool in Rails middleware is that we have the Rails application available to us in the scope of the middleware. This allows us to use to Rails logger and log the delta time.\nIf you managed to add your middleware to the Rails app, go ahead and boot it. When the server boots, issue any request to it. In the logs you will see something like:\n1 2 3  ================================================== Request delta time: 1.40877 seconds. ==================================================   This is our DeltaLogger logging the delta time.\nFormatting the output In one of the examples in the introduction of this post, I mentioned the option of passing arguments to the middleware class. Lets see how we can use this feature to improve the formatting of the DeltaLogger.\nPassing arguments is done by adding the arguments after the class name in the mounting command:\n1  config.middleware.use \"MyMiddleware\", \"First Argument\", { second: \"argument\" }, [\"nth-argument\"]   In our tiny example, we can send through the character that we want the output to be formatted with. Currently, our default formatting is done with the equals sign. Making this customizable is easily done by sending this character as the first argument:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  # lib/middleware/delta_logger.rb class DeltaLogger def initialize app, formatting_char = '=' @app = app @formatting_char = formatting_char end def call env request_started_on = Time.now @status, @headers, @response = @app.call(env) request_ended_on = Time.now Rails.logger.debug @formatting_char * 50 Rails.logger.debug \"Request delta time: #{request_ended_on - request_started_on}seconds.\" Rails.logger.debug @formatting_char * 50 [@status, @headers, @response] end end   Now, we can change the output when adding the DeltaLogger to the middleware stack:\n1  config.middleware.use \"DeltaLogger\", \"*\"   It’s worth mentioning that if your Rails application is running, when changing a middleware class you will have to reboot the application so the new changes in the middleware can be picked up. This happens because Rails loads the middleware only once - on boot.\nNow, when we send a request in the logs we can see that the DeltaLogger output changed:\n1 2 3  ************************************************** Request delta time: 1.40877 seconds. **************************************************   Logging levels Another way to leverage arguments is to make the logging level customizable. For example, you might want to change the logging level. In Rails, there are six different logging levels: :debug, :info, :warn, :error, :fatal, and :unknown. Lets make the logging level customizable.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  # lib/middleware/delta_logger.rb VALID_LOG_LEVELS = [:debug, :info, :warn, :error, :fatal, :unknown] class DeltaLogger def initialize app, log_level @app = app # Default to :info log level if the user sets an invalid log level. @log_level = VALID_LOG_LEVELS.include?(log_level) ? log_level : :info end def call env request_started_on = Time.now @status, @headers, @response = @app.call(env) request_ended_on = Time.now Rails.logger.send(@log_level, '=' * 50) Rails.logger.send(@log_level, \"Request delta time: #{request_ended_on - request_started_on}seconds.\") Rails.logger.send(@log_level, '=' * 50) [@status, @headers, @response] end end   Now, in our application.rb (or environment.rb) file, we can set the logger to use the desired loging level:\n1  config.middleware.use \"DeltaLogger\", :warn   If we reboot the Rails app and send a new request, the logs will show:\n1 2 3  [WARN] ================================================== [WARN] Request delta time: 0.270595 seconds. [WARN] ==================================================   Be aware that your output may vary because logging output relies on the logger formatter that your application is using.\nIf you are not seeing the exact output, you can plug this logging formatter in your app:\n1 2 3 4 5 6 7  # lib/delta_formatter.rb class DeltaFormatter Logger::Formatter def call(severity, time, program_name, msg) \"[#{severity}] #{String === msg ? msg : msg.inspect}\\n\" end end   You can use this formatter by including it into application.rb:\n1 2 3 4 5 6 7 8 9 10 11 12 13  *snipped* require \"./lib/delta_formatter\" module MyApplication class Application Rails::Application config.autoload_paths += %W( #{config.root}/lib/**/*) *snipped* config.middleware.use \"DeltaLogger\", :warn config.log_formatter = DeltaFormatter.new end end   After adding this, you’ll need to reboot your server and you should see the output with the severity tag.\nThread safety Last of the important topics about Rails middleware is thread-safety. When using Puma or Unicorn web servers, one of the strong sides of these servers is that they are threaded. Since our middleware runs on these servers, it has to be thread-safe, meaning, it should easily spawn multiple duplicates of it so different threads can use different objects of the same middleware.\nThe easiest and most efficient way to do this is to dup the middleware object that is created in runtime.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  # lib/middleware/delta_logger.rb VALID_LOG_LEVELS = [:debug, :info, :warn, :error, :fatal, :unknown] class DeltaLogger def initialize app, log_level @app = app # Default to :info log level if the user sets an invalid log level. @log_level = VALID_LOG_LEVELS.include?(log_level) ? log_level : :info end def call env dup._call env end def _call env request_started_on = Time.now @status, @headers, @response = @app.call(env) request_ended_on = Time.now Rails.logger.send(@log_level, '=' * 50) Rails.logger.send(@log_level, \"Request delta time: #{request_ended_on - request_started_on}seconds.\") Rails.logger.send(@log_level, '=' * 50) [@status, @headers, @response] end end   By adding the _call method and duplicating the object we make sure that any instance variables we set in _call will be set on the duped instance, not the original. This allows the web server to use a separate (duped) object for each thread which will contain different data, based on it’s execution.\nOutro As you can see, there’s quite a bit that needed to be covered in this post. I hope that this explained how you can write your own Rails middleware and mount it in the middleware stack. It’s very easy to get creative with Rails middleware as it iss highly customizable, quite low-level(ish) while you have the whole app available in runtime. Next time, we will work together on building and testing a real-life example of Rails middleware.\nUntil then, feel free to drop a comment, I would love to hear your opinions, problems and code that you’ve come up with.\nLiked this article? You can buy me a coffee. Or simply subscribe to my newsletter and get my fresh posts in your inbox. It's short and sweet, going out monthly to over 1,000 subscribers.  ","wordCount":"2259","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"2021-03-15T00:00:00Z","author":{"@type":"Person","name":"Ilija"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ieftimov.com/post/writing-rails-middleware/"},"publisher":{"@type":"Organization","name":"Ilija Eftimov ⚡️","logo":{"@type":"ImageObject","url":"https://ieftimov.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://ieftimov.com/ accesskey=h title="Ilija Eftimov ⚡️ (Alt + H)">Ilija Eftimov ⚡️</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://ieftimov.com/ title=About><span>About</span></a></li><li><a href=https://ieftimov.com/posts title=Writing><span>Writing</span></a></li><li><a href=https://ieftimov.com/newsletter title=Newsletter><span>Newsletter</span></a></li><li><a href=https://forms.gle/orfXK5jh1LRaiFzo8 title="Suggest a topic"><span>Suggest a topic</span></a></li><li><a href=https://www.buymeacoffee.com/ieftimov title="Buy me a ☕"><span>Buy me a ☕</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>How to write Rails middleware</h1><div class=post-meta>July 7, 2015&nbsp;·&nbsp;11 min&nbsp;·&nbsp;Ilija</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#rails-on-rack aria-label="Rails on Rack">Rails on Rack</a></li><li><a href=#setting-up-a-middleware-class aria-label="Setting up a middleware class">Setting up a middleware class</a></li><li><a href=#using-our-middleware aria-label="Using our middleware">Using our middleware</a><ul><li><a href=#mounting aria-label=Mounting>Mounting</a></li><li><a href=#mounting-the-middleware-in-the-stack aria-label="Mounting the middleware in the stack">Mounting the middleware in the stack</a></li></ul></li><li><a href=#deltalogger aria-label=DeltaLogger>DeltaLogger</a><ul><li><a href=#formatting-the-output aria-label="Formatting the output">Formatting the output</a></li><li><a href=#logging-levels aria-label="Logging levels">Logging levels</a></li></ul></li><li><a href=#thread-safety aria-label="Thread safety">Thread safety</a></li><li><a href=#outro aria-label=Outro>Outro</a></li></ul></div></details></div><div class=post-content><p>In my last two posts about Rack, I wrote about <a href=/rack-first-principles>the basics of
Rack</a> and <a href=/writing-rack-middleware>how to write
middleware</a>. If you have no idea what this is about,
I recommend reading the last two posts (in the order above). For the rest of
you, carry on - today we will see how to write awesome Rails middleware and how
to use it in any Rails application. Rails and Rack play together really nice,
so keep on reading!</p><h2 id=rails-on-rack>Rails on Rack<a hidden class=anchor aria-hidden=true href=#rails-on-rack>#</a></h2><p>Rails by default has bunch of middleware loaded that is crucial to Rails'
working. If you want to see what middleware your Rails app is using, open it up
in command line and run:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>rake middleware</code></pre></td></tr></table></div></div><p>You will see a big list of middleware classes that your current Rails app is
using. This is a sample output on a app that I am working on. Keep in mind
that your output may vary.</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>use ActionDispatch::Static
use Rack::Lock
use <span style=color:#4e4e4e>#&lt;ActiveSupport::Cache::Strategy::LocalCache::Middleware:0x007f93ff6810d8&gt;</span>
use Rack::Runtime
use Rack::MethodOverride
use ActionDispatch::RequestId
use Rails::Rack::Logger
use ActionDispatch::ShowExceptions
use ActionDispatch::DebugExceptions
use BetterErrors::Middleware
use ActionDispatch::RemoteIp
use ActionDispatch::Reloader
use ActionDispatch::Callbacks
use ActiveRecord::ConnectionAdapters::ConnectionManagement
use ActiveRecord::QueryCache
use ActionDispatch::Cookies
use ActionDispatch::Session::CookieStore
use ActionDispatch::Flash
use ActionDispatch::ParamsParser
use ActionDispatch::Head
use Rack::ConditionalGet
use Rack::ETag
use ActionDispatch::BestStandardsSupport
use Warden::Manager
run MyApplication::Application.routes</code></pre></td></tr></table></div></div><p>The list of middleware is quite big. If you are curious what any of these
middleware classes do, check <a href=http://guides.rubyonrails.org/rails_on_rack.html#internal-middleware-stack>this list
out</a>.
Cool stuff, right? Lets see what rules and conventions apply to writing Rails
middleware and how we can leverage those to write our own middleware.</p><h2 id=setting-up-a-middleware-class>Setting up a middleware class<a hidden class=anchor aria-hidden=true href=#setting-up-a-middleware-class>#</a></h2><p>Just like any Rack middleware that we wrote before, we will need to write a
middleware class. Since v3.2, Rails gave us the ability to add middleware
classes to <code>lib/middleware</code>. So, lets add that class.</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#4e4e4e># lib/middleware/my_middleware.rb</span>

<span style=color:#5f8700>class</span> <span style=color:#0087ff>MyMiddleware</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>As always, there are some conventions of how Rails middleware should be
created. Like any other middleware class, the class needs an <code>initialize</code>
method and a <code>call</code> method. Also, the first argument of the initialize
method is the application itself, and the first argument of the call method is
the request environment.</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#4e4e4e># lib/middleware/my_middleware.rb</span>

<span style=color:#5f8700>class</span> <span style=color:#0087ff>MyMiddleware</span>
  <span style=color:#5f8700>def</span> <span style=color:#0087ff>initialize</span> app
    @app = app
  <span style=color:#5f8700>end</span>

  <span style=color:#5f8700>def</span> <span style=color:#0087ff>call</span> env
    <span style=color:#4e4e4e># do something...</span>
  <span style=color:#5f8700>end</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><h2 id=using-our-middleware>Using our middleware<a hidden class=anchor aria-hidden=true href=#using-our-middleware>#</a></h2><p>Rails allows us to mount this middleware class in the middleware stack so the
application can use it in runtime. Again, you can see the middleware stack by
running</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>rake middleware</code></pre></td></tr></table></div></div><p>in your command line.</p><h3 id=mounting>Mounting<a hidden class=anchor aria-hidden=true href=#mounting>#</a></h3><p>Mounting middleware is usually done in the <code>config/application.rb</code> file. But,
Rails also allows us to mount different middleware for different environment.
This means that you can mount middleware in any of the <code>config/environments</code>
files. Mounting a middleware class is done with the command:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#5f8700>module</span> MyRailsApplication
  <span style=color:#5f8700>class</span> <span style=color:#0087ff>Application</span> &lt; <span style=color:#d75f00>Rails</span>::<span style=color:#d75f00>Application</span>
    *snip*

    config.middleware.use &lt;class-<span style=color:#0087ff>name</span>&gt;, &lt;first-argument&gt;, &lt;nth-argument&gt;

    *snip*
  <span style=color:#5f8700>end</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>Or, in our case:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#4e4e4e># config/application.rb</span>
<span style=color:#5f8700>module</span> MyRailsApplication
  <span style=color:#5f8700>class</span> <span style=color:#0087ff>Application</span> &lt; <span style=color:#d75f00>Rails</span>::<span style=color:#d75f00>Application</span>
    *snip*

    config.middleware.use <span style=color:#00afaf>&#34;MyMiddleware&#34;</span>

    *snip*
  <span style=color:#5f8700>end</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>There is this tiny caveat when mounting middleware - note that the class name
is written as a string, not as a constant. If you mount a middleware class in
the <code>config/application.rb</code> file the class name has to be a string. But, if
you load the middleware class in the environment files (i.e.
<code>config/environment/development.rb</code>) you can mount is as a constant:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#4e4e4e># config/environment/development.rb</span>
<span style=color:#5f8700>module</span> MyRailsApplication
  <span style=color:#5f8700>class</span> <span style=color:#0087ff>Application</span> &lt; <span style=color:#d75f00>Rails</span>::<span style=color:#d75f00>Application</span>
    *snip*

    config.middleware.use <span style=color:#d75f00>MyMiddleware</span>

    *snip*
  <span style=color:#5f8700>end</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>As far as I can tell, the reason for this tiny caveat is when Rails is loading
all the required files on server boot, when <code>config/application.rb</code> is loaded
not all constants are loaded. But, due to the nature of the envronment files,
they seem to be autoloaded at the end, when all of the constants are present in
memory.</p><h3 id=mounting-the-middleware-in-the-stack>Mounting the middleware in the stack<a hidden class=anchor aria-hidden=true href=#mounting-the-middleware-in-the-stack>#</a></h3><p>Adding our middleware at a certain point of the middleware stack is done via
the <code>insert_before</code> and <code>insert_after</code> commands.</p><p>For example, if we, for whatever reason, want to add our <code>MyMiddleware</code> class
just before the <code>Rails::Rack::Logger</code> middleware, we can use this line:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#5f8700>module</span> MyRailsApplication
  <span style=color:#5f8700>class</span> <span style=color:#0087ff>Application</span> &lt; <span style=color:#d75f00>Rails</span>::<span style=color:#d75f00>Application</span>
    *snip*

    config.middleware.insert_before <span style=color:#00afaf>&#34;Rails::Rack::Logger&#34;</span>, <span style=color:#00afaf>&#34;MyMiddleware&#34;</span>

    *snip*
  <span style=color:#5f8700>end</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>On the flipside, if we want to add our <code>MyMiddleware</code> class after the
<code>Rails::Rack::Logger</code> middleware, we can use this line:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>config.middleware.insert_after <span style=color:#00afaf>&#34;Rails::Rack::Logger&#34;</span>, <span style=color:#00afaf>&#34;MyMiddleware&#34;</span></code></pre></td></tr></table></div></div><p>Another convenience method that Rails provides us is <code>swap</code>, as in swapping
middleware. For example, if you wrote your own params parser middleware, that
will substitute <code>ActionDispatch::ParamsParser</code>, you can swap it using:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>config.middleware.swap <span style=color:#00afaf>&#34;ActionDispatch::ParamsParser&#34;</span>, <span style=color:#00afaf>&#34;MyParamsParser&#34;</span></code></pre></td></tr></table></div></div><p>This will swap the middleware classes, as in, it will use <code>MyParamsParser</code>
instead of <code>ActionDispatch::ParamsParser</code>.</p><p>Just to give you an idea, this can be useful when debugging - you can extend
the existing middleware, add some logging so you can see how the data mutates
in the params parsers and continue with the normal execution of parsing the
params. One can enable that middleware just in development mode, so the
middleware is swapped only in development environment.</p><p>That being said, lets see how we can write our own tiny middleware and mount it
to an existing Rails application.</p><h2 id=deltalogger>DeltaLogger<a hidden class=anchor aria-hidden=true href=#deltalogger>#</a></h2><p>We will write a tiny middleware class that will calculate the delta time of the
request and log it to the Rails console. You can open any Rails application
that you have laying in your computer and play with it. I promise we won&rsquo;t do
anything malicious. :-)</p><p>First, we need a middleware class. Lets add it to the <code>lib/middleware</code>
directory. It&rsquo;s worth mentioning that the directory does not exist by default.
So, if it is missing - feel free to create it.</p><p>Next, we&rsquo;ll need to add the <code>initialize</code> and the <code>call</code> method. Remember, the
first argument of the <code>initialize</code> method is the application, and the first
argument of the <code>call</code> method is the request environment.</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#4e4e4e># lib/middleware/delta_logger.rb</span>

<span style=color:#5f8700>class</span> <span style=color:#0087ff>DeltaLogger</span>
  <span style=color:#5f8700>def</span> <span style=color:#0087ff>initialize</span> app
    @app = app
  <span style=color:#5f8700>end</span>

  <span style=color:#5f8700>def</span> <span style=color:#0087ff>call</span> env
    <span style=color:#4e4e4e># do something...</span>
  <span style=color:#5f8700>end</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>Next, we&rsquo;ll need to calculate the total time that the applicaiton took to
process the request and log it:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#4e4e4e># lib/middleware/delta_logger.rb</span>

<span style=color:#5f8700>class</span> <span style=color:#0087ff>DeltaLogger</span>
  <span style=color:#5f8700>def</span> <span style=color:#0087ff>initialize</span> app
    @app = app
  <span style=color:#5f8700>end</span>

  <span style=color:#5f8700>def</span> <span style=color:#0087ff>call</span> env
    request_started_on = <span style=color:#d75f00>Time</span>.now
    @status, @headers, @response = @app.call(env)
    request_ended_on = <span style=color:#d75f00>Time</span>.now

    <span style=color:#d75f00>Rails</span>.logger.debug <span style=color:#00afaf>&#34;=&#34;</span> * <span style=color:#00afaf>50</span>
    <span style=color:#d75f00>Rails</span>.logger.debug <span style=color:#00afaf>&#34;Request delta time: </span><span style=color:#00afaf>#{</span>request_ended_on - request_started_on<span style=color:#00afaf>}</span><span style=color:#00afaf> seconds.&#34;</span>
    <span style=color:#d75f00>Rails</span>.logger.debug <span style=color:#00afaf>&#34;=&#34;</span> * <span style=color:#00afaf>50</span>

    [@status, @headers, @response]
  <span style=color:#5f8700>end</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>As you can see, this is quite trivial. We save the time before the request has
been passed onto the rest of the middleware stack and the time after the
middleware has finished with the request. Then, we subtract the start time from
the end time and we get a number of seconds that the request processing took.</p><p>What&rsquo;s cool in Rails middleware is that we have the Rails application available
to us in the scope of the middleware. This allows us to use to Rails logger and
log the delta time.</p><p>If you managed to add your middleware to the Rails app, go ahead and boot it.
When the server boots, issue any request to it. In the logs you will see
something like:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>==================================================
Request delta time: 1.40877 seconds.
==================================================</code></pre></td></tr></table></div></div><p>This is our <code>DeltaLogger</code> logging the delta time.</p><h3 id=formatting-the-output>Formatting the output<a hidden class=anchor aria-hidden=true href=#formatting-the-output>#</a></h3><p>In one of the examples in the introduction of this post, I mentioned the option
of passing arguments to the middleware class. Lets see how we can use this
feature to improve the formatting of the <code>DeltaLogger</code>.</p><p>Passing arguments is done by adding the arguments after the class name in the
mounting command:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>config.middleware.use <span style=color:#00afaf>&#34;MyMiddleware&#34;</span>, <span style=color:#00afaf>&#34;First Argument&#34;</span>, { <span style=color:#00afaf>second</span>: <span style=color:#00afaf>&#34;argument&#34;</span> }, [<span style=color:#00afaf>&#34;nth-argument&#34;</span>]</code></pre></td></tr></table></div></div><p>In our tiny example, we can send through the character that we want the output
to be formatted with. Currently, our default formatting is done with the equals
sign. Making this customizable is easily done by sending this character as the
first argument:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#4e4e4e># lib/middleware/delta_logger.rb</span>

<span style=color:#5f8700>class</span> <span style=color:#0087ff>DeltaLogger</span>
  <span style=color:#5f8700>def</span> <span style=color:#0087ff>initialize</span> app, formatting_char = <span style=color:#00afaf>&#39;=&#39;</span>
    @app = app
    @formatting_char = formatting_char
  <span style=color:#5f8700>end</span>

  <span style=color:#5f8700>def</span> <span style=color:#0087ff>call</span> env
    request_started_on = <span style=color:#d75f00>Time</span>.now
    @status, @headers, @response = @app.call(env)
    request_ended_on = <span style=color:#d75f00>Time</span>.now

    <span style=color:#d75f00>Rails</span>.logger.debug @formatting_char * <span style=color:#00afaf>50</span>
    <span style=color:#d75f00>Rails</span>.logger.debug <span style=color:#00afaf>&#34;Request delta time: </span><span style=color:#00afaf>#{</span>request_ended_on - request_started_on<span style=color:#00afaf>}</span><span style=color:#00afaf> seconds.&#34;</span>
    <span style=color:#d75f00>Rails</span>.logger.debug @formatting_char * <span style=color:#00afaf>50</span>

    [@status, @headers, @response]
  <span style=color:#5f8700>end</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>Now, we can change the output when adding the <code>DeltaLogger</code> to the middleware
stack:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>config.middleware.use <span style=color:#00afaf>&#34;DeltaLogger&#34;</span>, <span style=color:#00afaf>&#34;*&#34;</span></code></pre></td></tr></table></div></div><p>It&rsquo;s worth mentioning that if your Rails application is running, when changing
a middleware class you will have to reboot the application so the new changes
in the middleware can be picked up. This happens because Rails loads the
middleware only once - on boot.</p><p>Now, when we send a request in the logs we can see that the <code>DeltaLogger</code>
output changed:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>**************************************************
Request delta time: 1.40877 seconds.
**************************************************</code></pre></td></tr></table></div></div><h3 id=logging-levels>Logging levels<a hidden class=anchor aria-hidden=true href=#logging-levels>#</a></h3><p>Another way to leverage arguments is to make the logging level customizable.
For example, you might want to change the logging level. In Rails, there are
six different logging levels: <code>:debug</code>, <code>:info</code>, <code>:warn</code>, <code>:error</code>, <code>:fatal</code>,
and <code>:unknown</code>. Lets make the logging level customizable.</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#4e4e4e># lib/middleware/delta_logger.rb</span>

<span style=color:#d75f00>VALID_LOG_LEVELS</span> = [<span style=color:#00afaf>:debug</span>, <span style=color:#00afaf>:info</span>, <span style=color:#00afaf>:warn</span>, <span style=color:#00afaf>:error</span>, <span style=color:#00afaf>:fatal</span>, <span style=color:#00afaf>:unknown</span>]

<span style=color:#5f8700>class</span> <span style=color:#0087ff>DeltaLogger</span>
  <span style=color:#5f8700>def</span> <span style=color:#0087ff>initialize</span> app, log_level
    @app = app
    <span style=color:#4e4e4e># Default to :info log level if the user sets an invalid log level.</span>
    @log_level = <span style=color:#d75f00>VALID_LOG_LEVELS</span>.include?(log_level) ?  log_level : <span style=color:#00afaf>:info</span>
  <span style=color:#5f8700>end</span>

  <span style=color:#5f8700>def</span> <span style=color:#0087ff>call</span> env
    request_started_on = <span style=color:#d75f00>Time</span>.now
    @status, @headers, @response = @app.call(env)
    request_ended_on = <span style=color:#d75f00>Time</span>.now

    <span style=color:#d75f00>Rails</span>.logger.send(@log_level, <span style=color:#00afaf>&#39;=&#39;</span> * <span style=color:#00afaf>50</span>)
    <span style=color:#d75f00>Rails</span>.logger.send(@log_level, <span style=color:#00afaf>&#34;Request delta time: </span><span style=color:#00afaf>#{</span>request_ended_on - request_started_on<span style=color:#00afaf>}</span><span style=color:#00afaf> seconds.&#34;</span>)
    <span style=color:#d75f00>Rails</span>.logger.send(@log_level, <span style=color:#00afaf>&#39;=&#39;</span> * <span style=color:#00afaf>50</span>)

    [@status, @headers, @response]
  <span style=color:#5f8700>end</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>Now, in our application.rb (or environment.rb) file, we can set the logger to
use the desired loging level:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>config.middleware.use <span style=color:#00afaf>&#34;DeltaLogger&#34;</span>, <span style=color:#00afaf>:warn</span></code></pre></td></tr></table></div></div><p>If we reboot the Rails app and send a new request, the logs will show:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>[WARN] ==================================================
[WARN] Request delta time: 0.270595 seconds.
[WARN] ==================================================</code></pre></td></tr></table></div></div><p>Be aware that your output may vary because logging output relies on the <a href=http://api.rubyonrails.org/classes/ActiveSupport/Logger/SimpleFormatter.html>logger
formatter</a>
that your application is using.</p><p>If you are not seeing the exact output, you can plug this logging formatter in
your app:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#4e4e4e># lib/delta_formatter.rb</span>

<span style=color:#5f8700>class</span> <span style=color:#0087ff>DeltaFormatter</span> &lt; <span style=color:#d75f00>Logger</span>::<span style=color:#d75f00>Formatter</span>
  <span style=color:#5f8700>def</span> <span style=color:#0087ff>call</span>(severity, time, program_name, msg)
    <span style=color:#00afaf>&#34;[</span><span style=color:#00afaf>#{</span>severity<span style=color:#00afaf>}</span><span style=color:#00afaf>] </span><span style=color:#00afaf>#{</span><span style=color:#0087ff>String</span> === msg ? msg : msg.inspect<span style=color:#00afaf>}</span><span style=color:#af0000>\n</span><span style=color:#00afaf>&#34;</span>
  <span style=color:#5f8700>end</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>You can use this formatter by including it into <code>application.rb</code>:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>*snipped*
<span style=color:#0087ff>require</span> <span style=color:#00afaf>&#34;./lib/delta_formatter&#34;</span>

<span style=color:#5f8700>module</span> MyApplication
  <span style=color:#5f8700>class</span> <span style=color:#0087ff>Application</span> &lt; <span style=color:#d75f00>Rails</span>::<span style=color:#d75f00>Application</span>
    config.autoload_paths += <span style=color:#00afaf>%W( </span><span style=color:#00afaf>#{</span>config.root<span style=color:#00afaf>}</span><span style=color:#00afaf>/lib/**/*)</span>

    *snipped*

    config.middleware.use <span style=color:#00afaf>&#34;DeltaLogger&#34;</span>, <span style=color:#00afaf>:warn</span>
    config.log_formatter = <span style=color:#d75f00>DeltaFormatter</span>.new
  <span style=color:#5f8700>end</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>After adding this, you&rsquo;ll need to reboot your server and you should see the
output with the severity tag.</p><h2 id=thread-safety>Thread safety<a hidden class=anchor aria-hidden=true href=#thread-safety>#</a></h2><p>Last of the important topics about Rails middleware is thread-safety. When
using Puma or Unicorn web servers, one of the strong sides of these servers is
that they are threaded. Since our middleware runs on these servers, it has to
be thread-safe, meaning, it should easily spawn multiple duplicates of it so
different threads can use different objects of the same middleware.</p><p>The easiest and most efficient way to do this is to <code>dup</code> the middleware
object that is created in runtime.</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#4e4e4e># lib/middleware/delta_logger.rb</span>

<span style=color:#d75f00>VALID_LOG_LEVELS</span> = [<span style=color:#00afaf>:debug</span>, <span style=color:#00afaf>:info</span>, <span style=color:#00afaf>:warn</span>, <span style=color:#00afaf>:error</span>, <span style=color:#00afaf>:fatal</span>, <span style=color:#00afaf>:unknown</span>]

<span style=color:#5f8700>class</span> <span style=color:#0087ff>DeltaLogger</span>
  <span style=color:#5f8700>def</span> <span style=color:#0087ff>initialize</span> app, log_level
    @app = app
    <span style=color:#4e4e4e># Default to :info log level if the user sets an invalid log level.</span>
    @log_level = <span style=color:#d75f00>VALID_LOG_LEVELS</span>.include?(log_level) ? log_level : <span style=color:#00afaf>:info</span>
  <span style=color:#5f8700>end</span>

  <span style=color:#5f8700>def</span> <span style=color:#0087ff>call</span> env
    <span style=color:#0087ff>dup</span>._call env
  <span style=color:#5f8700>end</span>

  <span style=color:#5f8700>def</span> <span style=color:#0087ff>_call</span> env
    request_started_on = <span style=color:#d75f00>Time</span>.now
    @status, @headers, @response = @app.call(env)
    request_ended_on = <span style=color:#d75f00>Time</span>.now

    <span style=color:#d75f00>Rails</span>.logger.send(@log_level, <span style=color:#00afaf>&#39;=&#39;</span> * <span style=color:#00afaf>50</span>)
    <span style=color:#d75f00>Rails</span>.logger.send(@log_level, <span style=color:#00afaf>&#34;Request delta time: </span><span style=color:#00afaf>#{</span>request_ended_on - request_started_on<span style=color:#00afaf>}</span><span style=color:#00afaf> seconds.&#34;</span>)
    <span style=color:#d75f00>Rails</span>.logger.send(@log_level, <span style=color:#00afaf>&#39;=&#39;</span> * <span style=color:#00afaf>50</span>)

    [@status, @headers, @response]
  <span style=color:#5f8700>end</span>
<span style=color:#5f8700>end</span></code></pre></td></tr></table></div></div><p>By adding the <code>_call</code> method and duplicating the object we make sure that
any instance variables we set in <code>_call</code> will be set on the duped instance,
not the original. This allows the web server to use a separate (duped) object
for each thread which will contain different data, based on it&rsquo;s execution.</p><h2 id=outro>Outro<a hidden class=anchor aria-hidden=true href=#outro>#</a></h2><p>As you can see, there&rsquo;s quite a bit that needed to be covered in this post. I
hope that this explained how you can write your own Rails middleware and mount
it in the middleware stack. It&rsquo;s very easy to get creative with Rails
middleware as it iss highly customizable, quite low-level(ish) while you have
the whole app available in runtime. Next time, we will work together on
building and testing a real-life example of Rails middleware.</p><p>Until then, feel free to drop a comment, I would love to hear your opinions,
problems and code that you&rsquo;ve come up with.</p><section class=subscribe><b>Liked this article?</b>
You can <a href=https://www.buymeacoffee.com/ieftimov>buy me a coffee</a>.
Or simply <a href=/newsletter>subscribe to my
newsletter</a> and get my fresh posts in your inbox. It's short and sweet,
going out monthly to over 1,000 subscribers.</section></div><footer class=post-footer><ul class=post-tags><li><a href=https://ieftimov.com/tags/middleware/>middleware</a></li></ul><nav class=paginav><a class=prev href=https://ieftimov.com/post/migrate-rspec-to-minitest/><span class=title>« Prev Page</span><br><span>Migrating a test suite from RSpec to Minitest</span></a>
<a class=next href=https://ieftimov.com/post/writing-rack-middleware/><span class=title>Next Page »</span><br><span>Rack: Writing middleware</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share How to write Rails middleware on twitter" href="https://twitter.com/intent/tweet/?text=How%20to%20write%20Rails%20middleware&url=https%3a%2f%2fieftimov.com%2fpost%2fwriting-rails-middleware%2f&hashtags=middleware"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to write Rails middleware on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fieftimov.com%2fpost%2fwriting-rails-middleware%2f&title=How%20to%20write%20Rails%20middleware&summary=How%20to%20write%20Rails%20middleware&source=https%3a%2f%2fieftimov.com%2fpost%2fwriting-rails-middleware%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to write Rails middleware on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fieftimov.com%2fpost%2fwriting-rails-middleware%2f&title=How%20to%20write%20Rails%20middleware"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to write Rails middleware on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fieftimov.com%2fpost%2fwriting-rails-middleware%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to write Rails middleware on whatsapp" href="https://api.whatsapp.com/send?text=How%20to%20write%20Rails%20middleware%20-%20https%3a%2f%2fieftimov.com%2fpost%2fwriting-rails-middleware%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to write Rails middleware on telegram" href="https://telegram.me/share/url?text=How%20to%20write%20Rails%20middleware&url=https%3a%2f%2fieftimov.com%2fpost%2fwriting-rails-middleware%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>Copyright 2021 © Ilija Eftimov</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>