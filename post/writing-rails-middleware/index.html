<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>How to write Rails middleware - Ilija Eftimov</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta itemprop="name" content="How to write Rails middleware">
<meta itemprop="description" content="In my last two posts about Rack, I wrote about the basics of Rack and how to write middleware. If you have no idea what this is about, I recommend reading the last two posts (in the order above). For the rest of you, carry on - today we will see how to write awesome Rails middleware and how to use it in any Rails application. Rails and Rack play together really nice, so keep on reading!">

<meta itemprop="wordCount" content="2335">



<meta itemprop="keywords" content="middleware," /><meta property="og:title" content="How to write Rails middleware" />
<meta property="og:description" content="In my last two posts about Rack, I wrote about the basics of Rack and how to write middleware. If you have no idea what this is about, I recommend reading the last two posts (in the order above). For the rest of you, carry on - today we will see how to write awesome Rails middleware and how to use it in any Rails application. Rails and Rack play together really nice, so keep on reading!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ieftimov.com/post/writing-rails-middleware/" />
<meta property="article:published_time" content="2015-07-07T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to write Rails middleware"/>
<meta name="twitter:description" content="In my last two posts about Rack, I wrote about the basics of Rack and how to write middleware. If you have no idea what this is about, I recommend reading the last two posts (in the order above). For the rest of you, carry on - today we will see how to write awesome Rails middleware and how to use it in any Rails application. Rails and Rack play together really nice, so keep on reading!"/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://ieftimov.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://ieftimov.com/css/main.css" />
		<link rel="stylesheet" type="text/css" href="https://ieftimov.com/css/overrides.css" />
	

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="https://ieftimov.com/js/main.js"></script><script src="https://ieftimov.com/js/tooltip.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="https://ieftimov.com/">
				<img src="/avatar.png" alt="Ilija Eftimov" />
			</a>
		</div>
	
	<h1 class="site-title"><a href="https://ieftimov.com/">Ilija Eftimov</a></h1>
	<div class="site-description"><p>A human, interested in building products and software.</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/fteem" title="Github"><i data-feather="github"></i></a></li><li><a href="https://twitter.com/fteem" title="Twitter"><i data-feather="twitter"></i></a></li><li><a href="https://www.linkedin.com/in/ieftimov" title="Linkedin"><i data-feather="linkedin"></i></a></li><li><a href="mailto:blog@ieftimov.com" title="Email"><i data-feather="mail"></i></a></li></ul>
		</nav></div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/categories/testing-in-go">Testing in Go</a>
			</li>
			
			<li>
				<a href="/posts">Archive</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="https://forms.gle/orfXK5jh1LRaiFzo8">Suggest a topic</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">07</span>
							<span class="rest">Jul 2015</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">How to write Rails middleware</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>In my last two posts about Rack, I wrote about <a href="/rack-first-principles">the basics of Rack</a>
and <a href="/writing-rack-middleware">how to write middleware</a>. If you have no idea
what this is about, I recommend reading the last two posts (in the order above).
For the rest of you, carry on - today we will see how to write awesome Rails
middleware and how to use it in any Rails application. Rails and Rack play
together really nice, so keep on reading!</p>
<h2 id="rails-on-rack">Rails on Rack</h2>
<p>Rails by default has bunch of middleware loaded that is crucial to Rails&rsquo; working. If you want
to see what middleware your Rails app is using, open it up in command line and run:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rake middleware</code></pre></div>
<p>You will see a big list of middleware classes that your current Rails app is using.
This is a sample output on a app that I am working on. Keep in mind that your output
may vary.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">use ActionDispatch::Static
use Rack::Lock
use <span style="color:#998;font-style:italic">#&lt;ActiveSupport::Cache::Strategy::LocalCache::Middleware:0x007f93ff6810d8&gt;</span>
use Rack::Runtime
use Rack::MethodOverride
use ActionDispatch::RequestId
use Rails::Rack::Logger
use ActionDispatch::ShowExceptions
use ActionDispatch::DebugExceptions
use BetterErrors::Middleware
use ActionDispatch::RemoteIp
use ActionDispatch::Reloader
use ActionDispatch::Callbacks
use ActiveRecord::ConnectionAdapters::ConnectionManagement
use ActiveRecord::QueryCache
use ActionDispatch::Cookies
use ActionDispatch::Session::CookieStore
use ActionDispatch::Flash
use ActionDispatch::ParamsParser
use ActionDispatch::Head
use Rack::ConditionalGet
use Rack::ETag
use ActionDispatch::BestStandardsSupport
use Warden::Manager
run MyApplication::Application.routes</code></pre></div>
<p>The list of middleware is quite big. If you are curious what any of these middleware classes do,
check <a href="http://guides.rubyonrails.org/rails_on_rack.html#internal-middleware-stack">this list out</a>{:target=&rdquo;_blank&rdquo;}.
Cool stuff, right? Lets see what rules and conventions apply to writing Rails middleware
and how we can leverage those to write our own middleware.</p>
<h2 id="setting-up-a-middleware-class">Setting up a middleware class</h2>
<p>Just like any Rack middleware that we wrote before, we will need to write a middleware class.
Since v3.2, Rails gave us the ability to add middleware classes to <code>app/middleware</code>.
So, lets add that class.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># app/middleware/my_middleware.rb</span>

<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">MyMiddleware</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>Also, another option is using the <code>lib</code> directory, but you have to make sure that
the directory is in the autoload path. Or, you can manually require the middleware class
in the initializer.</p>
<p>As always, there are some conventions of how Rails middleware should be created.
Like any other middleware class, the class needs an <code>initialize</code> method and a <code>call</code> method.
Also, the first argument of the initialize method is the application itself, and
the first argument of the call method is the request environment.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># app/middleware/my_middleware.rb</span>

<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">MyMiddleware</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span> app
    @app <span style="font-weight:bold">=</span> app
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">call</span> env
    <span style="color:#998;font-style:italic"># do something...</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<h2 id="using-our-middleware">Using our middleware</h2>
<p>Rails allows us to mount this middleware class in the middleware stack so
the application can use it in runtime. Again, you can see the middleware stack by running
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rake middleware</code></pre></div>
in your command line.</p>
<h3 id="mounting">Mounting</h3>
<p>Mounting middleware is usually done in the <code>config/application.rb</code> file.
But, Rails also allows us to mount different middleware for different environment. This means that
you can mount middleware in any of the <code>config/environments</code> files. Mounting a
middleware class is done with the command:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">module</span> <span style="color:#555">MyRailsApplication</span>
  <span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Application</span> <span style="font-weight:bold">&lt;</span> <span style="color:#008080">Rails</span><span style="font-weight:bold">::</span><span style="color:#008080">Application</span>
    <span style="font-weight:bold">*</span>snip<span style="font-weight:bold">*</span>

    config<span style="font-weight:bold">.</span>middleware<span style="font-weight:bold">.</span>use <span style="font-weight:bold">&lt;</span>class<span style="font-weight:bold">-</span><span style="color:#999">name</span><span style="font-weight:bold">&gt;</span>, <span style="font-weight:bold">&lt;</span>first<span style="font-weight:bold">-</span>argument<span style="font-weight:bold">&gt;</span>, <span style="font-weight:bold">&lt;</span>nth<span style="font-weight:bold">-</span>argument<span style="font-weight:bold">&gt;</span>

    <span style="font-weight:bold">*</span>snip<span style="font-weight:bold">*</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>Or, in our case:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># config/application.rb</span>
<span style="font-weight:bold">module</span> <span style="color:#555">MyRailsApplication</span>
  <span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Application</span> <span style="font-weight:bold">&lt;</span> <span style="color:#008080">Rails</span><span style="font-weight:bold">::</span><span style="color:#008080">Application</span>
    <span style="font-weight:bold">*</span>snip<span style="font-weight:bold">*</span>

    config<span style="font-weight:bold">.</span>middleware<span style="font-weight:bold">.</span>use <span style="color:#b84">&#34;</span><span style="color:#b84">MyMiddleware</span><span style="color:#b84">&#34;</span>

    <span style="font-weight:bold">*</span>snip<span style="font-weight:bold">*</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>There is this tiny caveat when mounting middleware - note that the class name
is written as a string, not as a constant. If you mount a middleware class in the
<code>config/application.rb</code> file the class name has to be a string. But, if you load
the middleware class in the environment files (i.e. <code>config/environment/development.rb</code>)
you can mount is as a constant:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># config/environment/development.rb</span>
<span style="font-weight:bold">module</span> <span style="color:#555">MyRailsApplication</span>
  <span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Application</span> <span style="font-weight:bold">&lt;</span> <span style="color:#008080">Rails</span><span style="font-weight:bold">::</span><span style="color:#008080">Application</span>
    <span style="font-weight:bold">*</span>snip<span style="font-weight:bold">*</span>

    config<span style="font-weight:bold">.</span>middleware<span style="font-weight:bold">.</span>use <span style="color:#008080">MyMiddleware</span>

    <span style="font-weight:bold">*</span>snip<span style="font-weight:bold">*</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>As far as I can tell, the reason for this tiny caveat is when Rails is loading
all the required files on server boot, when <code>config/application.rb</code> is loaded
not all constants are loaded. But, due to the nature of the envronment files, they
seem to be autoloaded at the end, when all of the constants are present in memory.</p>
<h3 id="mounting-the-middleware-in-the-stack">Mounting the middleware in the stack</h3>
<p>Adding our middleware at a certain point of the middleware stack is done via
the <code>insert_before</code> and <code>insert_after</code> commands.</p>
<p>For example, if we, for whatever reason, want to add our <code>MyMiddleware</code> class
just before the <code>Rails::Rack::Logger</code> middleware, we can use this line:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">module</span> <span style="color:#555">MyRailsApplication</span>
  <span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Application</span> <span style="font-weight:bold">&lt;</span> <span style="color:#008080">Rails</span><span style="font-weight:bold">::</span><span style="color:#008080">Application</span>
    <span style="font-weight:bold">*</span>snip<span style="font-weight:bold">*</span>

    config<span style="font-weight:bold">.</span>middleware<span style="font-weight:bold">.</span>insert_before <span style="color:#b84">&#34;</span><span style="color:#b84">Rails::Rack::Logger</span><span style="color:#b84">&#34;</span>, <span style="color:#b84">&#34;</span><span style="color:#b84">MyMiddleware</span><span style="color:#b84">&#34;</span>

    <span style="font-weight:bold">*</span>snip<span style="font-weight:bold">*</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>On the flipside, if we want to add our <code>MyMiddleware</code> class after the
<code>Rails::Rack::Logger</code> middleware, we can use this line:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">config<span style="font-weight:bold">.</span>middleware<span style="font-weight:bold">.</span>insert_after <span style="color:#b84">&#34;</span><span style="color:#b84">Rails::Rack::Logger</span><span style="color:#b84">&#34;</span>, <span style="color:#b84">&#34;</span><span style="color:#b84">MyMiddleware</span><span style="color:#b84">&#34;</span></code></pre></div>
<p>Another convenience method that Rails provides us is <code>swap</code>, as in swapping middleware.
For example, if you wrote your own params parser middleware, that will substitute
<code>ActionDispatch::ParamsParser</code>, you can swap it using:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">config<span style="font-weight:bold">.</span>middleware<span style="font-weight:bold">.</span>swap <span style="color:#b84">&#34;</span><span style="color:#b84">ActionDispatch::ParamsParser</span><span style="color:#b84">&#34;</span>, <span style="color:#b84">&#34;</span><span style="color:#b84">MyParamsParser</span><span style="color:#b84">&#34;</span></code></pre></div>
<p>This will swap the middleware classes, as in, it will use <code>MyParamsParser</code> instead
of <code>ActionDispatch::ParamsParser</code>.</p>
<p>Just to give you an idea, this can be useful when debugging - you can extend the
existing middleware, add some logging so you can see how the data mutates in the
params parsers and continue with the normal execution of parsing the params.
One can enable that middleware just in development mode, so the middleware is swapped only in
development environment.</p>
<p>That being said, lets see how we can write our own tiny middleware and mount it to an existing Rails application.</p>
<h2 id="deltalogger">DeltaLogger</h2>
<p>We will write a tiny middleware class that will calculate the delta time of the request
and log it to the Rails console. You can open any Rails application that you have
laying in your computer and play with it. I promise we won't do anything malicious. :-)</p>
<p>First, we need a middleware class. Lets add it to the <code>app/middleware</code> directory.
It's worth mentioning that the directory does not exist by default.
So, if it is missing - feel free to create it.</p>
<p>Next, we'll need to add the <code>initialize</code> and the <code>call</code> method. Remember, the first
argument of the <code>initialize</code> method is the application, and the first argument of the <code>call</code> method
is the request environment.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># app/middleware/delta_logger.rb</span>

<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">DeltaLogger</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span> app
    @app <span style="font-weight:bold">=</span> app
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">call</span> env
    <span style="color:#998;font-style:italic"># do something...</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>Next, we'll need to calculate the total time that the applicaiton took to process the request
and log it:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># app/middleware/delta_logger.rb</span>

<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">DeltaLogger</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span> app
    @app <span style="font-weight:bold">=</span> app
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">call</span> env
    request_started_on <span style="font-weight:bold">=</span> <span style="color:#008080">Time</span><span style="font-weight:bold">.</span>now
    @status, @headers, @response <span style="font-weight:bold">=</span> @app<span style="font-weight:bold">.</span>call(env)
    request_ended_on <span style="font-weight:bold">=</span> <span style="color:#008080">Time</span><span style="font-weight:bold">.</span>now

    <span style="color:#008080">Rails</span><span style="font-weight:bold">.</span>logger<span style="font-weight:bold">.</span>debug <span style="color:#b84">&#34;</span><span style="color:#b84">=</span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">*</span> <span style="color:#099">50</span>
    <span style="font-weight:bold"></span><span style="color:#008080">Rails</span><span style="font-weight:bold">.</span>logger<span style="font-weight:bold">.</span>debug <span style="color:#b84">&#34;</span><span style="color:#b84">Request delta time: </span><span style="color:#b84">#{</span>request_ended_on <span style="font-weight:bold">-</span> request_started_on<span style="color:#b84">}</span><span style="color:#b84"> seconds.</span><span style="color:#b84">&#34;</span>
    <span style="color:#008080">Rails</span><span style="font-weight:bold">.</span>logger<span style="font-weight:bold">.</span>debug <span style="color:#b84">&#34;</span><span style="color:#b84">=</span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">*</span> <span style="color:#099">50</span>

    <span style="font-weight:bold"></span><span style="font-weight:bold">[</span>@status, @headers, @response<span style="font-weight:bold">]</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>As you can see, this is quite trivial. We save the time before the request has been
passed onto the rest of the middleware stack and the time after the middleware has finished with
the request. Then, we subtract the start time from the end time and we get a number of seconds
that the request processing took.</p>
<p>What's cool in Rails middleware is that we have the Rails application available to us in
the scope of the middleware. This allows us to use to Rails logger and log the delta time.</p>
<p>If you managed to add your middleware to the Rails app, go ahead and boot it. When
the server boots, issue any request to it. In the logs you will see something like:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span>
Request delta time: 1.40877 seconds.
<span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span></code></pre></div>
<p>This is our <code>DeltaLogger</code> logging the delta time.</p>
<h3 id="formatting-the-output">Formatting the output</h3>
<p>In one of the examples in the introduction of this post, I mentioned the option
of passing arguments to the middleware class. Lets see how we can use this
feature to improve the formatting of the <code>DeltaLogger</code>.</p>
<p>Passing arguments is done by adding the arguments after the class name in the mounting command:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">config<span style="font-weight:bold">.</span>middleware<span style="font-weight:bold">.</span>use <span style="color:#b84">&#34;</span><span style="color:#b84">MyMiddleware</span><span style="color:#b84">&#34;</span>, <span style="color:#b84">&#34;</span><span style="color:#b84">First Argument</span><span style="color:#b84">&#34;</span>, { <span style="color:#b84">second</span>: <span style="color:#b84">&#34;</span><span style="color:#b84">argument</span><span style="color:#b84">&#34;</span> }, <span style="font-weight:bold">[</span><span style="color:#b84">&#34;</span><span style="color:#b84">nth-argument</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">]</span></code></pre></div>
<p>In our tiny example, we can send through the character that we want the output
to be formatted with. Currently, our default formatting is done with the equals sign.
Making this customizable is easily done by sending this character as the first argument:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># app/middleware/delta_logger.rb</span>

<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">DeltaLogger</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span> app, formatting_char <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;=&#39;</span>
    @app <span style="font-weight:bold">=</span> app
    @formatting_char <span style="font-weight:bold">=</span> formatting_char
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">call</span> env
    request_started_on <span style="font-weight:bold">=</span> <span style="color:#008080">Time</span><span style="font-weight:bold">.</span>now
    @status, @headers, @response <span style="font-weight:bold">=</span> @app<span style="font-weight:bold">.</span>call(env)
    request_ended_on <span style="font-weight:bold">=</span> <span style="color:#008080">Time</span><span style="font-weight:bold">.</span>now

    <span style="color:#008080">Rails</span><span style="font-weight:bold">.</span>logger<span style="font-weight:bold">.</span>debug @formatting_char <span style="font-weight:bold">*</span> <span style="color:#099">50</span>
    <span style="font-weight:bold"></span><span style="color:#008080">Rails</span><span style="font-weight:bold">.</span>logger<span style="font-weight:bold">.</span>debug <span style="color:#b84">&#34;</span><span style="color:#b84">Request delta time: </span><span style="color:#b84">#{</span>request_ended_on <span style="font-weight:bold">-</span> request_started_on<span style="color:#b84">}</span><span style="color:#b84"> seconds.</span><span style="color:#b84">&#34;</span>
    <span style="color:#008080">Rails</span><span style="font-weight:bold">.</span>logger<span style="font-weight:bold">.</span>debug @formatting_char <span style="font-weight:bold">*</span> <span style="color:#099">50</span>

    <span style="font-weight:bold"></span><span style="font-weight:bold">[</span>@status, @headers, @response<span style="font-weight:bold">]</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>Now, we can change the output when adding the <code>DeltaLogger</code> to the middleware stack:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">config<span style="font-weight:bold">.</span>middleware<span style="font-weight:bold">.</span>use <span style="color:#b84">&#34;</span><span style="color:#b84">DeltaLogger</span><span style="color:#b84">&#34;</span>, <span style="color:#b84">&#34;</span><span style="color:#b84">*</span><span style="color:#b84">&#34;</span></code></pre></div>
<p>It's worth mentioning that if your Rails application is running, when changing
a middleware class you will have to reboot the application so the new changes in
the middleware can be picked up. This happens because Rails loads the middleware only once -
on boot.</p>
<p>Now, when we send a request in the logs we can see that the <code>DeltaLogger</code> output changed:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">**************************************************
Request delta time: 1.40877 seconds.
**************************************************</code></pre></div>
<h3 id="logging-levels">Logging levels</h3>
<p>Another way to leverage arguments is to make the logging level customizable. For example,
you might want to change the logging level. In Rails, there are six different
logging levels: <code>:debug</code>, <code>:info</code>, <code>:warn</code>, <code>:error</code>, <code>:fatal</code>, and <code>:unknown</code>.
Lets make the logging level customizable.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># app/middleware/delta_logger.rb</span>

<span style="color:#008080">VALID_LOG_LEVELS</span> <span style="font-weight:bold">=</span> <span style="font-weight:bold">[</span><span style="color:#b84">:debug</span>, <span style="color:#b84">:info</span>, <span style="color:#b84">:warn</span>, <span style="color:#b84">:error</span>, <span style="color:#b84">:fatal</span>, <span style="color:#b84">:unknown</span><span style="font-weight:bold">]</span>

<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">DeltaLogger</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span> app, log_level
    @app <span style="font-weight:bold">=</span> app
    <span style="color:#998;font-style:italic"># Default to :info log level if the user sets an invalid log level.</span>
    @log_level <span style="font-weight:bold">=</span> <span style="color:#008080">VALID_LOG_LEVELS</span><span style="font-weight:bold">.</span>include?(log_level) ?  log_level : <span style="color:#b84">:info</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">call</span> env
    request_started_on <span style="font-weight:bold">=</span> <span style="color:#008080">Time</span><span style="font-weight:bold">.</span>now
    @status, @headers, @response <span style="font-weight:bold">=</span> @app<span style="font-weight:bold">.</span>call(env)
    request_ended_on <span style="font-weight:bold">=</span> <span style="color:#008080">Time</span><span style="font-weight:bold">.</span>now

    <span style="color:#008080">Rails</span><span style="font-weight:bold">.</span>logger<span style="font-weight:bold">.</span>send(@log_level, <span style="color:#b84">&#39;=&#39;</span> <span style="font-weight:bold">*</span> <span style="color:#099">50</span><span style="font-weight:bold"></span>)
    <span style="color:#008080">Rails</span><span style="font-weight:bold">.</span>logger<span style="font-weight:bold">.</span>send(@log_level, <span style="color:#b84">&#34;</span><span style="color:#b84">Request delta time: </span><span style="color:#b84">#{</span>request_ended_on <span style="font-weight:bold">-</span> request_started_on<span style="color:#b84">}</span><span style="color:#b84"> seconds.</span><span style="color:#b84">&#34;</span>)
    <span style="color:#008080">Rails</span><span style="font-weight:bold">.</span>logger<span style="font-weight:bold">.</span>send(@log_level, <span style="color:#b84">&#39;=&#39;</span> <span style="font-weight:bold">*</span> <span style="color:#099">50</span><span style="font-weight:bold"></span>)

    <span style="font-weight:bold">[</span>@status, @headers, @response<span style="font-weight:bold">]</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>Now, in our application.rb (or environment.rb) file, we can set the logger to
use the desired loging level:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">config<span style="font-weight:bold">.</span>middleware<span style="font-weight:bold">.</span>use <span style="color:#b84">&#34;</span><span style="color:#b84">DeltaLogger</span><span style="color:#b84">&#34;</span>, <span style="color:#b84">:warn</span></code></pre></div>
<p>If we reboot the Rails app and send a new request, the logs will show:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="font-weight:bold">[</span>WARN<span style="font-weight:bold">]</span> <span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span>
<span style="font-weight:bold">[</span>WARN<span style="font-weight:bold">]</span> Request delta time: 0.270595 seconds.
<span style="font-weight:bold">[</span>WARN<span style="font-weight:bold">]</span> <span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span><span style="font-weight:bold">=</span></code></pre></div>
<p>Be aware that your output may vary because logging output relies on the <a href="http://api.rubyonrails.org/classes/ActiveSupport/Logger/SimpleFormatter.html">logger formatter</a>{:target=&rdquo;_blank&rdquo;} that your application is using.</p>
<p>If you are not seeing the exact output, you can plug this logging formatter in your app:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># lib/delta_formatter.rb</span>

<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">DeltaFormatter</span> <span style="font-weight:bold">&lt;</span> <span style="color:#008080">Logger</span><span style="font-weight:bold">::</span><span style="color:#008080">Formatter</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">call</span>(severity, time, program_name, msg)
    <span style="color:#b84">&#34;</span><span style="color:#b84">[</span><span style="color:#b84">#{</span>severity<span style="color:#b84">}</span><span style="color:#b84">] </span><span style="color:#b84">#{</span><span style="color:#999">String</span> <span style="font-weight:bold">===</span> msg ? msg : msg<span style="font-weight:bold">.</span>inspect<span style="color:#b84">}</span><span style="color:#b84">\n</span><span style="color:#b84">&#34;</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>You can use this formatter by including it into <code>application.rb</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold">*</span>snipped<span style="font-weight:bold">*</span>
<span style="color:#999">require</span> <span style="color:#b84">&#34;</span><span style="color:#b84">./lib/delta_formatter</span><span style="color:#b84">&#34;</span>

<span style="font-weight:bold">module</span> <span style="color:#555">MyApplication</span>
  <span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Application</span> <span style="font-weight:bold">&lt;</span> <span style="color:#008080">Rails</span><span style="font-weight:bold">::</span><span style="color:#008080">Application</span>
    config<span style="font-weight:bold">.</span>autoload_paths <span style="font-weight:bold">+=</span> <span style="color:#b84">%W(</span><span style="color:#b84"> </span><span style="color:#b84">#{</span>config<span style="font-weight:bold">.</span>root<span style="color:#b84">}</span><span style="color:#b84">/lib/**/*</span><span style="color:#b84">)</span>

    <span style="font-weight:bold">*</span>snipped<span style="font-weight:bold">*</span>

    config<span style="font-weight:bold">.</span>middleware<span style="font-weight:bold">.</span>use <span style="color:#b84">&#34;</span><span style="color:#b84">DeltaLogger</span><span style="color:#b84">&#34;</span>, <span style="color:#b84">:warn</span>
    config<span style="font-weight:bold">.</span>log_formatter <span style="font-weight:bold">=</span> <span style="color:#008080">DeltaFormatter</span><span style="font-weight:bold">.</span>new
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>After adding this, you'll need to reboot your server and you should see the output with
the severity tag.</p>
<h2 id="thread-safety">Thread safety</h2>
<p>Last of the important topics about Rails middleware is thread-safety. When using Puma or Unicorn web servers,
one of the strong sides of these servers is that they are threaded. Since
our middleware runs on these servers, it has to be thread-safe, meaning, it should
easily spawn multiple duplicates of it so different threads can use different objects of
the same middleware.</p>
<p>The easiest and most efficient way to do this is to <code>dup</code> the middleware object
that is created in runtime.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># app/middleware/delta_logger.rb</span>

<span style="color:#008080">VALID_LOG_LEVELS</span> <span style="font-weight:bold">=</span> <span style="font-weight:bold">[</span><span style="color:#b84">:debug</span>, <span style="color:#b84">:info</span>, <span style="color:#b84">:warn</span>, <span style="color:#b84">:error</span>, <span style="color:#b84">:fatal</span>, <span style="color:#b84">:unknown</span><span style="font-weight:bold">]</span>

<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">DeltaLogger</span>
  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">initialize</span> app, log_level
    @app <span style="font-weight:bold">=</span> app
    <span style="color:#998;font-style:italic"># Default to :info log level if the user sets an invalid log level.</span>
    @log_level <span style="font-weight:bold">=</span> <span style="color:#008080">VALID_LOG_LEVELS</span><span style="font-weight:bold">.</span>include?(log_level) ? log_level : <span style="color:#b84">:info</span>
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">call</span> env
    <span style="color:#999">dup</span><span style="font-weight:bold">.</span>_call env
  <span style="font-weight:bold">end</span>

  <span style="font-weight:bold">def</span> <span style="color:#458;font-weight:bold"></span><span style="font-weight:bold"></span><span style="color:#900;font-weight:bold">_call</span> env
    request_started_on <span style="font-weight:bold">=</span> <span style="color:#008080">Time</span><span style="font-weight:bold">.</span>now
    @status, @headers, @response <span style="font-weight:bold">=</span> @app<span style="font-weight:bold">.</span>call(env)
    request_ended_on <span style="font-weight:bold">=</span> <span style="color:#008080">Time</span><span style="font-weight:bold">.</span>now

    <span style="color:#008080">Rails</span><span style="font-weight:bold">.</span>logger<span style="font-weight:bold">.</span>send(@log_level, <span style="color:#b84">&#39;=&#39;</span> <span style="font-weight:bold">*</span> <span style="color:#099">50</span><span style="font-weight:bold"></span>)
    <span style="color:#008080">Rails</span><span style="font-weight:bold">.</span>logger<span style="font-weight:bold">.</span>send(@log_level, <span style="color:#b84">&#34;</span><span style="color:#b84">Request delta time: </span><span style="color:#b84">#{</span>request_ended_on <span style="font-weight:bold">-</span> request_started_on<span style="color:#b84">}</span><span style="color:#b84"> seconds.</span><span style="color:#b84">&#34;</span>)
    <span style="color:#008080">Rails</span><span style="font-weight:bold">.</span>logger<span style="font-weight:bold">.</span>send(@log_level, <span style="color:#b84">&#39;=&#39;</span> <span style="font-weight:bold">*</span> <span style="color:#099">50</span><span style="font-weight:bold"></span>)

    <span style="font-weight:bold">[</span>@status, @headers, @response<span style="font-weight:bold">]</span>
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>By adding the <code>_call</code> method and duplicating the object we make sure that any instance variables
we set in <code>_call</code> will be set on the duped instance, not the original. This allows the
web server to use a separate (duped) object for each thread which will contain different
data, based on it's execution.</p>
<h2 id="outro">Outro</h2>
<p>As you can see, there's quite a bit that needed to be covered in this post. I hope that
this explained how you can write your own Rails middleware and mount it in the middleware stack.
It's very easy to get creative with Rails middleware as it iss highly customizable, quite
low-level(ish) while you have the whole app available in runtime. Next time, we will work
together on building and testing a real-life example of Rails middleware.</p>
<p>Until then, feel free to drop a comment, I would love to hear your opinions, problems and
code that you've come up with.</p>
<script src="https://f.convertkit.com/ckjs/ck.5.js"></script>
      <form action="https://app.convertkit.com/forms/1215893/subscriptions" class="seva-form formkit-form" method="post" data-sv-form="1215893" data-uid="f786e71c27" data-format="inline" data-version="5" data-options="{&quot;settings&quot;:{&quot;after_subscribe&quot;:{&quot;action&quot;:&quot;message&quot;,&quot;success_message&quot;:&quot;Success! Now check your email to confirm your subscription.&quot;,&quot;redirect_url&quot;:&quot;&quot;},&quot;analytics&quot;:{&quot;google&quot;:null,&quot;facebook&quot;:null,&quot;segment&quot;:null,&quot;pinterest&quot;:null},&quot;modal&quot;:{&quot;trigger&quot;:&quot;timer&quot;,&quot;scroll_percentage&quot;:null,&quot;timer&quot;:5,&quot;devices&quot;:&quot;all&quot;,&quot;show_once_every&quot;:15},&quot;powered_by&quot;:{&quot;show&quot;:false,&quot;url&quot;:&quot;https://convertkit.com?utm_source=dynamic&amp;utm_medium=referral&amp;utm_campaign=poweredby&amp;utm_content=form&quot;},&quot;recaptcha&quot;:{&quot;enabled&quot;:false},&quot;return_visitor&quot;:{&quot;action&quot;:&quot;show&quot;,&quot;custom_content&quot;:&quot;&quot;},&quot;slide_in&quot;:{&quot;display_in&quot;:&quot;bottom_right&quot;,&quot;trigger&quot;:&quot;timer&quot;,&quot;scroll_percentage&quot;:null,&quot;timer&quot;:5,&quot;devices&quot;:&quot;all&quot;,&quot;show_once_every&quot;:15},&quot;sticky_bar&quot;:{&quot;display_in&quot;:&quot;top&quot;,&quot;trigger&quot;:&quot;timer&quot;,&quot;scroll_percentage&quot;:null,&quot;timer&quot;:5,&quot;devices&quot;:&quot;all&quot;,&quot;show_once_every&quot;:15}},&quot;version&quot;:&quot;5&quot;}" min-width="400 500 600 700 800" style="background-color: rgb(249, 250, 251); border-radius: 4px;"><div class="formkit-background" style="opacity: 0.2;"></div><div data-style="minimal"><div class="formkit-header" data-element="header" style="color: rgb(77, 77, 77); font-size: 27px; font-weight: 700;"><h1>Join the Newsletter</h1></div><div class="formkit-subheader" data-element="subheader" style="color: rgb(104, 104, 104); font-size: 18px;"><p>I write about backend technologies, programming and cloud architectures. Join hundreds of other developers that get my newsletter, once a month.</p></div><ul class="formkit-alert formkit-alert-error" data-element="errors" data-group="alert"></ul><div data-element="fields" data-stacked="false" class="seva-fields formkit-fields"><div class="formkit-field"><input class="formkit-input" name="email_address" placeholder="Your email address" required="" type="email" style="color: rgb(0, 0, 0); border-color: rgb(227, 227, 227); border-radius: 4px; font-weight: 400;"></div><button data-element="submit" class="formkit-submit formkit-submit" style="color: rgb(255, 255, 255); background-color: rgb(22, 119, 190); border-radius: 4px; font-weight: 400;"><div class="formkit-spinner"><div></div><div></div><div></div></div><span>Subscribe</span></button></div><div class="formkit-guarantee" data-element="guarantee" style="color: rgb(77, 77, 77); font-size: 13px; font-weight: 400;">

      <p>I respect your privacy. Never spam. Unsubscribe at any time.</p>
      <p>You can also subscribe <a href="/index.xml">via RSS</a> or <a href="https://t.me/ieftimovcom">to my Telegram channel</a>.</p>

      </div></div><style>.formkit-form[data-uid="f786e71c27"] *{box-sizing:border-box;}.formkit-form[data-uid="f786e71c27"]{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}.formkit-form[data-uid="f786e71c27"] legend{border:none;font-size:inherit;margin-bottom:10px;padding:0;position:relative;display:table;}.formkit-form[data-uid="f786e71c27"] fieldset{border:0;padding:0.01em 0 0 0;margin:0;min-width:0;}.formkit-form[data-uid="f786e71c27"] body:not(:-moz-handler-blocked) fieldset{display:table-cell;}.formkit-form[data-uid="f786e71c27"] h1,.formkit-form[data-uid="f786e71c27"] h2,.formkit-form[data-uid="f786e71c27"] h3,.formkit-form[data-uid="f786e71c27"] h4,.formkit-form[data-uid="f786e71c27"] h5,.formkit-form[data-uid="f786e71c27"] h6{color:inherit;font-size:inherit;font-weight:inherit;}.formkit-form[data-uid="f786e71c27"] p{color:inherit;font-size:inherit;font-weight:inherit;}.formkit-form[data-uid="f786e71c27"] ol:not([template-default]),.formkit-form[data-uid="f786e71c27"] ul:not([template-default]),.formkit-form[data-uid="f786e71c27"] blockquote:not([template-default]){text-align:left;}.formkit-form[data-uid="f786e71c27"] p:not([template-default]),.formkit-form[data-uid="f786e71c27"] hr:not([template-default]),.formkit-form[data-uid="f786e71c27"] blockquote:not([template-default]),.formkit-form[data-uid="f786e71c27"] ol:not([template-default]),.formkit-form[data-uid="f786e71c27"] ul:not([template-default]){color:inherit;font-style:initial;}.formkit-form[data-uid="f786e71c27"][data-format="modal"]{display:none;}.formkit-form[data-uid="f786e71c27"][data-format="slide in"]{display:none;}.formkit-form[data-uid="f786e71c27"] .formkit-input,.formkit-form[data-uid="f786e71c27"] .formkit-select,.formkit-form[data-uid="f786e71c27"] .formkit-checkboxes{width:100%;}.formkit-form[data-uid="f786e71c27"] .formkit-button,.formkit-form[data-uid="f786e71c27"] .formkit-submit{border:0;border-radius:5px;color:#ffffff;cursor:pointer;display:inline-block;text-align:center;font-size:15px;font-weight:500;cursor:pointer;margin-bottom:15px;overflow:hidden;padding:0;position:relative;vertical-align:middle;line-height:1.5;}.formkit-form[data-uid="f786e71c27"] .formkit-button:hover,.formkit-form[data-uid="f786e71c27"] .formkit-submit:hover,.formkit-form[data-uid="f786e71c27"] .formkit-button:focus,.formkit-form[data-uid="f786e71c27"] .formkit-submit:focus{outline:none;}.formkit-form[data-uid="f786e71c27"] .formkit-button:hover > span,.formkit-form[data-uid="f786e71c27"] .formkit-submit:hover > span,.formkit-form[data-uid="f786e71c27"] .formkit-button:focus > span,.formkit-form[data-uid="f786e71c27"] .formkit-submit:focus > span{background-color:rgba(0,0,0,0.1);}.formkit-form[data-uid="f786e71c27"] .formkit-button > span,.formkit-form[data-uid="f786e71c27"] .formkit-submit > span{display:block;-webkit-transition:all 300ms ease-in-out;transition:all 300ms ease-in-out;padding:12px 24px;}.formkit-form[data-uid="f786e71c27"] .formkit-input{background:#ffffff;font-size:15px;padding:12px;border:1px solid #e3e3e3;-webkit-flex:1 0 auto;-ms-flex:1 0 auto;flex:1 0 auto;line-height:1.4;margin:0;-webkit-transition:border-color ease-out 300ms;transition:border-color ease-out 300ms;}.formkit-form[data-uid="f786e71c27"] .formkit-input:focus{outline:none;border-color:#1677be;-webkit-transition:border-color ease 300ms;transition:border-color ease 300ms;}.formkit-form[data-uid="f786e71c27"] .formkit-input::-webkit-input-placeholder{color:inherit;opacity:0.8;}.formkit-form[data-uid="f786e71c27"] .formkit-input::-moz-placeholder{color:inherit;opacity:0.8;}.formkit-form[data-uid="f786e71c27"] .formkit-input:-ms-input-placeholder{color:inherit;opacity:0.8;}.formkit-form[data-uid="f786e71c27"] .formkit-input::placeholder{color:inherit;opacity:0.8;}.formkit-form[data-uid="f786e71c27"] [data-group="dropdown"]{position:relative;display:inline-block;width:100%;}.formkit-form[data-uid="f786e71c27"] [data-group="dropdown"]::before{content:"";top:calc(50% - 2.5px);right:10px;position:absolute;pointer-events:none;border-color:#4f4f4f transparent transparent transparent;border-style:solid;border-width:6px 6px 0 6px;height:0;width:0;z-index:999;}.formkit-form[data-uid="f786e71c27"] [data-group="dropdown"] select{height:auto;width:100%;cursor:pointer;color:#333333;line-height:1.4;margin-bottom:0;padding:0 6px;-webkit-appearance:none;-moz-appearance:none;appearance:none;font-size:15px;padding:12px;padding-right:25px;border:1px solid #e3e3e3;background:#ffffff;}.formkit-form[data-uid="f786e71c27"] [data-group="dropdown"] select:focus{outline:none;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"]{text-align:left;margin:0;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"]{margin-bottom:10px;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] *{cursor:pointer;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"]:last-of-type{margin-bottom:0;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] input[type="checkbox"]{display:none;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] input[type="checkbox"] + label::after{content:none;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] input[type="checkbox"]:checked + label::after{border-color:#ffffff;content:"";}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] input[type="checkbox"]:checked + label::before{background:#10bf7a;border-color:#10bf7a;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] label{position:relative;display:inline-block;padding-left:28px;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] label::before,.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] label::after{position:absolute;content:"";display:inline-block;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] label::before{height:16px;width:16px;border:1px solid #e3e3e3;background:#ffffff;left:0px;top:3px;}.formkit-form[data-uid="f786e71c27"] [data-group="checkboxes"] [data-group="checkbox"] label::after{height:4px;width:8px;border-left:2px solid #4d4d4d;border-bottom:2px solid #4d4d4d;-webkit-transform:rotate(-45deg);-ms-transform:rotate(-45deg);transform:rotate(-45deg);left:4px;top:8px;}.formkit-form[data-uid="f786e71c27"] .formkit-alert{background:#f9fafb;border:1px solid #e3e3e3;border-radius:5px;-webkit-flex:1 0 auto;-ms-flex:1 0 auto;flex:1 0 auto;list-style:none;margin:25px auto;padding:12px;text-align:center;width:100%;}.formkit-form[data-uid="f786e71c27"] .formkit-alert:empty{display:none;}.formkit-form[data-uid="f786e71c27"] .formkit-alert-success{background:#d3fbeb;border-color:#10bf7a;color:#0c905c;}.formkit-form[data-uid="f786e71c27"] .formkit-alert-error{background:#fde8e2;border-color:#f2643b;color:#ea4110;}.formkit-form[data-uid="f786e71c27"] .formkit-spinner{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:0px;width:0px;margin:0 auto;position:absolute;top:0;left:0;right:0;width:0px;overflow:hidden;text-align:center;-webkit-transition:all 300ms ease-in-out;transition:all 300ms ease-in-out;}.formkit-form[data-uid="f786e71c27"] .formkit-spinner > div{margin:auto;width:12px;height:12px;background-color:#fff;opacity:0.3;border-radius:100%;display:inline-block;-webkit-animation:formkit-bouncedelay-formkit-form-data-uid-f786e71c27- 1.4s infinite ease-in-out both;animation:formkit-bouncedelay-formkit-form-data-uid-f786e71c27- 1.4s infinite ease-in-out both;}.formkit-form[data-uid="f786e71c27"] .formkit-spinner > div:nth-child(1){-webkit-animation-delay:-0.32s;animation-delay:-0.32s;}.formkit-form[data-uid="f786e71c27"] .formkit-spinner > div:nth-child(2){-webkit-animation-delay:-0.16s;animation-delay:-0.16s;}.formkit-form[data-uid="f786e71c27"] .formkit-submit[data-active] .formkit-spinner{opacity:1;height:100%;width:50px;}.formkit-form[data-uid="f786e71c27"] .formkit-submit[data-active] .formkit-spinner ~ span{opacity:0;}.formkit-form[data-uid="f786e71c27"] .formkit-powered-by[data-active="false"]{opacity:0.35;}@-webkit-keyframes formkit-bouncedelay-formkit-form-data-uid-f786e71c27-{0%,80%,100%{-webkit-transform:scale(0);-ms-transform:scale(0);transform:scale(0);}40%{-webkit-transform:scale(1);-ms-transform:scale(1);transform:scale(1);}}@keyframes formkit-bouncedelay-formkit-form-data-uid-f786e71c27-{0%,80%,100%{-webkit-transform:scale(0);-ms-transform:scale(0);transform:scale(0);}40%{-webkit-transform:scale(1);-ms-transform:scale(1);transform:scale(1);}}.formkit-form[data-uid="f786e71c27"] blockquote{padding:10px 20px;margin:0 0 20px;border-left:5px solid #e1e1e1;} .formkit-form[data-uid="f786e71c27"]{border:1px solid #e3e3e3;max-width:700px;position:relative;overflow:hidden;margin:0 auto;}.formkit-form[data-uid="f786e71c27"] .formkit-background{width:100%;height:100%;position:absolute;top:0;left:0;background-size:cover;background-position:center;opacity:0.3;z-index:1;}.formkit-form[data-uid="f786e71c27"] [data-style="minimal"]{padding:20px;width:100%;z-index:2;position:relative;}.formkit-form[data-uid="f786e71c27"] .formkit-header{margin:0 0 27px 0;text-align:center;}.formkit-form[data-uid="f786e71c27"] .formkit-subheader{margin:18px 0;text-align:center;}.formkit-form[data-uid="f786e71c27"] .formkit-guarantee{font-size:13px;margin:10px 0 15px 0;text-align:center;}.formkit-form[data-uid="f786e71c27"] .formkit-guarantee > p{margin:0;}.formkit-form[data-uid="f786e71c27"] .formkit-powered-by{color:#7d7d7d;display:block;font-size:12px;margin:10px 0 0 0;text-align:center;}.formkit-form[data-uid="f786e71c27"] .formkit-fields{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin:25px auto 0 auto;}.formkit-form[data-uid="f786e71c27"] .formkit-field{min-width:220px;}.formkit-form[data-uid="f786e71c27"] .formkit-field,.formkit-form[data-uid="f786e71c27"] .formkit-submit{margin:0 0 15px 0;-webkit-flex:1 0 100%;-ms-flex:1 0 100%;flex:1 0 100%;}.formkit-form[data-uid="f786e71c27"][min-width~="600"] [data-style="minimal"]{}.formkit-form[data-uid="f786e71c27"][min-width~="600"] .formkit-fields[data-stacked="false"]{margin-left:-5px;margin-right:-5px;}.formkit-form[data-uid="f786e71c27"][min-width~="600"] .formkit-fields[data-stacked="false"] .formkit-field,.formkit-form[data-uid="f786e71c27"][min-width~="600"] .formkit-fields[data-stacked="false"] .formkit-submit{margin:0 5px 15px 5px;}.formkit-form[data-uid="f786e71c27"][min-width~="600"] .formkit-fields[data-stacked="false"] .formkit-field{-webkit-flex:100 1 auto;-ms-flex:100 1 auto;flex:100 1 auto;}.formkit-form[data-uid="f786e71c27"][min-width~="600"] .formkit-fields[data-stacked="false"] .formkit-submit{-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;} </style></form>


			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="/tags/middleware">middleware</a></li>
							
						</ul>
					
				
			</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = 'eftimov';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the </a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2015  Copyright  Ilija Eftimov |  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-11264459-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
