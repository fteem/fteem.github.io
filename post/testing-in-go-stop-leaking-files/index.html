<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Testing in Go: Stop Leaking Files | Ilija Eftimov ⚡️</title><meta name=keywords content><meta name=description content="No test suite is perfect. Some test suites are missing good helper functions; others are under-configured or over-customize. Some have obsolete packages included and are left unmaintained. Folks that have experience with more mature projects will likely agree that all of the above can be found in the wild.
Often, when we test our Go programs, need to create files. Such files can be just fixture files, or whole file trees, to set up the correct environment for the tests to run."><meta name=author content="Ilija"><link rel=canonical href=https://ieftimov.com/post/testing-in-go-stop-leaking-files/><link href=/assets/css/stylesheet.min.0c016bf8df20af25fb1fecc0f0fe602e81ea9fd3d9f96c8995b7d48ec2a0b8a3.css integrity="sha256-DAFr+N8gryX7H+zA8P5gLoHqn9PZ+WyJlbfUjsKguKM=" rel="preload stylesheet" as=style><link rel=icon href=https://ieftimov.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ieftimov.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ieftimov.com/favicon-32x32.png><link rel=apple-touch-icon href=https://ieftimov.com/apple-touch-icon.png><link rel=mask-icon href=https://ieftimov.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.81.0"><script async defer data-domain=ieftimov.com src=https://plausible.io/js/plausible.js></script><meta property="og:title" content="Testing in Go: Stop Leaking Files"><meta property="og:description" content="No test suite is perfect. Some test suites are missing good helper functions; others are under-configured or over-customize. Some have obsolete packages included and are left unmaintained. Folks that have experience with more mature projects will likely agree that all of the above can be found in the wild.
Often, when we test our Go programs, need to create files. Such files can be just fixture files, or whole file trees, to set up the correct environment for the tests to run."><meta property="og:type" content="article"><meta property="og:url" content="https://ieftimov.com/post/testing-in-go-stop-leaking-files/"><meta property="og:image" content="https://ieftimov.com/cards/testing-in-go-stop-leaking-files.png"><meta property="article:published_time" content="2020-05-22T00:00:00+00:00"><meta property="article:modified_time" content="2020-05-22T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ieftimov.com/cards/testing-in-go-stop-leaking-files.png"><meta name=twitter:title content="Testing in Go: Stop Leaking Files"><meta name=twitter:description content="No test suite is perfect. Some test suites are missing good helper functions; others are under-configured or over-customize. Some have obsolete packages included and are left unmaintained. Folks that have experience with more mature projects will likely agree that all of the above can be found in the wild.
Often, when we test our Go programs, need to create files. Such files can be just fixture files, or whole file trees, to set up the correct environment for the tests to run."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ieftimov.com/posts/"},{"@type":"ListItem","position":2,"name":"Testing in Go: Stop Leaking Files","item":"https://ieftimov.com/post/testing-in-go-stop-leaking-files/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Testing in Go: Stop Leaking Files","name":"Testing in Go: Stop Leaking Files","description":"No test suite is perfect. Some test suites are missing good helper functions; others are under-configured or over-customize. Some have obsolete packages included and are left …","keywords":[],"articleBody":"No test suite is perfect. Some test suites are missing good helper functions; others are under-configured or over-customize. Some have obsolete packages included and are left unmaintained. Folks that have experience with more mature projects will likely agree that all of the above can be found in the wild.\nOften, when we test our Go programs, need to create files. Such files can be just fixture files, or whole file trees, to set up the correct environment for the tests to run. Once the tests finish running, we have to clean them up, so they don’t linger around.\nWe should rely on the test suite’s set of helpers to provide us with a way to manage test files if they exist in the first place. Unfortunately, not all test suites have such clean-up helpers set up. Sometimes, you might find a few different implementations, instead of one obvious way to do it.\nComing up in Go v1.15, the testing package will improve the support for creating temporary test files and directories. Let’s see how we can put them to use.\nConverting PDFs to TXT files While thinking about a small program that will aid our understanding of leaking test files, I was asking myself, “What is a program that generates files?”. Because I work for a company that does a lot with documents, I thought, “let’s do something straightforward with PDFs”.\nImagine we have a program that extracts text out of PDFs. Why? Well, for one, if we want to know how long it will take us to read the PDF, we can take the number of words in a PDF and divide it by the average reading speed (which, according to Google, is 250 words per minute).\nBut to do that, we first have to take a PDF and create a TXT file with all of the sentences inside. To do that, we can use one of the many PDF parsing libraries for Go.\nHere’s the code that takes a PDF, extracts all rows of text from it, and saves them in a TXT file.\nFirst, the persist function:\n1 2 3 4 5 6 7 8 9  func persist(content []byte, w io.Writer) error { _, err := w.Write(content) if err != nil { log.Println(\"Failed to persist contents.\") return err } return nil }   It takes some bytes as content and persists them to a io.Writer - it can be a file, a strings.StringBuilder or a different type that implements the io.Writer interface. The argument types are generic (interfaces) by design, so the function arguments are more liberal. You will see why when we test this function.\nThe slurp function is next. It will take a pdf.Reader type, which is a type from the pdf library we use. We will slurp all of the relevant content (text) from the PDF and return a slice of bytes.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  func slurp(r *pdf.Reader) []byte { var bs []byte total := r.NumPage() for i := 1; i Page(i) if p.V.IsNull() { continue } rows, _ := p.GetTextByRow() for _, row := range rows { for _, word := range row.Content { bs = append(bs, []byte(word.S)...) } } } return bs }   By returning a slice of bytes, instead of a string, we can use a generic interface such as io.Writer (like in persist). The interface is applicable because the Write function it implements takes a slice of bytes as an argument - making the arguments of slurp and the returned values of persist compatible.\nNext, the function that ties them all together – run:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  func run(args []string, out io.Writer) error { log.SetOutput(out) if len(args) 3 { return fmt.Errorf(\"Expected at least 2 arguments, got %d.\", len(args)-1) } pdfFile, r, err := pdf.Open(args[1]) if err != nil { return err } defer pdfFile.Close() contents := slurp(r) txtFile, err := os.Create(args[2]) if err != nil { return err } defer txtFile.Close() err = persist(contents, txtFile) if err != nil { return err } return nil }   run’s role is to check the arguments received from main and the io.Writer to where it should send all of its output. Then it opens the PDF file for reading and passes the file reference to the slurp function.\nOnce slurp returns the contents of the file, which is just a slice of bytes run will create a new file for writing, called txtFile. Once it opens the file, it will send the contents and the txtFile to persist as arguments.\nAs we already saw above, persist will save the contents to the file and return any potential errors. If no errors are returned, run successfully exits.\nLastly, the straightforward main function:\n1 2 3 4 5  func main() { if err := run(os.Args, os.Stdout); err != nil { log.Fatal(err) } }   Locally, I have a simple PDF with some text inside that I’ve found online. Its contents, according to the author, are popular interview questions. We will run the above program with any PDF, and as long as it finds some text inside it will save it to an output file.\nHere it is in action:\n1 2 3  $ go run main.go input.pdf out.txt $ cat out.txt 50 Common Interview Questions and Answers1. Tell me about yourself: The most often asked question in interviews. ...   That’s really it. Our program took the contents from input.pdf and stored them in out.txt. Let’s see how we can test this program.\nTesting persist The persist function does not do much. In fact it just invokes the Write function of the io.Writer instance. Since we are using a file, that is part of the standard library, we do not need to test it. But, given that there’s some error handling, which is a custom implementation, we can add some tests to strive to get to that full test coverage.\nTestPersist, in all of its glory:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45  func TestPersist(t *testing.T) { tt := []struct { name string content []byte out func() (io.ReadWriter, error) }{ { name: \"WithNoContent\", content: []byte{}, out: func() (io.ReadWriter, error) { return os.Create(\"empty.txt\") }, }, { name: \"WithContent\", content: []byte{}, out: func() (io.ReadWriter, error) { return os.Create(\"not-empty.txt\") }, }, } for _, tc := range tt { t.Run(tc.name, func(t *testing.T) { f, err := tc.out() if err != nil { t.Fatalf(\"Cannot create output file: %s\", err) } err = persist(tc.content, f) if err != nil { t.Fatalf(\"Cannot persits to output file: %s\", err) } b := []byte{} if _, err = io.ReadFull(f, b); err != nil { t.Fatalf(\"Cannot read test output file: %s\", err) } if !bytes.Equal(b, tc.content) { t.Errorf(\"Persisted content is different than saved content.\") } }) } }   Each of the test cases, part of the table-driven tests, contains the name of the test case, the content that it will persist, and the out function, which will create the output file.\nIn the test itself, we create a subtest for each of the test cases, which will try to write the content to a file, and then it will read all of the content back from the file. If the persisted content and the test case content are the same, then the test successfully passes.\nIf we run the tests, this is the output we will see:\n1 2 3 4 5 6 7 8 9  $ go test -v -run TestPersist === RUN TestPersist === RUN TestPersist/WithNoContent === RUN TestPersist/WithContent --- PASS: TestPersist (0.00s) --- PASS: TestPersist/WithNoContent (0.00s) --- PASS: TestPersist/WithContent (0.00s) PASS ok github.com/fteem/go-playground/testing-in-go-leak-test-files\t0.250s   We ran the two test cases where we try to persist a file with no content and some content. Both of them passed, and we can move on!\nTesting slurp The slurp function is more involved. It requires two different test files – two dummy PDFs with some content and no content (empty). Then, by passing the two different files to slurp, we can test if extracting the text from the PDF works as intended.\nThis is the test:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  func TestSlurp(t *testing.T) { tt := []struct { name string pdfPath string size int }{ { name: \"PDFWithContent\", pdfPath: \"testdata/content.pdf\", size: 11463, }, { name: \"PDFWithoutContent\", pdfPath: \"testdata/empty.pdf\", size: 0, }, } for _, tc := range tt { t.Run(tc.name, func(t *testing.T) { pdfFile, r, err := pdf.Open(tc.pdfPath) if err != nil { t.Fatalf(\"Couldn't open PDF %s, error: %s\", tc.pdfPath, err) } defer pdfFile.Close() contents := slurp(r) if len(contents) != tc.size { t.Errorf(\"Expected contents to be %d bytes, got %d\", tc.size, len(contents)) } }) } }   Each of the test cases from the table-driven tests will have a pdfPath, which is an actual PDF file on disk. For each of the test cases, a subtest will be run, which will open the PDF using the ledongthuc/pdf library. We will then pass the reference to the PDF file to the slurp function, expecting the contents to be returned by slurp.\nOnce it returns the content, we simply compare the size - the number of bytes that are expected (tc.size), comparing it against the len(contents), which is the size of the bytes returned. If the sizes match, we assume that the content is correct, and the test will pass.\nHere’s the test in action:\n1 2 3 4 5 6 7 8 9  $ go test -v -run TestSlurp === RUN TestSlurp === RUN TestSlurp/PDFWithContent === RUN TestSlurp/PDFWithoutContent --- PASS: TestSlurp (0.03s) --- PASS: TestSlurp/PDFWithContent (0.03s) --- PASS: TestSlurp/PDFWithoutContent (0.00s) PASS ok github.com/fteem/go-playground/testing-in-go-leak-test-files\t0.253s   Testing run The run function is what glues everything together. It validates the arguments, then opens the PDF for reading, slurps all of the contents using slurp, and lastly saves all of the text content to the TXT file using persist.\nHere’s the test:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  func TestRun(t *testing.T) { tt := []struct { name string input string output string }{ { name: \"WithValidArguments\", input: \"testdata/input.pdf\", output: \"testdata/output.txt\", }, { name: \"WithEmptyInput\", input: \"testdata/empty.pdf\", output: \"testdata/output.txt\", }, } for _, tc := range tt { t.Run(tc.name, func(t *testing.T) { err := run([]string{\"foo\", tc.input, tc.output}, os.Stdout) if err != nil { t.Fatalf(\"Expected no error, got: %s\", err) } if _, err := os.Stat(tc.output); os.IsNotExist(err) { t.Errorf(\"Expected persisted file at %s, did not find it: %s\", tc.output, err) } }) } }   In TestRun, we check if, for each of the test PDFs we provide, the run function crates the corresponding TXT file. In TestRun, we do not care about the actual contents – we can assume that the rest of the unit tests covers that part of the functionality.\nThen, for each test case, we use os.Stat, which will return an error if the file does not exist. If the file does exist, we consider the run function as properly functioning and mark the test as passed.\nHere’s the test in action:\n1 2 3 4 5 6 7 8 9  $ go test -v -run TestRun === RUN TestRun === RUN TestRun/WithValidArguments === RUN TestRun/WithEmptyInput --- PASS: TestRun (0.03s) --- PASS: TestRun/WithValidArguments (0.03s) --- PASS: TestRun/WithEmptyInput (0.00s) PASS ok github.com/fteem/go-playground/testing-in-go-leak-test-files\t0.106s   Another test we can also run is to test the returned errors. We will create another function called TestRunErrors, which will cover the potential errors returned by run. Here’s the test function:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  func TestRunErrors(t *testing.T) { tt := []struct { name string input string output string }{ { name: \"WithoutArguments\", input: \"\", output: \"\", }, { name: \"WithoutOneArgument\", input: \"testdata/input.pdf\", output: \"\", }, { name: \"WithNonexistentInput\", input: \"testdata/nonexistent.pdf\", output: \"testdata/output.txt\", }, } for _, tc := range tt { t.Run(tc.name, func(t *testing.T) { err := run([]string{\"foo\", tc.input, tc.output}, os.Stdout) if err == nil { t.Fatalf(\"Expected an error, did not get one.\") } }) } }   The TestRunErrors is similar to TestRun, with having the focus on the returned errors. It checks that for each of the bad inputs the run function receives, that it returns an error. We could take this a step further by implementing sentinel errors and asserting on them, but this will do just fine this article.\nHere’s the TestRunErrors function in action:\n$ go test -v -run TestRunErrors === RUN TestRunErrors === RUN TestRunErrors/WithoutArguments === RUN TestRunErrors/WithoutOneArgument === RUN TestRunErrors/WithNonexistentInput --- PASS: TestRunErrors (0.02s) --- PASS: TestRunErrors/WithoutArguments (0.00s) --- PASS: TestRunErrors/WithoutOneArgument (0.02s) --- PASS: TestRunErrors/WithNonexistentInput (0.00s) PASS ok github.com/fteem/go-playground/testing-in-go-leak-test-files\t0.140sbash Cleaning up after our test If you were following along, you should notice that test files are created in your project’s directory. The files stay there because we never clean up the output files that our program creates when the tests run.\nStarting from Go v1.15, there will be a nice way to do this: TB.TempDir(). To clean up the test files, we can use TB.TempDir as a parent directory wherever we are passing the output file path. Once the tests pass, Go will automatically get rid of this directory, without us having to do any clean-up.\nFirst, let’s see how we can change the TestPersist function to clean up the empty.txt and non-empty.txt files it creates:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  func TestPersist(t *testing.T) { tt := []struct { name string content []byte out func() (io.ReadWriter, error) }{ { name: \"WithNoContent\", content: []byte{}, out: func() (io.ReadWriter, error) { return os.Create(filepath.Join(t.TempDir(), \"empty.txt\")) }, }, { name: \"WithContent\", content: []byte{}, out: func() (io.ReadWriter, error) { return os.Create(filepath.Join(t.TempDir(), \"not-empty.txt\")) }, }, } for _, tc := range tt { // Snipped... \t} }   The only notable change is to use filepath.Join with t.TempDir() and the file name as arguments. This combo will compose a valid temporary path, that Go will remove once the tests finish. Given that at the time of writing this, Go 1.15 is still not out, we can use the gotip tool to run Go’s latest master version:\n1 2 3 4 5 6 7 8 9  $ gotip test -v -run TestPersist === RUN TestPersist === RUN TestPersist/WithNoContent === RUN TestPersist/WithContent --- PASS: TestPersist (0.00s) --- PASS: TestPersist/WithNoContent (0.00s) --- PASS: TestPersist/WithContent (0.00s) PASS ok github.com/fteem/go-playground/testing-in-go-leak-test-files\t0.048s   If we inspect the project root, we will see that no new files are being created. The output files are cleaned up after the tests have finished running.\n.notice{ padding:18px; line-height:24px; margin-bottom:24px; border-radius:4px; color:#444; background:#e7f2fa } .notice p:last-child{ margin-bottom:0 } .notice-title{ margin:-18px -18px 12px; padding:4px 18px; border-radius:4px 4px 0 0; font-weight:700; color:#fff; background:#6ab0de } .notice-title:before{ margin-right:8px; font-family:\"Font Awesome 5 Free\",FontAwesome; font-weight:400 } .notice.warning .notice-title{ background:rgba(217,83,79,.9) } .notice.warning{ background:#fae2e2 } .notice.info .notice-title{ background:#f0b37e } .notice.info{ background:#fff2db } .notice.note .notice-title{ background:#6ab0de } .notice.note{ background:#e7f2fA } .notice.tip .notice-title{ background:rgba(92,184,92,.8) } .notice.tip{ background:#e6f9e6 } Note\nThe gotip tool compiles and runs the go command from the development tree. Using the gotip command, instead of the normal go command, will run the latest version of the language, as seen in the main Git trunk.\nYou can see its documentation for more details.\n Next, we can do the same change to the TestRun function:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  func TestRun(t *testing.T) { tt := []struct { name string input string output string }{ { name: \"WithValidArguments\", input: \"testdata/input.pdf\", output: filepath.Join(t.TempDir(), \"output.txt\"), }, { name: \"WithEmptyInput\", input: \"testdata/empty.pdf\", output: filepath.Join(t.TempDir(), \"output.txt\"), }, } for _, tc := range tt { // Same as before... \t} }   In the TestRun function, we use the same trick - we use the T.TempDir function to concatenate the path of the output file. Running the test the same way, we can see T.TempDir once more in action:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  $ gotip test -v -run TestRun === RUN TestRun === RUN TestRun/WithValidArguments === RUN TestRun/WithEmptyInput --- PASS: TestRun (0.03s) --- PASS: TestRun/WithValidArguments (0.03s) --- PASS: TestRun/WithEmptyInput (0.00s) === RUN TestRunErrors === RUN TestRunErrors/WithoutArguments === RUN TestRunErrors/WithoutOneArgument === RUN TestRunErrors/WithNonexistentInput --- PASS: TestRunErrors (0.02s) --- PASS: TestRunErrors/WithoutArguments (0.00s) --- PASS: TestRunErrors/WithoutOneArgument (0.02s) --- PASS: TestRunErrors/WithNonexistentInput (0.00s) PASS ok github.com/fteem/go-playground/testing-in-go-leak-test-files\t0.265s   If you want to check out the motivation and the discussion around this addition to the new Go version 1.15, you can head over to the original proposal.\nLiked this article? Subscribe to my newsletter and get my fresh posts in your inbox. It's short and sweet, going out monthly to over 1,000 subscribers.  ","wordCount":"2899","inLanguage":"en","datePublished":"2020-05-22T00:00:00Z","dateModified":"2020-05-22T00:00:00Z","author":{"@type":"Person","name":"Ilija"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ieftimov.com/post/testing-in-go-stop-leaking-files/"},"publisher":{"@type":"Organization","name":"Ilija Eftimov ⚡️","logo":{"@type":"ImageObject","url":"https://ieftimov.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://ieftimov.com/ accesskey=h title="Ilija Eftimov ⚡️ (Alt + H)">Ilija Eftimov ⚡️</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://ieftimov.com/posts title=Archive><span>Archive</span></a></li><li><a href=https://ieftimov.com/about title=About><span>About</span></a></li><li><a href=https://ieftimov.com/newsletter title=Newsletter><span>Newsletter</span></a></li><li><a href=https://forms.gle/orfXK5jh1LRaiFzo8 title="Suggest a topic"><span>Suggest a topic</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Testing in Go: Stop Leaking Files</h1><div class=post-meta>May 22, 2020&nbsp;·&nbsp;14 min&nbsp;·&nbsp;Ilija</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#converting-pdfs-to-txt-files aria-label="Converting PDFs to TXT files">Converting PDFs to TXT files</a></li><li><a href=#testing-persist aria-label="Testing persist">Testing <code>persist</code></a></li><li><a href=#testing-slurp aria-label="Testing slurp">Testing <code>slurp</code></a></li><li><a href=#testing-run aria-label="Testing run">Testing <code>run</code></a></li><li><a href=#cleaning-up-after-our-test aria-label="Cleaning up after our test">Cleaning up after our test</a></li></ul></div></details></div><div class=post-content><p>No test suite is perfect. Some test suites are missing good helper functions;
others are under-configured or over-customize. Some have obsolete packages
included and are left unmaintained. Folks that have experience with more mature
projects will likely agree that all of the above can be found in the wild.</p><p>Often, when we test our Go programs, need to create files. Such files can be
just fixture files, or whole file trees, to set up the correct environment for
the tests to run. Once the tests finish running, we have to clean them up, so
they don&rsquo;t linger around.</p><p>We should rely on the test suite&rsquo;s set of helpers to provide us with a way to
manage test files if they exist in the first place. Unfortunately, not all test
suites have such clean-up helpers set up. Sometimes, you might find a few
different implementations, instead of one obvious way to do it.</p><p>Coming up in Go v1.15, the <a href=https://golang.org/pkg/testing/><code>testing</code></a> package
will improve the support for creating temporary test files and directories.
Let&rsquo;s see how we can put them to use.</p><h2 id=converting-pdfs-to-txt-files>Converting PDFs to TXT files<a hidden class=anchor aria-hidden=true href=#converting-pdfs-to-txt-files>#</a></h2><p>While thinking about a small program that will aid our understanding of leaking
test files, I was asking myself, &ldquo;What is a program that generates files?&rdquo;.
Because I work for a company that does a lot with documents, I thought, &ldquo;let&rsquo;s
do something straightforward with PDFs&rdquo;.</p><p>Imagine we have a program that extracts text out of PDFs. Why? Well, for one,
if we want to know how long it will take us to read the PDF, we can take the
number of words in a PDF and divide it by the average reading speed (which,
according to Google, is 250 words per minute).</p><p>But to do that, we first have to take a PDF and create a TXT file with all of
the sentences inside. To do that, we can use <a href=https://github.com/ledongthuc/pdf>one of the many PDF parsing
libraries for Go</a>.</p><p>Here&rsquo;s the code that takes a PDF, extracts all rows of text from it, and saves
them in a TXT file.</p><p>First, the <code>persist</code> function:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>persist</span>(content []<span style=color:#af0000>byte</span>, w io.Writer) <span style=color:#af0000>error</span> {
	_, err := w.<span style=color:#0087ff>Write</span>(content)
	<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
		log.<span style=color:#0087ff>Println</span>(<span style=color:#00afaf>&#34;Failed to persist contents.&#34;</span>)
		<span style=color:#5f8700>return</span> err
	}

	<span style=color:#5f8700>return</span> <span style=color:#d75f00>nil</span>
}
</code></pre></td></tr></table></div></div><p>It takes some bytes as <code>content</code> and persists them to a <code>io.Writer</code> - it can be
a file, a <code>strings.StringBuilder</code> or a different type that implements the
<code>io.Writer</code> interface. The argument types are generic (interfaces) by design,
so the function arguments are more liberal. You will see why when we test this
function.</p><p>The <code>slurp</code> function is next. It will take a <code>pdf.Reader</code> type, which is a type
from the <code>pdf</code> library we use. We will slurp all of the relevant content (text)
from the PDF and return a slice of bytes.</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>slurp</span>(r *pdf.Reader) []<span style=color:#af0000>byte</span> {
	<span style=color:#0087ff>var</span> bs []<span style=color:#af0000>byte</span>

	total := r.<span style=color:#0087ff>NumPage</span>()
	<span style=color:#5f8700>for</span> i := <span style=color:#00afaf>1</span>; i &lt;= total; i++ {
		p := r.<span style=color:#0087ff>Page</span>(i)
		<span style=color:#5f8700>if</span> p.V.<span style=color:#0087ff>IsNull</span>() {
			<span style=color:#5f8700>continue</span>
		}

		rows, _ := p.<span style=color:#0087ff>GetTextByRow</span>()
		<span style=color:#5f8700>for</span> _, row := <span style=color:#5f8700>range</span> rows {
			<span style=color:#5f8700>for</span> _, word := <span style=color:#5f8700>range</span> row.Content {
				bs = <span style=color:#0087ff>append</span>(bs, []<span style=color:#0087ff>byte</span>(word.S)...)
			}
		}
	}
	<span style=color:#5f8700>return</span> bs
}
</code></pre></td></tr></table></div></div><p>By returning a slice of bytes, instead of a string, we can use a generic
interface such as <a href=https://golang.org/pkg/io/#Writer><code>io.Writer</code></a> (like in
<code>persist</code>). The interface is applicable because the <code>Write</code> function it
implements takes a slice of bytes as an argument - making the arguments of
<code>slurp</code> and the returned values of <code>persist</code> compatible.</p><p>Next, the function that ties them all together – <code>run</code>:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>run</span>(args []<span style=color:#af0000>string</span>, out io.Writer) <span style=color:#af0000>error</span> {
	log.<span style=color:#0087ff>SetOutput</span>(out)

	<span style=color:#5f8700>if</span> <span style=color:#0087ff>len</span>(args) &lt; <span style=color:#00afaf>3</span> {
		<span style=color:#5f8700>return</span> fmt.<span style=color:#0087ff>Errorf</span>(<span style=color:#00afaf>&#34;Expected at least 2 arguments, got %d.&#34;</span>, <span style=color:#0087ff>len</span>(args)-<span style=color:#00afaf>1</span>)
	}

	pdfFile, r, err := pdf.<span style=color:#0087ff>Open</span>(args[<span style=color:#00afaf>1</span>])
	<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
		<span style=color:#5f8700>return</span> err
	}
	<span style=color:#5f8700>defer</span> pdfFile.<span style=color:#0087ff>Close</span>()

	contents := <span style=color:#0087ff>slurp</span>(r)

	txtFile, err := os.<span style=color:#0087ff>Create</span>(args[<span style=color:#00afaf>2</span>])
	<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
		<span style=color:#5f8700>return</span> err
	}
	<span style=color:#5f8700>defer</span> txtFile.<span style=color:#0087ff>Close</span>()

	err = <span style=color:#0087ff>persist</span>(contents, txtFile)
	<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
		<span style=color:#5f8700>return</span> err
	}

	<span style=color:#5f8700>return</span> <span style=color:#d75f00>nil</span>
}
</code></pre></td></tr></table></div></div><p><code>run</code>&rsquo;s role is to check the arguments received from <code>main</code> and the <code>io.Writer</code>
to where it should send all of its output. Then it opens the PDF file for
reading and passes the file reference to the <code>slurp</code> function.</p><p>Once <code>slurp</code> returns the contents of the file, which is just a slice of bytes
<code>run</code> will create a new file for writing, called <code>txtFile</code>. Once it opens the
file, it will send the <code>contents</code> and the <code>txtFile</code> to <code>persist</code> as arguments.</p><p>As we already saw above, <code>persist</code> will save the <code>contents</code> to the file and
return any potential errors. If no errors are returned, <code>run</code> successfully
exits.</p><p>Lastly, the straightforward <code>main</code> function:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>main</span>() {
	<span style=color:#5f8700>if</span> err := <span style=color:#0087ff>run</span>(os.Args, os.Stdout); err != <span style=color:#d75f00>nil</span> {
		log.<span style=color:#0087ff>Fatal</span>(err)
	}
}
</code></pre></td></tr></table></div></div><p>Locally, I have a simple PDF with some text inside that I&rsquo;ve found online. Its
contents, according to the author, are popular interview questions. We will run
the above program with any PDF, and as long as it finds some text inside it
will save it to an output file.</p><p>Here it is in action:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>$ <span style=color:#5f8700>go</span> run main.<span style=color:#5f8700>go</span> input.pdf out.txt
$ cat out.txt
<span style=color:#00afaf>50</span> Common Interview Questions and Answers1. Tell me about yourself: The most often asked question in interviews. ...
</code></pre></td></tr></table></div></div><p>That&rsquo;s really it. Our program took the contents from <code>input.pdf</code> and stored
them in <code>out.txt</code>. Let&rsquo;s see how we can test this program.</p><h2 id=testing-persist>Testing <code>persist</code><a hidden class=anchor aria-hidden=true href=#testing-persist>#</a></h2><p>The <code>persist</code> function does not do much. In fact it just invokes the <code>Write</code>
function of the <code>io.Writer</code> instance. Since we are using a file, that is part
of the standard library, we do not need to test it. But, given that there&rsquo;s
some error handling, which is a custom implementation, we can add some tests to
strive to get to that full test coverage.</p><p><code>TestPersist</code>, in all of its glory:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">45
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>TestPersist</span>(t *testing.T) {
	tt := []<span style=color:#0087ff>struct</span> {
		name    <span style=color:#af0000>string</span>
		content []<span style=color:#af0000>byte</span>
		out     <span style=color:#0087ff>func</span>() (io.ReadWriter, <span style=color:#af0000>error</span>)
	}{
		{
			name:    <span style=color:#00afaf>&#34;WithNoContent&#34;</span>,
			content: []<span style=color:#af0000>byte</span>{},
			out: <span style=color:#0087ff>func</span>() (io.ReadWriter, <span style=color:#af0000>error</span>) {
				<span style=color:#5f8700>return</span> os.<span style=color:#0087ff>Create</span>(<span style=color:#00afaf>&#34;empty.txt&#34;</span>)
			},
		},
		{
			name:    <span style=color:#00afaf>&#34;WithContent&#34;</span>,
			content: []<span style=color:#af0000>byte</span>{},
			out: <span style=color:#0087ff>func</span>() (io.ReadWriter, <span style=color:#af0000>error</span>) {
				<span style=color:#5f8700>return</span> os.<span style=color:#0087ff>Create</span>(<span style=color:#00afaf>&#34;not-empty.txt&#34;</span>)
			},
		},
	}

	<span style=color:#5f8700>for</span> _, tc := <span style=color:#5f8700>range</span> tt {
		t.<span style=color:#0087ff>Run</span>(tc.name, <span style=color:#0087ff>func</span>(t *testing.T) {
			f, err := tc.<span style=color:#0087ff>out</span>()
			<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
				t.<span style=color:#0087ff>Fatalf</span>(<span style=color:#00afaf>&#34;Cannot create output file: %s&#34;</span>, err)
			}

			err = <span style=color:#0087ff>persist</span>(tc.content, f)
			<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
				t.<span style=color:#0087ff>Fatalf</span>(<span style=color:#00afaf>&#34;Cannot persits to output file: %s&#34;</span>, err)
			}

			b := []<span style=color:#af0000>byte</span>{}
			<span style=color:#5f8700>if</span> _, err = io.<span style=color:#0087ff>ReadFull</span>(f, b); err != <span style=color:#d75f00>nil</span> {
				t.<span style=color:#0087ff>Fatalf</span>(<span style=color:#00afaf>&#34;Cannot read test output file: %s&#34;</span>, err)
			}

			<span style=color:#5f8700>if</span> !bytes.<span style=color:#0087ff>Equal</span>(b, tc.content) {
				t.<span style=color:#0087ff>Errorf</span>(<span style=color:#00afaf>&#34;Persisted content is different than saved content.&#34;</span>)
			}
		})
	}
}
</code></pre></td></tr></table></div></div><p>Each of the test cases, part of the table-driven tests, contains the <code>name</code> of
the test case, the <code>content</code> that it will persist, and the <code>out</code> function,
which will create the output file.</p><p>In the test itself, we create a subtest for each of the test cases,
which will try to write the <code>content</code> to a file, and then it will read all of
the content back from the file. If the persisted content and the test case
content are the same, then the test successfully passes.</p><p>If we run the tests, this is the output we will see:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ go <span style=color:#0087ff>test</span> -v -run <span style=color:#0087ff>TestPersist</span>
=== RUN   <span style=color:#0087ff>TestPersist</span>
=== RUN   TestPersist/WithNoContent
=== RUN   TestPersist/WithContent
--- PASS: TestPersist (0.00s)
    --- PASS: TestPersist/WithNoContent (0.00s)
    --- PASS: TestPersist/WithContent (0.00s)
PASS
ok  	github.com/fteem/go-playground/testing-in-go-leak-test-files	0.250s
</code></pre></td></tr></table></div></div><p>We ran the two test cases where we try to persist a file with no content and
some content. Both of them passed, and we can move on!</p><h2 id=testing-slurp>Testing <code>slurp</code><a hidden class=anchor aria-hidden=true href=#testing-slurp>#</a></h2><p>The <code>slurp</code> function is more involved. It requires two different test files
– two dummy PDFs with some content and no content (empty). Then, by passing the
two different files to <code>slurp</code>, we can test if extracting the text from the PDF
works as intended.</p><p>This is the test:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>TestSlurp</span>(t *testing.T) {
	tt := []<span style=color:#0087ff>struct</span> {
		name    <span style=color:#af0000>string</span>
		pdfPath <span style=color:#af0000>string</span>
		size    <span style=color:#af0000>int</span>
	}{
		{
			name:    <span style=color:#00afaf>&#34;PDFWithContent&#34;</span>,
			pdfPath: <span style=color:#00afaf>&#34;testdata/content.pdf&#34;</span>,
			size:    <span style=color:#00afaf>11463</span>,
		},
		{
			name:    <span style=color:#00afaf>&#34;PDFWithoutContent&#34;</span>,
			pdfPath: <span style=color:#00afaf>&#34;testdata/empty.pdf&#34;</span>,
			size:    <span style=color:#00afaf>0</span>,
		},
	}

	<span style=color:#5f8700>for</span> _, tc := <span style=color:#5f8700>range</span> tt {
		t.<span style=color:#0087ff>Run</span>(tc.name, <span style=color:#0087ff>func</span>(t *testing.T) {
			pdfFile, r, err := pdf.<span style=color:#0087ff>Open</span>(tc.pdfPath)
			<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
				t.<span style=color:#0087ff>Fatalf</span>(<span style=color:#00afaf>&#34;Couldn&#39;t open PDF %s, error: %s&#34;</span>, tc.pdfPath, err)
			}
			<span style=color:#5f8700>defer</span> pdfFile.<span style=color:#0087ff>Close</span>()

			contents := <span style=color:#0087ff>slurp</span>(r)

			<span style=color:#5f8700>if</span> <span style=color:#0087ff>len</span>(contents) != tc.size {
				t.<span style=color:#0087ff>Errorf</span>(<span style=color:#00afaf>&#34;Expected contents to be %d bytes, got %d&#34;</span>, tc.size, <span style=color:#0087ff>len</span>(contents))
			}
		})
	}
}
</code></pre></td></tr></table></div></div><p>Each of the test cases from the table-driven tests will have a <code>pdfPath</code>, which
is an actual PDF file on disk. For each of the test cases, a subtest will be
run, which will open the PDF using the <code>ledongthuc/pdf</code> library. We will then
pass the reference to the PDF file to the slurp function, expecting the
<code>contents</code> to be returned by <code>slurp</code>.</p><p>Once it returns the <code>content</code>, we simply compare the <code>size</code> - the number of
bytes that are expected (<code>tc.size</code>), comparing it against the <code>len(contents)</code>,
which is the size of the bytes returned. If the sizes match, we assume that the
content is correct, and the test will pass.</p><p>Here&rsquo;s the test in action:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ go <span style=color:#0087ff>test</span> -v -run <span style=color:#0087ff>TestSlurp</span>
=== RUN   <span style=color:#0087ff>TestSlurp</span>
=== RUN   TestSlurp/PDFWithContent
=== RUN   TestSlurp/PDFWithoutContent
--- PASS: TestSlurp (0.03s)
    --- PASS: TestSlurp/PDFWithContent (0.03s)
    --- PASS: TestSlurp/PDFWithoutContent (0.00s)
PASS
ok  	github.com/fteem/go-playground/testing-in-go-leak-test-files	0.253s
</code></pre></td></tr></table></div></div><h2 id=testing-run>Testing <code>run</code><a hidden class=anchor aria-hidden=true href=#testing-run>#</a></h2><p>The <code>run</code> function is what glues everything together. It validates the
arguments, then opens the PDF for reading, slurps all of the contents using
<code>slurp</code>, and lastly saves all of the text content to the TXT file using
<code>persist</code>.</p><p>Here&rsquo;s the test:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>TestRun</span>(t *testing.T) {
	tt := []<span style=color:#0087ff>struct</span> { name   <span style=color:#af0000>string</span> input  <span style=color:#af0000>string</span> output <span style=color:#af0000>string</span>
	}{
		{
			name:   <span style=color:#00afaf>&#34;WithValidArguments&#34;</span>,
			input:  <span style=color:#00afaf>&#34;testdata/input.pdf&#34;</span>,
			output: <span style=color:#00afaf>&#34;testdata/output.txt&#34;</span>,
		},
		{
			name:   <span style=color:#00afaf>&#34;WithEmptyInput&#34;</span>,
			input:  <span style=color:#00afaf>&#34;testdata/empty.pdf&#34;</span>,
			output: <span style=color:#00afaf>&#34;testdata/output.txt&#34;</span>,
		},
	}

	<span style=color:#5f8700>for</span> _, tc := <span style=color:#5f8700>range</span> tt {
		t.<span style=color:#0087ff>Run</span>(tc.name, <span style=color:#0087ff>func</span>(t *testing.T) {
			err := <span style=color:#0087ff>run</span>([]<span style=color:#af0000>string</span>{<span style=color:#00afaf>&#34;foo&#34;</span>, tc.input, tc.output}, os.Stdout)
			<span style=color:#5f8700>if</span> err != <span style=color:#d75f00>nil</span> {
				t.<span style=color:#0087ff>Fatalf</span>(<span style=color:#00afaf>&#34;Expected no error, got:  %s&#34;</span>, err)
			}

			<span style=color:#5f8700>if</span> _, err := os.<span style=color:#0087ff>Stat</span>(tc.output); os.<span style=color:#0087ff>IsNotExist</span>(err) {
				t.<span style=color:#0087ff>Errorf</span>(<span style=color:#00afaf>&#34;Expected persisted file at %s, did not find it: %s&#34;</span>, tc.output, err)
			}
		})
	}
}
</code></pre></td></tr></table></div></div><p>In <code>TestRun</code>, we check if, for each of the test PDFs we provide, the <code>run</code>
function crates the corresponding TXT file. In <code>TestRun</code>, we do not care about
the actual contents – we can assume that the rest of the unit tests covers that
part of the functionality.</p><p>Then, for each test case, we use <code>os.Stat</code>, which will return an error if the
file does not exist. If the file does exist, we consider the <code>run</code> function as
properly functioning and mark the test as passed.</p><p>Here&rsquo;s the test in action:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ go <span style=color:#0087ff>test</span> -v -run <span style=color:#0087ff>TestRun</span>
=== RUN   <span style=color:#0087ff>TestRun</span>
=== RUN   TestRun/WithValidArguments
=== RUN   TestRun/WithEmptyInput
--- PASS: TestRun (0.03s)
    --- PASS: TestRun/WithValidArguments (0.03s)
    --- PASS: TestRun/WithEmptyInput (0.00s)
PASS
ok  	github.com/fteem/go-playground/testing-in-go-leak-test-files	0.106s
</code></pre></td></tr></table></div></div><p>Another test we can also run is to test the returned errors. We will create
another function called <code>TestRunErrors</code>, which will cover the potential errors
returned by <code>run</code>. Here&rsquo;s the test function:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>TestRunErrors</span>(t *testing.T) {
	tt := []<span style=color:#0087ff>struct</span> {
		name   <span style=color:#af0000>string</span>
		input  <span style=color:#af0000>string</span>
		output <span style=color:#af0000>string</span>
	}{
		{
			name:   <span style=color:#00afaf>&#34;WithoutArguments&#34;</span>,
			input:  <span style=color:#00afaf>&#34;&#34;</span>,
			output: <span style=color:#00afaf>&#34;&#34;</span>,
		},
		{
			name:   <span style=color:#00afaf>&#34;WithoutOneArgument&#34;</span>,
			input:  <span style=color:#00afaf>&#34;testdata/input.pdf&#34;</span>,
			output: <span style=color:#00afaf>&#34;&#34;</span>,
		},
		{
			name:   <span style=color:#00afaf>&#34;WithNonexistentInput&#34;</span>,
			input:  <span style=color:#00afaf>&#34;testdata/nonexistent.pdf&#34;</span>,
			output: <span style=color:#00afaf>&#34;testdata/output.txt&#34;</span>,
		},
	}

	<span style=color:#5f8700>for</span> _, tc := <span style=color:#5f8700>range</span> tt {
		t.<span style=color:#0087ff>Run</span>(tc.name, <span style=color:#0087ff>func</span>(t *testing.T) {
			err := <span style=color:#0087ff>run</span>([]<span style=color:#af0000>string</span>{<span style=color:#00afaf>&#34;foo&#34;</span>, tc.input, tc.output}, os.Stdout)

			<span style=color:#5f8700>if</span> err == <span style=color:#d75f00>nil</span> {
				t.<span style=color:#0087ff>Fatalf</span>(<span style=color:#00afaf>&#34;Expected an error, did not get one.&#34;</span>)
			}
		})
	}
}
</code></pre></td></tr></table></div></div><p>The <code>TestRunErrors</code> is similar to <code>TestRun</code>, with having the focus on the
returned errors. It checks that for each of the bad inputs the <code>run</code> function
receives, that it returns an error. We could take this a step further by
implementing <a href=https://dave.cheney.net/2019/06/10/constant-time>sentinel
errors</a> and asserting on
them, but this will do just fine this article.</p><p>Here&rsquo;s the <code>TestRunErrors</code> function in action:</p><pre><code>$ go test -v -run TestRunErrors
=== RUN   TestRunErrors
=== RUN   TestRunErrors/WithoutArguments
=== RUN   TestRunErrors/WithoutOneArgument
=== RUN   TestRunErrors/WithNonexistentInput
--- PASS: TestRunErrors (0.02s)
    --- PASS: TestRunErrors/WithoutArguments (0.00s)
    --- PASS: TestRunErrors/WithoutOneArgument (0.02s)
    --- PASS: TestRunErrors/WithNonexistentInput (0.00s)
PASS
ok  	github.com/fteem/go-playground/testing-in-go-leak-test-files	0.140sbash
</code></pre><h2 id=cleaning-up-after-our-test>Cleaning up after our test<a hidden class=anchor aria-hidden=true href=#cleaning-up-after-our-test>#</a></h2><p>If you were following along, you should notice that test files are created in
your project&rsquo;s directory. The files stay there because we never clean up the
output files that our program creates when the tests run.</p><p>Starting from Go v1.15, there will be a nice way to do this: <code>TB.TempDir()</code>.
To clean up the test files, we can use <code>TB.TempDir</code> as a parent directory
wherever we are passing the output file path. Once the tests pass, Go will
automatically get rid of this directory, without us having to do any clean-up.</p><p>First, let&rsquo;s see how we can change the <code>TestPersist</code> function to clean up the
<code>empty.txt</code> and <code>non-empty.txt</code> files it creates:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>TestPersist</span>(t *testing.T) {
	tt := []<span style=color:#0087ff>struct</span> {
		name    <span style=color:#af0000>string</span>
		content []<span style=color:#af0000>byte</span>
		out     <span style=color:#0087ff>func</span>() (io.ReadWriter, <span style=color:#af0000>error</span>)
	}{
		{
			name:    <span style=color:#00afaf>&#34;WithNoContent&#34;</span>,
			content: []<span style=color:#af0000>byte</span>{},
			out: <span style=color:#0087ff>func</span>() (io.ReadWriter, <span style=color:#af0000>error</span>) {
				<span style=color:#5f8700>return</span> os.<span style=color:#0087ff>Create</span>(filepath.<span style=color:#0087ff>Join</span>(t.<span style=color:#0087ff>TempDir</span>(), <span style=color:#00afaf>&#34;empty.txt&#34;</span>))
			},
		},
		{
			name:    <span style=color:#00afaf>&#34;WithContent&#34;</span>,
			content: []<span style=color:#af0000>byte</span>{},
			out: <span style=color:#0087ff>func</span>() (io.ReadWriter, <span style=color:#af0000>error</span>) {
				<span style=color:#5f8700>return</span> os.<span style=color:#0087ff>Create</span>(filepath.<span style=color:#0087ff>Join</span>(t.<span style=color:#0087ff>TempDir</span>(), <span style=color:#00afaf>&#34;not-empty.txt&#34;</span>))
			},
		},
	}

	<span style=color:#5f8700>for</span> _, tc := <span style=color:#5f8700>range</span> tt {
		<span style=color:#4e4e4e>// Snipped...
</span><span style=color:#4e4e4e></span>	}
}
</code></pre></td></tr></table></div></div><p>The only notable change is to use <code>filepath.Join</code> with <code>t.TempDir()</code> and the
file name as arguments. This combo will compose a valid temporary path, that Go
will remove once the tests finish. Given that at the time of writing this, Go
1.15 is still not out, we can use the <code>gotip</code> tool to run Go&rsquo;s latest <code>master</code>
version:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ gotip <span style=color:#0087ff>test</span> -v -run <span style=color:#0087ff>TestPersist</span>
=== RUN   <span style=color:#0087ff>TestPersist</span>
=== RUN   TestPersist/WithNoContent
=== RUN   TestPersist/WithContent
--- PASS: TestPersist (0.00s)
    --- PASS: TestPersist/WithNoContent (0.00s)
    --- PASS: TestPersist/WithContent (0.00s)
PASS
ok  	github.com/fteem/go-playground/testing-in-go-leak-test-files	0.048s
</code></pre></td></tr></table></div></div><p>If we inspect the project root, we will see that no new files are being
created. The output files are cleaned up after the tests have finished running.</p><style type=text/css>.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:#444;background:#e7f2fa}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:#fff;background:#6ab0de}.notice-title:before{margin-right:8px;font-family:"font awesome 5 free",FontAwesome;font-weight:400}.notice.warning .notice-title{background:rgba(217,83,79,.9)}.notice.warning{background:#fae2e2}.notice.info .notice-title{background:#f0b37e}.notice.info{background:#fff2db}.notice.note .notice-title{background:#6ab0de}.notice.note{background:#e7f2fa}.notice.tip .notice-title{background:rgba(92,184,92,.8)}.notice.tip{background:#e6f9e6}</style><div class="notice note"><p class="first notice-title">Note</p><p>The <code>gotip</code> tool compiles and runs the <code>go</code> command from the development tree.
Using the <code>gotip</code> command, instead of the normal <code>go</code> command, will run the
latest version of the language, as seen in the main Git trunk.</p><p>You can see <a href="https://pkg.go.dev/golang.org/dl/gotip?tab=doc">its documentation</a>
for more details.</p></div><p>Next, we can do the same change to the <code>TestRun</code> function:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#0087ff>func</span> <span style=color:#0087ff>TestRun</span>(t *testing.T) {
	tt := []<span style=color:#0087ff>struct</span> {
		name   <span style=color:#af0000>string</span>
		input  <span style=color:#af0000>string</span>
		output <span style=color:#af0000>string</span>
	}{
		{
			name:   <span style=color:#00afaf>&#34;WithValidArguments&#34;</span>,
			input:  <span style=color:#00afaf>&#34;testdata/input.pdf&#34;</span>,
			output: filepath.<span style=color:#0087ff>Join</span>(t.<span style=color:#0087ff>TempDir</span>(), <span style=color:#00afaf>&#34;output.txt&#34;</span>),
		},
		{
			name:   <span style=color:#00afaf>&#34;WithEmptyInput&#34;</span>,
			input:  <span style=color:#00afaf>&#34;testdata/empty.pdf&#34;</span>,
			output: filepath.<span style=color:#0087ff>Join</span>(t.<span style=color:#0087ff>TempDir</span>(), <span style=color:#00afaf>&#34;output.txt&#34;</span>),
		},
	}

	<span style=color:#5f8700>for</span> _, tc := <span style=color:#5f8700>range</span> tt {
		<span style=color:#4e4e4e>// Same as before...
</span><span style=color:#4e4e4e></span>	}
}
</code></pre></td></tr></table></div></div><p>In the <code>TestRun</code> function, we use the same trick - we use the <code>T.TempDir</code>
function to concatenate the path of the <code>output</code> file. Running the test the
same way, we can see <code>T.TempDir</code> once more in action:</p><div class=highlight><div style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#454545">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ gotip <span style=color:#0087ff>test</span> -v -run <span style=color:#0087ff>TestRun</span>
=== RUN   <span style=color:#0087ff>TestRun</span>
=== RUN   TestRun/WithValidArguments
=== RUN   TestRun/WithEmptyInput
--- PASS: TestRun (0.03s)
    --- PASS: TestRun/WithValidArguments (0.03s)
    --- PASS: TestRun/WithEmptyInput (0.00s)
=== RUN   <span style=color:#0087ff>TestRunErrors</span>
=== RUN   TestRunErrors/WithoutArguments
=== RUN   TestRunErrors/WithoutOneArgument
=== RUN   TestRunErrors/WithNonexistentInput
--- PASS: TestRunErrors (0.02s)
    --- PASS: TestRunErrors/WithoutArguments (0.00s)
    --- PASS: TestRunErrors/WithoutOneArgument (0.02s)
    --- PASS: TestRunErrors/WithNonexistentInput (0.00s)
PASS
ok  	github.com/fteem/go-playground/testing-in-go-leak-test-files	0.265s
</code></pre></td></tr></table></div></div><p>If you want to check out the motivation and the discussion around this addition
to the new Go version 1.15, you can head over to the <a href=https://github.com/golang/go/issues/35998>original
proposal</a>.</p><section class=subscribe><b>Liked this article?</b> <a href=/newsletter>Subscribe to my
newsletter</a> and get my fresh posts in your inbox. It's short and sweet,
going out monthly to over 1,000 subscribers.</section></div><footer class=post-footer><nav class=paginav><a class=next href=https://ieftimov.com/post/four-steps-daemonize-your-golang-programs/><span class=title>Next Page »</span><br><span>Four Steps to Daemonize Your Go Programs</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: Stop Leaking Files on twitter" href="https://twitter.com/intent/tweet/?text=Testing%20in%20Go%3a%20Stop%20Leaking%20Files&url=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-stop-leaking-files%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: Stop Leaking Files on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-stop-leaking-files%2f&title=Testing%20in%20Go%3a%20Stop%20Leaking%20Files&summary=Testing%20in%20Go%3a%20Stop%20Leaking%20Files&source=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-stop-leaking-files%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: Stop Leaking Files on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-stop-leaking-files%2f&title=Testing%20in%20Go%3a%20Stop%20Leaking%20Files"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: Stop Leaking Files on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-stop-leaking-files%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: Stop Leaking Files on whatsapp" href="https://api.whatsapp.com/send?text=Testing%20in%20Go%3a%20Stop%20Leaking%20Files%20-%20https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-stop-leaking-files%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing in Go: Stop Leaking Files on telegram" href="https://telegram.me/share/url?text=Testing%20in%20Go%3a%20Stop%20Leaking%20Files&url=https%3a%2f%2fieftimov.com%2fpost%2ftesting-in-go-stop-leaking-files%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>Copyright 2021 © Ilija Eftimov</span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position"))},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})});var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft)}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>